<html><!--/*************************************************************************
* Â© Microsoft. All rights reserved.
*/--><head>
    <meta charset="utf-8">
    <title>PAY FOR THIS PACKAGE</title>
    <script src="../scripts/jQuery.js" type="text/javascript"></script>
    <link href="../scripts/common.css" rel="stylesheet">
    <script src="../scripts/common.js" type="text/javascript"></script>
    <script type="text/javascript" src="https://js.stripe.com/v2/"></script>

    <meta>
<meta></head>
<body style="overflow-wrap: break-word;">
    <style type="text/css">
        table, th {
            border-collapse: collapse;
            color: #444444;
            font-family: 'Hind', sans-serif;
            font-size: 14px;
            font-weight: 500;
        }

        th, td {
            padding: 5px;
            text-align: left;
        }

        table, td {
            color: #444444;
            font-family: 'Hind', sans-serif;
            font-size: 14px;
            font-weight: 500;
        }

        input[type=text] {
            width: 190px;
        }

        input:disabled {
            opacity: 0.5;
        }

        .red-border {
            border: solid 1px #CD2828 !important;
        }

        .tabview {
            border-style: none;
            padding: 12px;
            position: relative;
            top: 0px;
            left: 0px;
            width: calc(100% - 22px);
            height: 33px;
            background-color: #ededed;
            z-index: 1;
        }

        .tab {
            display: block;
            text-align: center;
            text-shadow: none;
            border: 1px solid #b4b4b4;
            -webkit-transition: all 0.1s ease-in-out;
            -moz-transition: all 0.1s ease-in-out;
            -ms-transition: all 0.1s ease-in-out;
            -o-transition: all 0.1s ease-in-out;
            transition: all 0.1s ease-in-out;
            -webkit-box-shadow: none;
            box-shadow: none;
            font-weight: bolder;
            color: #243a5e;
            font-family: 'Hind', sans-serif;
            font-size: 14px;
            background-color: #cccccc;
            padding: 5px 8px 3px 8px;
            text-transform: uppercase;
            text-decoration: none !important;
            cursor: pointer !important;
            white-space: nowrap;
            float: left;
        }

            .tab:hover {
                cursor: pointer;
                color: white;
                border: 1px solid #243a5e;
                background-color: #243a5e;
            }

        .tab-active {
            color: white !important;
            border: 1px solid #243a5e;
            background-color: #243a5e;
            opacity: 1;
            cursor: pointer !important;
        }

        .tab-disable {
            opacity: 0.3;
            cursor: default !important;
        }

        .fa, .fas, .far {
            font-size: 18px !important;
            vertical-align: middle;
        }

        .tab-disable:hover {
            opacity: 0.3;
            cursor: default !important;
            background-color: #cccccc;
            color: black;
        }

        .tab:first-of-type {
            border-radius: 0px;
        }

        .tab:last-of-type {
            border-radius: 0px;
        }

        .content-header h2 {
            color: #000000;
            font-size: 18px !important;
            margin-top: 10px;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        input:disabled {
            opacity: 0.5;
        }

        .content-details input, .content-details select, .contDet input, .contDet select {
            margin: 2px;
            padding: .280rem .5rem;
            font-size: 14px;
            line-height: 1.5;
            color: #495057;
            background-color: #fff;
            background-clip: padding-box;
            border: 1px solid #ced4da;
            border-radius: .25rem;
            transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out;
            margin-top: 1px;
        }

        .form-container-head {
            background-color: white;
            padding-left: 20px;
            padding-top: 20px;
            border-top: 0.6em solid #243a5e;
            padding-right: 0px;
        }

        .form-container-headNBorder {
            background-color: white;
            padding-left: 20px;
            padding-top: 20px;
            padding-right: 0px;
        }

        .form-container {
            background-color: white;
            padding-left: 20px;
            padding-right: 0px;
        }

        .main-button {
            text-align: center !important;
            text-shadow: none !important;
            border: 1px solid #b4b4b4 !important;
            background-color: #cccccc !important;
            -webkit-transition: all 0.1s ease-in-out !important;
            -moz-transition: all 0.1s ease-in-out !important;
            -ms-transition: all 0.1s ease-in-out !important;
            -o-transition: all 0.1s ease-in-out !important;
            transition: all 0.1s ease-in-out !important;
            padding: 5px 6px 3px 6px !important;
            font-family: 'Hind', sans-serif !important;
            font-weight: bolder !important;
            text-transform: uppercase !important;
            font-size: 14px !important;
            color: #243a5e !important;
            cursor: pointer !important;
            border-radius: 0px !important;
            background-clip: initial !important;
            margin: 0 !important;
            margin-top: 0px !important;
            line-height: unset !important;
            margin-right: 5px !important;
            white-space: nowrap !important;
        }

            .main-button:hover {
                cursor: pointer !important;
                color: white !important;
                border: 1px solid #243a5e !important;
                background-color: #243a5e !important;
            }

            .main-button .button-icon {
                margin-left: 10px;
                text-rendering: optimizeLegibility;
            }

        .validationError {
            color: #e60000;
        }

        .mandatory:after {
            content: '*';
            color: red;
            font-weight: bold;
            font-size: 15px;
            padding-left: 3px;
        }

        a:link {
            color: #243a5e;
        }

        a:visited {
            color: #243a5e;
        }

        .divloader {
            position: fixed;
            width: 100%;
            height: 100%;
            text-align: center;
            background: lightgrey;
            opacity: 0.8;
            filter: alpha(opacity=40);
            z-index: 2000;
            margin-top: -8px;
            margin-left: -8px;
        }
    </style>
    <div class="divloader" style="display: none; font-family: undefined;">
        <img id="ajax-loader" src="../images/ajaxloader.gif" style="margin: 25% 49%; display: block;">
    </div>
    <div id="tblPaymentProcess">
        <table class="content-details" style="width: 100%; margin-top: 5px;" border="0" role="presentation">
            <tbody>
                <tr>
                    <td style="padding-left: 0px;padding-right: 2px;">
                        <div class="tabview">
                            <div class="content-header" style="float:left;width: 220px;margin-top: 4px;">
                                <h2 class="noselect" style="margin: 0;">PAY FOR THIS PACKAGE</h2>
                            </div>
                            <!--<div role="navigation" aria-label="Payment Type">-->
                                <a class="tab" href="javascript:void(0)" id="TabCash" title="Cash">Cash</a>
                                <a class="tab" href="javascript:void(0)" id="TabCheque" title="Cheque" style="margin-left: -1px;">Check</a>
                                <a class="tab" href="javascript:void(0)" id="TabWireTransfer" title="WireTransfer">Wire Transfer</a>
                                <a class="tab" href="javascript:void(0)" id="TabCC" title="CC" style="margin-left: -2px;">Credit Card</a>
                            <!--</div>-->                            
                        </div>
                        <table style="border-style:none;width:100%;" border="0">
                            <tbody>
                                <tr style="background:#fff;">
                                    </tr></tbody></table><table style="border-style:none;width:99%;margin-left: 2px;" border="0" align="center">
                                        <tbody>
                                            <tr>
                                                <td style="width: 157px;height:15px;"></td>
                                                <td style="width: 30%;"></td>
                                                <td></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </td></tr>
                                <tr>
                                    <td colspan="3" style="background:#ededed !important;padding: 13px;padding-top: 15px;padding-bottom: 15px;text-align:center;">
                                        <table style="border-style:none;width:99%;margin-left: 2px;" border="0" align="center" role="presentation">
                                            <tbody>
                                                <tr>
                                                    <td style="width: 157px;" class="form-container-head">Contact</td>
                                                    <td class="form-container-head">
                                                        <input type="text" id="txtCustomer" disabled="">
                                                        <input type="hidden" id="hdCustomerid">
                                                    </td>
                                                </tr>
                                                <tr id="CC">
                                                    <td colspan="2" class="form-container">
                                                        <div class="linktab">
                                                            <table style="width: 103.6%; margin: -6px;" border="0" role="presentation">
                                                                <tbody>
                                                                    <tr id="trCardList">
                                                                        <td style="width: 168px;"><span>Existing Card</span></td>
                                                                        <td>
                                                                            <select id="listCreditCard" style="width: 190px;padding: .280rem .5rem;height: 32px;" disabled="" role="listbox" aria-label="Existing Card">
                                                                                <option value="0" role="option"></option>
                                                                            </select>
                                                                            <select id="listCCType" hidden="hidden">
                                                                                <option value="844060000" role="option">Visa</option>
                                                                                <option value="844060001" role="option">Master Card</option>
                                                                                <option value="844060002" role="option">Visa Debit</option>
                                                                                <option value="844060003" role="option">Master Card Debit</option>
                                                                                <option value="844060004" role="option">American Express</option>
                                                                                <option value="844060005" role="option">Diners Club</option>
                                                                                <option value="844060006" role="option">JCB</option>
                                                                                <option value="844060007" role="option">Interact</option>
                                                                            </select>
                                                                        </td>
                                                                    </tr>
                                                                    <tr class="trCCAttribute" style="display: none;">
                                                                        <td><span>Name on the Card</span></td>
                                                                        <td><input type="text" id="txtNameOnCard" aria-label="Name on the Card" disabled=""></td>
                                                                    </tr>
                                                                    <tr class="trCCAttribute" style="display: none;">
                                                                        <td><span>Card Number</span></td>
                                                                        <td><input type="text" id="txtCardNumber" aria-label="Card Number" onkeypress="return checkIt(event);"></td>
                                                                    </tr>
                                                                    <tr class="trCCAttribute" style="display: none;">
                                                                        <td><span>Credit Card Type</span></td>
                                                                        <td>
                                                                            <select id="listCardType" style="width: 190px; height: 32px;" role="listbox" aria-label="Credit Card Type">
                                                                                <!--hidden="hidden">-->
                                                                                <option value="0" role="option"></option>
                                                                                <option value="844060000" role="option">Visa</option>
                                                                                <option value="844060001" role="option">Master Card</option>
                                                                                <option value="844060002" role="option">Visa Debit</option>
                                                                                <option value="844060003" role="option">Master Card Debit</option>
                                                                                <option value="844060004" role="option">American Express</option>
                                                                                <option value="844060005" role="option">Diners Club</option>
                                                                                <option value="844060006" role="option">JCB</option>
                                                                                <option value="844060007" role="option">Interact</option>
                                                                            </select>
                                                                        </td>
                                                                    </tr>
                                                                    <tr class="trCCAttribute" style="display: none;">
                                                                        <td><span>Expiry</span></td>
                                                                        <td><input type="text" id="txtCardExpiry" placeholder="mmyy" maxlength="7" aria-label="Expiry"></td><!--onkeypress="return checkIt(event);" onblur="checkLength(this)" /></td>-->
                                                                    </tr>
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <tr id="Cheque">
                                                    <td colspan="2" class="form-container">
                                                        <div class="linktab">
                                                            <table style="width: 103.6%; margin: -6px;" border="0" role="presentation">
                                                                <tbody>
                                                                    <tr class="trCheckWireAttribute">
                                                                        <td style="width: 168px;">
                                                                            <span class="spnChequeNumber field-label hide">Check Number</span>
                                                                            <span class="spnWireNumber field-label hide">Wire Number</span>
                                                                        </td>
                                                                        <td><input type="text" id="txtChequeNumber" aria-label="Check Number" onkeypress="return checkIt(event);"></td>
                                                                    </tr>
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <tr id="Cash">
                                                    <td colspan="2" class="form-container">
                                                        <div class="linktab">
                                                            <table style="width: 103.6%; margin: -6px;" border="0">
                                                                <tbody>
                                                                    <tr><td>&nbsp;</td></tr>
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class="form-container" style="height:10px;" colspan="2"><br></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <div style="height:20px;border-style:none;">&nbsp;</div>
                        <table style="width:100%;border-style:none;" class="contDet" border="0" role="presentation">
                            <tbody>
                                <tr>
                                    <td colspan="3" style="background:#ededed !important;padding: 13px;padding-top: 15px;padding-bottom: 15px;text-align:center;">
                                        <table style="border-style:none;width:99%;margin-left: 2px;" border="0" align="center" role="presentation">
                                            <tbody>
                                                <tr>
                                                    <td class="form-container-headNBorder" style="width: 157px;">Remaining Balance</td>
                                                    <td class="form-container-headNBorder" colspan="2"><input type="text" id="txtTotalRemaining" disabled="disabled"></td>
                                                </tr>
                                                <tr>
                                                    <td class="form-container mandatory">Confirm Amount</td>
                                                    <td class="form-container">
                                                        <input type="text" id="txtConfirmAmount" aria-label="Confirm Amount" aria-required="true">â
                                                        <input type="button" role="button" value="Process" class="main-button" id="btnProcess" style="width: 87px;">
                                                        <input type="button" role="button" class="main-button" value="Close" id="btnMainClose">
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class="form-container" colspan="2">
                                                        <label id="lblError" class="validationError" role="alert"></label><br>
                                                        <label id="lblErrorValidation" class="validationError" role="alert"></label><br>
                                                        <label id="lblErrorExpiry" class="validationError" role="alert"></label><br>
                                                        <!--<label id="lblErrorAmount" class="validationError" role="alert"></label>-->
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    
                
            
        
        <select id="ddlPaymentGateway" hidden="hidden">
            <option value=""></option>
            <option value="844060000">Moneris</option>
            <option value="844060001">Authorize.Net</option>
            <option value="844060002">iATS</option>
            <option value="844060003">Adyen</option>
            <option value="844060004">WorldPay</option>
            <option value="844060005">Stripe</option>
        </select>
    </div>

    <div id="tblTransactionResult">
        <table class="content-details" style="width: 100%; margin-top: 5px;" border="0" role="presentation">
            <tbody>
                <tr>
                    <td>
                        <table style="border-style:none;width:100%;" border="0" role="presentation">
                            <tbody>
                                <tr style="background:#fff;">
                                    </tr></tbody></table><table style="border-style:none;width:99%;margin-left: 2px;" border="0" align="center" role="presentation">
                                        <tbody>
                                            <tr>
                                                <td style="height:0px;"></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </td></tr>
                                <tr>
                                    <td colspan="3" style="background:#ededed !important;padding: 13px;padding-top: 15px;padding-bottom: 15px;text-align:center;">
                                        <table style="border-style:none;width:99%;margin-left: 2px;" border="0" align="center" role="presentation">
                                            <tbody>
                                                <tr>
                                                    <td style="width: 157px;" class="form-container-headNBorder">Contact</td>
                                                    <td class="form-container-headNBorder">
                                                        <input type="text" id="txtCust" aria-label="Contact">
                                                        <input type="hidden" id="hdCustId">
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class="form-container">Payment Result</td>
                                                    <td class="form-container">
                                                        <!--<span id="lblResult" style="display:block;" role="alert"></span>-->
                                                        <label id="lblResult" role="alert"></label>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class="form-container"></td>
                                                    <td class="form-container" style="padding-right: 20px;text-align: right;">
                                                        â
                                                        <input type="button" class="main-button" role="button" value="Close" id="btnClose">
                                                        <input type="button" class="main-button" role="button" value="Try Again" id="btnTryAgain">
                                                        <input type="button" class="main-button" role="button" value="Print" id="btnPrint" style="visibility: hidden;">
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class="form-container" colspan="2">
                                                        <select id="listState" hidden="hidden">
                                                            <option value="0"></option>
                                                            <option value="844060000">AL-Alabama</option>
                                                            <option value="844060001">AK-Alaska</option>
                                                            <option value="844060002">AS-American Samoa</option>
                                                            <option value="844060003">AZ-Arizona</option>
                                                            <option value="844060004">AR-Arkansas</option>
                                                            <option value="844060005">CA-California</option>
                                                            <option value="844060006">CO-Colorado</option>
                                                            <option value="844060007">CT-Connecticut</option>
                                                            <option value="844060008">DE-Delaware</option>
                                                            <option value="844060009">DC-District of Columbia</option>
                                                            <option value="844060010">FL-Florida</option>
                                                            <option value="844060011">GA-Georgia</option>
                                                            <option value="844060012">GU-Guam</option>
                                                            <option value="844060013">HI-Hawaii</option>
                                                            <option value="844060014">ID-Idaho</option>
                                                            <option value="844060015">IL-Illinois</option>
                                                            <option value="844060016">IN-Indiana</option>
                                                            <option value="844060017">IA-Iowa</option>
                                                            <option value="844060018">KS-Kansas</option>
                                                            <option value="844060019">KY-Kentucky</option>
                                                            <option value="844060020">LA-Louisiana</option>
                                                            <option value="844060021">ME-Maine</option>
                                                            <option value="844060022">MD-Maryland</option>
                                                            <option value="844060023">MA-Massachusetts</option>
                                                            <option value="844060024">MI-Michigan</option>
                                                            <option value="844060025">MN-Minnesota</option>
                                                            <option value="844060026">MS-Mississippi</option>
                                                            <option value="844060027">MO-Missouri</option>
                                                            <option value="844060028">MT-Montana</option>
                                                            <option value="844060029">NE-Nebraska</option>
                                                            <option value="844060030">NV-Nevada</option>
                                                            <option value="844060031">NH-New Hampshire</option>
                                                            <option value="844060032">NJ-New Jersey</option>
                                                            <option value="844060033">NM-New Mexico</option>
                                                            <option value="844060034">NY-New York</option>
                                                            <option value="844060035">NC-North Carolina</option>
                                                            <option value="844060036">ND-North Dakota</option>
                                                            <option value="844060037">MP-Northern Mariana Islands</option>
                                                            <option value="844060038">OH-Ohio</option>
                                                            <option value="844060039">OK-Oklahoma</option>
                                                            <option value="844060040">OR-Oregon</option>
                                                            <option value="844060041">PA-Pennsylvania</option>
                                                            <option value="844060042">PR-Puerto Rico</option>
                                                            <option value="844060043">RI-Rhode Island</option>
                                                            <option value="844060044">SC-South Carolina</option>
                                                            <option value="844060045">SD-South Dakota</option>
                                                            <option value="844060046">TN-Tennessee</option>
                                                            <option value="844060047">TX-Texas</option>
                                                            <option value="844060048">UT-Utah</option>
                                                            <option value="844060049">VT-Vermont</option>
                                                            <option value="844060050">VI-Virgin Islands</option>
                                                            <option value="844060051">VA-Virginia</option>
                                                            <option value="844060052">WA-Washington</option>
                                                            <option value="844060053">WV-West Virginia</option>
                                                            <option value="844060054">WI-Wisconsin</option>
                                                            <option value="844060055">WY-Wyoming</option>
                                                            <option value="844060056">AB-Alberta</option>
                                                            <option value="844060057">BC-British Columbia</option>
                                                            <option value="844060058">MB-Manitoba</option>
                                                            <option value="844060059">NB-New Brunswick</option>
                                                            <option value="844060060">NF-Newfoundland</option>
                                                            <option value="844060061">NT-Northwest Territories</option>
                                                            <option value="844060062">NS-Nova Scotia</option>
                                                            <option value="844060063">NU-Nunavut</option>
                                                            <option value="844060064">ON-Ontario</option>
                                                            <option value="844060065">PE-Prince Edward Island</option>
                                                            <option value="844060066">PQ-Quebec</option>
                                                            <option value="844060067">SK-Saskatchewan</option>
                                                            <option value="844060068">YT-Yukon Territory</option>
                                                        </select>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class="form-container" style="height:10px;" colspan="2"><br></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    
                
            
        
    </div>

    <script type="text/javascript">
        var PaymentType = {
            Cash: 844060000,
            Cheque: 844060001,
            WireTransfer: 844060009,
            CreditDebit: 844060002,
            Bank: 844060003,
            Invoice: 844060013
        }

        var customer;
        var customerName;
        var customerID;
        var customerEmail;
        var defaultGUID = '00000000-0000-0000-0000-000000000000';
        var transactionID = "";
        var paymentID = "";
        var customerEntityType;
        var selectedPaymentType;
        var packageRec;
        var isoCurrencyCode;
        var currencySymbol;
        var userSettings;

        var packageID;// = crmParent.Xrm.Page.data.entity.getId().replace('{', '').replace('}', '').toUpperCase();

        var configRecord = null;
        var userConfigID = null;

        var xrm = XrmUtility.get_Xrm();

        var currentuserID = xrm.Page.context.getUserId().replace('{', '').replace('}', '').toUpperCase();
        var userSelect = "systemusers?$select=systemuserid,_msnfp_configurationid_value"
        userSelect += "&$filter=systemuserid eq " + currentuserID;
        var user = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + userSelect);
        user = user[0];

        if (!isNullOrUndefined(user._msnfp_configurationid_value)) {
            userConfigID = user._msnfp_configurationid_value;
        }

        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            var results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        };

        function getParameters() {
            var Parameters = GetGlobalContext().getQueryStringParameters();
            if (Parameters && Parameters.Data) {
                var paramList = Parameters.Data.split("&");
                packageID = paramList[0].split("=")[1];
            }
        }

        $('#Cheque').hide();
        $('#CC').hide();;

        $(function () {

            //getParameters();
            packageID = getUrlParameter('data').replace("entityGUID=", "");

            var pQuery = "msnfp_eventpackages(" + packageID + ")?";
            pQuery += "$select=msnfp_eventpackageid,msnfp_emailaddress1,msnfp_amount_balance,msnfp_amount,msnfp_paymenttype,_msnfp_customerid_value,";
            pQuery += "msnfp_billing_line1,msnfp_billing_line2,msnfp_billing_line3,msnfp_billing_city,msnfp_billing_stateorprovince,msnfp_billing_postalcode,_msnfp_configurationid_value,_transactioncurrencyid_value&";
            pQuery += "$expand=msnfp_CustomerId_account($select=accountid,name,address1_line1,address1_line2,address1_line3,address1_city,address1_stateorprovince,address1_country,address1_postalcode,telephone1,emailaddress1),";
            pQuery += "msnfp_CustomerId_contact($select=contactid,firstname,lastname,fullname,address1_line1,address1_line2,address1_line3,address1_city,address1_stateorprovince,address1_country,address1_postalcode,telephone1,emailaddress1)";
            packageRec = XrmServiceUtility.ExecuteQueryWithExpand(XrmServiceUtility.GetWebAPIUrl() + pQuery);


            jQuery.ajax({
                url: `${parent.Xrm.Page.context.getClientUrl()}/api/data/v9.1/usersettingscollection(${MissionFunctions.GetCurrentUserID()})`,
                success: function (result) {
                    userSettings = result;
                },
                async: false
            });

            customerEmail = packageRec.msnfp_emailaddress1;

            if (!isNullOrUndefined(packageRec._transactioncurrencyid_value)) {
                getCurrencySymbol(packageRec._transactioncurrencyid_value);
            }

            var Address = {
                line1: packageRec.msnfp_billing_line1,
                line2: packageRec.msnfp_billing_line2,
                line3: packageRec.msnfp_billing_line3,
                city: packageRec.msnfp_billing_city,
                stateProvince: packageRec.msnfp_billing_stateorprovince,
                postalcode: packageRec.msnfp_billing_postalcode,
            }


            var remainingBalance = packageRec.msnfp_amount_balance != null ? parseFloat(packageRec.msnfp_amount_balance) : 0;

            //$("#txtTotalRemaining").val(remainingBalance);
            $("#txtTotalRemaining").val(currencySymbol + addCommasonLoad(parseFloat(remainingBalance.toString()).toFixed(2)));

            if (!isNullOrUndefined(packageRec.msnfp_CustomerId_contact)) {
                $("#txtCustomer").val(packageRec.msnfp_CustomerId_contact.fullname);
                $("#hdCustomerid").val(packageRec.msnfp_CustomerId_contact.contactid);
                customerID = packageRec.msnfp_CustomerId_contact.contactid;
                customerEntityType = "contact";
                customerName = packageRec.msnfp_CustomerId_contact.fullname;
                customer = packageRec.msnfp_CustomerId_contact;
                customer.isAccount = false;
            }
            else if (!isNullOrUndefined(packageRec.msnfp_CustomerId_account)) {
                $("#txtCustomer").val(packageRec.msnfp_CustomerId_account.name);
                $("#hdCustomerid").val(packageRec.msnfp_CustomerId_account.accountid);
                customerID = packageRec.msnfp_CustomerId_account.accountid;
                customerEntityType = "account";
                customerName = packageRec.msnfp_CustomerId_account.name;
                customer = packageRec.msnfp_CustomerId_account;
                customer.isAccount = true;
            }

            if (!isNullOrUndefined(packageRec._msnfp_configurationid_value)) {
                var select = "msnfp_configurations?$select=msnfp_configurationid,_msnfp_paymentprocessorid_value, msnfp_label_creditcard,msnfp_label_cheque,msnfp_label_cash,msnfp_label_wire";
                select += "&$filter=msnfp_configurationid eq " + user._msnfp_configurationid_value;
                var configresult = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + select);
                configRecord = configresult[0];
            }

            $("#tblTransactionResult").hide();

            loadCreditCardList();

            settingLabels();

            var giftType = packageRec.msnfp_paymenttype;

            $('.tabview').find('a#TabCash').addClass('tab-active');
            $('#Cash').show();
            $('#listCreditCard').attr('disabled', false);

            //$('#txtConfirmAmount').focusout(function () {
            //    if (!isNaN(parseFloat($('#txtConfirmAmount').val().replace(/[^\d\.\-]/g, "")))) {
            //        var totalRemaining = parseFloat($('#txtTotalRemaining').val().replace(currencySymbol, '').replace(/[^\d\.\-]/g, ""));
            //        var confirmAmount = parseFloat($('#txtConfirmAmount').val().replace(currencySymbol, '').replace(/[^\d\.\-]/g, ""));
            //        $(this).val(currencySymbol + addCommasonLoad(parseFloat(confirmAmount.toString()).toFixed(2)));

            //        if (confirmAmount > totalRemaining) {
            //            $(this).addClass('red-border');
            //            $(this).focus();
            //            //$("#btnProcess").attr('disabled', 'disabled');
            //        }
            //        else {
            //            $(this).removeClass('red-border');
            //            //$("#btnProcess").attr('disabled', false);
            //        }
            //    }
            //    else {
            //        $(this).addClass('red-border');
            //        $(this).focus();
            //        //$("#btnProcess").attr('disabled', 'disabled');
            //        $('#txtConfirmAmount').val("");
            //    }
            //});

            $('.tabview').children('a').each(function () {
                $(this).click(function (e) {
                    manageTab(this);
                });
            });

            $('#listCreditCard').change(function () {
                $('#listCreditCard').removeClass('red-border');
                //$('#lblError')[0].innerText = '';
                //$('#lblErrorValidation')[0].innerText = '';

                $('#lblError').html('');
                $('#lblErrorValidation').html('');

                if ($(this).val() === "-1") {
                    //new Credit Card
                    $('tr.trCCAttribute').show();
                    $('#txtNameOnCard').val($("#txtCustomer").val());
                    $('tr.trCCAttribute > td > span').addClass('mandatory');
                    $('tr.trCCAttribute > td > input').attr('aria-required', true);
                    $('tr.trCCAttribute > td > select').attr('aria-required', true);
                    $('tr#trCardList > td > span').removeClass('mandatory');
                    $('tr#trCardList > td > input').attr('aria-required', false);
                    $('tr#trCardList > td > select').attr('aria-required', false);
                }
                else {
                    $('tr.trCCAttribute > td > span').removeClass('mandatory');
                    $('tr.trCCAttribute > td > input').attr('aria-required', false);
                    $('tr.trCCAttribute > td > select').attr('aria-required', false);
                    $('tr.trCCAttribute').hide();
                    $('tr#trCardList > td > span').addClass('mandatory');
                    $('tr#trCardList > td > input').attr('aria-required', true);
                    $('tr#trCardList > td > select').attr('aria-required', true);

                    if ($(this).val() != 0) {
                        //Existing Credit Card
                        var selectQueryCC = "msnfp_paymentmethods?$select=msnfp_paymentmethodid,_msnfp_paymentprocessorid_value";
                        var filterCC = "&$filter=msnfp_paymentmethodid eq " + $(this).val();
                        var ccResult = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + selectQueryCC + filterCC);

                        if (configRecord._msnfp_paymentprocessorid_value != ccResult[0]._msnfp_paymentprocessorid_value) {
                            var defaultGateway = $('#ddlPaymentGateway option[value=' + configRecord._msnfp_paymentprocessorid_value + ']').text();
                            $('#lblError')[0].innerText = 'The Credit card ' + $('#ddlExistingCard option:selected').text() + ' is not registered with ' + defaultGateway + ' Payment Gateway.';
                        }

                    }
                }
            });
        });

        function loadCreditCardList() {
            var ccQuery = "msnfp_paymentmethods?$select=msnfp_paymentmethodid,msnfp_bankname,msnfp_name,createdon&$orderby=createdon desc&$filter=(statuscode eq 1 and msnfp_type eq 844060000 and _msnfp_customerid_value eq " + XrmUtility.CleanGuid(customerID) + ")";

            var CCList = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + ccQuery);

            $('tr#trCardList > td > span').addClass('mandatory');
            $('tr#trCardList > td > input, select').attr('aria-required', true);

            if (CCList != null && CCList != undefined && CCList.length > 0) {
                $.each(CCList, function (key, value) {
                    $('#listCreditCard').append($("<option role='option'></option>").attr("value", value.msnfp_paymentmethodid).text(value.msnfp_name));
                });
                $('#listCreditCard').append('<option value="-1" role="option">New Credit Card</option>');
            }
            else {
                $('#listCreditCard').append('<option value="-1" role="option">New Credit Card</option>');
            }
        }

        function settingLabels() {

            if (!isNullOrUndefined(configRecord.msnfp_label_creditcard))
                $('#TabCC')[0].innerText = configRecord.msnfp_label_creditcard;
            if (!isNullOrUndefined(configRecord.msnfp_label_cheque))
                $('#TabCheque')[0].innerText = configRecord.msnfp_label_cheque;
            if (!isNullOrUndefined(configRecord.msnfp_label_cash))
                $('#TabCash')[0].innerText = configRecord.msnfp_label_cash;
            if (!isNullOrUndefined(configRecord.msnfp_label_wire))
                $('#TabWireTransfer')[0].innerText = configRecord.msnfp_label_wire;
        }

        function saveCreditCardDetails() {
            var eEntity = {};

            if (customer.isAccount)
                eEntity["msnfp_CustomerId_account@odata.bind"] = "/accounts(" + customer.accountid + ")";
            else
                eEntity["msnfp_CustomerId_contact@odata.bind"] = "/contacts(" + customer.contactid + ")";

            var cardNo = $('#txtCardNumber').val();
            //eEntity["msnfp_firstname"] = $('#txtNameOnCard').val();
            //eEntity["msnfp_lastname"] = $('#txtLastName').val();
            eEntity["msnfp_nameonfile"] = $("#txtNameOnCard").val();
            eEntity["msnfp_emailaddress1"] = customer.emailaddress1;
            eEntity["msnfp_telephone1"] = customer.telephone1;
            eEntity["msnfp_billing_line1"] = customer.address1_line1;
            eEntity["msnfp_billing_line2"] = customer.address1_line2;
            eEntity["msnfp_billing_line3"] = customer.address1_line3;
            eEntity["msnfp_billing_city"] = customer.address1_city;
            eEntity["msnfp_billing_state"] = customer.address1_stateorprovince;
            eEntity["msnfp_billing_country"] = customer.address1_country;
            eEntity["msnfp_billing_postalcode"] = customer.address1_postalcode;
            eEntity["msnfp_cclast4"] = cardNo;
            eEntity["msnfp_ccexpmmyy"] = $('#txtCardExpiry').val();
            eEntity["msnfp_ccbrandcode"] = parseInt($('#listCardType').val());
            creditCardType = parseInt($('#listCardType').val());
            var identifier = RandomGuid().substring(0, 8);
            eEntity["msnfp_identifier"] = identifier;
            eEntity["msnfp_name"] = $('#listCardType option:selected').text() + " - " + cardNo.substr(cardNo.length - 4);
            eEntity["msnfp_type"] = 844060000;
            eEntity["msnfp_PaymentProcessorId@odata.bind"] = "/msnfp_paymentprocessors(" + configRecord._msnfp_paymentprocessorid_value + ")";
            var stripeToken = "";
            var recordId = "";

            var invoiceIdentifier = "FUND" + RandomGuid().substring(0, 7).toUpperCase();

            if (configRecord.msnfp_paymentgateway == 844060005)  //Stripe API
            {
                var clientKey = configRecord.msnfp_key;
                //var stripe = Stripe(clientKey);
                Stripe.setPublishableKey(clientKey);

                var cardNumber = cardNo;
                var holderName = $("#txtNameOnCard").val();
                var expiryMonth = $('#txtCardExpiry').val().substr(0, 2);
                var expiryYear = "20" + $('#txtCardExpiry').val().substr(2, 2);
                var generationTime = new Date().toISOString();


            }

            if (recordId == "") {
                var query = XrmServiceUtility.GetWebAPIUrl() + "msnfp_paymentmethods";
                recordId = XrmServiceUtility.CreateRecord(query, eEntity);
            }
            console.log(recordId);

            return recordId;
        }

        function checkIt(evt) {
            evt = (evt) ? evt : window.event;
            var charCode = (evt.which) ? evt.which : evt.keyCode;
            if (charCode > 31 && (charCode < 48 || charCode > 57)) {
                status = "This field accepts numbers only."
                return false;
            }
            status = "";
            return true;
        }

        function cardnumber(inputtxt) {
            var AE = /^(?:3[47][0-9]{13})$/;                 //Amercican Express
            var visa = /^(?:4[0-9]{12}(?:[0-9]{3})?)$/;      //Visa
            var MC = /^(?:5[1-5][0-9]{14})$/;                //Mastercard
            var Dis = /^(?:6(?:011|5[0-9][0-9])[0-9]{12})$/; //Discover
            var DC = /^(?:3(?:0[0-5]|[68][0-9])[0-9]{11})$/; //Dinners Club

            if (inputtxt.val().match(AE)) {
                $(inputtxt).removeClass('red-border');
                return true;
            }
            else if (inputtxt.val().match(visa)) {
                $(inputtxt).removeClass('red-border');
                return true;
            }
            else if (inputtxt.val().match(MC)) {
                $(inputtxt).removeClass('red-border');
                return true;
            }
            else if (inputtxt.val().match(Dis)) {
                $(inputtxt).removeClass('red-border');
                return true;
            }
            else if (inputtxt.val().match(DC)) {
                $(inputtxt).removeClass('red-border');
                return true;
            }
        }

        function checkLength(elem) {
            if ($(elem)[0].id == "txtCardExpiry") {
                if (elem.value.length < 4) {
                    $(elem).addClass('red-border');
                    $(elem).focus();
                    return false;
                }
            }
            else {
                $(elem).removeClass('red-border');
                return true;
            }
        }

        $("#btnProcess").click(function () {
            //$("#btnProcess").attr('disabled', 'disabled');
            $("#btnProcess").hide();

            $('.validationError').each(function () {
                this.innerText = '';
            });

            var isValid = validate();

            if (!isValid) {
                //$("#btnProcess").attr('disabled', false);
                $("#btnProcess").show();
            }

            if ($('.tabview').find('#TabCC').hasClass('tab-active')) {
                if (isValid) {
                    if ($('#listCreditCard').val() == -1) {
                        var cardId = saveCreditCardDetails();
                        if (!isNullOrUndefined(cardId)) {
                            createPayment(cardId);
                        }
                    }
                    else {
                        var cardId = $('#listCreditCard').val();
                        createPayment(cardId);
                    }
                }
            }

            if ($('.tabview').find('#TabCheque').hasClass('tab-active') || ($('.tabview').find('#TabWireTransfer').hasClass('tab-active'))) {
                if (isValid)
                    createPayment(defaultGUID);
            }
            else if ($('.tabview').find('#TabCash').hasClass('tab-active') && $('#txtConfirmAmount').val() != "") {
                if (isValid)
                    createPayment(defaultGUID);
            }
        });

        $.as_VerifyEmpty = function (elem) {
            var r = false;
            if (elem) {
                r = $.trim(elem.val()).length > 0;
                if (!r)
                    elem.addClass('red-border').val('');
                else
                    elem.removeClass('red-border');
            }
            return r;
        }

        $('#txtCardNumber, #txtCardExpiry, #txtAccountNumber, #txtRoutingNumber').focusout(function () {
            $.as_VerifyEmpty($(this));
        });

        function validate() {
            var isValidate = true;
            //$("#lblErrorValidation")[0].innerText = '';
            $('#lblErrorValidation').html('');
            $("#txtConfirmAmount").removeClass('red-border');
            $("#txtChequeNumber").removeClass('red-border');
            $("#listCreditCard").removeClass('red-border');
            $("#txtCardNumber").removeClass('red-border');
            $("#listCardType").removeClass('red-border');
            $("#txtCardExpiry").removeClass('red-border');
            

            if (selectedPaymentType == PaymentType.Cheque) {
                if (isNullOrUndefined($('#txtChequeNumber').val())) {
                    isValidate = false;
                    $("#txtChequeNumber").addClass('red-border');
                    //$('#lblErrorValidation')[0].innerText = "Please enter check number.";
                    $('#lblErrorValidation').append('<p>Please enter check number.</p>');
                    return;
                }
            }
            else if (selectedPaymentType == PaymentType.WireTransfer) {
                if (isNullOrUndefined($('#txtChequeNumber').val())) {
                    isValidate = false;
                    $("#txtChequeNumber").addClass('red-border');
                    //$('#lblErrorValidation')[0].innerText = "Please enter wire number.";
                    $('#lblErrorValidation').append('<p>Please enter wire number.</p>');
                    return;
                }
            }
            else if (selectedPaymentType == PaymentType.CreditDebit) {
                if ($('#listCreditCard').val() === "-1") {
                    if ($('#txtCardNumber').val() === "" || !cardnumber($('#txtCardNumber'))) {
                        isValidate = false;
                        $("#txtCardNumber").addClass('red-border');
                        //$('#lblErrorValidation')[0].innerText = "Please enter a valid credit card number.";
                        $('#lblErrorValidation').append('<p>Please enter a valid credit card number.</p>');
                        return;
                    }
                    if ($('#listCardType').val() === "0") {
                        isValidate = false;
                        $("#listCardType").addClass('red-border');
                        //$('#lblErrorValidation')[0].innerText = "Please select Credit Card type.";
                        $('#lblErrorValidation').append('<p>Please select Credit Card type.</p>');
                        return;
                    }
                    if ($('#txtCardExpiry').val() === "" || !validateExpiry()) {
                        isValidate = false;
                        $("#txtCardExpiry").addClass('red-border');
                        //$('#lblErrorValidation')[0].innerText = "Please enter a valid expiry date.";
                        $('#lblErrorValidation').append('<p>Please enter a valid expiry date.</p>');
                        return;
                    }
                }
                else if ($('#listCreditCard').val() === "0" && ($('#listCreditCard').closest('tr#trCardList').find('span').hasClass('mandatory'))) {
                    isValidate = false;
                    $("#listCreditCard").addClass('red-border');
                    //$('#lblErrorValidation')[0].innerText = "Please select or enter a credit/debit card";
                    $('#lblErrorValidation').append('<p>Please select or enter a credit/debit card.</p>');
                    return;
                }
            }

            //var amount = $('#txtConfirmAmount').val();
            var amount = parseFloat($('#txtConfirmAmount').val().replace(currencySymbol, '').replace(/[^\d\.\-]/g, ""))
            
            if (isNaN(amount) || amount === '' || parseFloat(amount) <= 0) {
                //$("#lblErrorValidation")[0].innerText = "Please enter valid amount.";
                $('#lblErrorValidation').append('<p>Please enter valid amount.</p>');
                isValidate = false;
                $("#txtConfirmAmount").addClass('red-border');
                return;
            }
            else {
                
                var totalRemaining = parseFloat($('#txtTotalRemaining').val().replace(currencySymbol, '').replace(/[^\d\.\-]/g, ""));
                var confirmAmount = parseFloat($('#txtConfirmAmount').val().replace(currencySymbol, '').replace(/[^\d\.\-]/g, ""));
                $(this).val(currencySymbol + addCommasonLoad(parseFloat(confirmAmount.toString()).toFixed(2)));

                if (confirmAmount > totalRemaining) {
                    //$("#lblErrorValidation")[0].innerText = "Confirm amount cannot be greater than remaining balance.";
                    $('#lblErrorValidation').append('<p>Confirm amount cannot be greater than remaining balance.</p>');
                    $("#txtConfirmAmount").addClass('red-border');
                    isValidate = false;
                    return;
                    //$(this).focus();
                    //$("#btnProcess").attr('disabled', 'disabled');
                }                                            
            }

            return isValidate;
        }

        function validateExpiry() {
            //$('#lblErrorExpiry')[0].innerText = '';
            $('#lblErrorExpiry').html('');

            var currentDate = new Date();
            var isExpValidate = true;
            var cardExp = $('#txtCardExpiry').val();
            var mm = parseInt(cardExp.substring(0, 2));
            var yy = parseInt(cardExp.substring(cardExp.length - 2));
            var currentMonth = parseInt(currentDate.getMonth() + 1);
            var currentYear = parseInt(currentDate.getFullYear().toString().substr(-2));

            if (mm > 12 || mm <= currentMonth) {
                if (yy == currentYear && mm >= currentMonth && mm <= 12) {
                    isExpValidate = true;
                }
                else if (yy > currentYear && mm <= 12) {
                    isExpValidate = true;
                }
                else {
                    //$('#lblErrorExpiry')[0].innerText = "Month value must be 1 to 12 and greater than or equal to current month.";
                    $('#lblErrorExpiry').append('<p>Month value must be 1 to 12 and greater than or equal to current month.</p>');
                    isExpValidate = false;
                }
            }

            if (yy < currentYear) {
                //$('#lblErrorExpiry')[0].innerText = "Year value must be greater than or equal to current year.";
                $('#lblErrorExpiry').append('<p>Year value must be greater than or equal to current year.</p>');
                isExpValidate = false;
            }
            return isExpValidate;
        }

        function RandomGuid() {
            return s4() + s4() + '' + s4() + '' + s4() + '' +
                s4() + '' + s4() + s4() + s4();
        }

        function s4() {
            return Math.floor((1 + Math.random()) * 0x10000)
                .toString(16)
                .substring(1);
        }

        function createPayment(CCorBArecordId) {
            $(".divloader").show();

            var payment = {};
            var dte = new Date();
            var payingAmount = parseFloat($('#txtConfirmAmount').val().replace(currencySymbol, '').replace(/[^\d\.\-]/g, ""));

            //payment["msnfp_name"] = "PMNT" + dte.mmddyyyy() + "_" + parseFloat($('#txtConfirmAmount').val());
            //payment["msnfp_amount"] = parseFloat($('#txtConfirmAmount').val());
            payment["msnfp_name"] = "PMNT" + dte.mmddyyyy() + "_" + parseFloat($('#txtConfirmAmount').val().replace(currencySymbol, '').replace(/[^\d\.\-]/g, ""));
            payment["msnfp_amount"] = payingAmount;
            payment["msnfp_amount_balance"] = payingAmount;

            if (!isNullOrUndefined(configRecord._msnfp_paymentprocessorid_value))
                payment["msnfp_PaymentProcessorId@odata.bind"] = "/msnfp_paymentprocessors(" + configRecord._msnfp_paymentprocessorid_value + ")";

            if (customerEntityType == "account") {
                payment["msnfp_customerid_account@odata.bind"] = "/accounts(" + customerID + ")";
            }
            else if (customerEntityType == "contact") {
                payment["msnfp_customerid_contact@odata.bind"] = "/contacts(" + customerID + ")";
            }

            if (CCorBArecordId != defaultGUID && $('.tabview').find('#TabCC').hasClass('tab-active')) {
                payment["msnfp_PaymentMethodId@odata.bind"] = "/msnfp_paymentmethods(" + CCorBArecordId + ")";
                payment["msnfp_paymenttype"] = 844060002;//Credit Card
            }
            else if ($('.tabview').find('#TabCheque').hasClass('tab-active')) {
                payment["msnfp_chequenumber"] = $("#txtChequeNumber").val();
                payment["msnfp_paymenttype"] = 844060001;//Cheque
            }
            else if ($('.tabview').find('#TabWireTransfer').hasClass('tab-active')) {
                payment["msnfp_chequenumber"] = $("#txtChequeNumber").val();
                payment["msnfp_paymenttype"] = 844060009;//Wire Transfer
            }
            else if ($('.tabview').find('#TabCash').hasClass('tab-active')) {
                payment["msnfp_paymenttype"] = 844060000;//Cash
            }

            payment["msnfp_bookdate"] = DSTOffsetYYYYMMDD(new Date());
            payment["statuscode"] = parseInt(844060000); //completed
            payment["msnfp_eventpackageid@odata.bind"] = "/msnfp_eventpackages(" + packageID + ")";

            // Save the configuration to the payment from the user:
            if (!isNullOrUndefined(userConfigID)) {
                payment["msnfp_ConfigurationId@odata.bind"] = "/msnfp_configurations(" + userConfigID + ")";
            }

            if (!isNullOrUndefined(packageRec._transactioncurrencyid_value)) {
                payment["transactioncurrencyid@odata.bind"] = "/transactioncurrencies(" + packageRec._transactioncurrencyid_value + ")";
            }

            var qry = XrmServiceUtility.GetWebAPIUrl() + "msnfp_payments";
            var recID = XrmServiceUtility.CreateRecord(qry, payment);

            if (recID != "" && recID != undefined) {
                paymentID = recID;

                $(".divloader").hide();

                setTimeout(GetPayment(recID), 2000);
            }
        }


        function GetPayment(recID) {
            return function () {
                var str = "";
                str += "msnfp_payments?";
                str += "$select=msnfp_paymentid,msnfp_transactionresult,statuscode&";
                str += "$filter=msnfp_paymentid eq " + recID + "";

                var queryResults = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + str);

                if (queryResults.length > 0) {
                    $("#tblPaymentProcess").hide();
                    $("#tblTransactionResult").show();

                    $("#txtCust").val(customerName);
                    $("#hdCustId").val(customerID);
                    $("#txtEmail").val(customerEmail);

                    if (queryResults[0].statuscode == "844060000") {
                        //$("#lblResult")[0].innerText = "Payment Successful.";                         
                        $("#btnPrint").show();
                        $("#btnClose").show();
                        $("#btnTryAgain").hide();
                        $('#lblResult').css('color', 'green');
                        $('#lblResult').append('<p>Payment Successful.</p>');
                        window.parent.opener.location.reload(true);
                    }
                    else if (queryResults[0].statuscode == "844060003") {
                        //$("#lblResult")[0].innerText = "Payment Failed.";                        
                        $("#btnPrint").hide();
                        $("#btnClose").show();
                        $("#btnTryAgain").show();
                        $('#lblResult').css('color', '#e60000');
                        $('#lblResult').append('<p>Payment Failed.</p>');
                    }
                }
            }
            crmParent.Xrm.Page.data.refresh();
        };


        $("#btnPrint").click(function () {
            var rdlName = "Receipt.rdl";
            if (configResult != null && configResult.length > 0) {
                var reportGuid = configResult[0].msnfp_eventreceipt;
                var url = crmParent.Xrm.Page.context.getClientUrl()
                    + "/crmreports/viewer/viewer.aspx?action=filter&helpID="
                    + rdlName + "&id={" + reportGuid + "}&p:Transaction=" + transactionID;

                window.open(url, null, 600, 400, true, false, null);
            }
        });

        $("#btnClose").click(function () {
            //window.close();
            parent.window.close();
        });


        $("#btnMainClose").click(function () {
            parent.window.close();
        });

        $("#btnTryAgain").click(function () {
            $("#tblTransactionResult").hide();
            $("#tblPaymentProcess").show();
        });

        Date.prototype.mmddyyyy = function () {
            var mm = this.getMonth() + 1; // getMonth() is zero-based
            var dd = this.getDate();

            return [(mm > 9 ? '' : '0') + mm,
            (dd > 9 ? '' : '0') + dd,
            this.getFullYear()
            ].join('');
        };

        function formatExpiry(val) {
            if (val.length == 4)
                return val;

            if (val.indexOf("/") > 0) {
                var s = val.split("/");
                var yr = "";
                if (s[1].length == 4)
                    yr = s[1].substring(0, 2);
                if (s[1].length == 2)
                    yr = s[1];
            }
            return s[0] + yr;
        }

        function isNullOrUndefined(value) {
            return (typeof (value) === "undefined" || value === null || value === "");
        }

        function manageTab(current) {

            $("#lblError")[0].innerText = '';
            //if (packageRec.msnfp_paymenttype == PaymentType.Invoice) {
            $('.tabview').children('a').each(function () {
                if (this === current) {
                    $(this).toggleClass('tab-active');
                    //$('#txtChequeNumber').closest('tr').removeClass('mandatory');
                    $('tr.trCheckWireAttribute > td > span').removeClass('mandatory');
                    $('#txtChequeNumber').attr('aria-required', false);
                    
                    if (current.id == "TabCash") {
                        selectedPaymentType = PaymentType.Cash;
                        $('#Cash').show();
                    }
                    else if (current.id == "TabCheque") {
                        selectedPaymentType = PaymentType.Cheque;
                        $('#Cheque').show();
                        //$('#txtChequeNumber').closest('tr').addClass('mandatory');
                        $('tr.trCheckWireAttribute > td > span').addClass('mandatory');
                        $('#txtChequeNumber').attr('aria-required', true);
                        $('#txtChequeNumber').attr('aria-label', 'Check Number');
                        $('.spnWireNumber').hide();
                        $('.spnChequeNumber').show();                        
                    }
                    else if (current.id == "TabWireTransfer") {
                        selectedPaymentType = PaymentType.WireTransfer;
                        $('#Cheque').show();
                        //$('#txtChequeNumber').closest('tr').addClass('mandatory');
                        $('tr.trCheckWireAttribute > td > span').addClass('mandatory');
                        $('#txtChequeNumber').attr('aria-required', true);
                        $('#txtChequeNumber').attr('aria-label', 'Wire Number');
                        $('.spnChequeNumber').hide();
                        $('.spnWireNumber').show();
                    }
                    else if (current.id == "TabCC") {
                        selectedPaymentType = PaymentType.CreditDebit;
                        $('#CC').show();
                    }
                    else
                        selectedPaymentType = 0;
                }
                else {
                    $(this).removeClass('tab-active');
                    $('#' + this.title).hide();
                }
            });
            //}
        }

        function getCurrencySymbol(currencyID) {
            if (!isNullOrUndefined(currencyID)) {
                var currencySelect = "transactioncurrencies?$select=transactioncurrencyid,currencysymbol,isocurrencycode"
                currencySelect += "&$filter=transactioncurrencyid eq " + currencyID;
                var currencyRec = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + currencySelect);
                if (!isNullOrUndefined(currencyRec))
                    currencyRec = currencyRec[0];

                if (!isNullOrUndefined(currencyRec)) {
                    currencySymbol = currencyRec.currencysymbol;
                    isoCurrencyCode = currencyRec.isocurrencycode;
                }
            }
        }

        function addCommasonLoad(nStr) {
            if (nStr != 0) {
                nStr = nStr.replace(currencySymbol, '').replace(',', '');
                nStr += '';
                x = nStr.split('.');
                x1 = x[0];
                x2 = x.length > 1 ? '.' + x[1] : '';
                var rgx = /(\d+)(\d{3})/;
                while (rgx.test(x1)) {
                    x1 = x1.replace(rgx, '$1' + ',' + '$2');
                }
                return x1 + x2;
            }
            else return '0.00';
        }

        function DSTOffsetYYYYMMDD(str) {
            if (str != null && str != undefined && userSettings != null && userSettings != undefined) {
                let dt = new Date(str);
                let start = new Date(dt.getYear(), userSettings.timezonedaylightmonth - 1, userSettings.timezonedaylightday);
                let end = new Date(dt.getYear(), userSettings.timezonestandardmonth - 1, userSettings.timezonestandardday);
                if (dt >= start && dt < end) dt.setMinutes(-userSettings.timezonedaylightbias);
                return dt.getFullYear() + "-" + (dt.getMonth() + 1) + "-" + dt.getDate();
            }
        }

    </script>


</body></html>