<html>
<!--/*************************************************************************
* © Microsoft. All rights reserved.
*/-->
<head>
    <title></title>
    <meta charset="utf-8">
    <link href="../scripts/jquery_ui.css" rel="stylesheet">
    <link href="../scripts/jquery.dataTables.min.css" rel="stylesheet">
    <link href="../scripts/bootstrap.min.css" rel="stylesheet">
    <link href="../scripts/common.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Hind:500" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">

    <script src="../scripts/jQuery.js" type="text/javascript"></script>
    <script src="../scripts/jquery_ui.js" type="text/javascript"></script>
    <script src="../scripts/loadmask.js" type="text/javascript"></script>
    <script src="../scripts/jquery.dataTables.min.js" type="text/javascript"></script>
    <script src="../scripts/dataTables.cellEdit.js" type="text/javascript"></script>
    <script src="../scripts/jquery.autocomplete.js"></script>
    <script src="../scripts/common.js" type="text/javascript"></script>

    <style type="text/css">
        html, body {
            margin: 0px;
            padding: 0px;
            font-family: SegoeUI, "Segoe UI", "Helvetica Neue",Arial,"Noto Sans",sans-serif;
        }


        /*Note that several items below override bootstrap for this page.*/
        .container {
            padding-right: 0;
            padding-left: 10;
            margin-right: 0;
            margin-left: 0;
            background-color: #ededed;
            width: 100%;
            max-width: 20000px; /*In some environments the container width does not adhere to bootstrap in the same way, so this prevents issues where the page would be too narrow*/
        }

        .form-row {
            margin-right: 0;
        }

            .form-row > .col {
                padding-top: 10px;
            }

        b {
            font-size: 1.1em;
        }

        .notExists {
            width: 100%;
        }

        .badge-success {
            color: #fff;
            background-color: #243a5e;
        }

        #btnDepositDateAll {
            min-width: 120px;
        }

        label {
            display: inline-block;
            margin-bottom: .5rem;
            width: 130px;
            /*white-space: nowrap;*/
            text-align: right;
            margin-right: 0.5em;
            font-size: 1.2em;
            margin-top: 0.5em;
            z-index: 1; /*This fixes an issue where labels may overlap a text box.*/
        }

        .form-group {
            margin-bottom: 0.8rem; /*1rem*/
        }

        .form-control {
            display: block;
            width: 50%;
            z-index: 2; /*This fixes an issue where labels may overlap a text box.*/
            min-width: 50%;
            height: calc((1.5em + 0.75rem) + 2px);
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            color: rgb(73, 80, 87);
            background-color: rgb(255, 255, 255);
            background-clip: padding-box;
            padding: 0.375rem 0.75rem;
            border-width: 1px;
            border-style: solid;
            border-color: rgb(206, 212, 218);
            border-image: initial;
            border-radius: 0.25rem;
            transition: border-color 0.15s ease-in-out 0s, box-shadow 0.15s ease-in-out 0s;
        }

        .row {
            margin-right: 0;
            margin-left: 0;
        }

        .col {
            padding-right: 0;
            padding-left: 0;
        }

        .mb20 {
            padding-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }

        .pt20 {
            padding-top: 13px;
        }

        .switch-field {
            overflow: hidden;
        }

            .switch-field input {
                position: absolute !important;
                clip: rect(0, 0, 0, 0);
                height: 1px;
                width: 1px;
                border: 0;
                overflow: hidden;
            }

        input:disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        select:disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .switch-field label {
            float: left;
            display: block;
            text-align: center;
            text-shadow: none;
            border: 1px solid #b4b4b4;
            -webkit-transition: all 0.1s ease-in-out;
            -moz-transition: all 0.1s ease-in-out;
            -ms-transition: all 0.1s ease-in-out;
            -o-transition: all 0.1s ease-in-out;
            transition: all 0.1s ease-in-out;
            -webkit-box-shadow: none;
            box-shadow: none;
            font-weight: bolder;
            color: #243a5e;
            font-family: 'Hind', sans-serif;
            font-size: 14px;
            background-color: #cccccc;
            padding: 5px 6px 3px 6px;
            text-transform: uppercase;
            cursor: pointer !important;
            white-space: nowrap;
            width: auto;
            margin-right: 0em;
        }

            .switch-field label:hover {
                cursor: pointer;
                color: white;
                border: 1px solid #243a5e;
                background-color: #243a5e;
            }

        .switch-field input:disabled + label {
            opacity: 0.3;
            cursor: default !important;
            pointer-events: none;
        }

        .switch-field input:checked + label {
            color: white;
            border: 1px solid #243a5e;
            background-color: #243a5e;
            opacity: 1;
            cursor: pointer !important;
        }

        .switch-field label:first-of-type {
            border-radius: 0px;
        }

        .switch-field label:last-of-type {
            border-radius: 0px;
        }

        .table-details {
            background-color: #ededed;
            padding-top: 5%;
        }

        .table td {
            border: 1px solid #ced4da;
        }

        .content-details {
            margin-right: 0.5%;
        }

            .content-details input, .content-details select {
                font-size: 14px;
                line-height: 1.5;
                color: #495057;
                background-color: #fff;
                background-clip: padding-box;
                border: 1px solid #ced4da;
                border-radius: .25rem;
                transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out;
                margin-top: 1px;
            }

        .form-container {
            margin-bottom: 20px;
            background-color: white;
            border-top: 0.6em solid #243a5e;
            padding: 20px;
            margin-right: 8px;
            align-self: center;
        }

        .main-button {
            text-align: center !important;
            text-shadow: none !important;
            border: 1px solid #b4b4b4 !important;
            background-color: #cccccc !important;
            -webkit-transition: all 0.1s ease-in-out !important;
            -moz-transition: all 0.1s ease-in-out !important;
            -ms-transition: all 0.1s ease-in-out !important;
            -o-transition: all 0.1s ease-in-out !important;
            transition: all 0.1s ease-in-out !important;
            padding: 5px 6px 3px 6px !important;
            font-family: 'Hind', sans-serif !important;
            font-weight: bolder !important;
            text-transform: uppercase !important;
            font-size: 14px !important;
            color: #243a5e !important;
            cursor: pointer !important;
            border-radius: 0px !important;
            background-clip: initial !important;
            margin: 0;
            margin-top: 0px;
            line-height: unset !important;
            margin-right: 5px !important;
            white-space: nowrap !important;
            min-width: 100px;
        }

            .main-button:hover {
                cursor: pointer !important;
                color: white !important;
                border: 1px solid #243a5e !important;
                background-color: #243a5e !important;
            }

            .main-button:disabled {
                opacity: 0.3 !important;
                pointer-events: none !important;
            }

        .main-button-lnk {
            text-align: center !important;
            text-shadow: none !important;
            border: 1px solid #b4b4b4 !important;
            background-color: #cccccc !important;
            -webkit-transition: all 0.1s ease-in-out !important;
            -moz-transition: all 0.1s ease-in-out !important;
            -ms-transition: all 0.1s ease-in-out !important;
            -o-transition: all 0.1s ease-in-out !important;
            transition: all 0.1s ease-in-out !important;
            padding: 5px 6px 3px 6px !important;
            font-family: 'Hind', sans-serif !important;
            font-weight: bolder !important;
            text-transform: uppercase !important;
            font-size: 14px !important;
            color: #243a5e !important;
            cursor: pointer !important;
            border-radius: 0px !important;
            margin-top: 0px !important;
            background-clip: initial !important;
            margin: 0 !important;
            line-height: unset !important;
            margin-right: 5px !important;
            display: inline-block;
        }

            .main-button-lnk:hover {
                cursor: pointer !important;
                color: white !important;
                border: 1px solid #243a5e !important;
                background-color: #243a5e !important;
            }

            .main-button-lnk:disabled {
                opacity: 0.3 !important;
                pointer-events: none !important;
            }

            .main-button-lnk:before {
                font-family: "Font Awesome 5 Free";
                content: "\f0c1";
                opacity: 0.8 !important;
                margin-right: 5px;
            }

        .content-header h2 {
            color: #000000;
            margin-top: 3px;
            margin-bottom: 3px;
            margin-right: 0px;
            padding-top: 10px;
            font-size: 17px;
            padding-bottom: 1%;
            background: #ededed;
        }

        .mandatory span:after {
            content: '*';
            color: red;
            font-weight: bold;
            font-size: 15px;
            padding-left: 3px;
        }

        .mandatory label:after {
            content: '*';
            color: red;
            font-weight: bold;
            font-size: 15px;
            padding-left: 3px;
        }

        .red-border {
            border: solid 1px #CD2828 !important;
        }

        .subsequent-main {
            max-width: 613px;
        }

        .spacebetween {
            margin-right: 50px;
        }

        .errorMSG {
            color: red;
            padding: 5px 15px;
            font-weight: bold;
            width: 100%;
            text-align: left;
        }

        @media only screen and (max-width: 1030px) {
            .msg-div {
                width: 100%;
            }
        }

        @media only screen and (min-width: 1030px) {
            .msg-div {
                width: 50%;
            }
        }

        .field-label {
            padding-right: 0px;
        }

        div.divSection {
            height: 105px;
            width: 100%;
            max-width: 450px;
            background-color: #f2f2f2;
            font-family: SegoeUI, "Segoe UI", "Helvetica Neue",Arial,"Noto Sans",sans-serif; /*'Hind';*/
            background-position: right -15px; /*Positioning*/
            background-repeat: no-repeat;
            border-bottom-width: 5px;
            border-bottom-style: solid;
            margin-bottom: 3%;
        }

        .boldCaps {
            font-weight: 700;
            font-size: 14px !important;
            text-transform: uppercase;
            padding-left: 7px;
            padding-top: 4%;
            color: black;
        }

        div.emptyDiv {
            line-height: 15px;
        }

        .spanHighlighted {
            color: #243a5e;
            padding-left: 3px;
            padding-right: 3px;
        }

        .header2 {
            font-size: 16px;
            padding-left: 6%;
            line-height: 1.4;
        }

        .header3 {
            font-size: 16px;
            line-height: 1.3;
            padding-left: 5%;
        }

        a:link {
            color: black;
        }

        a:visited {
            color: black;
        }

        table, th {
            border-collapse: collapse;
            font-family: 'Hind', sans-serif;
            font-size: 12px;
        }

        th, td {
            text-align: left;
        }

        table, td {
            color: #444444;
            font-family: 'Hind', sans-serif;
            font-size: 14px;
            font-weight: 500;
        }


        .tab {
            background-color: #e6e6e4;
            text-decoration: none;
            color: black;
            text-align: center;
            display: inline-block;
            min-width: 50px;
        }

        .tab-active {
            color: white !important;
            border: 1px solid #243a5e !important;
            background-color: #243a5e !important;
        }

        .tabview a.tab {
            margin-right: -3px;
            text-align: center;
            text-shadow: none;
            border: 1px solid #b4b4b4;
            -webkit-transition: all 0.1s ease-in-out;
            -moz-transition: all 0.1s ease-in-out;
            -ms-transition: all 0.1s ease-in-out;
            -o-transition: all 0.1s ease-in-out;
            transition: all 0.1s ease-in-out;
            -webkit-box-shadow: none;
            box-shadow: none;
            font-weight: bolder;
            color: #243a5e;
            font-family: 'Hind', sans-serif;
            font-size: 14px;
            background-color: #cccccc;
            padding: 5px 8px 3px 8px;
            text-transform: uppercase;
            cursor: pointer !important;
            white-space: nowrap;
        }

            .tabview a.tab:hover {
                cursor: pointer;
                color: white;
                border: 1px solid #243a5e;
                background-color: #243a5e;
            }

        .content {
            width: 450px;
            margin: auto;
            background-color: white;
            padding: 15px;
        }

        .fieldWrap {
            width: 100%;
            clear: both;
        }

        .seperator {
            margin-bottom: 15px;
            display: none;
        }

        .outputArea {
            display: none;
            padding-left: 5px;
        }

        /* The Modal (background) */

        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 3; /* Sit on top of other labels and buttons */
            padding-top: 100px; /* Location of the box */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgb(0,0,0); /* Fallback color */
            background-color: rgba(0,0,0,0.1); /* Black w/ opacity */
        }

        /* Modal Content */
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 60%;
        }

        /* The Close Button */
        .closeBtn {
            color: #aaaaaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

            .closeBtn:hover,
            .closeBtn:focus {
                color: #000;
                text-decoration: none;
                cursor: pointer;
            }

        .modal-header {
            display: -ms-flexbox;
            display: flex;
            -ms-flex-align: start;
            align-items: flex-start;
            -ms-flex-pack: justify;
            justify-content: space-between;
            border-bottom: 1px solid #e4e7ea;
            border-top-left-radius: .3rem;
            border-top-right-radius: .3rem;
        }

        /*End of Modal styling*/

    </style>
</head>
<body style="word-wrap: break-word; margin: 1px;">
    <div class="container manual-main">
        <div style="border-style:none;background:#ededed;padding:6px;padding-top:10px;padding-bottom:3px;margin-bottom: 3px;">
            <div class="content-header" style="display: inline-block;width: 125px;vertical-align: top;">
                <h2 class="noselect">GIFT DETAILS</h2>
            </div>
            <div class="content-details switch-field" style="display: inline-block;">
                <input name="donationPledgeType" id="radioPledge" type="radio" checked="" value="3" aria-label="Pledge">
                <label for="radioPledge">Pledge</label>
            </div>
        </div>
        <div style="border-style:none;background:#ededed;padding:6px;padding-top: 10px;padding-bottom: 2px;margin-bottom: 3px;">
            <div class="content-header" style="display: inline-block;width: 125px;vertical-align: top;">
                <h2 class="noselect">PROCESS GIFTS</h2>
            </div>
            <div class="content-details switch-field" style="display: inline-block;margin-bottom:3px;">

                <input name="anonymousDonation" id="radioanonymousDonation" type="radio" checked="" value="844060000" aria-label="Visible">
                <label class="lblAnonymousDonation" style="margin-left: 15px;" for="radioanonymousDonation">Visible</label>
                <input name="anonymousDonation" id="radioAnonymous" type="radio" value="844060001" aria-label="Anonymous">
                <label class="lblAnonymous" for="radioAnonymous">Anonymous</label>

                <input name="giftSource" id="radioPhone" type="radio" checked="" value="844060000" aria-label="Phone">
                <label class="lblPhone" style="margin-left: 15px;" for="radioPhone">Phone</label>
                <input name="giftSource" id="radioMail" type="radio" value="844060002" aria-label="Mail">
                <label class="lblMail" for="radioMail">Mail</label>
                <input name="giftSource" id="radioInPerson" type="radio" value="844060001" aria-label="In Person">
                <label class="lblInPerson" for="radioInPerson">In Person</label>
                <input name="giftSource" id="radioOnline" type="radio" value="844060003" aria-label="Online">
                <label class="lblOnline" for="radioOnline">Online</label>
                <input name="giftSource" id="radioSocial" type="radio" value="844060004" aria-label="Social">
                <label class="lblSource" for="radioSocial" >Social</label>

            </div>
        </div>

        <div class="row form-container">
            <div class="col-sm-3">
                <div class="donationFields">
                    <div class="hide form-group">
                        <label for="txtDisableAmount">Amount (Gift)</label>
                        <input type="text" class="form-control" id="txtDisableAmount">
                    </div>
                    <div class="hide form-group">
                        <label for="txtDisableBalance">Amount (Balance)</label>
                        <input type="text" class="form-control" id="txtDisableBalance">
                    </div>
                    <div class="hide form-group">
                        <label for="txtDisableAmountNonreceiptable">Amount (Nonreceiptable)</label>
                        <input type="text" class="form-control" id="txtDisableAmountNonreceiptable">
                    </div>
                    <div class="hide form-group">
                        <label for="txtDisableAmountMembership">Amount (Member)</label>
                        <input type="text" class="form-control" id="txtDisableAmountMembership">
                    </div>
                    <div class="hide form-group">
                        <label for="txtDisableTotal">Total</label>
                        <input type="text" class="form-control" id="txtDisableTotal">
                    </div>
                    <div class="hide form-group" style="display:none !important;">
                        <label for="txtDisableDonorName">Receiptable Name</label>
                        <input type="text" class="form-control" id="txtDisableDonorName" aria-label="Receiptable Name">
                    </div>
                    <div class="mandatory form-group" style="display: flex;">
                        <label for="txtFirstName">First Name</label>
                        <input type="text" class="form-control" id="txtFirstName" aria-label="First Name" aria-required="true">
                    </div>
                    <div class="mandatory form-group" style="display: flex;">
                        <label for="txtLastName">Last Name</label>
                        <input type="text" class="form-control" id="txtLastName" aria-label="Last Name" aria-required="true">
                    </div>
                    <div class="divEmail form-group">
                        <label for="txtEmail">Email</label>
                        <input type="text" class="form-control" id="txtEmail" aria-label="Email">
                    </div>
                    <div class="divPhone form-group">
                        <label for="txtPhone">Phone</label>
                        <input type="text" class="form-control" id="txtPhone" aria-label="Phone">
                    </div>
                    <div class="divAltPhone form-group">
                        <label for="txtAltPhone">Alt. Phone</label>
                        <input type="text" class="form-control" id="txtAltPhone" aria-label="Alt. Phone">
                    </div>
                    <div class="divMobilePhone form-group">
                        <label for="txtMobilePhone">Mobile</label>
                        <input type="text" class="form-control" id="txtMobilePhone" aria-label="Mobile">
                    </div>
                    <div class="divInHonour form-group">
                        <label for="txtInHonorMemoryOf">In Honor/Memory of</label>
                        <input type="text" class="form-control" id="txtInHonorMemoryOf" aria-label="In Honor/Memory of">
                    </div>
                    <div id="divTransactionIdentifier" hidden="">
                        <label for="txtTransactionIdentifier">Gateway ID</label>
                        <input type="tel" id="txtTransactionIdentifier">
                    </div>
                    <div id="divSourceIdentifier" hidden="">
                        <label for="txtSourceIdentifier">Source Identifier</label>
                        <input type="text" id="txtSourceIdentifier">
                    </div>
                    <div id="divCreditCard" hidden="">
                        <label for="txtCreditCard">Credit<span style="font-size:1px;"> </span>/<span style="font-size:1px;"> </span>Debit Card</label>
                        <input type="text" id="txtCreditCard">
                    </div>
                    <div id="divBankAccount" hidden="">
                        <label for="txtBankAccount">Bank Account</label>
                        <input type="tel" id="txtBankAccount">
                    </div>
                </div>
            </div>

            <div class="col-sm-3">
                <div class="donationFields">
                    <div class="divAddressFields form-group">
                        <label for="txtAddressLine1">Street 1</label>
                        <input type="text" class="form-control" id="txtAddressLine1" aria-label="Street 1">
                    </div>
                    <div class="divAddressFields form-group">
                        <label for="txtAddressLine2">Street 2</label>
                        <input type="text" class="form-control" id="txtAddressLine2" aria-label="Street 2">
                    </div>
                    <div class="divAddressFields form-group">
                        <label for="txtAddressLine3">Street 3</label>
                        <input type="text" class="form-control" id="txtAddressLine3" aria-label="Street 3">
                    </div>
                    <div class="divAddressFields form-group">
                        <label for="txtAddressCity">City</label>
                        <input type="text" class="form-control" id="txtAddressCity" aria-label="City">
                    </div>
                    <div class="divAddressFields form-group">
                        <label for="txtAddressProvince">State</label>
                        <input type="text" class="form-control" id="txtAddressProvince" aria-label="State">
                    </div>
                    <div class="divAddressFields form-group">
                        <label for="txtAddressPostalCode">Zip Code</label>
                        <input type="text" class="form-control" id="txtAddressPostalCode" aria-label="Zip Code">
                    </div>
                    <div class="divAddressFields form-group">
                        <label for="txtAddressCountry">Country</label>
                        <input type="text" class="form-control" id="txtAddressCountry" aria-label="Country">
                    </div>
                    <div class="content">
                        <div class="fieldWrap">
                            <div class="error" id="errorMessage"></div>
                        </div>
                        <div class="fieldWrap">
                            <div id="result"></div>
                        </div>
                        <div class="seperator" id="seperator"></div>
                        <div class="fieldWrap">
                            <div class="outputArea" id="output"></div>
                        </div>
                    </div>
                </div>
            </div>


            <div class="col-sm-6">
                <div class="form-row">
                    <div id="donationInfo">
                        <div class="form-group" style="display:none !important;">
                            <label for="txtDonorName">Receiptable Name</label>
                            <input type="text" class="form-control" id="txtDonorName">
                        </div>
                        <div class="donationCheque hide">
                            <div class="form-group" style="display:flex;">
                                <label for="txtChequeDate" class="spnChequeDate field-label hide">Cheque Date</label>
                                <label for="txtChequeDate" class="spnWireDate field-label hide">Wire Date</label>
                                <input type="text" class="form-control" id="txtChequeDate">
                            </div>
                            <div class="form-group" style="display:flex;">
                                <label class="spnChequeNumber field-label hide">Cheque Number</label>
                                <label class="spnWireNumber field-label hide">Wire Number</label>
                                <input class="form-control" type="text" id="txtChequeNumber" onkeypress="return checkIt(event);">
                            </div>
                        </div>
                        <div class="form-group donationInKind hide">
                            <div class="form-group" style="display:flex;">
                                <label for="txtDescription">Description</label>
                                <input class="form-control" type="text" id="txtDescription">
                            </div>
                            <div class="form-group" style="display:flex;">
                                <label for="txtApraiser">Appraiser</label>
                                <input class="form-control" type="text" id="txtApraiser">
                            </div>
                        </div>
                        <div class="form-group divAmount clearfix">
                            <div class="mandatory" style="display:flex;">
                                <label for="txtAmount">Gift Amount</label>
                                <input class="form-control" type="text" id="txtAmount" onkeypress="return validateFloatKeyPress(this, event)" aria-label="Gift Amount" aria-required="true">
                            </div>
                        </div>
                        <div class="form-group divProcess clearfix" style="display: flex;flex-flow: column wrap;align-items: center;">
                            <input class="form-control float-left main-button" id="btnProcess" type="button" role="button" value="Process >">
                        </div>

                        <div class="form-group msg-div" style="width:100%;">
                            <!--Bootstrap error message--->
                            <div id="divErrorMessageContainer" style="display:none; margin-left:10px;" class="alert alert-danger">
                                <strong>Error:</strong> <label id="lblErrorMessageText" class="errorMSG" role="alert"></label>
                            </div>

                            <!--Legacy Ways to display errors, to be transitioned to the above-->
                            <div class="error-msg"></div>
                            <div class="noMatch">
                                <label id="lblError"></label>
                            </div>
                            <div class="form-group payment-failed-msg hide">
                                <label class="field-label errorMsg">Payment Failed</label>
                                <label id="payment-failed-block"></label>
                                <div class="clearfix">
                                    <input class="form-control float-right main-button" id="btnTryAgain" type="button" value="Try Again >">
                                </div>
                            </div>

                        </div>
                    </div>

                    <div class="form-group subsequent-main hide" style="width: 100%;">
                        <div class="default-subsequent" style="width: 100%;">
                            <div class="form-group subsequent-buttons divUpdateDepositDateMain">
                                <div>
                                    <b>
                                        Deposit Date : <input type="button" id="btnDepositDateAll" class="main-button" value="">
                                    </b>
                                </div>
                                <div id="divUpdateDepositDateAll" class="form-group" style="display:none;">
                                    <input class="" type="text" id="txtNewDepositDateAll" readonly="" style="background: white;">
                                    <input class="main-button" type="button" id="btnUpdateDepositDateAll" value="Update"><br>
                                    <label id="lblDepositDateAllError" style="display:none;color:red">Please select the Date</label>
                                </div>
                            </div>
                            <div class="form-group subsequent-buttons divUpdateChequeDepositDate">
                                <div class="row" style="width:100%;">
                                    <div class="col-md-4" style="display:flex;">
                                        <label>Cheque Date</label><input class="form-control main-button" style="margin-top:0.5em; width: 250px;" type="button" id="btnChequeDate" value="">
                                    </div>
                                    <div class="col-md-4" style="display:flex;">
                                        <label>Deposit Date</label><input class="form-control main-button" style="margin-top:0.5em; width: 250px;" type="button" id="btnDepositDate" value="">
                                    </div>
                                    <div class="col-md-4" style="display:flex;">
                                        <label>Cheque Number</label><input class="form-control main-button" style="margin-top:0.5em; width: 250px;" type="button" id="btnChequeNumber" value="">
                                    </div>
                                </div>
                            </div>
                            <div class="form-group subsequent-buttons mb20">
                                <div id="divUpdateChequeDate" class="form-group" style="display: none;width:440px;">
                                    <input class="form-control" type="text" id="txtNewChequeDate" placeholder="Select a Cheque Date" readonly="" style="background: white;margin-right: 10px;">
                                    <input class="form-control main-button" type="button" id="btnUpdateChequeDate" value="Update">
                                </div>
                                <div id="divUpdateDepositDate" class="form-group" style="display: none;width:440px;">
                                    <input class="form-control" type="text" id="txtNewDepositDate" placeholder="Select a Deposit Date" readonly="" style="background: white;margin-right: 10px;">
                                    <input class="form-control main-button" type="button" id="btnUpdateDepositDate" value="Update">
                                </div>
                                <div id="divUpdateChequeNumber" class="form-group" style="display: none;width:440px;">
                                    <input class="form-control" type="text" id="txtNewChequeNumber" placeholder="Enter a Cheque Number" style="margin-left: 0px;margin-right: 10px;" onkeypress="return checkIt(event);">
                                    <input class="form-control main-button" type="button" id="btnUpdateChequeNumber" value="Update">
                                </div>
                            </div>
                            <div class="form-group subsequent-buttons divUpdateWireDepositDate mb20">
                                <div class="form-group">
                                    <b>
                                        Wire Date : <input class="form-control main-button" type="button" id="btnWireDate" value="">
                                        Deposit Date : <input class="form-control main-button" type="button" id="btnWireDepositDate" value="">
                                        Wire Number : <input class="form-control main-button" type="button" id="btnWireNumber" value="">
                                    </b>
                                </div>
                                <div class="form-group" id="divUpdateWireDate" hidden="">
                                    <input class="form-control" type="text" id="txtNewWireDate" readonly="" style="background: white;">
                                    <input class="form-control main-button" type="button" id="btnUpdateWireDate" value="Update">
                                </div>
                                <div class="form-group" id="divUpdateWireDepositDate" hidden="">
                                    <input class="form-control" type="text" id="txtNewWireDepositDate" readonly="" style="background: white;">
                                    <input class="form-control main-button" type="button" id="btnUpdateWireDepositDate" value="Update">
                                </div>
                                <div class="form-group" id="divUpdateWireNumber" hidden="">
                                    <input class="form-control" type="text" id="txtNewWireNumber" onkeypress="return checkIt(event);">
                                    <input class="form-control main-button" type="button" id="btnUpdateWireNumber" value="Update">
                                </div>
                            </div>

                            <div class="form-group subsequent-buttons mb20 hide" id="btn-Payment-Schedule-Container">
                                <b>Payment Schedule</b>
                                <div class="payment-schedule-link right">
                                    <input class="form-control main-button" id="btn-Payment-Schedule" type="button" />
                                </div>
                            </div>

                            <div class="form-group subsequent-buttons refund-donation hide mb20">
                                <div>
                                    <b>This Donation has been successfully processed:</b>
                                </div>
                                <div class="form-group clearfix">
                                    <input class="form-control float-right main-button" id="btnRefundDonation" type="button" value="Refund this Donation >">
                                </div>
                            </div>
                            <div class="form-group subsequent-buttons refund-donation-sucess hide mb20">
                                <div class="form-group">
                                    <b>This Donation has been refunded:</b>
                                </div>
                                <table>
                                    <tbody>
                                        <tr>
                                            <td>
                                                <div class="form-group" style="display:flex;">
                                                    <label style="width:50px;">On</label>
                                                    <input class="form-control" type="text" id="txtRefundSucessOn" value="" disabled="disabled">
                                                </div>
                                            </td>
                                            <td>
                                                <div class="form-group" style="display:flex;">
                                                    <label>Refund Amount</label>
                                                    <input class="form-control" type="text" id="txtRefundSuccessAmount" value="" disabled="disabled">
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="form-group subsequent-buttons pledgeOverpaid hide mb20">
                                <div style="padding-bottom: 10px;">
                                    <div style="display: inline-block;">
                                        <b style="line-height: 25px;margin-right: 6px;">This Pledge has been overpaid</b>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group subsequent-buttons convertPledgeToDonation hide mb20">
                                <div class="form-group">
                                    <b style="line-height: 34px;">This Pledge has not been fulfilled</b>
                                </div>
                                <div class="form-group clearfix">
                                    <input class="form-control float-right btnConvertPledgeToDonation main-button" type="button" value="Convert this Pledge to a Donation >">
                                </div>
                                <div class="error-msg">
                                </div>
                            </div>
                            <div class="form-group subsequent-buttons convertPledgeToDonationSuccess hide mb20">
                                <div>
                                    <div class="form-group">
                                        <b style="line-height: 25px;">This Pledge has been successfully converted to a donation</b>
                                    </div>
                                    <div class="divConvertedDonationList">
                                    </div>
                                </div>
                                <div class="form-group clearfix">
                                    <input class="form-control float-right btnConvertPledgeToDonationSuccess main-button" type="button" value="Create another Donation based on this pledge >" style="margin-right: 0px;margin-top: 5px;width:auto;">
                                </div>
                            </div>
                            <div class="form-group subsequent-buttons clearfix">
                                <label for="emailReceipt" style="display: none !important;"><b>Email Receipt To</b></label>
                                <input type="text" class="form-control float-right" id="emailReceipt" style="display: none !important;margin-right: 5px; width: 425px;">
                            </div>

                            <div class="row">
                                <div class="col-sm-4" style="padding-left: 0px;">
                                    <input class="form-control main-button" style="width:110px" type="button" id="btnPrintReceipt" value="Print Receipt">
                                </div>
                                <div class="col-sm-4" style="padding-left: 0px;">
                                    <input class="form-control main-button" style="width:135px" type="button" id="btnThankyou" value="Print Thank You">
                                </div>
                                <div class="col-sm-4" style="padding-left: 30px;">
                                    <input class="form-control main-button" style="width:110px" type="button" id="btnEmailReceipt" value="Email Receipt">
                                </div>
                            </div>

                        </div>

                        <div class="form-group cancelDonation hide">
                            <div class="form-group">
                                <label for="ddlCancelDonationReason">Reason</label>
                                <select class="form-control" id="ddlCancelDonationReason">
                                    <option value=""></option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="txtCancelDonationNote">Note</label>
                                <textarea id="txtCancelDonationNote"></textarea>
                            </div>
                            <div class="error-msg-cancel hide" style="color: red; font-weight: bold;"></div>
                            <div class="form-group">
                                <input type="button" id="btnCancelDonation" class="form-control main-button" value="Cancel This Donation">
                                <input type="button" id="btnCancelDonationBack" class="form-control main-button" value="Back">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        var DonationPledgeType =
        {
            Donation: 84406000,
            Pledge: 84406001,
            PledgeSchedule: 84406003,
            Grant: 84406004,
            MatchedGiftDonation: 84406006,
            MatchedGiftPledge: 84406007,
            DonationSchedule: 84406009,
            RecurringDonation: 84406010,
            SoftCreditDonation: 84406012,
            SoftCreditPledge: 84406013,
            Membership: 84406014
        }

        var DonationPledgeTypeForm = {
            Donation: 1,
            Grant: 2,
            Pledge: 3,
            SoftCredit: 4,
            RecurringDonation: 5,
            PledgeSchedule: 6,
            DonationSchedule: 7,
            Membership: 8
        }

        var DonationOccurrence = {
            PostDated: 84406000,
            Recurring: 84406001,
            Instant: 84406002
        }


        var RecurrenceStart = {
            CurrentDay: 844060000,
            FirstOftheMonth: 844060002,
            FifteenoOftheMonth: 844060001
        }

        var Anonymity = {
            No: 844060000,
            Yes: 844060001
        };

        var xrm;
        var formType;
        var currentID;
        var selectedDonor = null;
        var donorId = null;
        var donationPledge = [];
        var selectedConstitute = null;
        var constituteId = null;
        var campaignEventID = null;
        var defaultDesignationID = null;
        var customerId;
        var relatedPledgeId;
        var configRecord = null;
        var select = "";
        var expand = "";
        var filter = "";
        var isFromPledgeAllocation = false;
        var pledgeAllocationResult = null;
        var parentGiftID;
        var parentGiftTypeWhenTransferGiftAmount;
        var parentTypeWhenTransferGiftAmount;
        var parentGiftAmount;
        var currencySymbol;
        var isoCurrencyCode;
        var userConfigID = null;
        var pledgeScheduleID;

        $(document).ready(function () {
            // First, setup all the datepickers:
            $('#txtChequeDate').datepicker({
                dateFormat: 'mm/dd/yy',
            });

            $('#txtDepositDate').datepicker({
                dateFormat: 'mm/dd/yy',
            });

            $('#txtNewChequeDate').datepicker({
                dateFormat: 'mm/dd/yy',
            });

            $('#txtNewDepositDate').datepicker({
                dateFormat: 'mm/dd/yy',
            });

            $('#txtNewWireDate').datepicker({
                dateFormat: 'mm/dd/yy',
            });

            $('#txtNewWireDepositDate').datepicker({
                dateFormat: 'mm/dd/yy',
            });

            $('#txtNewDepositDateAll').datepicker({
                dateFormat: 'mm/dd/yy',
            });


            xrm = XrmUtility.get_Xrm();
            formType = xrm.Page.ui.getFormType();

            // Fill in the date field for new gifts to now:
            if (formType == FormType.Create)
                xrm.Page.getAttribute('msnfp_bookdate').setValue(new Date());

            // Current ID of the gift page we are on:
            currentID = xrm.Page.data.entity.getId().replace('{', '').replace('}', '');
            customerId = getLookupGuid('msnfp_customerid');

            var currentuserID = MissionFunctions.GetCurrentUserID();

            console.log("currentuserID: " + currentuserID);

            var userSelect = "systemusers?$select=systemuserid,_msnfp_configurationid_value"
            userSelect += "&$filter=systemuserid eq " + currentuserID;
            var user = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + userSelect);
            user = user[0];

            getCurrencySymbol();
            // If the configuration record is found for the user, show/hide several fields:
            if (!isNullOrUndefined(user._msnfp_configurationid_value)) {
                userConfigID = user._msnfp_configurationid_value;
                loadConfiguration(user._msnfp_configurationid_value);


                loadGiftDetailsLabels(configRecord);

                if (isNullOrUndefined(configRecord.msnfp_tran_anonymous) || configRecord.msnfp_tran_anonymous == false) {
                    $('#radioanonymousDonation').next('label').remove();
                    $('#radioanonymousDonation').remove();
                    $('#radioAnonymous').next('label').remove();
                    $('#radioAnonymous').remove();
                }

                if (!isNullOrUndefined(configRecord.msnfp_tran_nonreceiptable) && configRecord.msnfp_tran_nonreceiptable == true) {
                    $('.divAmountNonReceiptable').show();
                }

                if (!isNullOrUndefined(configRecord.msnfp_tran_showamounttax) && configRecord.msnfp_tran_showamounttax == true) {
                    $('.divAmountTax').show();
                }

                if (formType == FormType.Update) {
                    xrm.WebApi.retrieveRecord(xrm.Page.data.entity.getEntityName(), currentID, "?$select=_msnfp_parentscheduleid_value").then(
                        (x) => {
                            if (x._msnfp_parentscheduleid_value) {
                                $('#btn-Payment-Schedule').val(x["_msnfp_parentscheduleid_value@OData.Community.Display.V1.FormattedValue"]);
                                $('#btn-Payment-Schedule').click(() => xrm.Utility.openEntityForm(
                                    x["_msnfp_parentscheduleid_value@Microsoft.Dynamics.CRM.lookuplogicalname"],
                                    x["_msnfp_parentscheduleid_value"]));
                                $('#btn-Payment-Schedule-Container').show();
                            }
                        }
                    );
                }

                customerChange();
            }

            // Populate fields with existing data in the evenet of an existing record:
            if (formType === FormType.Update || formType === FormType.Disabled || formType === FormType.ReadOnly) {
                loadDonationPledge();
            }

            showHideControlsAndLabelChange();

            // Bind the inputs to their respective function calls:
            $('input[name=donationPledgeType]').change(function () {
                donationPledgeTypechange();
            });


            $('input[name=anonymousDonation]').change(function () {
                manageTab(this);
                var selectedVal = $('input[name=anonymousDonation]:checked').val();
                if (selectedVal == Anonymity.Yes) {
                    xrm.Page.getAttribute("msnfp_customerid").setRequiredLevel("none");
                    xrm.Page.getAttribute("msnfp_constituentid").setRequiredLevel("none");
                }
                else {
                    xrm.Page.getAttribute("msnfp_customerid").setRequiredLevel("required");
                }
            });

            $('input[name=giftSource]').change(function () {
                manageTab(this);
            });

            // When the final process button is clicked, validate the data and save/update:
            $('#btnProcess').click(function () {
                $('.manual-main .error-msg').hide();
                //$('#lblErrorMessageText')[0].innerText = '';
                $('#lblErrorMessageText').html('');
                // Validate fields (moved to validate function):
                if (validate()) {
                    xrm.Utility.showProgressIndicator("Creating Pledge");

                    var attributes = xrm.Page.data.entity.attributes.get();
                    var entity = {};

                    if (xrm.Page.getAttribute("msnfp_name").getValue() == null) {
                        xrm.Page.getAttribute("msnfp_name").setValue("Pledge - " + RandomGuid().substring(0, 6).toUpperCase());
                    }

                    entity["msnfp_name"] = xrm.Page.getAttribute("msnfp_name").getValue();
                    entity["msnfp_totalamount"] = parseFloat($('#txtAmount').val());
                    entity["msnfp_totalamount_balance"] = parseFloat($('#txtAmount').val());
                    entity["msnfp_totalamount_paid"] = parseFloat(0);
                    entity["msnfp_bookdate"] = xrm.Page.getAttribute("msnfp_bookdate").getValue();
                    entity["msnfp_receiveddate"] = new Date($('#txtDepositDate').val());

                    for (var i in attributes) { attributes[i].setSubmitMode("never"); }

                    // Save the configuration to the gift from the user:
                    if (!isNullOrUndefined(userConfigID)) {
                        entity["msnfp_ConfigurationId@odata.bind"] = "/msnfp_configurations(" + userConfigID + ")";
                    }

                    // Assign the contact/account:
                    var anonymousDonation = parseInt($('input[name=anonymousDonation]:checked').val());
                    entity["msnfp_anonymous"] = anonymousDonation;
                    if (anonymousDonation == 844060001 && (selectedDonor == null || selectedDonor.length == 0)) {
                        var anonymousContactId = createAnonymousContact();

                        if (isNullOrUndefined(anonymousContactId))
                            return;

                        entity["msnfp_CustomerId_contact@odata.bind"] = "/contacts(" + anonymousContactId + ")";
                        selectedDonor = {
                            contactid: anonymousContactId,
                            isAccount: false,
                            Name: ($('#txtFirstName').val() + ' ' + $('#txtLastName').val())
                        };
                    }
                    else if (selectedDonor != null) {
                        console.log("accountid - " + selectedDonor.accountid);
                        console.log("contactid - " + selectedDonor.contactid);

                        if (selectedDonor.isAccount)
                            entity["msnfp_CustomerId_account@odata.bind"] = "/accounts(" + selectedDonor.accountid + ")";
                        else
                            entity["msnfp_CustomerId_contact@odata.bind"] = "/contacts(" + selectedDonor.contactid + ")";
                    }


                    // Assign the constitute, campaign and fund (if applicable):
                    if (!isNullOrUndefined(selectedConstitute)) {
                        entity["msnfp_ConstituentId@odata.bind"] = "/contacts(" + selectedConstitute.contactid + ")";
                    }
                    else
                        entity["msnfp_ConstituentId"] = null;

                    // Campaign:
                    campaignEventID = XrmUtility.CleanGuid(xrm.Page.data.entity.attributes.get("msnfp_commitment_campaignid").getValue()[0].id);
                    if (!isNullOrUndefined(campaignEventID)) {
                        entity["msnfp_Commitment_CampaignId@odata.bind"] = "/campaigns(" + campaignEventID + ")";
                    }
                    else {
                        entity["msnfp_commitment_campaignid"] = null;
                    }


                    // Default Designation:
                    if (!isNullOrUndefined(xrm.Page.data.entity.attributes.get("msnfp_commitment_defaultdesignationid").getValue())) {
                        defaultDesignationID = XrmUtility.CleanGuid(xrm.Page.data.entity.attributes.get("msnfp_commitment_defaultdesignationid").getValue()[0].id);
                        if (!isNullOrUndefined(defaultDesignationID)) {
                            entity["msnfp_Commitment_DefaultDesignationId@odata.bind"] = "/campaigns(" + defaultDesignationID + ")";
                        }
                        else {
                            entity["msnfp_Commitment_DefaultDesignationId"] = null;
                        }
                    }


                    // Appeal ID:
                    if (!isNullOrUndefined(xrm.Page.data.entity.attributes.get("msnfp_appealid").getValue())) {
                        var appealID = XrmUtility.CleanGuid(xrm.Page.data.entity.attributes.get("msnfp_appealid").getValue()[0].id);
                        if (!isNullOrUndefined(appealID)) {
                            entity["msnfp_AppealId@odata.bind"] = "/msnfp_appeals(" + appealID + ")";
                        }
                    }

                    // Package ID:
                    if (!isNullOrUndefined(xrm.Page.data.entity.attributes.get("msnfp_packageid").getValue())) {
                        var packageID = XrmUtility.CleanGuid(xrm.Page.data.entity.attributes.get("msnfp_packageid").getValue()[0].id);
                        if (!isNullOrUndefined(packageID)) {
                            entity["msnfp_PackageId@odata.bind"] = "/msnfp_packages(" + packageID + ")";
                        }
                    }


                    // Pledged on Account:
                    if (xrm.Page.data.entity.attributes.get("msnfp_pledgedonaccountid").getValue() != null) {
                        var pledgedOnAccountID = XrmUtility.CleanGuid(xrm.Page.data.entity.attributes.get("msnfp_pledgedonaccountid").getValue()[0].id)
                        if (!isNullOrUndefined(pledgedOnAccountID)) {
                            entity["msnfp_PledgedOnAccountId@odata.bind"] = "/accounts(" + pledgedOnAccountID + ")";
                        }
                        else {
                            entity["msnfp_PledgedOnAccountId@odata.bind"] = null;
                        }
                    }


                    if ($('input[name=giftSource]:checked').val() != undefined)
                        entity["msnfp_dataentrysource"] = $('input[name=giftSource]:checked').val();

                    entity["msnfp_firstname"] = $('#txtFirstName').val();
                    entity["msnfp_lastname"] = $('#txtLastName').val();
                    entity["msnfp_emailaddress1"] = $('#txtEmail').val();
                    entity["msnfp_telephone1"] = $('#txtPhone').val();
                    entity["msnfp_telephone2"] = $('#txtAltPhone').val();
                    entity["msnfp_mobilephone"] = $('#txtMobilePhone').val();
                    entity["msnfp_billing_line1"] = $('#txtAddressLine1').val();
                    entity["msnfp_billing_line2"] = $('#txtAddressLine2').val();
                    entity["msnfp_billing_line3"] = $('#txtAddressLine3').val();
                    entity["msnfp_billing_city"] = $('#txtAddressCity').val();
                    entity["msnfp_billing_stateorprovince"] = $('#txtAddressProvince').val();
                    entity["msnfp_billing_postalcode"] = $('#txtAddressPostalCode').val();
                    entity["msnfp_billing_country"] = $('#txtAddressCountry').val();

                    entity["statuscode"] = parseInt(1);

                    // Now either create or update this gift record:
                    if (isNullOrUndefined(currentID)) {
                        var qry = XrmServiceUtility.GetWebAPIUrl() + "msnfp_donorcommitments";
                        XrmServiceUtility.CreateRecordAsync(qry, entity, saveSuccess, errorFailure);
                    }
                    else {
                        var qry = XrmServiceUtility.GetWebAPIUrl() + "msnfp_donorcommitments(" + currentID + ")";
                        XrmServiceUtility.UpdateRecordAsync(qry, entity, saveSuccess, errorFailure);
                    }
                }
                else {
                    //alert("Please Complete all Mandatory Fields Prior to Processing a Pledge");
                }
            });


            $('#btnThankyou').click(function () {
                var processName = "msnfp_ActionDonorCommitmentThankYou";
                DownloadThankYouTemplate("Microsoft.Dynamics.CRM." + processName);
            });

            $('#btnPrintReceipt').click(function () {
                if (donationPledge.statuscode == 844060004) //refund
                    DownloadReceiptTemplete("Microsoft.Dynamics.CRM.msnfp_ActionGiftRefund");
                else
                    DownloadReceiptTemplete("Microsoft.Dynamics.CRM.msnfp_ActionGiftReceipt");
            });

            $('#btnEmailReceipt').click(function () {
                var emailId = $('#emailReceipt').val();

                if (emailId == '') {
                    alert("Please enter recipient email id");
                }
                else if (!isEmail(emailId)) {
                    alert("No valid email id on current record");
                }
                else {
                    var message = "Selecting this will generate an receipt and email the donor. Press OK to continue";
                    xrm.Utility.confirmDialog(message, GenerateEmailReciept, cancelClick);
                }
            });


            //	Create a Transaction from this Pledge Record
            $('.btnConvertPledgeToDonation').click(function () {
                var parameters = {};
                parameters["parameter_parentdonationid"] = currentID;
                xrm.Utility.openEntityForm("msnfp_transaction", null, parameters, true);
            });

            //	Create another Transaction from this Pledge Record
            $('.btnConvertPledgeToDonationSuccess').click(function () {
                var parameters = {};
                parameters["parameter_parentdonationid"] = currentID;
                xrm.Utility.openEntityForm("msnfp_transaction", null, parameters, true);
            });

            $('.spanConvertedDonation').click(function () {
                var donationId = $(this).data('id');
                if (donationId != '') {
                    var parameters = {};
                    xrm.Utility.openEntityForm("msnfp_transaction", donationId, parameters, true);
                }
            });


            xrm.Page.getAttribute("msnfp_customerid").addOnChange(customerChange);
            xrm.Page.getAttribute("msnfp_constituentid").addOnChange(constituteChange);


            $('#txtAmount').change(function () {
                var amount = !isNullOrUndefined($(this).val()) ? parseFloat($(this).val()) : 0;

                $(this).val(amount.toFixed(2));

                if (!isNullOrUndefined(parentGiftAmount)) {
                    if (amount > parentGiftAmount) {
                      //  $("#lblErrorMessageText")[0].innerText = "Amount should not exceed " + parentGiftAmount + " amount of the parent gift.";
                        $("#lblErrorMessageText").append('<p>Amount should not exceed ' + parentGiftAmount + ' amount of the parent gift.</p>');
                        $("#divErrorMessageContainer").show();
                        $(this).addClass('red-border');
                    }
                    else {
                        //$("#lblErrorMessageText")[0].innerText = "";
                        $('#lblErrorMessageText').html('');
                        $("#divErrorMessageContainer").hide();
                        $(this).removeClass('red-border');
                    }
                }

                var selectedType = parseInt($('input[name=donationPledgeType]:checked').val());
                if (selectedType == DonationPledgeTypeForm.Membership) {
                    $("input[name=donationPledgeType][value='" + DonationPledgeTypeForm.Donation + "']").prop("checked", true);
                    $('#txtAmount').closest('div').addClass('mandatory');
                }
            });

            $('#btnChequeDate').click(function () {
                $('#divUpdateChequeDate').toggle();
            });

            $('#btnDepositDate').click(function () {
                $('#divUpdateDepositDate').toggle();
            });

            $('#btnUpdateChequeDate').click(function () {
                var donationPledge = {};
                if ($('#txtNewChequeDate').val() != null) {
                    donationPledge["msnfp_chequewiredate"] = new Date($('#txtNewChequeDate').val());

                    var qry = XrmServiceUtility.GetWebAPIUrl() + "msnfp_donorcommitments(" + currentID + ")";
                    XrmServiceUtility.UpdateRecordAsync(qry, donationPledge, reloadOnUpdateSuccess, errorFailure);
                }
            });

            $('#btnUpdateDepositDate').click(function () {
                var donationPledge = {};
                if ($('#txtNewDepositDate').val() != null) {
                    donationPledge["msnfp_depositdate"] = new Date($('#txtNewDepositDate').val());

                    var qry = XrmServiceUtility.GetWebAPIUrl() + "msnfp_donorcommitments(" + currentID + ")";
                    XrmServiceUtility.UpdateRecordAsync(qry, donationPledge, reloadOnUpdateSuccess, errorFailure);
                }
            });

            $('#btnChequeNumber').click(function () {
                $('#divUpdateChequeNumber').toggle();
            });

            $('#btnUpdateChequeNumber').click(function () {
                var donationPledge = {};

                if ($('#txtNewChequeNumber').val() != null) {
                    donationPledge["msnfp_chequenumber"] = $('#txtNewChequeNumber').val();

                    var qry = XrmServiceUtility.GetWebAPIUrl() + "msnfp_donorcommitments(" + currentID + ")";
                    XrmServiceUtility.UpdateRecordAsync(qry, donationPledge, reloadOnUpdateSuccess, errorFailure);
                }
            });

            //Wire Trasfer ///
            $('#btnWireDate').click(function () {
                $('#divUpdateWireDate').toggle();
            });

            $('#btnWireDepositDate').click(function () {
                $('#divUpdateWireDepositDate').toggle();
            });

            $('#btnWireNumber').click(function () {
                $('#divUpdateWireNumber').toggle();
            });

            $('#btnDepositDateAll').click(function () {
                $('#divUpdateDepositDateAll').toggle();
            });

            $('#btnUpdateWireDate').click(function () {
                var donationPledge = {};
                if ($('#txtNewWireDate').val() != null) {
                    donationPledge["msnfp_chequewiredate"] = new Date($('#txtNewWireDate').val());

                    var qry = XrmServiceUtility.GetWebAPIUrl() + "msnfp_donorcommitments(" + currentID + ")";
                    XrmServiceUtility.UpdateRecordAsync(qry, donationPledge, reloadOnUpdateSuccess, errorFailure);
                }
            });

            $('#btnUpdateWireDepositDate').click(function () {
                var donationPledge = {};
                if ($('#txtNewWireDepositDate').val() != null) {
                    donationPledge["msnfp_depositdate"] = new Date($('#txtNewWireDepositDate').val());

                    var qry = XrmServiceUtility.GetWebAPIUrl() + "msnfp_donorcommitments(" + currentID + ")";
                    XrmServiceUtility.UpdateRecordAsync(qry, donationPledge, reloadOnUpdateSuccess, errorFailure);
                }
            });

            $('#btnUpdateDepositDateAll').click(function () {
                var donationPledge = {};
                if (!isNullOrUndefined($('#txtNewDepositDateAll').val())) {
                    donationPledge["msnfp_depositdate"] = new Date($('#txtNewDepositDateAll').val());

                    var qry = XrmServiceUtility.GetWebAPIUrl() + "msnfp_donorcommitments(" + currentID + ")";
                    XrmServiceUtility.UpdateRecordAsync(qry, donationPledge, reloadOnUpdateSuccess, errorFailure);
                } else {
                    $('#lblDepositDateAllError').show();
                }
            });

            $('#btnUpdateWireNumber').click(function () {
                var donationPledge = {};
                if ($('#txtNewWireNumber').val() != null) {
                    donationPledge["msnfp_chequenumber"] = $('#txtNewWireNumber').val();

                    var qry = XrmServiceUtility.GetWebAPIUrl() + "msnfp_donorcommitments(" + currentID + ")";
                    XrmServiceUtility.UpdateRecordAsync(qry, donationPledge, reloadOnUpdateSuccess, errorFailure);
                }
            });

            xrm.Page.getAttribute("transactioncurrencyid").addOnChange(getCurrencySymbol);

        });


        function showHideControlsAndLabelChange() {
            if (!isNullOrUndefined(configRecord.msnfp_transaction_inhonour) && configRecord.msnfp_transaction_inhonour)
                $('.divInHonour').css('display', 'flex');
            else
                $('.divInHonour').css('display', 'none');

            if (!isNullOrUndefined(configRecord.msnfp_label_inhonourmemoryof))
                $('.divInHonour').find('label').text(configRecord.msnfp_label_inhonourmemoryof);

            if (!isNullOrUndefined(configRecord.msnfp_transaction_showaddress) && configRecord.msnfp_transaction_showaddress) {
                $('.divAddressFields').css('display', 'flex');

                if (!isNullOrUndefined(configRecord.msnfp_label_line1))
                    $('#txtAddressLine1').prev('label').text(configRecord.msnfp_label_line1);

                if (!isNullOrUndefined(configRecord.msnfp_label_line2))
                    $('#txtAddressLine2').prev('label').text(configRecord.msnfp_label_line2);

                if (!isNullOrUndefined(configRecord.msnfp_label_line3))
                    $('#txtAddressLine3').prev('label').text(configRecord.msnfp_label_line3);

                if (!isNullOrUndefined(configRecord.msnfp_label_city))
                    $('#txtAddressCity').prev('label').text(configRecord.msnfp_label_city);

                if (!isNullOrUndefined(configRecord.msnfp_label_stateorprovince))
                    $('#txtAddressProvince').prev('label').text(configRecord.msnfp_label_stateorprovince);

                if (!isNullOrUndefined(configRecord.msnfp_label_postalcode))
                    $('#txtAddressPostalCode').prev('label').text(configRecord.msnfp_label_postalcode);

                if (!isNullOrUndefined(configRecord.msnfp_label_country))
                    $('#txtAddressCountry').prev('label').text(configRecord.msnfp_label_country);

            }
            else {
                $('.divAddressFields').css('display', 'none');
            }

            if (!isNullOrUndefined(configRecord.msnfp_transaction_showemail) && configRecord.msnfp_transaction_showemail)
                $('.divEmail').css('display', 'flex');
            else
                $('.divEmail').css('display', 'none');

            if (!isNullOrUndefined(configRecord.msnfp_transaction_showtelephone) && configRecord.msnfp_transaction_showtelephone) {
                $('.divPhone').css('display', 'flex');
                $('.divAltPhone').css('display', 'flex');
                $('.divMobilePhone').css('display', 'flex');
                if (!isNullOrUndefined(configRecord.msnfp_label_telephone1))
                    $('.divPhone').find('label').text(configRecord.msnfp_label_telephone1);
                if (!isNullOrUndefined(configRecord.msnfp_label_telephone2))
                    $('.divAltPhone').find('label').text(configRecord.msnfp_label_telephone2);
                if (!isNullOrUndefined(configRecord.msnfp_label_telephone3))
                    $('.divMobilePhone').find('label').text(configRecord.msnfp_label_telephone3);
            }
            else {
                $('.divPhone').css('display', 'none');
                $('.divAltPhone').css('display', 'none');
                $('.divMobilePhone').css('display', 'none');
            }

            // Amounts
            if (!isNullOrUndefined(configRecord.msnfp_label_amount_receipted)) {
                $('.divAmount').find('label').text(configRecord.msnfp_label_amount_receipted);
                $('.divDisableAmount').find('label').text(configRecord.msnfp_label_amount_receipted);
            }

            if (!isNullOrUndefined(configRecord.msnfp_label_amount_nonreceiptable)) {
                $('.divDisableAmountNonreceiptable').find('label').text(configRecord.msnfp_label_amount_nonreceiptable);
            }   

        }

        function getCurrencySymbol() {
            var currencyField = xrm.Page.data.entity.attributes.get("transactioncurrencyid").getValue();
            if (!isNullOrUndefined(currencyField)) {
                var currencyid = xrm.Page.data.entity.attributes.get("transactioncurrencyid").getValue()[0].id;
                var currencySelect = "transactioncurrencies?$select=transactioncurrencyid,currencysymbol,isocurrencycode"
                currencySelect += "&$filter=transactioncurrencyid eq " + XrmUtility.CleanGuid(currencyid);
                var currencyRec = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + currencySelect);
                if (!isNullOrUndefined(currencyRec))
                    currencyRec = currencyRec[0];

                if (!isNullOrUndefined(currencyRec)) {
                    currencySymbol = currencyRec.currencysymbol;
                    isoCurrencyCode = currencyRec.isocurrencycode;
                }
                customerChange();
            }
        }

        function GenerateEmailReciept() {
            var emailId = $('#emailReceipt').val();
            if (emailId != '') {
                var dPledge = {};
                dPledge["emailaddress"] = emailId;
                dPledge['statuscode'] = donationPledge.statuscode;
                var qry = XrmServiceUtility.GetWebAPIUrl() + "msnfp_donorcommitments(" + currentID + ")";
                XrmServiceUtility.UpdateRecord(qry, dPledge);

                var workflowName = null;
                if (donationPledge.statuscode == 844060004)//refund
                    workflowName = "WF - Gift - Email Refund Receipt";
                else
                    workflowName = "WF - Gift - Email Receipt";

                var workflowId = getWorkflowId(workflowName);
                if (workflowId != undefined && workflowId != null) {
                    ExecuteWorkflow(currentID, workflowId);
                }
            }
        }

        function errorFailure(message) {
            alert(message);
        }

        function loadGiftDetailsLabels(configRec) {
            if (!isNullOrUndefined(configRec.msnfp_label_pledge))
                $('#radioPledge').next('label')[0].innerText = configRec.msnfp_label_pledge;
        }



        function resetTimeZoneOffset(value) {
            var dtValue = new Date(value + ' UTC');

            var _userOffset = dtValue.getTimezoneOffset() * 60 * 1000;
            var _centralOffset = 6 * 60 * 60 * 1000;
            return _date = new Date(dtValue.getTime() - _userOffset + _centralOffset);
        }

        function reloadOnUpdateSuccess() {
            var parameters = {};
            xrm.Utility.openEntityForm("msnfp_donorcommitment", currentID, parameters, true);
        }

        function cancelClick() {
        }

        function manageTab(current) {
            $(this).children('label').each(function () {
                if (this == current) {
                    $(this).toggleClass('back-color');
                }
                else {
                    $(this).removeClass('back-color');
                }
            });
        }

        function base64ToArrayBuffer(base64) {
            var binaryString = window.atob(base64);
            var len = binaryString.length;
            var bytes = new Uint8Array(len);
            for (var i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function DownloadThankYouTemplate(requestName) {
            var entityId = xrm.Page.data.entity.getId().replace(/\{|\}/gi, '');

            try {
                var organizationUrl = xrm.Page.context.getClientUrl();
                var data = {};
                var query = "msnfp_donorcommitments(" + entityId + ")/" + requestName;
                var req = new XMLHttpRequest();
                req.open("POST", organizationUrl + "/api/data/v8.0/" + query, true);
                req.setRequestHeader("Accept", "application/json");
                req.setRequestHeader("Content-Type", "application/json; charset=utf-8");
                req.setRequestHeader("OData-MaxVersion", "4.0");
                req.setRequestHeader("OData-Version", "4.0");
                req.onreadystatechange = function () {
                    if (this.readyState == 4) {
                        req.onreadystatechange = null;
                        if (this.status == 204) {
                            select = "annotations?$select=documentbody,createdon,subject,filename,notetext,_objectid_value,annotationid&$orderby=createdon desc&$top=1&$filter=(_objectid_value eq " + entityId + ")";
                            var result = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + select);
                            if (result != null && result.length > 0) {
                                download(base64ToArrayBuffer(result[0].documentbody), result[0].filename, "application/vnd.openxmlformats-officedocument.wordprocessingml.document");
                                XrmServiceUtility.DeleteRecord(result[0].annotationid, 'annotations');
                            }
                        }
                    }
                };
                req.send(window.JSON.stringify(data));
            }
            catch (error) {
                console.log("Download Thank You Template Error: " + error);
                //errorHandler(error);
            }
        }

        function DownloadReceiptTemplete(requestName) {
            var entityId = xrm.Page.data.entity.getId().replace(/\{|\}/gi, '');
            var donorId = xrm.Page.data.entity.attributes.get("msnfp_customerid").getValue()[0].id;

            try {
                var organizationUrl = xrm.Page.context.getClientUrl();
                var data = {};
                var query = "msnfp_donorcommitments(" + entityId + ")/" + requestName;
                var req = new XMLHttpRequest();
                req.open("POST", organizationUrl + "/api/data/v8.0/" + query, true);
                req.setRequestHeader("Accept", "application/json");
                req.setRequestHeader("Content-Type", "application/json; charset=utf-8");
                req.setRequestHeader("OData-MaxVersion", "4.0");
                req.setRequestHeader("OData-Version", "4.0");
                req.onreadystatechange = function () {
                    if (this.readyState == 4) {
                        req.onreadystatechange = null;
                        if (this.status == 204) {
                            select = "annotations?$select=documentbody,createdon,subject,filename,notetext,_objectid_value,annotationid&$orderby=createdon desc&$top=1&$filter=(_objectid_value eq " + donorId + ")";
                            var result = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + select);
                            if (result != null && result.length > 0) {
                                download(base64ToArrayBuffer(result[0].documentbody), result[0].filename, "application/pdf");
                                XrmServiceUtility.DeleteRecord(result[0].annotationid, 'annotations');
                            }
                        }
                    }
                };
                req.send(window.JSON.stringify(data));
            }
            catch (error) {
                console.log("Receipt Template Error: " + error);
                //errorHandler(error);
            }
        }

        function customerChange() {

            var donor = xrm.Page.data.entity.attributes.get("msnfp_customerid").getValue();
            if (donor != null) {
                donorId = xrm.Page.data.entity.attributes.get("msnfp_customerid").getValue()[0].id;
                if (donor[0].entityType == "account") {
                    select = "accounts(" + XrmUtility.CleanGuid(donorId) + ")?$select=accountid,name,address1_line1,address1_line2,address1_line3,address1_city,address1_stateorprovince,address1_country,address1_postalcode,telephone1,telephone2,telephone3,emailaddress1,_primarycontactid_value,msnfp_anonymity,msnfp_accounttype";

                    expand = "&$expand=primarycontactid($select=contactid,fullname,firstname,lastname)"

                    selectedDonor = XrmServiceUtility.ExecuteQueryWithExpand(XrmServiceUtility.GetWebAPIUrl() + select + expand);

                    if (selectedDonor.msnfp_accounttype !== null && selectedDonor.msnfp_accounttype !== undefined && selectedDonor.msnfp_accounttype === 844060000) {
                        parent.Xrm.Page.data.entity.attributes.get("msnfp_customerid").setValue(null);
                        return;
                    }

                    if (selectedDonor.primarycontactid != null) {
                        var primaryContactID = selectedDonor._primarycontactid_value;
                        var primaryContactName = selectedDonor.primarycontactid.fullname;
                        var primaryContactType = "contact";

                        console.log("Setting msnfp_constituentid to: " + selectedDonor.primarycontactid.fullname);

                        xrm.Page.getAttribute("msnfp_constituentid").setValue([{ id: primaryContactID, name: primaryContactName, entityType: primaryContactType }]);
                        $('#txtFirstName').val(selectedDonor.primarycontactid.firstname != null ? selectedDonor.primarycontactid.firstname : "");
                        $('#txtLastName').val(selectedDonor.primarycontactid.lastname != null ? selectedDonor.primarycontactid.lastname : "");
                    }
                    else {
                        console.log("Nulling out msnfp_constituentid.");
                        xrm.Page.getAttribute("msnfp_constituentid").setValue(null);
                        $('#txtFirstName').val('');
                        $('#txtLastName').val('');
                    }
                    selectedDonor.isAccount = true;
                    $('#txtFirstName').closest('div').removeClass('mandatory');
                    $('#txtLastName').closest('div').removeClass('mandatory');
                    $('#txtMobilePhone').val(selectedDonor.telephone3 != null ? selectedDonor.telephone3 : "");
                }
                else if (donor[0].entityType == "contact") {
                    select = "contacts(" + XrmUtility.CleanGuid(donorId) + ")?$select=contactid,firstname,lastname,fullname,address1_line1,address1_line2,address1_line3,address1_city,address1_stateorprovince,address1_country,address1_postalcode,telephone1,telephone2,mobilephone,emailaddress1,_parentcustomerid_value,msnfp_anonymity";

                    selectedDonor = XrmServiceUtility.ExecuteQueryWithExpand(XrmServiceUtility.GetWebAPIUrl() + select);

                    selectedDonor.isAccount = false;

                    $('#txtFirstName').val(selectedDonor.firstname != null ? selectedDonor.firstname : "");
                    $('#txtLastName').val(selectedDonor.lastname != null ? selectedDonor.lastname : "");

                    $('#txtFirstName').closest('div').addClass('mandatory');
                    $('#txtLastName').closest('div').addClass('mandatory');
                    $('#txtMobilePhone').val(selectedDonor.mobilephone != null ? selectedDonor.mobilephone : "");
                }

                $('#txtEmail').val(selectedDonor.emailaddress1 != null ? selectedDonor.emailaddress1 : "");
                $('#txtPhone').val(selectedDonor.telephone1 != null ? selectedDonor.telephone1 : "");
                $('#txtAltPhone').val(selectedDonor.telephone2 != null ? selectedDonor.telephone2 : "");
                $('#txtAddressLine1').val(selectedDonor.address1_line1 != null ? selectedDonor.address1_line1 : "");
                $('#txtAddressLine2').val(selectedDonor.address1_line2 != null ? selectedDonor.address1_line2 : "");
                $('#txtAddressLine3').val(selectedDonor.address1_line3 != null ? selectedDonor.address1_line3 : "");
                $('#txtAddressCity').val(selectedDonor.address1_city != null ? selectedDonor.address1_city : "");
                $('#txtAddressProvince').val(selectedDonor.address1_stateorprovince != null ? selectedDonor.address1_stateorprovince : "");
                $('#txtAddressPostalCode').val(selectedDonor.address1_postalcode != null ? selectedDonor.address1_postalcode.replace(/\s/g, '') : "");
                $('#txtAddressCountry').val(selectedDonor.address1_country != null ? selectedDonor.address1_country : "");
                $("input[name=anonymousDonation][value='" + selectedDonor.msnfp_anonymity + "']").prop("checked", true);
            }
            else {
                $('#txtFirstName').val('');
                $('#txtLastName').val('');
                $('#txtEmail').val('');
                $('#txtPhone').val('');
                $('#txtAltPhone').val('');
                $('#txtMobilePhone').val('');
                $('#txtAddressLine1').val('');
                $('#txtAddressLine2').val('');
                $('#txtAddressLine3').val('');
                $('#txtAddressCity').val('');
                $('#txtAddressProvince').val('');
                $('#txtAddressPostalCode').val('');
                $('#txtAddressCountry').val('');
                $('#txtDonorName').val('');
                $('#txtInHonorMemoryOf').val('');
                $('#txtChequeNumber').val('');
                $('#txtDescription').val('');
                $('#txtApraiser').val('');
                $('#txtChequeDate').val('');
                $('#txtChequeNumber').val('');
            }
        }

        function constituteChange() {
            var constitute = xrm.Page.data.entity.attributes.get("msnfp_constituentid").getValue();
            if (constitute != null) {
                constituteId = xrm.Page.data.entity.attributes.get("msnfp_constituentid").getValue()[0].id;
                select = "contacts?$select=contactid,fullname,firstname,lastname,emailaddress1&";
                filter = "$filter=contactid eq " + XrmUtility.CleanGuid(constituteId) + "";

                var donorResult = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + select + filter);
                selectedConstitute = donorResult[0];
                if (!isNullOrUndefined(selectedDonor) && selectedDonor.isAccount) {
                    $('#txtEmail').val(selectedConstitute.emailaddress1 != null ? selectedConstitute.emailaddress1 : "");
                    $('#txtFirstName').val(selectedConstitute.firstname != null ? selectedConstitute.firstname : "");
                    $('#txtLastName').val(selectedConstitute.lastname != null ? selectedConstitute.lastname : "");
                }
            }
        }

        // Populate the fields with existing data:
        function loadDonationPledge() {
            selectQuery = "msnfp_donorcommitments(" + currentID + ")?";  //NFP CHANGE "msnfp_donationpledges(" + currentID + ")?";
            //NFP CHANGE expandQuery = "$expand=msnfp_customerid_contact($select=contactid,fullname),msnfp_customerid_account($select=accountid,name)";
            donationPledge = XrmServiceUtility.ExecuteQueryWithExpand(XrmServiceUtility.GetWebAPIUrl() + selectQuery); //NFP CHANGE + expandQuery);

            $(donationPledge).each(function () {
                donorId = this.msnfp_customerid;

                $("input[name=anonymousDonation][value='" + this.msnfp_anonymous + "']").prop("checked", true);


                $("input[name=giftSource][value='" + this.msnfp_dataentrysource + "']").prop("checked", true);

                //MCDMI-382 GIFT: Deposit Date
                if (this.msnfp_type == 84406000 || this.msnfp_type == 84406014) {
                    $('.divUpdateDepositDateMain').show();
                    if (!isNullOrUndefined(this.msnfp_depositdate)) {
                        var utcYear1 = new Date(this.msnfp_depositdate).getFullYear();
                        var utcMonth1 = new Date(this.msnfp_depositdate).getMonth();
                        var utcDate1 = new Date(this.msnfp_depositdate).getDate();

                        var depositDt = new Date(utcYear1, utcMonth1, utcDate1);
                        $('#btnDepositDateAll').val(getFormattedDate(depositDt));
                    }
                    else {
                        $('#btnDepositDateAll').val("Not Selected");
                    }
                }
                else {
                    $('.divUpdateDepositDateMain').hide();
                }
                ///End//

                if (this.msnfp_bookdate != null && this.msnfp_bookdate != '') {
                    var str = this.msnfp_bookdate.split('-');
                    var _date = new Date(str[0] + '-' + str[1] + '-' + str[2]);
                    var _utcdate = new Date(_date.getUTCFullYear(), _date.getUTCMonth(), _date.getUTCDate(), _date.getUTCHours(), _date.getUTCMinutes(), _date.getUTCSeconds());
                    $('#txtDate').val(getFormattedDate(_utcdate));
                }

                $('#txtFirstName').val(this.msnfp_firstname);
                $('#txtLastName').val(this.msnfp_lastname);
                $('#txtEmail').val(this.msnfp_emailaddress1);
                $('#emailReceipt').val(this.msnfp_emailaddress1);
                $('#txtPhone').val(this.msnfp_telephone1);
                $('#txtAltPhone').val(this.msnfp_telephone2);
                $('#txtMobilePhone').val(this.msnfp_mobilephone);
                $('#txtAddressLine1').val(this.msnfp_billing_line1);
                $('#txtAddressLine2').val(this.msnfp_billing_line2);
                $('#txtAddressLine3').val(this.msnfp_billing_line3);
                $('#txtAddressCity').val(this.msnfp_billing_city);
                $('#txtAddressProvince').val(this.msnfp_billing_stateorprovince);
                $('#txtAddressPostalCode').val(this.msnfp_billing_postalcode);
                $('#txtAddressCountry').val(this.msnfp_billing_country);
                $('#txtDonorName').val();

                if (!isNullOrUndefined(this.msnfp_totalamount)) {
                    if (this.msnfp_totalamount > 0) {
                        $('#txtAmount').val(parseFloat(this.msnfp_totalamount).toFixed(2));
                    } else {
                        $('#txtAmount').val('0.00');
                    }
                }
                else {
                    $('#txtAmount').val('0.00');

                }

                $('#txtDisableAmountMembership').closest('div').hide();

                if ((!isNullOrUndefined(configRecord.msnfp_tran_nonreceiptable) && configRecord.msnfp_tran_nonreceiptable == true) &&
                    (!isNullOrUndefined(this.msnfp_amount_nonreceiptable) && parseFloat(this.msnfp_amount_nonreceiptable) > 0)) {
                    $('#txtDisableAmountNonreceiptable').closest('div').css("display", "flex");
                    $('#txtDisableAmountNonreceiptable').val(parseFloat(this.msnfp_amount_nonreceiptable).toFixed(2));
                }
                else {
                    $('#txtDisableAmountNonreceiptable').closest('div').hide();
                }

                if (!isNullOrUndefined(this.msnfp_total_header) && parseFloat(this.msnfp_total_header) > 0) {
                    $('#txtDisableTotal').closest('div').show();
                    $('#txtDisableTotal').val(parseFloat(this.msnfp_total_header).toFixed(2));
                }
                else {
                    $('#txtDisableTotal').closest('div').hide();
                }

                $('#txtChequeNumber').val(this.msnfp_chequenumber);

                $('.divUpdateChequeDepositDate').hide();
                $('.divUpdateWireDepositDate').hide();


                if (configRecord.msnfp_tran_receipt && (this.msnfp_type == 84406000 || this.msnfp_type == 84406010 || this.msnfp_type == 84406009))
                    $('#btnPrintReceipt').css('display', 'block');
                else
                    $('#btnPrintReceipt').css('display', 'none');

                if (configRecord.msnfp_transaction_thankyou)
                    $('#btnThankyou').css('display', 'inline-block');
                else
                    $('#btnThankyou').css('display', 'none');

                if (configRecord.msnfp_transaction_email && (this.msnfp_type == 84406000 || this.msnfp_type == 84406010 || this.msnfp_type == 84406009))
                    $('#btnEmailReceipt').css('display', 'block');
                else
                    $('#btnEmailReceipt').css('display', 'none');

                if (this.statecode == 1)//inactive
                {
                    relatedPledgeId = this._msnfp_relatedpledgeid_value;
                    disableFields();

                    $('.subsequent-main').show();
                    $('#donationInfo').hide();
                    $('#lblCancelDonationReason')[0].innerText = donationPledge.msnfp_cancellationtext;
                    $('.refund-donation').hide();
                    $('.divUpdateChequeDepositDate').hide();
                    $('.divUpdateWireDepositDate').hide();
                }
                else if (this.statuscode == 844060000 || this.statuscode == 844060004 || this.statuscode == 844060002 || this.statuscode == 1) {
                    relatedPledgeId = this._msnfp_relatedpledgeid_value;

                    $('.subsequent-main').show();
                    $('#donationInfo').hide();

                    if (this.statuscode == 844060001) {
                        $('#lblCancelDonationReason')[0].innerText = donationPledge.msnfp_cancellationtext;
                        $('.refund-donation').hide();
                        $('.divUpdateChequeDepositdate').hide();
                        $('.divUpdateWireDepositDate').hide();

                        if (!isNullOrUndefined(this.msnfp_amount) && this.msnfp_amount > 0)
                            $('#btnRefundDonation').attr('disabled', false);
                        else
                            $('#btnRefundDonation').attr('disabled', 'disabled');
                    }
                    else {
                        bindChequeWireFields(donationPledge);
                        bindConvertDonation();
                    }
                    donationPledgeTypechange();
                    disableFields();
                }
            });
        }

        function loadConfiguration(configID) {
            if (isNullOrUndefined(configID))
                configID = userConfigID;
            //get Configuration record
            select = "msnfp_configurations?$select=msnfp_configurationid,msnfp_tran_anonymous,";
            select += "msnfp_tran_softcredit,msnfp_sche_pledgeschedule,msnfp_comm_pledge,msnfp_tran_donation,";
            select += "msnfp_tran_cash,msnfp_tran_cheque,msnfp_tran_wireortransfer,msnfp_tran_creditcard,msnfp_tran_bank,msnfp_tran_inkind,msnfp_tran_property,msnfp_tran_stock,";
            select += "msnfp_sche_graceperiod,";
            select += "msnfp_tran_extcreditcard,msnfp_label_bankach,msnfp_label_cash,msnfp_label_cheque,msnfp_label_creditcard,";
            select += "msnfp_label_donation,msnfp_label_donationschedule,msnfp_label_extcreditcard,msnfp_label_inkind,msnfp_label_membership,msnfp_label_other,";
            select += "msnfp_label_pledge,msnfp_label_pledgeschedule,msnfp_label_property,msnfp_label_recurringdonation,msnfp_label_securities,msnfp_label_softcredit,msnfp_label_wire,";
            select += "msnfp_tran_nonreceiptable,msnfp_tran_receipt,msnfp_transaction_thankyou,msnfp_transaction_email,msnfp_label_inhonourmemoryof,msnfp_transaction_inhonour,msnfp_transaction_showaddress,msnfp_transaction_showemail,";
            select += "msnfp_transaction_showtelephone,msnfp_label_telephone1,msnfp_label_telephone2,msnfp_label_telephone3,msnfp_label_line1,msnfp_label_line2,msnfp_label_line3,";
            select += "msnfp_label_city,msnfp_label_stateorprovince,msnfp_label_postalcode,msnfp_label_country,msnfp_tran_showreceiptpreference,msnfp_tran_showamounttax,";
            select += "msnfp_label_amount_receipted,msnfp_label_amount_nonreceiptable,msnfp_label_amount,msnfp_label_amount_tax,msnfp_label_amount_membership";
            select += "&$filter=msnfp_configurationid eq " + configID;
            var configresult = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + select);
            configRecord = configresult[0];
        }

        function bindChequeWireFields(donationPledge) {
            if (donationPledge.msnfp_gifttype == 844060001)//cheque
            {
                $('.divUpdateChequeDepositDate').show();

                if (!isNullOrUndefined(donationPledge.msnfp_chequewiredate)) {
                    var utcYear = new Date(donationPledge.msnfp_chequewiredate).getFullYear();
                    var utcMonth = new Date(donationPledge.msnfp_chequewiredate).getMonth();
                    var utcDate = new Date(donationPledge.msnfp_chequewiredate).getDate();

                    var chequeDt = new Date(utcYear, utcMonth, utcDate);
                    $('#btnChequeDate').val(getFormattedDate(chequeDt));
                }
                else
                    $('#btnChequeDate').val("Not Selected");

                if (!isNullOrUndefined(donationPledge.msnfp_depositdate)) {
                    var utcYear1 = new Date(donationPledge.msnfp_depositdate).getFullYear();
                    var utcMonth1 = new Date(donationPledge.msnfp_depositdate).getMonth();
                    var utcDate1 = new Date(donationPledge.msnfp_depositdate).getDate();

                    var depositDt = new Date(utcYear1, utcMonth1, utcDate1);
                    $('#btnDepositDate').val(getFormattedDate(depositDt));
                }
                else
                    $('#btnDepositDate').val("Not Selected");
            }
            else if (donationPledge.msnfp_gifttype == 844060009) {

                $('.divUpdateWireDepositDate').show();

                if (!isNullOrUndefined(donationPledge.msnfp_chequewiredate)) {
                    var utcYear = new Date(donationPledge.msnfp_chequewiredate).getFullYear();
                    var utcMonth = new Date(donationPledge.msnfp_chequewiredate).getMonth();
                    var utcDate = new Date(donationPledge.msnfp_chequewiredate).getDate();

                    var chequeDt = new Date(utcYear, utcMonth, utcDate);
                    $('#btnWireDate').val(getFormattedDate(chequeDt));
                }
                else
                    $('#btnWireDate').val("Not Selected");

                if (!isNullOrUndefined(donationPledge.msnfp_depositdate)) {
                    var utcYear1 = new Date(donationPledge.msnfp_depositdate).getFullYear();
                    var utcMonth1 = new Date(donationPledge.msnfp_depositdate).getMonth();
                    var utcDate1 = new Date(donationPledge.msnfp_depositdate).getDate();

                    var depositDt = new Date(utcYear1, utcMonth1, utcDate1);
                    $('#btnWireDepositDate').val(getFormattedDate(depositDt));
                }
                else
                    $('#btnWireDepositDate').val("Not Selected");
            }
        }


        function donationPledgeTypechange() {
            var selectedVal = $('input[name=donationPledgeType]:checked').val();

            $('#btnProcess').show();
            $('.divAmountNonReceiptable').show();

            if (selectedVal == DonationPledgeTypeForm.Pledge) {
                $('#txtAmount').closest('div').addClass('mandatory');
                $('#btnPrintReceipt').hide();
                $('#btnEmailReceipt').hide();
            }
        }

        function saveSuccess(recordID) {
            $('.payment-failed-msg').hide();
            $('#payment-failed-block').text('');

            if (recordID != null && recordID != '') {
                currentID = recordID;
                if (isFromPledgeAllocation) {
                    var pledgeAllocationEntity = {};
                    pledgeAllocationEntity["statuscode"] = 844060000; //paid
                    pledgeAllocationEntity["msnfp_donationpledgeid@odata.bind"] = "/msnfp_donorcommitments(" + pledgeScheduleID + ")";
                    pledgeAllocationEntity["msnfp_Giftid@odata.bind"] = "/msnfp_donorcommitments(" + currentID + ")";
                    var qryPA = XrmServiceUtility.GetWebAPIUrl() + "msnfp_pledgeallocations(" + pledgeAllocationResult.msnfp_pledgeallocationid + ")";
                    XrmServiceUtility.UpdateRecord(qryPA, pledgeAllocationEntity);
                }

                if (!isNullOrUndefined(parentGiftID)) {
                    //related to transfer gift amount functionality
                    select = "msnfp_donorcommitments?$select=msnfp_donationpledgeid,msnfp_amount_transfer,_msnfp_fund_value";
                    filter = "&$filter=(msnfp_donationpledgeid eq " + parentGiftID + ")";
                    var result = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + select + filter);
                    if (result != null)
                        result = result[0];
                    var parentAmountTransfer = !isNullOrUndefined(result.msnfp_amount_transfer) ? parseFloat(result.msnfp_amount_transfer) : 0;
                    var parentDonationPledge = {};
                    // NFP CHANGE parentDonationPledge["msnfp_amount"] = parseFloat(parentGiftAmount) - parseFloat($('#txtAmount').val()); //paid
                    parentDonationPledge["msnfp_amount_transfer"] = parentAmountTransfer + parseFloat($('#txtAmount').val());
                    var qryPD = XrmServiceUtility.GetWebAPIUrl() + "msnfp_donorcommitments(" + XrmUtility.CleanGuid(parentGiftID) + ")";
                    XrmServiceUtility.UpdateRecord(qryPD, parentDonationPledge);

                    //Added FundAllocation Record
                    var entity = {};
                    entity["msnfp_donationpledgeid@odata.bind"] = "/msnfp_donorcommitments(" + parentGiftID + ")";

                    if (!isNullOrUndefined(result._msnfp_fund_value)) {
                        entity["msnfp_fund@odata.bind"] = "/msnfp_funds(" + result._msnfp_fund_value + ")";
                    }

                    var qry = XrmServiceUtility.GetWebAPIUrl() + "msnfp_fundallocations";
                    XrmServiceUtility.CreateRecord(qry, entity);

                }

                if (!isNullOrUndefined(relatedPledgeId)) {
                    var entity = {};
                    entity["msnfp_amountpaid"] = parseFloat($('#txtAmount').val());

                    var qry = XrmServiceUtility.GetWebAPIUrl() + "msnfp_donorcommitments(" + relatedPledgeId + ")";
                    XrmServiceUtility.UpdateRecord(qry, entity);
                }

                var selectedDonationPledgeType = parseInt($('input[name=donationPledgeType]:checked').val());

                if (selectedDonationPledgeType == DonationPledgeTypeForm.PledgeSchedule) {
                    generatePledgeAllocations();
                }

                savedDonationSuccessfully();
            }
            else {
                $('.payment-failed-msg').show();
                $('#payment-failed-block').text('An Error Occurred, please check the response logs for details.');
                $('.divAmount, .divProcess').hide();
                xrm.Utility.closeProgressIndicator();
            }
        }

        function savedDonationSuccessfully() {
            updatePrimaryContacttoAccount();
            xrm.Utility.closeProgressIndicator();

            var donationId = $(this).data('id');

            if (donationId != '') {
                var parameters = {};
                xrm.Utility.openEntityForm("msnfp_donorcommitment", currentID, parameters, true);
            }
        }

        function createAnonymousContact() {
            var conatct = {};
            conatct["firstname"] = $('#txtFirstName').val();
            conatct["lastname"] = $('#txtLastName').val();
            var qry = XrmServiceUtility.GetWebAPIUrl() + "contacts";
            return XrmServiceUtility.CreateRecord(qry, conatct);
        }


        //Specify the acknowledgement constituent
        function updatePrimaryContacttoAccount() {
            if (selectedDonor.isAccount && selectedDonor.primarycontactid == null && selectedConstitute != null) {
                var account = {};
                account["primarycontactid@odata.bind"] = "/contacts(" + selectedConstitute.contactid + ")";
                var qry = XrmServiceUtility.GetWebAPIUrl() + "accounts(" + selectedDonor.accountid + ")";
                XrmServiceUtility.UpdateRecord(qry, account);
            }
        }

        //Validations
        function disableFields() {
            $('.switch-field input, .donationFields input, .donationFields select, .headerFields input, .headerFields select').each(function () {
                $(this).attr("disabled", "disabled");
            });

            // var dName = xrm.Page.data.entity.attributes.get("msnfp_donorname");
            var dName = xrm.Page.data.entity.attributes.get("msnfp_firstname").getValue() + " " + xrm.Page.data.entity.attributes.get("msnfp_lastname").getValue(); // NFP CHANGE xrm.Page.data.entity.attributes.get("msnfp_donorname").getValue();
            if (dName != null && xrm.Page.data.entity.attributes.get("msnfp_firstname").getValue() != null && xrm.Page.data.entity.attributes.get("msnfp_lastname").getValue() != null) {

                $('#txtDisableDonorName').val(dName);
                $('#txtDisableDonorName').closest('div').css("display", "flex");
            }
            else {
                $('#txtDisableDonorName').closest('div').hide();
            }

            $('#txtDisableAmount').val($('#txtAmount').val());
            $('#txtDisableAmount').closest('div').css("display", "flex");

            if (xrm.Page.data.entity.attributes.get("msnfp_totalamount_balance").getValue() != null) {

                var totalAmountBalance = xrm.Page.data.entity.attributes.get("msnfp_totalamount_balance").getValue().toFixed(2);
                $('#txtDisableBalance').val(totalAmountBalance);

                if (totalAmountBalance < 0)
                    $('.pledgeOverpaid').show();

            }

            $('#txtDisableBalance').closest('div').css("display", "flex");
        }

        function validate() {
            var isValidate = true;

            $("#lblErrorMessageText").html('');
            $("#divErrorMessageContainer").hide();

            var campaignField = xrm.Page.data.entity.attributes.get("msnfp_commitment_campaignid").getValue();
            var dateField = xrm.Page.data.entity.attributes.get("msnfp_bookdate").getValue();
            var donorField = xrm.Page.data.entity.attributes.get("msnfp_customerid").getValue();

            var isAnonSelected = $('input[name=anonymousDonation]:checked').val();
            if (isAnonSelected != Anonymity.Yes && isNullOrUndefined(donorField)) {
               //$("#lblErrorMessageText")[0].innerText = "Could not retrieve the donor field.";
                $("#lblErrorMessageText").append('<p>Could not retrieve the donor field.</p>');

                $("#divErrorMessageContainer").show();
                isValidate = false;
            }


            if (isNullOrUndefined(campaignField)) {
                //$("#lblErrorMessageText")[0].innerText = "Could not retrieve the campaign field.";
                $("#lblErrorMessageText").append('<p>Could not retrieve the campaign field.</p>');

                $("#divErrorMessageContainer").show();
                isValidate = false;
            }

            if (isNullOrUndefined(dateField)) {
               // $("#lblErrorMessageText")[0].innerText = "Could not retrieve date field.";
                $("#lblErrorMessageText").append('<p>Could not retrieve the date field.</p>');

                $("#divErrorMessageContainer").show();
                isValidate = false;
            }

            $('.manual-main div.mandatory input, .manual-main div.mandatory select').each(function () {
                var $this = $(this);
                if ($this.val() == '') {
                    isValidate = false;
                    $this.addClass('red-border');
                    console.log("Mandatory field incomplete: " + $(this)[0].id);
                    //return isValidate;
                }
                else {
                    $this.removeClass('red-border');
                }
            });

            return isValidate;
        }

        function checkIt(evt) {
            evt = (evt) ? evt : window.event;
            var charCode = (evt.which) ? evt.which : evt.keyCode;
            if (charCode > 31 && (charCode < 48 || charCode > 57)) {
                status = "This field accepts numbers only."
                return false;
            }
            status = "";
            return true;
        }

        function cardnumber(inputtxt) {
            var AE = /^(?:3[47][0-9]{13})$/;                 //Amercican Express
            var visa = /^(?:4[0-9]{12}(?:[0-9]{3})?)$/;      //Visa
            var MC = /^(?:5[1-5][0-9]{14})$/;                //Mastercard
            var Dis = /^(?:6(?:011|5[0-9][0-9])[0-9]{12})$/; //Discover
            var DC = /^(?:3(?:0[0-5]|[68][0-9])[0-9]{11})$/; //Dinners Club

            if (inputtxt.val().match(AE)) {
                $(inputtxt).removeClass('red-border');
                return true;
            }
            else if (inputtxt.val().match(visa)) {
                $(inputtxt).removeClass('red-border');
                return true;
            }
            else if (inputtxt.val().match(MC)) {
                $(inputtxt).removeClass('red-border');
                return true;
            }
            else if (inputtxt.val().match(Dis)) {
                $(inputtxt).removeClass('red-border');
                return true;
            }
            else if (inputtxt.val().match(DC)) {
                $(inputtxt).removeClass('red-border');
                return true;
            }
        }

        function setDonationPledgeType(type, occurencetype) {
            if (type == DonationPledgeType.Donation && occurencetype == DonationOccurrence.Instant)
                $("input[name=donationPledgeType][value='" + DonationPledgeTypeForm.Donation + "']").prop("checked", true);
            else if (type == DonationPledgeType.Grant && occurencetype == DonationOccurrence.Instant)
                $("input[name=donationPledgeType][value='" + DonationPledgeTypeForm.Grant + "']").prop("checked", true);
            else if (type == DonationPledgeType.Pledge && occurencetype == DonationOccurrence.Instant)
                $("input[name=donationPledgeType][value='" + DonationPledgeTypeForm.Pledge + "']").prop("checked", true);
            else if (type == DonationPledgeType.SoftCreditDonation && (occurencetype == DonationOccurrence.Instant || isNullOrUndefined(occurencetype)))
                $("input[name=donationPledgeType][value='" + DonationPledgeTypeForm.SoftCredit + "']").prop("checked", true);
            else if (type == DonationPledgeType.RecurringDonation && occurencetype == DonationOccurrence.Recurring)
                $("input[name=donationPledgeType][value='" + DonationPledgeTypeForm.RecurringDonation + "']").prop("checked", true);
            else if (type == DonationPledgeType.PledgeSchedule && occurencetype == DonationOccurrence.Recurring)
                $("input[name=donationPledgeType][value='" + DonationPledgeTypeForm.PledgeSchedule + "']").prop("checked", true);
            else if (type == DonationPledgeType.DonationSchedule && occurencetype == DonationOccurrence.Recurring)
                $("input[name=donationPledgeType][value='" + DonationPledgeTypeForm.DonationSchedule + "']").prop("checked", true);
            else if (type == DonationPledgeType.Membership && occurencetype == DonationOccurrence.Instant)
                $("input[name=donationPledgeType][value='" + DonationPledgeTypeForm.Membership + "']").prop("checked", true);
        }

        function getWorkflowId(workflowName) {
            select = "workflows?$select=workflowid&$filter=statecode eq 1 and _parentworkflowid_value eq null and name eq \'" + workflowName + "\'";
            var workflowRecord = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + select);
            if (workflowRecord != undefined && workflowRecord != null) {
                return workflowRecord[0].workflowid;
            }
            return undefined;
        }

        function ExecuteWorkflow(currentID, workflowId) {
            var functionName = "executeWorkflow >>";
            var query = "";
            try {
                //Define the query to execute the action
                query = "workflows(" + workflowId.replace("}", "").replace("{", "") + ")/Microsoft.Dynamics.CRM.ExecuteWorkflow";
                var data = { "EntityId": currentID };

                var req = new XMLHttpRequest();
                req.open("POST", XrmServiceUtility.GetWebAPIUrl() + query, true);
                req.setRequestHeader("Accept", "application/json");
                req.setRequestHeader("Content-Type", "application/json; charset=utf-8");
                req.setRequestHeader("OData-MaxVersion", "4.0");
                req.setRequestHeader("OData-Version", "4.0");

                req.onreadystatechange = function () {
                    if (this.readyState == 4) {
                        req.onreadystatechange = null;
                        if (this.status == 200) {
                            //success callback this returns null since no return value available.
                            var result = JSON.parse(this.response);
                            xrm.Utility.alertDialog("Mail sent successfully");
                        }
                        else {
                            //error callback
                            var error = JSON.parse(this.response).error;

                        }
                    }
                };
                req.send(JSON.stringify(data));
            }
            catch (e) {
                throwError(functionName, e);
            }
        }

        function getLookupGuid(fieldName) {
            var field = xrm.Page.data.entity.attributes.get(fieldName);
            if (field != null && field.getValue() != null) {
                return xrm.Page.data.entity.attributes.get(fieldName).getValue()[0].id.replace('{', '').replace('}', '');
            }
            return null;
        }

        function getGiftType(giftType) {
            if (giftType == 844060000) { return 'Cash'; }
            if (giftType == 844060001) { return 'Cheque'; }
            if (giftType == 844060002) { return 'Credit / Debit Card'; }
            if (giftType == 844060003) { return 'Bank (Ach)'; }
            if (giftType == 844060004) { return 'In Kind'; }
            if (giftType == 844060005) { return 'Gift'; }
            if (giftType == 844060006) { return 'Stock'; }
            if (giftType == 844060007) { return 'Property'; }
            if (giftType == 844060009) { return 'WireTransfer'; }
            if (giftType == 844060008) { return 'Other'; }
            return '';
        }

        //10.	Create a Manual Pledge Record
        function bindConvertDonation() {
            var monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            var month;
            var suffix;

            var selectedVal = $('input[name=donationPledgeType]:checked').val();
            if (selectedVal == DonationPledgeTypeForm.Pledge) {
                $('.divUpdateChequeDepositDate').hide();
                $('.divUpdateWireDepositDate').hide();

                select = "msnfp_transactions?$select=msnfp_transactionid,msnfp_amount,createdon";
                //filter = "&$filter=(_msnfp_parentdonationpledgeid_value eq " + currentID + ")";
                filter = "&$filter=(_msnfp_donorcommitmentid_value eq " + currentID + ")";
                var result = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + select + filter);
                if (result != null && result.length > 0) {
                    $('.convertPledgeToDonationSuccess').show();
                    $('.refund-donation').hide();
                    $(result).each(function () {
                        month = new Date(this.createdon).getMonth();
                        suffix = getSuffix(new Date(this.createdon).getDate());

                        var text = 'Donation: Cash Amount: ' + currencySymbol + this.msnfp_amount + ' created on ' + new Date(this.createdon).getDate() + suffix + ' ' + monthNames[month] + ' ' + new Date(this.createdon).getFullYear();
                        $('.divConvertedDonationList').
                            append('<span class="spanConvertedDonation main-button-lnk" style="margin-left: 0px;float:right;" data-id=' +
                                this.msnfp_transactionid +
                                '>' + text + '</span>');
                    });
                }
                else {
                    $('.convertPledgeToDonation').show();
                    $('.refund-donation').hide();
                }
            }
        }

        function getSuffix(n) {
            return n < 11 || n > 13 ? ['st', 'nd', 'rd', 'th'][Math.min((n - 1) % 10, 3)] : 'th'
        }

        //11.	Convert a Pledge to a Donation
        function loadParentDonationDetails(parentDonationId) {
            selectQuery = "msnfp_donorcommitments(" + parentDonationId + ")?";
            expandQuery = "$expand=msnfp_customerid_contact($select=contactid,fullname),msnfp_customerid_account($select=accountid,name)";
            var result = XrmServiceUtility.ExecuteQueryWithExpand(XrmServiceUtility.GetWebAPIUrl() + selectQuery + expandQuery);

            $(result).each(function () {
                var parentId = this.msnfp_donorcommitmentid;
                var parentName = this.msnfp_title;
                var parentType = "msnfp_donationpledge";

                //xrm.Page.getAttribute("msnfp_parentdonationpledgeid").setValue([{ id: parentId, name: parentName, entityType: parentType }]);
                xrm.Page.getAttribute("msnfp_relatedpledgeid").setValue([{ id: parentId, name: parentName, entityType: parentType }]);

                $("input[name=donationPledgeType][value='" + DonationPledgeTypeForm.Donation + "']").prop("checked", true);
                $("input[name=donationPledgeType]").each(function () {
                    $(this).attr("disabled", "disabled");
                });

                $("input[name=anonymousDonation][value='" + this.msnfp_anonymity + "']").prop("checked", true);
                $("input[name=giftSource][value='" + this.msnfp_dataentrysource + "']").prop("checked", true);

                if (this.msnfp_bookdate != null && this.msnfp_bookdate != '')
                    var str = this.msnfp_bookdate.split('-');
                var _date = new Date(str[0] + '-' + str[1] + '-' + str[2]);
                var _utcdate = new Date(_date.getUTCFullYear(), _date.getUTCMonth(), _date.getUTCDate(), _date.getUTCHours(), _date.getUTCMinutes(), _date.getUTCSeconds());

                $('#txtDate').val(getFormattedDate(_utcdate));
                $('#txtFirstName').val(this.msnfp_firstname);
                $('#txtLastName').val(this.msnfp_lastname);
                $('#txtEmail').val(this.msnfp_emailaddress1);
                $('#txtPhone').val(this.msnfp_telephone1);
                $('#txtAltPhone').val(this.msnfp_telephone2);
                $('#txtMobilePhone').val(this.msnfp_mobilephone);
                $('#txtAddressLine1').val(this.msnfp_billing_line1);
                $('#txtAddressLine2').val(this.msnfp_billing_line2);
                $('#txtAddressLine3').val(this.msnfp_billing_line3);
                $('#txtAddressCity').val(this.msnfp_billing_city);
                $('#txtAddressProvince').val(this.msnfp_billing_stateorprovince);
                $('#txtAddressPostalCode').val(this.msnfp_billing_postalcode);
                $('#txtDonorName').val();
                $('#txtInHonorMemoryOf').val(this.msnfp_honorormemory);
                $('#txtAmount').val(this.msnfp_amount);
                $('#txtChequeNumber').val(this.msnfp_chequenumber);

                var selectRelated = "";
                var filterRelated = "";
                if (this.msnfp_customerid_account != null) {
                    selectRelated = "accounts?";
                    filterRelated = "$filter=accountid eq " + this._msnfp_customerid_value;
                }
                else if (this.msnfp_customerid_contact != null) {
                    selectRelated = "contacts?";
                    filterRelated = "$filter=contactid eq " + this._msnfp_customerid_value;
                }

                if (this.msnfp_customerid_account != null || this.msnfp_customerid_contact != null) {
                    var resultRelatedDonor = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + selectRelated + filterRelated);

                    if (resultRelatedDonor != null && this.msnfp_customerid_account != null) {
                        var donorID = resultRelatedDonor[0].accountid;
                        var donorName = resultRelatedDonor[0].name;
                        var donorType = "account";
                    }
                    else if (resultRelatedDonor != null && this.msnfp_customerid_contact != null) {
                        var donorID = resultRelatedDonor[0].contactid;
                        var donorName = resultRelatedDonor[0].fullname;
                        var donorType = "contact";
                    }
                    xrm.Page.getAttribute("msnfp_customerid").setValue([{ id: donorID, name: donorName, entityType: donorType }]);
                    customerChange();
                }
            });
        }

        //Helper Methods
        Array.prototype.distinct = function () {
            var map = {}, out = [];
            var l = this.length;

            for (var i = 0; i < l; i++) {
                if (map[this[i].data]) { continue; }

                out.push(this[i]);
                map[this[i].data] = 1;
            }

            return out;
        }

        Array.prototype.distinctMembershipGroup = function () {
            var map = {}, out = [];
            var l = this.length;

            for (var i = 0; i < l; i++) {
                if (map[this[i].msnfp_title]) { continue; }

                out.push(this[i]);
                map[this[i].msnfp_title] = 1;
            }

            return out;
        }

        function getLookupGuid(fieldName) {
            var field = xrm.Page.data.entity.attributes.get(fieldName);
            if (field != null && field.getValue() != null) {
                return xrm.Page.data.entity.attributes.get(fieldName).getValue()[0].id.replace('{', '').replace('}', '');
            }
            return null;
        }

        function RandomGuid() {
            return s4() + s4() + '' + s4() + '' + s4() + '' +
                s4() + '' + s4() + s4() + s4();
        }

        function s4() {
            return Math.floor((1 + Math.random()) * 0x10000)
                .toString(16)
                .substring(1);
        }

        function getUrlParameter(name) {
            var param = xrm.Page.context.getQueryStringParameters();
            return param[name];
        }

        function isEmail(email) {
            var regex = /^([a-zA-Z0-9_.+-])+\@(([a-zA-Z0-9-])+\.)+([a-zA-Z0-9]{2,4})+$/;
            return regex.test(email);
        }

        function getFormattedDate(date) {
            return ("0" + (date.getMonth() + 1)).slice(-2)
                + "/"
                + ("0" + date.getDate()).slice(-2)
                + "/"
                + date.getFullYear();
        }

        function isNullOrUndefined(value) {
            return (typeof (value) === "undefined" || value === null || value === "");
        }

        function listSorter(a, b) {
            var x = a.msnfp_title.toLowerCase();
            var y = b.msnfp_title.toLowerCase();
            return ((x < y) ? -1 : ((x > y) ? 1 : 0));
        }

        function validateFloatKeyPress(el, evt) {
            var charCode = (evt.which) ? evt.which : event.keyCode;
            var number = el.value.split('.');
            if (charCode != 46 && charCode > 31 && (charCode < 48 || charCode > 57)) {
                return false;
            }
            //just one dot
            if (number.length > 1 && charCode == 46) {
                return false;
            }
            //get the carat position
            var caratPos = getSelectionStart(el);
            var dotPos = el.value.indexOf(".");
            if (caratPos > dotPos && dotPos > -1 && (number[1].length > 1)) {
                return false;
            }
            return true;
        }

        function getSelectionStart(o) {
            if (o.createTextRange) {
                var r = document.selection.createRange().duplicate();
                r.moveEnd('character', o.value.length);
                if (r.text === '') return o.value.length;
                return o.value.lastIndexOf(r.text);
            } else return o.selectionStart;
        }

        function isNumber(evt) {
            evt = (evt) ? evt : window.event;
            var charCode = (evt.which) ? evt.which : evt.keyCode;
            if (charCode > 31 && (charCode < 48 || charCode > 57)) {
                return false;
            }
            return true;
        }

        function addCommasonLoad(nStr) {
            if (nStr != 0) {
                nStr = nStr.replace(currencySymbol, '').replace(',', '');
                nStr += '';
                x = nStr.split('.');
                x1 = x[0];
                x2 = x.length > 1 ? '.' + x[1] : '';
                var rgx = /(\d+)(\d{3})/;
                while (rgx.test(x1)) {
                    x1 = x1.replace(rgx, '$1' + ',' + '$2');
                }
                return x1 + x2;
            }
            else return 0;
        }

    </script>
</body>
</html>