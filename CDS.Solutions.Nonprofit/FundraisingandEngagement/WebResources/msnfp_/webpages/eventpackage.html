<html><!--/*************************************************************************
* Â© Microsoft. All rights reserved.
*/--><head>
    <title></title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link href="../scripts/jquery.dataTables.min.css" rel="stylesheet">
    <link href="../scripts/common.css" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
    <script src="../scripts/jQuery.js" type="text/javascript"></script>
    <script src="../scripts/loadmask.js" type="text/javascript"></script>
    <script src="../scripts/jquery.dataTables.min.js" type="text/javascript"></script>
    <script src="../scripts/jquery.autocomplete.js"></script>
    <script src="../scripts/stepper.min.js"></script>
    <script src="../scripts/common.js" type="text/javascript"></script>
    <script src="../scripts/utilities" type="text/javascript"></script>
    <script src="https://cdn.worldpay.com/v1/worldpay.js"></script>
    <script type="text/javascript" src="https://js.stripe.com/v2/"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">



    <style type="text/css">

        .switch-field {
            overflow: hidden;
        }

        .mgLeft {
            margin-left: 2%;
        }

        @media screen and (min-width: 1500px) {
            .mgLeft {
                margin-left: 7%;
            }
        }

        .switch-field input {
            position: absolute !important;
            clip: rect(0, 0, 0, 0);
            height: 1px;
            width: 1px;
            border: 0;
            overflow: hidden;
        }

        .phoneMailBtn {
            width: 80px !important;
        }

        .inPersonBtn {
            width: 191px !important;
        }

        .cvvLbl {
            min-width: 102px !important;
            display: inline-block !important;
        }

        .expLbl {
            min-width: 102px !important;
            display: inline-block !important;
        }

        .amtOwArea {
            width: 310px !important;
        }

        .fa, .fas, .far {
            font-size: 18px !important;
            vertical-align: middle;
        }

        .switch-field label {
            float: left;
        }

        .switch-field label {
            margin-right: 5px;
            display: block;
            text-align: center;
            text-shadow: none;
            border: 1px solid #b4b4b4;
            -webkit-transition: all 0.1s ease-in-out;
            -moz-transition: all 0.1s ease-in-out;
            -ms-transition: all 0.1s ease-in-out;
            -o-transition: all 0.1s ease-in-out;
            transition: all 0.1s ease-in-out;
            -webkit-box-shadow: none;
            box-shadow: none;
            font-weight: bolder;
            color: #243a5e;
            font-family: 'Hind', sans-serif;
            font-size: 16px;
            background-color: #cccccc;
            padding: 3px 12px 3px 12px;
            text-transform: uppercase;
            cursor: pointer !important;
            white-space: nowrap;
            margin-bottom: 5px;
            width: 130px;
        }

        .packageInfo-inner .switch-field label {
            padding: 5px 15px 5px 15px;
            width: auto !important
        }

        hr {
            border: 0;
            border-top: 1px solid #ccc;
        }

        .switch-field label:hover {
            color: white;
            border: 1px solid #243a5e;
            background-color: #243a5e;
        }

        /*.switch-field input:checked + label { background-color: #95BCF2; -webkit-box-shadow: none; box-shadow: none; }*/
        .switch-field input:checked + label {
            color: white;
            border: 1px solid #243a5e;
            background-color: #243a5e;
        }

        .switch-field label:first-of-type {
            border-radius: 0px;
        }

        .switch-field label:last-of-type {
            border-radius: 0px;
        }

        .icon {
            width: 25px;
        }

        .form-container {
            margin-bottom: 20px;
            background-color: white;
            padding: 20px;
            border-top: 0.6em solid #243a5e;
            padding-top: 15px !important;
        }

        .main-button {
            text-align: center !important;
            text-shadow: none !important;
            border: 1px solid #b4b4b4 !important;
            background-color: #cccccc !important;
            -webkit-transition: all 0.1s ease-in-out !important;
            -moz-transition: all 0.1s ease-in-out !important;
            -ms-transition: all 0.1s ease-in-out !important;
            -o-transition: all 0.1s ease-in-out !important;
            transition: all 0.1s ease-in-out !important;
            padding: 5px 6px 3px 6px !important;
            font-family: 'Hind', sans-serif !important;
            font-weight: bolder !important;
            text-transform: uppercase !important;
            font-size: 14px !important;
            color: #243a5e !important;
            cursor: pointer !important;
            border-radius: 0px !important;
            background-clip: initial !important;
            margin: 0 !important;
            margin-top: 0px !important;
            line-height: unset !important;
            margin-right: 5px !important;
            white-space: nowrap !important;
        }

            .main-button:hover {
                cursor: pointer !important;
                color: white !important;
                border: 1px solid #243a5e !important;
                background-color: #243a5e !important;
            }

            .main-button .button-icon {
                margin-left: 10px !important;
                text-rendering: optimizeLegibility !important;
                vertical-align: top;
                margin-top: 1px;
            }

        .main-button-BkNx {
            border: 2px solid #1D2122 !important;
            background-color: #1D2122 !important;
            padding: 4px 10px 0px 10px !important;
            font-family: 'Hind', sans-serif !important;
            font-weight: bold !important;
            text-transform: uppercase !important;
            font-size: 14px !important;
            color: #fff !important;
            cursor: pointer !important;
            letter-spacing: 0.4px !important;
            border-radius: 0px !important;
            margin-top: 0px !important;
            background-clip: initial !important;
            margin: 0 !important;
            line-height: unset !important;
            margin-right: 5px !important;
        }

            .main-button-BkNx:hover {
                color: white !important;
                border: 2px solid #243a5e !important;
                background-color: #243a5e !important;
            }

            .main-button-BkNx .button-icon {
                margin-left: 10px !important;
                text-rendering: optimizeLegibility !important;
                vertical-align: top;
                margin-top: 1px;
            }

        .container span.field-label {
            display: inline-block;
            min-width: 100px;
        }

        .content-details {
            margin-left: 0.5%;
        }

        .eventPackageFields input[type=text] {
            width: 176px !important;
        }

        .content-details input, .content-details select {
            margin: 6px;
            padding: 3px 8px;
            font-size: 14px;
            line-height: 1.5;
            color: #495057;
            background-color: #fff;
            background-clip: padding-box;
            border: 1px solid #ced4da;
            border-radius: 5px;
            transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out;
            margin-top: 1px;
        }

        .form-control-textarea {
            display: block;
            width: 100%;
            z-index: 2; /*This fixes an issue where labels may overlap a text box.*/
            min-width: 100%;
            height: calc((1.5em + 0.75rem) + 20px);
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            color: rgb(73, 80, 87);
            background-color: rgb(255, 255, 255);
            background-clip: padding-box;
            padding: 0.375rem 0.75rem;
            border-width: 1px;
            border-style: solid;
            border-color: rgb(206, 212, 218);
            border-image: initial;
            border-radius: 0.25rem;
            transition: border-color 0.15s ease-in-out 0s, box-shadow 0.15s ease-in-out 0s;
        }

        .ptb10 {
            padding: 10px 0;
        }
        /*.content-header h2, .content-header i { cursor: pointer; }*/
        .content-header h2 {
            color: #7C7C7C;
        }

        .content-header i {
            cursor: pointer;
            border: solid #7C7C7C;
            display: inline-block;
            border-width: 0 3px 3px 0;
        }

        .package-main span.field-label {
            min-width: 89px;
        }

        .reducLabel span.field-label {
            min-width: 89px;
        }

        _:-ms-lang(x), .reducLabel {
            padding-bottom: 15px !important;
        }

        .text-right {
            text-align: right;
        }

        .width100 {
            width: 100%;
        }

        input:disabled {
            opacity: 0.5;
        }

        .packageInfo {
            margin: 10px 0;
            padding: 20px;
            border: 1px solid #666;
        }

        .mandatory span:after {
            content: '*';
            color: red;
            font-weight: bold;
            font-size: 15px;
            padding-left: 3px;
        }

        input.search-box {
            background-color: white;
            background-image: url('msnfp_searchicon.png');
            background-position: 98% 1px;
            background-repeat: no-repeat;
            padding-right: 5%;
            border: 1px solid rgb(169, 169, 169);
        }

            input.search-box:disabled {
                background: #e5e5e5;
            }

        input.search-box {
        }

        .error-msg {
            font-weight: bold;
        }

        .subsequent-main {
            max-width: 400px;
        }

        .eventPackageFields select {
            min-width: 145px;
        }

        .red-border {
            border: solid 1px #CD2828 !important;
        }

        .blue-text {
            color: #1160b7;
            cursor: pointer;
            display: block;
            margin: 5px 10px;
        }

        .wizard {
            width: 100% !important;
            background-image: linear-gradient(to left, #ededed 0, #ededed 90px, lightgray 90px, lightgray 1113px, #ededed 0px, #ededed) !important;
            background-size: 100% 3px;
            background-position: bottom;
            background-repeat: no-repeat;
        }

            .wizard a {
                text-transform: uppercase;
                position: relative;
                display: inline-block;
                min-width: 110px;
                text-align: center;
                cursor: auto;
                /*width: 1;*/
                width: auto;
                font-size: 17px;
                font-weight: 600;
                font-family: 'Hind', sans-serif;
                letter-spacing: 2px;
                padding-left: 25px;
                margin-top: 10px;
                background: url('../msnfp_/images/dot_grey.png') no-repeat 56%;
                background-size: auto 25%;
                height: 85px;
                color: #cdcdcd;
                pointer-events: none;
            }
                /*.wizard a:before { width: 0; height: 0; border-top: 25px inset transparent; border-bottom: 25px inset transparent; border-left: 20px solid #fff; position: absolute; content: ""; top: 0; left: 0; }
        .wizard a:after { width: 0; height: 0; border-top: 25px inset transparent; border-bottom: 25px inset transparent; border-left: 20px solid #7C7C7C; position: absolute; content: ""; top: 0; right: -20px; z-index: 2; }*/
                .wizard a:first-child:before,
                .wizard a:last-child:after {
                    border: none;
                }

            .wizard .badge {
                margin: 0 5px 0 18px;
                position: relative;
                top: -1px;
            }

            .wizard a:first-child .badge {
                margin-left: 0;
            }
            /*.wizard .current { background: #243a5e; color: #fff; }*/
            .wizard .current {
                background: url('../../msnfp_/images/dot_red.png') no-repeat 56%;
                background-size: auto 25%;
                color: #000;
                cursor: pointer;
                pointer-events: auto;
            }

            .wizard .clicked {
                text-decoration: underline;
            }

            .wizard .current:after {
                border-left-color: #243a5e;
            }

            .wizard .current.grey:after {
                border-left-color: #888;
            }

        .packageInfo-inner {
            height: 310px;
            overflow-y: auto;
            margin-bottom: 3px;
            background-color: white;
            padding: 20px;
            border-top: 0.6em solid #243a5e;
            padding-top: 15px !important;
        }

        .currencySymbol {
            font-size: 21px;
            padding-right: 5px;
            margin-left: 7px;
        }


        .lbl-PayForPackage {
            font-size: 14px;
            font-weight: bolder;
            color: #e60000;
        }

        #amountCont {
            background: #ededed;
            height: 36px;
            line-height: 36px;
            width: 98%;
        }   

        .js-stepper {
            -moz-appearance: textfield;
        }

            .js-stepper::-webkit-inner-spin-button,
            .js-stepper::-webkit-outer-spin-button {
                -webkit-appearance: none;
                margin: 0;
            }

        .donationCustomAmount {
            width: 50px;
            height: 27px;
            vertical-align: top;
            margin-top: 5px !important;
        }

        .ticketAmount, .donationAmount, .productAmount, .sponsorshipAmount {
            font-size: 21px;
            padding-left: 10px;
        }



        h3 {
            margin-bottom: 0px !important;
            font-size: 16px;
        }

        .ticketQuantity, .productQuantity, .sponsorshipQuantity {
            margin-bottom: 0px !important;
            width: 37px !important;
            height: 27px;
            padding: 0px !important;
            text-align: center;
            padding-top: 4px !important;
        }

            .ticketQuantity::-webkit-inner-spin-button,
            .ticketQuantity::-webkit-outer-spin-button {
                -webkit-appearance: none;
                margin: 0;
            }

            .productQuantity::-webkit-inner-spin-button,
            .productQuantity::-webkit-outer-spin-button {
                -webkit-appearance: none;
                margin: 0;
            }

            .sponsorshipQuantity::-webkit-inner-spin-button,
            .sponsorshipQuantity::-webkit-outer-spin-button {
                -webkit-appearance: none;
                margin: 0;
            }

        .change-quantity {
            height: 20px;
            width: 18px;
            border: 1px solid lightgrey;
            color: #243a5e;
            background-color: white;
            display: inline-flex;
            margin-right: -8px;
            padding-left: 7px;
            padding-top: 5px;
            vertical-align: top;
            margin-left: -8px;
            margin-top: 1px;
            cursor: pointer;
        }

        .disBtn {
            opacity: 0.85;
            cursor: auto !important;
            pointer-events: none !important;
        }


        div.relative {
            position: relative;
            width: 900px;
            /*border: 3px solid #73AD21;*/
        }

        div.absolute {
            position: absolute;
            top: 0px;
            right: -10px;
            width: 400px;
            /*height: 200px;*/
            overflow: auto;
            /*border: 3px solid #73AD21;*/
            z-index: 100;
        }

        #first {
            width: 700px;
            float: left; /** add this **/
            border: 5px solid lime;
            margin: 5px 5px auto 5px;
            overflow: hidden;
        }

        #second {
            width: 300px;
            float: left; /** add this **/
            border: 5px solid yellow;
            overflow: hidden; /* if you don't want #second to wrap below #first */
            margin: 5px 5px auto 5px;
            /**
        What is margin: 5px 5px auto 5px; ???
         margin-top: 5px;
         margin-right: 5px;
         margin-bottom:5px;
         margin-right: 5px;
         **/
            overflow: hidden;
        }




        #lblConst {
            cursor: pointer !important;
        }

        .acknoledgemetnError, .ticket-error, .table-error, .wizard-error {
            color: red;
        }

        .chkClientAgree, .chkDonationItem, .chkEventPreference {
            width: 20px;
            height: 20px;
        }

        .ticket-item, .product-item, .donation-item {
            border-bottom: 1px solid #ccc;
            padding-bottom: 0px;
            margin-bottom: 5px;
        }

        .product-list h3 {
            margin-bottom: 0;
        }

        .product-list input {
            width: 100px;
        }

        .paying-info input {
            width: 100px;
        }

        .paying-info {
            margin-top: -5px !important;
        }

        .bgGray {
            background-color: #f3f3f3;
        }

        .errorMSG {
            color: red;
        }

        .payment-detail span.field-label {
            min-width: 120px;
        }

        .payment-detail input[type=text] {
            min-width: 165px;
        }

        .packageInfo-inner.payment-detail input[type=text] {
            max-width: 165px;
        }

        .payment-detail select {
            min-width: 165px;
            height: 30px;
        }

        .accType {
            min-width: 165px;
        }

        .cheque-details, .credit-details, .bank-details span.field-label {
            padding-left: 5px;
        }

        .loader {
            position: fixed;
            left: 0px;
            top: 0px;
            width: 100%;
            height: 100%;
            z-index: 9999;
            background: url('msnfp_ajaxLoader.gif') 50% 50% no-repeat #ccc;
            opacity: .8;
        }

        #ajax-loader {
            position: fixed;
            width: 100%;
            height: 100%;
            text-align: center;
            background: grey;
            opacity: 0.8;
            filter: alpha(opacity=40);
            display: none;
            background: lightGrey url("msnfp_ajaxLoader.gif") no-repeat center center;
            z-index: 2000;
        }

        .bottom-section input[type=text], .bottom-section button {
            min-width: 100px;
        }

        .back-color {
            background-color: #243a5e !important;
        }

        @media screen and (max-width: 1380px) {
            .phoneMailBtn {
                width: 71px !important;
            }

            .inPersonBtn {
                width: 173px !important;
            }

            .mgLeft {
                margin-left: 2% !important;
            }

            /*.wizard {
                width: 100% !important;
                background-image: linear-gradient(to left, #ededed 0, #ededed 60px, lightgray 60px, lightgray 705px, #ededed 0px, #ededed) !important;
            }*/

            .payment-detail input[type=text] {
                min-width: 100px !important;
            }

            .packageInfo-inner.payment-detail input[type=text] {
                max-width: 100px !important;
            }

            .payment-detail select {
                max-width: 100px !important;
                min-width: 100px !important;
            }

            .wizard a {
                min-width: 40px !important;
                font-size: 16px !important;
            }

            .amtOwArea {
                width: 243px !important;
            }

            .payment-detail .switch-field label {
                padding: 5px 7px 5px 7px !important;
                width: auto !important;
                font-size: 15px !important;
            }

            .payment-detail .fa, .fas, .far {
                font-size: 16px !important;
                vertical-align: middle !important;
            }

            .accType {
                min-width: 100px !important;
            }

            .cvvLbl {
                min-width: 101px !important;
            }

            .expLbl {
                min-width: 101px !important;
            }
        }

        @media screen and (min-width: 1700px) {
            .mgLeft {
                margin-left: 12%;
            }
        }
    </style>
<meta></head>
<body style="word-wrap: break-word; margin: 0px;">
    <div id="ajax-loader"></div>
    <select id="ddlPaymentGateway" hidden="hidden">
        <option value=""></option>
        <option value="844060000">Moneris</option>
        <option value="844060001">Authorize.Net</option>
        <option value="844060002">iATS</option>
        <option value="844060003">Adyen</option>
        <option value="844060004">WorldPay</option>
        <option value="844060005">Stripe</option>
    </select>

    <div class="container manual-main">
        <table cellpadding="0" cellspacing="0" style="background:#ededed;border-style:none; width: 100%;" role="presentation">
            <tbody>
                <tr>
                    <td>
                        <div class="headerFields content-details">
                            <div class="ptb10 cols cols6" style="padding:0px;">

                                <div style="width: 100%; float:left; text-align:center; margin:10px">
                                    <div style="width:1200px;text-align:center;">
                                        <div class="wizard" style="height:50px; text-align:center;">
                                            <a id="acknowledgment">Disclaimer</a>
                                            <a id="sponsorship">Sponsors</a>
                                            <a id="ticket">Tickets</a>
                                            <a id="attendee">Attendees</a>
                                            <a id="preference">Preferences</a>
                                            <a id="product">Products</a>
                                            <a id="donation">Donations</a>
                                            <a id="payment">Purchase </a>
                                        </div>
                                    </div>
                                </div>
                                <div class="cols2">

                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>
                        <div class="package-main content-details">
                            <div class="ms-col-8" style="clear: both;">
                                <input type="hidden" id="txtFirstName">
                                <input type="hidden" id="txtLastName">
                                <input type="hidden" id="txtEmail">
                                <input type="hidden" id="txtPhone">
                                <input type="hidden" id="txtOrganization">
                                <input type="hidden" id="txtAddressLine1">
                                <input type="hidden" id="txtAddressLine2">
                                <input type="hidden" id="txtAddressLine3">
                                <input type="hidden" id="txtAddressCity">
                                <input type="hidden" id="txtAddressProvince">
                                <input type="hidden" id="txtAddressPostalCode">
                                <input type="hidden" id="txtCountry">

                                <div>
                                    <div id="packageInfo" style="margin-right: 27px;">
                                        <div class="packageInfo-inner acknowledgement-detail">
                                            <div class="acknowledgement-list" style="width: 70%">
                                                Acknowledgment
                                            </div>
                                            <div class="acknoledgemetnError hide"></div>
                                        </div>
                                        <div class="packageInfo-inner sponsorship-detail hide">
                                            <div class="sponsorship-list" style="width: 70%">
                                                Sponsorship
                                            </div>
                                            <div class="sponsorshipError hide"></div>
                                        </div>
                                        <div class="packageInfo-inner ticket-detail hide">
                                            <div class="ticket-list" style="width: 70%">
                                                Ticket
                                            </div>
                                        </div>
                                        <div class="packageInfo-inner attendee-detail hide">
                                            <div class="attendee-list" style="width: 70%">
                                                attendees
                                            </div>
                                        </div>
                                        <div class="packageInfo-inner preference-detail hide">
                                            <div class="preference-list" style="width: 70%">
                                                preference
                                            </div>
                                        </div>
                                        <div class="packageInfo-inner product-detail hide">
                                            <div class="product-list" style="width: 70%">
                                                product
                                            </div>
                                        </div>
                                        <div class="packageInfo-inner donation-detail hide">
                                            <div class="donation-list" style="width: 70%">
                                                donation
                                            </div>
                                        </div>
                                        <div class="packageInfo-inner payment-detail hide" style="padding-right:0px !important;">
                                            <div class="ptb10" style="padding:0px;margin-bottom:7px;">
                                                <div class="switch-field">
                                                    <input type="radio" id="radioCash" name="paymentType" value="844060000" checked="">
                                                    <label for="radioCash"><i class="fas fa-money-bill"></i>&nbsp;&nbsp;Cash</label>
                                                    <input type="radio" id="radioCheque" name="paymentType" value="844060001">
                                                    <label for="radioCheque"><i class="fas fa-money-check-alt"></i>&nbsp;&nbsp;Check</label>
                                                    <input type="radio" id="radioCreditDebit" name="paymentType" value="844060002">
                                                    <label for="radioCreditDebit"><i class="fas fa-credit-card"></i>&nbsp;&nbsp;Credit / Debit</label>
                                                    <input type="radio" id="radioWire" name="paymentType" value="844060009">
                                                    <label for="radioWire"><i class="fas fa-exchange-alt"></i>&nbsp;&nbsp;Wire Transfer</label>
                                                    <input type="radio" id="radioInvoiceMe" name="paymentType" value="844060013">
                                                    <label for="radioInvoiceMe">Invoice Me</label>
                                                </div>
                                            </div>
                                            <div class="cash-details">
                                            </div>
                                            <div class="cheque-details hide">
                                                <div class="mb20">
                                                    <span class="spnChequeNumber field-label hide"><label for="txtChequeNumber" title="The check number of the payment process.">Check Number</label></span>
                                                    <span class="spnWireNumber field-label hide"><label title="Wire Number.">Wire Number</label></span>
                                                    <input type="text" aria-label="Check Number" id="txtChequeNumber" onkeypress="return checkIt(event);">
                                                </div>
                                            </div>
                                            <div class="credit-details hide">
                                                <div class="notExists hide">
                                                    <div>
                                                        <span class="field-label"><label for="ddlExistingCard" title="Existing Card.">Existing Card</label></span>
                                                        <select id="ddlExistingCard" aria-label="Existing Card" role="listbox">
                                                            <option value="" role="option">-- Select --</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="exists">
                                                    <div>
                                                        <div style="display: inline-block;">
                                                            <span class="field-label"><label for="txtCardNumber" title="The Card Number used for Payment">Card Number</label></span>
                                                            <input type="text" aria-label="Card Number" id="txtCardNumber" onkeypress="return checkIt(event);"> <!--onblur="cardnumber(this)"-->
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <div style="display: inline-block;">
                                                            <span class="field-label"><label for="txtCardName" title="The Name on the Card used for Payment">Name on the Card</label></span>
                                                            <input type="text" aria-label="Name on the Card" id="txtCardName">
                                                        </div>
                                                        <div>
                                                            <span class="field-label"><label for="txtExpiry" title="The expiry of the Card used for Payment">Expiry</label></span>
                                                            <input type="text" aria-label="The expiry of Card used for Payment" id="txtExpiry">
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <span class="field-label"><label for="ddlCardType" title="The type of the Card used for payment">Credit Card Type</label></span>
                                                        <select id="ddlCardType" aria-label="The type of the Card used for payment" role="listbox">
                                                            <option value="" role="option">-- Select --</option>
                                                            <option value="844060000" role="option">Visa</option>
                                                            <option value="844060001" role="option">Master Card</option>
                                                            <option value="844060002" role="option">Visa Debit</option>
                                                            <option value="844060003" role="option">Master Card Debit</option>
                                                            <option value="844060004" role="option">American Express</option>
                                                            <option value="844060005" role="option">Diners Club</option>
                                                            <option value="844060006" role="option">JCB</option>
                                                            <option value="844060007" role="option">Interact</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="paying-info">
                                                <table class="width100" role="presentation">
                                                    <tbody>
                                                        <tr class="applyDiscount hide">
                                                            <td colspan="2" style="padding-top: 6px;padding-bottom: 2px;">
                                                                <span class="field-label" style="width: 125px;padding-right: 0px;"><label for="txtApplyDiscount" title="Apply a Discount">Apply a Discount</label></span>
                                                                <input style="margin-bottom: 0px;" type="text" id="txtApplyDiscount" value="0">
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td class="amtOwArea" style="margin-top:0px; padding-top:5px;padding-right:2px !important;">
                                                                <span class="field-label"><label for="txtAmountOwning" title="Total Amount Owning">Amount Owning</label></span>
                                                                <input aria-label="Amount Owning" type="text" id="txtAmountOwning" disabled="disabled" value="0">
                                                            </td>
                                                            <td style="margin-top: 0px; padding-top: 5px; padding-left: 0px;">
                                                                <span class="field-label" style="min-width:80px !important; padding-right: 0px !important;"><label for="txtPayingToday" title="Amount Paying Today">Paying Today</label></span>
                                                                <input type="text" aria-label="Amount Paying Today" id="txtPayingToday" value="0">
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td colspan="2">
                                                                <span class="table-error payment-detail-err hide"></span><br>
                                                                <span class="errorMSG hide"></span>
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div class="error-payment hide">
                                                <label id="lblPaymentFailed" class="validationError" role="alert"></label>
                                                <!--<span>Payment Failed</span>--> <br>
                                                <input type="text" class="width100" disabled="disabled" id="txtPaymentFailed">
                                            </div>
                                            <div class="payment-success hide" style="margin-top: 15px;">
                                                <table class="width100" border="0" style="width: 100%;" role="presentation">
                                                    <tbody>
                                                        <tr class="amountOwning">
                                                            <td colspan="4">
                                                                <table border="0" cellpadding="0" cellspacing="0" role="presentation">
                                                                    <tbody><tr>
                                                                        <td>
                                                                            <span>Total </span>
                                                                            <input type="text" aria-label="Total Amount" title="Total Amount" disabled="disabled" class="successTxtAmount">
                                                                        </td>
                                                                        <td>
                                                                            <span>Remaining Balance </span>
                                                                            <input type="text" aria-label="Amount Owning" title="Amount Owning" disabled="disabled" class="successTxtAmountOwning">
                                                                        </td>
                                                                        <td style="text-align: left;">
                                                                            <span>Paid </span>
                                                                            <input type="text" aria-label="Amount Paid" title="Amount Paid" disabled="disabled" class="successTxtAmountPaid">
                                                                        </td>
                                                                    </tr>
                                                                </tbody></table>
                                                            </td>
                                                        </tr>
                                                        <tr class="divPayForPackage hide">
                                                            <td colspan="4">
                                                                <span class="lbl-PayForPackage">This Event Package has not been paid for in full</span> <br>
                                                                <input id="btnPayforPackage" type="button" class="main-button" style="margin:-1px !important;max-width: initial !important;" value="Pay for this Package >"> <br><br>
                                                                <!--<span class="success-PayForPackage">This package has been successfully processed </span>-->
                                                            </td>
                                                        </tr>
                                                        <tr class="divChequeNumber hide">
                                                            <td style="width: 33%;">
                                                                <span class="spnDChequeNumber hide">Check Number</span>
                                                                <span class="spnDWireNumber hide">Wire Number</span>
                                                            </td>
                                                            <td colspan="3" style="width: 66%;">
                                                                <input type="text" disabled="disabled" id="successChequeNumber">
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td style="width: 25%;">
                                                                <input type="button" style="margin:-1px;" class="main-button print-thank-you hide" value="Print Thank You" id="btnPrintThankyou">
                                                            </td>
                                                            <td style=" text-align: center; width: 25%; ">
                                                                <input type="button" value="Print Receipt" class="main-button print-receipt hide" id="btnPrintReceipt">
                                                            </td>
                                                            <td></td>
                                                            <td></td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                        <div class="bottom-section">
                                            <table border="0" role="presentation">
                                                <tbody>
                                                    <tr>
                                                        <td style="width: 38%;vertical-align:bottom;padding-bottom:12px;">
                                                            <button class="main-button-BkNx" id="btnBack" type="button" role="button" aria-label="Back">
                                                                <i class="button-icon fas fa-angle-left" style="margin-right:10px;margin-left:0px !important;"></i> Back
                                                            </button>
                                                        </td>
                                                        <td style="width: 14%;">
                                                            &nbsp;<label aria-label="The number of items purchased with this registration package">Quantity</label><br><input type="text" title="The number of items purchased with this registration package" id="txtQuantity" disabled="disabled" style="margin-left:0px;margin-bottom:0px;width:120px !important;">
                                                        </td>
                                                        <td style="width: 14%;">
                                                            &nbsp;<label aria-label="The total cash, credit or transaction amount (typically the receiptable, Nonreceiptable, membership and any tax amounts)">Total Amount</label><br><input type="text" title="The total cash, credit or transaction amount (typically the receiptable, Nonreceiptable, membership and any tax amounts)" id="txtConfirmAmount" disabled="disabled" style="margin-left:0px;margin-bottom:0px;width:120px !important;">
                                                        </td>
                                                        <td style="width: 34%; text-align: right;vertical-align:bottom;padding-bottom:12px;">
                                                            <div id="clickAreaBtn">
                                                                <button class="main-button-BkNx" id="btnNext" style="margin-right:-4px !important;" type="button" role="button" aria-label="Next">
                                                                    Next <i class="button-icon fas fa-angle-right"></i>
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td></td>
                                                        <td colspan="3">
                                                            <div class="wizard-error hide" role="alert"></div>
                                                            <label style="color:red;" id="lblErrorValidation" role="alert"></label>
                                                            <label style="color:red" id="lblErrorExpiry" role="alert"></label>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="clone-sponsorship hide" style="height: auto;">
        <table class="width100">
            <tbody>
                <tr>
                    <td colspan="3">
                        <h3 class="sponsorshipTitle" tabindex="0">Lead Sponsor</h3>
                        <input type="hidden" class="hiddenSponsorshipId">
                    </td>
                </tr>
                <tr>
                    <td style="width: 160px;">
                        <div id="amountCont">
                            <span class="sponsorshipAmount" tabindex="0"></span>
                        </div>
                    </td>
                    <td style="padding-right: 10px;">
                        <span class="sponsorshipDescription" tabindex="0"></span>
                    </td>
                    <td style="float:right;margin-right:10px;width:80px;">
                        <div class="change-quantity downArrow" tabindex="0" aria-label="down arrow">
                            <i class="fas fa-angle-down"></i>
                        </div>
                        <input aria-label="Sponsorship Quantity" title="Sponsorship Quantity" class="js-stepper sponsorshipQuantity" type="number" step="1" max="10" min="0" data-stepper-debounce="400" value="0" tabindex="0">
                        <div class="change-quantity upArrow" tabindex="0" aria-label="up arrow">
                            <i class="fas fa-angle-up"></i>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td colspan="3">
                        <span class="table-error hide"></span>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="clone-ticket hide" style="height: auto;">
        <table class="width100">
            <tbody>
                <tr>
                    <td colspan="3">
                        <h3 class="ticketTitle" tabindex="0">Single Ticket </h3>
                        <input type="hidden" class="hiddenTicketId">
                    </td>
                </tr>
                <tr>
                    <td style="width: 160px;">
                        <div id="amountCont">
                            <span class="ticketAmount" tabindex="0"></span>
                        </div>
                    </td>
                    <td style="padding-right: 10px;">
                        <span class="ticketDesc" tabindex="0"></span>
                    </td>
                    <td style="float:right;margin-right:10px;width:80px;">
                        <input type="hidden" class="itemsAvailable" value="0">
                        <div class="change-quantity downArrow1" tabindex="0" aria-label="down arrow">
                            <i class="fas fa-angle-down"></i>
                        </div>
                        <input aria-label="Ticket Quantity" title="Ticket Quantity" class="js-stepper ticketQuantity" type="number" step="1" max="10" min="0" data-stepper-debounce="400" value="0" tabindex="0">
                        <div class="change-quantity upArrow1" tabindex="0" aria-label="up arrow">
                            <i class="fas fa-angle-up"></i>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td colspan="3">
                        <span class="errorMSG"></span>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="clone-product hide" style="height: auto;">
        <table class="width100">
            <tbody>
                <tr>
                    <td colspan="3">
                        <h3 class="productTitle" tabindex="0">Product</h3>
                        <input type="hidden" class="hiddenProductId">
                    </td>
                </tr>
                <tr>
                    <td style="width: 160px;">
                        <div id="amountCont">
                            <span class="productAmount" tabindex="0"></span>
                        </div>
                    </td>
                    <td style="padding-right: 10px;">
                        <span class="productDescription" tabindex="0"></span>
                    </td>
                    <td style="float:right;margin-right:10px;width:80px;">
                        <div class="change-quantity downArrow2" tabindex="0" aria-label="down arrow">
                            <i class="fas fa-angle-down"></i>
                        </div>
                        <input type="number" aria-label="Product Quantity" title="Product Quantity" class="js-stepper productQuantity form-control" step="1" min="0" data-stepper-debounce="400" value="0" tabindex="0">
                        <div class="change-quantity upArrow2" tabindex="0" aria-label="up arrow">
                            <i class="fas fa-angle-up"></i>
                        </div>
                        <input type="hidden" class="itemsAvailable" value="0">
                        <select id="ddlProductType" hidden="hidden">
                            <option value="84406000">Apparel</option>
                            <option value="84406001">Miscellaneous</option>
                            <option value="84406002">Publication</option>
                            <option value="84406003">Media</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td colspan="3">
                        <span class="errorMSG"></span>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="clone-donation hide" style="height: auto;">
        <table class="width100">
            <tbody>
                <tr>
                    <td colspan="3">
                        <input type="hidden" class="hiddenDonationId">
                    </td>
                </tr>
                <tr>
                    <td style="width: 160px;">
                        <div id="amountCont">
                            <span class="donationAmount" tabindex="0"></span>
                            <input aria-label="Donation Amount" title="Donation Amount" type="text" class="donationCustomAmount hide" onkeypress="return checkIt(event);">
                        </div>
                    </td>
                    <td>
                        <span class="donationDesc" tabindex="0"></span>
                    </td>
                    <td style="float:right;margin-right:10px;width:15px;">
                        <input type="checkbox" class="chkDonationItem" tabindex="0">
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="clone-attendee hide" style="height: auto;">
        <table class="width100">
            <tbody>
                <tr>
                    <td style="width: 40px;">
                        <input type="hidden" id="hdnEventTicketID" name="hdnEventTicketID" class="hdnEventTicketID">
                        <input type="hidden" id="hdnRecID" name="hdnRecID" class="hdnRecID">
                        <span class="addContact hide">
                            <input aria-label="Check Contact" title="Check Contact" type="checkbox" id="chkContact" name="chkContact" class="chkContact">
                        </span>
                        <i class="fas fa-user-plus fa-xs addContactIcon hide" title="Add as new Contact">
                    </i></td>
                    <td style="width: 10px;">
                        <span class="ticketCounter"></span>
                    </td>
                    <td style="width: 110px;">
                        <div>
                            <input type="text" aria-label="First Name" id="txtRegFirstName" name="txtRegFirstName" class="cFirstName hide" style="width:110px"><span></span>
                        </div>
                    </td>
                    <td style="width: 110px;">
                        <div>
                            <input type="text" aria-label="Last Name" id="txtRegLastName" name="txtRegLastName" class="cLastName hide" style="width:110px"><span></span>
                        </div>
                    </td>
                    <td style="width: 170px;">
                        <div>
                            <input type="text" aria-label="Email Address" id="txtRegEmail" name="txtRegEmail" class="cEmail hide" style="width:170px"><span></span>
                        </div>
                    </td>
                    <td style="width: 100px;">
                        <div>
                            <input type="text" aria-label="Phone Number" id="txtRegPhone" name="txtRegPhone" class="cPhone hide" style="width:100px"><span></span>
                        </div>
                    </td>
                </tr>
                <!--<tr>
                    <td colspan="7">
                        <span class="errorMSG"></span>
                    </td>
                </tr>-->
            </tbody>
        </table>

    </div>


    <div class="clone-preferences-main hide" style="height: auto;">

        <div class="relative">
            <table style="width:460px; background-color:white">
                <tbody>
                    <tr style="border-bottom: 1px solid #cccccc;">
                        <td>
                            <input type="hidden" id="txtEventTicketID" name="txtEventTicketID" class="hiddenEventTicketID">
                            <input type="hidden" id="hdnAttendeeID" name="hdnAttendeeID" class="hdnAttendeeID">
                            <input type="hidden" id="txtRID" name="txtRID">
                            <span id="txtPrefCounter"></span>.
                        </td>
                        <td style="width: 300px;">
                            <div>
                                <b><span id="txtPrefName"></span></b>
                            </div>
                        </td>

                        <td style="width: 120px;">
                            <a class="aLink" style="color:dimgrey">Add Preference</a>
                        </td>
                    </tr>
                </tbody>
            </table>

            <div class="absolute">
                <div class="aLinkContent" style="display: none;">
                    <div id="closeBtn" style="display:inline-block; cursor: pointer;font-size:large;float:right;">Ã</div>
                    <div id="dContent" style="width:370px;" class="dContent"></div>
                </div>

            </div>
        </div>
    </div>

    <script type="text/javascript">
        var PaymentType = {
            Cash: 844060000,
            Cheque: 844060001,
            Wire: 844060009,
            CreditDebit: 844060002,
            Bank: 844060003,
            Invoice: 844060013
        }

        var GiftSource = {
            Phone: 844060000,
            Inperson: 844060001,
            Mail: 844060002,
            Online: 844060003
        }

        var StepList = {
            Acknowledgements: 0,
            Sponsorship: 1,
            Tickets: 2,
            Attendees: 3,
            Preference: 4,
            Products: 5,
            Donation: 6,
            Payment: 7
        }
        var currentStep = 0;

        var xrm;// = window.parent.Xrm;
        var formType;// = xrm.Page.ui.getFormType();
        var currentID;// = xrm.Page.data.entity.getId().replace('{', '').replace('}', '');
        var userConfigID = null;

        var eventPackage;

        var donorList = [];
        var selectedDonor = null;
        var donorId = null;

        var constituteList = [];
        var selectedConstitute = null;
        var constituteId = null;

        var eventID = null;
        var selectedEvent = null;
        var eventList = [];

        var clickOnButton = false;
        var listAcknowledgement = [];
        var listTickets = [];
        var listAttendees = [];
        var listAttendeesEdited = [];
        var listPreferencesEdited = [];
        var listSponsorships = [];
        var listProducts = [];
        var listDonations = [];

        var enableSponsorshipDicsount = false;
        var enableEventPackageDiscount = false;

        var displayCreditDetails = true;
        var bankExists = false;
        var cardExists = false;

        var wizardTotalAmount;
        var totalDonationAmount = 0;
        var isRetry = false;

        var thankyouReportId = null;
        var printReceiptReportId = null;
        var isAcknowledgement = false;
        var isSponsorship = false;
        var isTickets = false;
        var isProducts = false;
        var isDonations = false;
        var isNew = false;
        var isBack = false;

        var showName = false;
        var showEmail = false;
        var showPhone = false;
        var mandateName = false;
        var mandateEmail = false;
        var mandatePhone = false;
        var matchContact = false;
        var autoCreateContact = false;
        var showCreateContact = false;
        var matchNames = false;
        var matchEmail = false;
        var matchPhone = false;
        var matchAddress = false;

        var configRecord = null;
        var query = null;
        var currencySymbol = "";
        var creditCardType;
        var isoCurrencyCode;
        var currentEventPackageID;
        var parentEventRec;
        var cardId;
        var bankId;
        var paymentMethodId = null;
        var isEnableInvoiceMe = false;
        var selectedPaymentType;
        var transactioncurrencyID;
        var eventPreferenceSelectHTML;
        var userSettings;


        $(document).ready(function () {
            xrm = XrmUtility.get_Xrm();
            formType = xrm.Page.ui.getFormType();
            currentID = xrm.Page.data.entity.getId().replace('{', '').replace('}', '');

            jQuery.ajax({
                url: `${parent.Xrm.Page.context.getClientUrl()}/api/data/v9.1/usersettingscollection(${MissionFunctions.GetCurrentUserID()})`,
                success: function (result) {
                    userSettings = result;
                },
                async: false
            });

            //get Configuration record
            xrm.Page.getAttribute("transactioncurrencyid").addOnChange(getCurrencySymbol);

            getCurrencySymbol();

            var currentuserID = xrm.Page.context.getUserId().replace('{', '').replace('}', '').toUpperCase();
            var userSelect = "systemusers?$select=systemuserid,_msnfp_configurationid_value"
            userSelect += "&$filter=systemuserid eq " + currentuserID;
            var user = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + userSelect);
            user = user[0];

            if (!isNullOrUndefined(user._msnfp_configurationid_value)) {

                userConfigID = user._msnfp_configurationid_value;

                var select = "msnfp_configurations?$select=msnfp_configurationid,";
                select += "_msnfp_paymentprocessorid_value,msnfp_event_cash,msnfp_event_cheque,";
                select += "msnfp_event_credit,msnfp_event_wire_transfer,msnfp_event_discounts,";
                select += "msnfp_event_invoice,msnfp_label_cash,msnfp_label_cheque,msnfp_label_wire,msnfp_label_invoiceme,";
                select += "msnfp_event_showname,msnfp_event_showemail,msnfp_event_showphone,msnfp_event_mandatename,msnfp_event_mandateemail,msnfp_event_mandatephone,";
                select += "msnfp_event_matchcontact,msnfp_event_autocreatecontact,msnfp_event_showcreatecontact,";
                select += "msnfp_event_matchnames,msnfp_event_matchemail,msnfp_event_matchphone,msnfp_event_matchaddress,";
                select += "msnfp_label_creditcard,msnfp_event_printthankyou,msnfp_event_printreceipt";
                select += "&$expand=msnfp_PaymentProcessorId($select=msnfp_testmode,msnfp_avsvalidation)";
                var filter = "&$filter=(statuscode eq 1 and msnfp_configurationid eq " + user._msnfp_configurationid_value + ")";
                //var filterQuery = "&$filter=(statuscode eq 1)";
                var configResult = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + select + filter);
                configRecord = configResult[0];

                showHideGiftType();
                showHideButtons();
                validateRegistrationContact();
            }

            if (formType == FormType.Update) {
                isNew = false;
                loadProcessedPackageNagigation();
                loadEventPackage(currentID);
            }

            else if (formType == FormType.Create) {
                isNew = true;
                customerChange();
                eventChange();
            }

            $('input[name=paymentType]').change(function () {
                var errorMSG = $(this).closest('div.payment-detail').find('.errorMSG')[0];
                $(errorMSG).html('');

                var selectedVal = $('input[name=paymentType]:checked').val();
                $('.cash-details, .cheque-details, .credit-details, .bank-details').addClass('hide');
                $('#txtChequeNumber').closest('div').removeClass('mandatory');
                $('#txtChequeNumber').attr('aria-required', false);
                selectedPaymentType = selectedVal;

                addRemoveCardValidation();

                if (selectedVal == PaymentType.Cash) {
                    $('.cash-details').removeClass('hide');
                }
                else if (selectedVal == PaymentType.Cheque) {
                    $('.cheque-details').removeClass('hide');
                    $('.spnWireNumber').hide();
                    $('.spnChequeNumber').show();
                    $('#txtChequeNumber').closest('div').addClass('mandatory');
                    $('#txtChequeNumber').attr('aria-required', true);
                    $('#txtChequeNumber').attr('aria-label', 'Check Number');
                }
                else if (selectedVal == PaymentType.Wire) {
                    $('.cheque-details').removeClass('hide');
                    $('.spnChequeNumber').hide();
                    $('.spnWireNumber').show();
                    $('#txtChequeNumber').closest('div').addClass('mandatory');
                    $('#txtChequeNumber').attr('aria-required', true);
                    $('#txtChequeNumber').attr('aria-label', 'Wire Number');
                }
                else if (selectedVal == PaymentType.CreditDebit) {
                    $('.credit-details').removeClass('hide');
                    addRemoveCardValidation();
                    $('#ddlExistingCard').change();
                }
            });

            $('input[name=annonymousDonation]').change(function () {
                manageTab(this);
                var selectedVal = $('input[name=annonymousDonation]:checked').val();
                if (selectedVal == 'true') {
                    xrm.Page.getAttribute("msnfp_customerid").setRequiredLevel("none");
                    xrm.Page.getAttribute("msnfp_constituentid").setRequiredLevel("none");
                }
                else {
                    xrm.Page.getAttribute("msnfp_customerid").setRequiredLevel("required");
                    if (selectedDonor != null && selectedDonor.isAccount) {
                        xrm.Page.getAttribute("msnfp_constituentid").setRequiredLevel("required");
                    }
                }
            });

            $('input[name=giftSource]').change(function () {
                manageTab(this);
            });

            $('wizard a').click(function () {
                return false;
            });

            $(document).on('click', '#closeBtn', function () {
                $('.aLinkContent').hide();
            });

            $(document).on('click', '#lblConst', function () {
                if ($(this).prev().is(':checked'))
                    $(this).prev().each(function () { this.checked = false; });
                else {
                    $(this).prev().each(function () { this.checked = true; });
                    $(this).prev().html('');
                }
                clientAgree();
            });

            $('#acknowledgment').click(function () {
                if (isNew) {
                    currentStep = StepList.Acknowledgements;
                    isBack = true;
                    loadCurrentWizardDetails();
                }
            });

            $('#sponsorship').click(function () {
                if (isNew) {
                    currentStep = StepList.Sponsorship;
                    isBack = true;
                    loadCurrentWizardDetails();
                }
            });

            $('#ticket').click(function () {
                if (isNew) {
                    currentStep = StepList.Tickets;
                    isBack = true;
                    loadCurrentWizardDetails();
                }
            });

            $('#product').click(function () {
                if (isNew) {
                    currentStep = StepList.Products;
                    isBack = true;
                    loadCurrentWizardDetails();
                }
            });

            $('#donation').click(function () {
                if (isNew) {
                    currentStep = StepList.Donation;
                    isBack = true;
                    loadCurrentWizardDetails();
                }
            });

            $('#preference').click(function () {
                if (isNew) {
                    currentStep = StepList.Preference;
                    isBack = true;
                    loadCurrentWizardDetails();
                }
            });

            $('#payment').click(function () {
                if (isNew) {
                    currentStep = StepList.Payment;
                    isBack = true;
                    loadCurrentWizardDetails();
                }
            });

            $('#btnNext').click(function () {
                isBack = false;
                if (currentStep == StepList.Payment) {
                    $('.wizard-error').hide();
                    if (isRetry) {
                        isRetry = false;
                        $('#btnNext').html('Next <i class="button-icon fas fa-angle-right"></i>');
                        $('.error-payment').addClass('hide');
                        $('.paying-info').removeClass('hide');
                        resetPaymentFields();
                        return;
                    }
                    if (validate()) {
                        if (validateAmounts()) {
                            saveEventPackage();
                        }
                    }
                    else {
                        $('.wizard-error').show();
                        //$('.wizard-error').html('Please fill mandatory fields');
                    }
                    $('.payment-detail').removeClass('hide');
                    return;
                }
                else {
                    var stepValidated = true;

                    if (currentStep == StepList.Attendees) {
                        $('.wizard-error').hide();
                        stepValidated = validateAttendees();
                        if (!stepValidated) {
                            $('.wizard-error').show();
                            //$('.wizard-error').html('Please fill mandatory fields');
                        }

                        updateAttendeeList();
                    }

                    if (currentStep == StepList.Preference) {
                        $('.wizard-error').hide();
                        stepValidated = validateMandatoryEventPreference();
                        if (!stepValidated) {
                            $('.wizard-error').show();
                            $('.wizard-error').html('Please provide details for event preference selected');
                        }

                        updatePreferenceList();
                    }

                    if (stepValidated) {
                        if (currentStep == StepList.Products && isEnableInvoiceMe)
                            currentStep = currentStep + 2;
                        else
                            currentStep = currentStep + 1;
                        loadCurrentWizardDetails();
                    }
                }
            });

            $('#btnBack').click(function () {
                isBack = true;

                if (currentStep == StepList.Preference && isEnableInvoiceMe)
                    currentStep = currentStep - 2;
                else
                    currentStep = currentStep - 1;
                loadCurrentWizardDetails();
            });

            $('#clickAreaBtn').click(function () {
                if ($('#btnNext').hasClass('disBtn')) {
                    $('.wizard-error').show();
                    $('.wizard-error').html('Please fill mandatory fields');
                }
            });

            //Sponsorship
            $('.manual-main').on('blur', 'input.sponsorshipQuantity', function () {
                qtyChange($(this));
            });

            $(document).on('click', '.downArrow', function () {
                var oldVal = parseInt($(this).next().find('input.js-stepper.sponsorshipQuantity')['prevObject'].val());
                if (oldVal != 0) {
                    $(this).next().find('input.js-stepper.sponsorshipQuantity')['prevObject'].val(oldVal - 1);
                    qtyChange($(this).next().find('input.js-stepper.sponsorshipQuantity')['prevObject']);
                }
            });

            $(document).on('click', '.upArrow', function () {
                var oldVal = parseInt($(this).prev().find('input.js-stepper.sponsorshipQuantity')['prevObject'].val());
                if (oldVal < $(this).prev().find('input.js-stepper.sponsorshipQuantity')['prevObject'].attr('max')) {
                    $(this).prev().find('input.js-stepper.sponsorshipQuantity')['prevObject'].val(oldVal + 1);
                    qtyChange($(this).prev().find('input.js-stepper.sponsorshipQuantity')['prevObject']);
                }
            });


            $(document).on('click', '.downArrow1', function () {
                var oldVal = parseInt($(this).next().find('input.js-stepper.ticketQuantity')['prevObject'].val());
                if (oldVal != 0) {
                    $(this).next().find('input.js-stepper.ticketQuantity')['prevObject'].val(oldVal - 1);
                    qtyChange1($(this).next().find('input.js-stepper.ticketQuantity')['prevObject']);
                }
            });

            $(document).on('click', '.upArrow1', function () {
                var oldVal = parseInt($(this).prev().find('input.js-stepper.ticketQuantity')['prevObject'].val());
                if (oldVal < $(this).prev().find('input.js-stepper.ticketQuantity')['prevObject'].attr('max')) {
                    $(this).prev().find('input.js-stepper.ticketQuantity')['prevObject'].val(oldVal + 1);
                    qtyChange1($(this).prev().find('input.js-stepper.ticketQuantity')['prevObject']);
                }
            });

            $('.manual-main').on('blur', 'input.ticketQuantity', function () {
                qtyChange1($(this));
            });

            $(document).on('click', '.downArrow2', function () {
                var oldVal = parseInt($(this).next().find('input.js-stepper.productQuantity')['prevObject'].val());
                if (oldVal != 0) {
                    $(this).next().find('input.js-stepper.productQuantity')['prevObject'].val(oldVal - 1);
                    qtyChange2($(this).next().find('input.js-stepper.productQuantity')['prevObject']);
                }
            });

            $(document).on('click', '.upArrow2', function () {
                var oldVal = parseInt($(this).prev().find('input.js-stepper.productQuantity')['prevObject'].val());
                if (oldVal < $(this).prev().find('input.js-stepper.productQuantity')['prevObject'].attr('max')) {
                    $(this).prev().find('input.js-stepper.productQuantity')['prevObject'].val(oldVal + 1);
                    qtyChange2($(this).prev().find('input.js-stepper.productQuantity')['prevObject']);
                }
            });


            $('.manual-main').on('blur', 'input.productQuantity', function () {
                qtyChange2($(this));
            });

            $('.manual-main').on('change', '.chkDonationItem', function () {
                var isChecked = $(this).is(':checked');
                if (isChecked) {
                    uncheckOtherDonations();
                    $(this).prop('checked', true);
                }
                var parentDonationItem = $(this).parents('.donation-item');
                setDonationAmount(parentDonationItem);
            });

            $('.manual-main').on('change', '.donationCustomAmount', function () {
                var parentDonationItem = $(this).parents('.donation-item');
                setDonationAmount(parentDonationItem);
            });

            $('.manual-main').on('change', '#txtApplyDiscount', function () {
                var $this = $(this);

                var tableError = $this.closest('table').find('.table-error')[0];
                $(tableError).hide();

                //var discount = parseFloat($this.val());
                var discount = !isNullOrUndefined($(this).val()) ? parseFloat($(this).val().replace(currencySymbol, '').replace(/[^\d\.\-]/g, "")) : 0;
                $(this).val(currencySymbol + addCommasonLoad(parseFloat(discount.toString()).toFixed(2)));

                if (discount > wizardTotalAmount) {
                    $(tableError).show();
                    $(tableError).html('Discount should not be greater than ' + currencySymbol + addCommasonLoad(parseFloat(wizardTotalAmount.toString()).toFixed(2)));
                    $this.focus();
                }
                else {
                    setTotalAmount();
                }

            });

            $('#ddlExistingCard').change(function () {
                var tableError = $(this).closest('div.payment-detail').find('.errorMSG')[0];
                if ($(this).val() == '-1') {
                    $(tableError).hide();
                    $('.credit-details .exists').show();
                }
                else if ($(this).val() != "") {
                    $(tableError).show();

                    var selectQueryCC = "msnfp_paymentmethods?$select=msnfp_paymentmethodid,_msnfp_paymentprocessorid_value";
                    var filterCC = "&$filter=msnfp_paymentmethodid eq " + $(this).val();
                    var ccResult = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + selectQueryCC + filterCC);

                    if (configRecord._msnfp_paymentprocessorid_value != ccResult[0]._msnfp_paymentprocessorid_value) {
                        var defaultGateway = $('#ddlPaymentGateway option[value=' + configRecord._msnfp_paymentprocessorid_value + ']').text();
                        $(tableError).html('The Credit card ' + $('#ddlExistingCard option:selected').text() + ' is not registered with ' + defaultGateway + ' Payment Gateway.');
                    }
                    else
                        $(tableError).hide();

                    $('.credit-details .exists').hide();
                }
                addRemoveCardValidation();
            });

            $('#txtPayingToday').change(function () {
                var $this = $(this);

                var tableError = $this.closest('table').find('.table-error')[0];
                $(tableError).addClass('hide');

                var amountOwning = parseFloat($('#txtAmountOwning').val().replace(currencySymbol, '').replace(/[^\d\.\-]/g, ""));
                var payingToday = parseFloat($(this).val().replace(currencySymbol, '').replace(/[^\d\.\-]/g, ""));

                if ($(this).val() == '') {
                    $(this).val(currencySymbol + addCommasonLoad(parseFloat(amountOwning.toString()).toFixed(2)));
                    return;
                }
                else {
                    $(this).val(currencySymbol + addCommasonLoad(parseFloat(payingToday.toString()).toFixed(2)));
                }

                validateAmounts();
            });

            xrm.Page.getAttribute("msnfp_eventid").addOnChange(eventChange);
            xrm.Page.getAttribute("msnfp_customerid").addOnChange(customerChange);
            xrm.Page.getAttribute("msnfp_constituentid").addOnChange(constituteChange);

        });


        function validateAmounts() {

            var retval = true;

            var amountOwning = parseFloat($('#txtAmountOwning').val().replace(currencySymbol, '').replace(/[^\d\.\-]/g, ""));
            var payingToday = parseFloat($('#txtPayingToday').val().replace(currencySymbol, '').replace(/[^\d\.\-]/g, ""));
            var errSpan = $("span.payment-detail-err");
            var payingTodayControl = $('#txtPayingToday');

            $('.wizard-error').hide();
            $('#btnNext').removeClass('disBtn');
            $(errSpan).html('');

            if (totalDonationAmount > 0) {
                if (totalDonationAmount > payingToday) {
                    //$('#btnNext').addClass('disBtn');
                    $(errSpan).show();
                    $(errSpan).html('The minimum amount paid today should be equal to or greater than the donation amount of ' + currencySymbol + addCommasonLoad(parseFloat(totalDonationAmount.toString()).toFixed(2)));
                    $(payingTodayControl).focus();
                    retval = false;
                }
            }

            if (payingToday > amountOwning) {
                //$('#btnNext').addClass('disBtn');
                $(errSpan).show();
                $(errSpan).html('Paying Today amount should not be greater than Amount Owning');
                $(payingTodayControl).focus();
                retval = false;
            }

            if (payingToday < 0) {
                //$('#btnNext').addClass('disBtn');
                $(errSpan).show();
                $(errSpan).html('Paying Today amount cannot be negative');
                $(payingTodayControl).focus();
                retval = false;
            }


            return retval;
        }

        function validateItemsAvailable($this) {
            var itemsAvailable = $($($this).closest('div').find('.itemsAvailable')[0]).val();
            var currentValue = $this.val();
            if (currentValue != '') {
                currentValue = parseInt(currentValue);
                if (currentValue > parseInt(itemsAvailable)) {
                    return false;
                }
            }
            return true;
        }

        function showPreferenceDetails(id) {
            $('.aLinkContent').each(function (index) {
                if ($(this).attr("id") == id) {
                    $(this).show();
                }
                else {
                    $(this).hide();
                }
            });
        }


        function qtyChange(qtyInput) {
            var $this = qtyInput;
            var tableError = $this.closest('table').find('.table-error')[0];
            $(tableError).addClass('hide');
            $($this).parents('.sponsorship-item').removeClass('bgGray');

            if (validateMaxQuantity($this)) {
                var currentValue = parseInt($this.val());
                var id = $($this.parents('.sponsorship-item').find('.hiddenSponsorshipId')[0]).val();
                var result = $.grep(listSponsorships, function (e) { return e.id == id; });
                result = result[0];

                if (currentValue > 0) {
                    $($this).parents('.sponsorship-item').addClass('bgGray');

                    result.quantity = currentValue;
                    result.totalAmount = currentValue * result.amount;
                    result.payingToday = currentValue * result.amount;
                    result.discount = 0;
                }
                else {
                    result.quantity = 0;
                    result.totalAmount = 0;
                    result.payingToday = 0;
                    result.discount = 0;
                }
                setTotalAmount();
            }
            else {
                var maxValue = parseInt($this.attr('max'));
                $this.val('0');
                $(tableError).removeClass('hide');
                $(tableError).html('You can select a maximum of ' + maxValue + ' sponsorships.');
                $this.focus();
            }
        }

        function qtyChange1(qtyInput1) {
            var $this = qtyInput1;
            var tableError = $this.closest('table').find('.errorMSG')[0];
            $(tableError).hide();
            $($this).parents('.ticket-item').removeClass('bgGray');

            if (validateMaxQuantity($this)) {
                if (validateItemsAvailable($this)) {
                    var currentValue = parseInt($this.val());
                    var id = $($this.parents('.ticket-item').find('.hiddenTicketId')[0]).val();
                    var result = $.grep(listTickets, function (e) { return e.id == id; });
                    result = result[0];
                    if (currentValue > 0) {
                        $($this).parents('.ticket-item').addClass('bgGray');

                        result.quantity = currentValue;
                        result.totalAmount = result.amount;
                    }
                    else {
                        result.quantity = 0;
                        result.totalAmount = 0;
                    }
                    setTotalAmount();

                    loadAttendeeList();
                    //loadRegistrationList();
                }
                else {
                    var availableTickets = $($($this).closest('div').find('.itemsAvailable')[0]).val();
                    $this.val('0');
                    $(tableError).show();
                    $(tableError).html('You can select from available of ' + availableTickets + ' tickets.');
                    $this.focus();
                }
            }
            else {
                var maxValue = parseInt($this.attr('max'));
                $this.val('0');
                $(tableError).show();
                $(tableError).html('You can select a maximum of ' + maxValue + ' tickets');
                $this.focus();
            }
        }

        function qtyChange2(qtyInput2) {
            var $this = qtyInput2;
            var tableError = $this.closest('table').find('.errorMSG')[0];
            $(tableError).hide();
            $($this).parents('.product-item').removeClass('bgGray');

            if (validateMaxQuantity($this)) {
                if (validateItemsAvailable($this)) {
                    var currentValue = parseInt($this.val());
                    var id = $($this.parents('.product-item').find('.hiddenProductId')[0]).val();
                    var result = $.grep(listProducts, function (e) { return e.id == id; });
                    result = result[0];
                    if (currentValue > 0) {
                        $($this).parents('.product-item').addClass('bgGray');

                        result.quantity = currentValue;
                        result.totalAmount = result.amount;
                    }
                    else {

                        result.quantity = 0;
                        result.totalAmount = 0;
                    }
                    setTotalAmount();
                }
                else {
                    var availableProducts = $($($this).closest('div').find('.itemsAvailable')[0]).val();
                    $this.val('0');
                    $(tableError).show();
                    $(tableError).html('You can select from available of ' + availableProducts + ' products.');
                    $this.focus();
                }

            }
            else {
                var maxValue = parseInt($this.attr('max'));
                $this.val('0');
                $(tableError).show();
                $(tableError).html('You can select a maximum of ' + maxValue + ' products.');
                $this.focus();
            }
        }

        function getCurrencySymbol() {
            var currencyField = xrm.Page.data.entity.attributes.get("transactioncurrencyid").getValue();
            if (!isNullOrUndefined(currencyField)) {
                var currencyid = xrm.Page.data.entity.attributes.get("transactioncurrencyid").getValue()[0].id;
                var currencySelect = "transactioncurrencies?$select=transactioncurrencyid,currencysymbol,isocurrencycode"
                currencySelect += "&$filter=transactioncurrencyid eq " + XrmUtility.CleanGuid(currencyid);
                var currencyRec = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + currencySelect);
                if (!isNullOrUndefined(currencyRec))
                    currencyRec = currencyRec[0];

                if (!isNullOrUndefined(currencyRec)) {
                    currencySymbol = currencyRec.currencysymbol;
                    isoCurrencyCode = currencyRec.isocurrencycode;
                    transactioncurrencyID = currencyRec.transactioncurrencyid;
                    //$('.currencySymbol').val().innerHTML = currencySymbol;
                    $('.currencySymbol').each(function () {
                        $(this)[0].innerText = currencySymbol;
                    });
                }
            }
        }

        function manageTab(current) {
            $(this).children('label').each(function () {
                if (this == current) {
                    $(this).toggleClass('back-color');
                }
                else {
                    $(this).removeClass('back-color');
                }
            });
        }

        function eventChange() {
            //loadCurrentWizardDetails();
            listAcknowledgement = [];
            listSponsorships = [];
            listTickets = [];
            listProducts = [];
            listDonations = [];
            currentStep = 0;

            var event = xrm.Page.data.entity.attributes.get("msnfp_eventid").getValue();
            if (event != null) {
                eventID = XrmUtility.CleanGuid(xrm.Page.data.entity.attributes.get("msnfp_eventid").getValue()[0].id);

                loadAcknowledgementList(eventID);
                loadSponsorshipList(eventID);
                loadTicketList(eventID);
                loadProductList(eventID);
                loadDonationList(eventID);
                clearTotalAmount();
                loadCurrentWizardDetails();
                $('#acknowledgment, #sponsorship, #ticket, #attendee,  #preference, #product, #donation, #payment').removeClass('current');

                // loading navigation
                loadNavigation();

                currentStep = StepList.Acknowledgements;
                isBack = false;
                loadCurrentWizardDetails();
            }
            else {
                $('#btnNext').addClass('disBtn');
                $('#btnBack').addClass('hide');
            }
        }

        function loadProcessedPackageNagigation() {

            var event = xrm.Page.data.entity.attributes.get("msnfp_eventid").getValue();
            if (event != null) {
                eventID = XrmUtility.CleanGuid(xrm.Page.data.entity.attributes.get("msnfp_eventid").getValue()[0].id);

                if (getEventAcknowledgementCount(eventID) > 0) {
                    $('#acknowledgment').show();
                }
                else {
                    $('#acknowledgment').hide();
                }

                if (getEventSponsorshipCount(eventID) > 0) {
                    $('#sponsorship').show();
                }
                else {
                    $('#sponsorship').hide();
                }

                if (getEventTicketCount(eventID) > 0) {
                    $('#ticket').show();
                    $('#attendee').show();
                    $('#preference').show();
                }
                else {
                    $('#ticket').hide();
                    $('#attendee').hide();
                    $('#preference').hide();
                }

                if (getEventProductCount(eventID) > 0) {
                    $('#product').show();
                }
                else {
                    $('#product').hide();
                }

                if (getEventDonationCount(eventID) > 0) {
                    $('#donation').show();
                }
                else {
                    $('#donation').hide();
                }
            }
        }

        function loadNavigation() {

            if (listAcknowledgement.length > 0) {
                $('#acknowledgment').show();
            }
            else {
                $('#acknowledgment').hide();
            }

            if (listSponsorships.length > 0) {
                $('#sponsorship').show();
            }
            else {
                $('#sponsorship').hide();
            }

            if (listTickets.length > 0) {
                $('#ticket').show();
                $('#attendee').show();
                $('#preference').show();
            }
            else {
                $('#ticket').hide();
                $('#attendee').hide();
                $('#preference').hide();
            }

            if (listProducts.length > 0) {
                $('#product').show();
            }
            else {
                $('#product').hide();
            }

            if (!isEnableInvoiceMe && listDonations.length > 0) {
                $('#donation').show();
            }
            else {
                $('#donation').hide();
            }
        }

        function customerChange() {
            var donor = xrm.Page.data.entity.attributes.get("msnfp_customerid").getValue();
            if (donor != null) {
                donorId = xrm.Page.data.entity.attributes.get("msnfp_customerid").getValue()[0].id;
                if (donor[0].entityType == "account") {
                    xrm.Page.getAttribute("msnfp_constituentid").setRequiredLevel("required");
                    select = "accounts(" + XrmUtility.CleanGuid(donorId) + ")?$select=accountid,name,address1_line1,address1_line2,address1_line3,address1_city,address1_stateorprovince,address1_postalcode,address1_country,telephone1,emailaddress1,_primarycontactid_value";
                    expand = "&$expand=primarycontactid($select=contactid,fullname,firstname,lastname)";

                    selectedDonor = XrmServiceUtility.ExecuteQueryWithExpand(XrmServiceUtility.GetWebAPIUrl() + select + expand);
                    if (selectedDonor.primarycontactid != null) {
                        var primaryContactID = selectedDonor.primarycontactid.contactid;
                        var primaryContactName = selectedDonor.primarycontactid.fullname;
                        var primaryContactType = "contact";

                        xrm.Page.getAttribute("msnfp_constituentid").setValue([{ id: primaryContactID, name: primaryContactName, entityType: primaryContactType }]);
                        //$('#txtFirstName').val(selectedDonor.primarycontactid.firstname);
                        //$('#txtLastName').val(selectedDonor.primarycontactid.lastname);
                    }
                    else {
                        xrm.Page.getAttribute("msnfp_constituentid").setValue(null);
                        //$('#txtFirstName').val('');
                        //$('#txtLastName').val('');
                    }

                    constituteChange();
                    selectedDonor.isAccount = true;
                    //$('#txtFirstName').closest('div').removeClass('mandatory');
                    //$('#txtLastName').closest('div').removeClass('mandatory');
                    //$('#txtOrganization').closest('div').addClass('mandatory');
                    $('#txtOrganization').val(selectedDonor.name != null ? selectedDonor.name : "");
                    $('#txtCardName').val(selectedDonor.name != null ? selectedDonor.name : "");
                    $('#txtBankUserName').val(selectedDonor.name != null ? selectedDonor.name : "");
                }
                else if (donor[0].entityType == "contact") {
                    xrm.Page.getAttribute("msnfp_constituentid").setValue(null);
                    xrm.Page.getAttribute("msnfp_constituentid").setRequiredLevel("none");

                    select = "contacts(" + XrmUtility.CleanGuid(donorId) + ")?$select=contactid,firstname,lastname,fullname,address1_line1,address1_line2,address1_line3,address1_city,address1_stateorprovince,address1_postalcode,address1_country,telephone1,emailaddress1,_parentcustomerid_value";
                    expand = "&$expand=parentcustomerid_account($select=accountid,name)";

                    selectedDonor = XrmServiceUtility.ExecuteQueryWithExpand(XrmServiceUtility.GetWebAPIUrl() + select + expand);

                    if (selectedDonor.parentcustomerid_account != null) {
                        var parentCustomerID = selectedDonor.parentcustomerid_account.accountid;
                        var parentCustomerName = selectedDonor.parentcustomerid_account.name;
                        $('#txtOrganization').val(parentCustomerName);
                    }
                    else {
                        $('#txtOrganization').val('');
                    }

                    selectedDonor.isAccount = false;
                    $('#txtFirstName').val(selectedDonor.firstname != null ? selectedDonor.firstname : "");
                    $('#txtLastName').val(selectedDonor.lastname != null ? selectedDonor.lastname : "");
                    $('#txtCardName').val(selectedDonor.fullname != null ? selectedDonor.fullname : "");
                    $('#txtBankUserName').val(selectedDonor.fullname != null ? selectedDonor.fullname : "");
                    $('#txtEmail').val(selectedDonor.emailaddress1 != null ? selectedDonor.emailaddress1 : "");
                    $('#txtPhone').val(selectedDonor.telephone1 != null ? selectedDonor.telephone1 : "");

                    //$('#txtFirstName').closest('div').addClass('mandatory');
                    //$('#txtLastName').closest('div').addClass('mandatory');
                    //$('#txtOrganization').closest('div').removeClass('mandatory');
                }
                //$('#txtEmail').val(selectedDonor.emailaddress1 != null ? selectedDonor.emailaddress1 : "");
                //$('#txtPhone').val(selectedDonor.telephone1 != null ? selectedDonor.telephone1 : "");
                $('#txtAddressLine1').val(selectedDonor.address1_line1 != null ? selectedDonor.address1_line1 : "");
                $('#txtAddressLine2').val(selectedDonor.address1_line2 != null ? selectedDonor.address1_line2 : "");
                $('#txtAddressLine3').val(selectedDonor.address1_line3 != null ? selectedDonor.address1_line3 : "");
                $('#txtAddressCity').val(selectedDonor.address1_city != null ? selectedDonor.address1_city : "");
                $('#txtAddressProvince').val(selectedDonor.address1_stateorprovince != null ? selectedDonor.address1_stateorprovince : "");
                $('#txtAddressPostalCode').val(selectedDonor.address1_postalcode != null ? selectedDonor.address1_postalcode.replace(/\s/g, '') : "");
                $('#txtCountry').val(selectedDonor.address1_country != null ? selectedDonor.address1_country : "");

                $('#radioCash').click();
                loadCreditCardDetail(donorId);

                var event = xrm.Page.data.entity.attributes.get("msnfp_eventid").getValue();
                if (event != null)
                    clientAgree();
            }
            else {
                $('#txtFirstName').val('');
                $('#txtLastName').val('');
                $('#txtCardName').val('');
                $('#txtBankUserName').val('');
                $('#txtOrganization').val('');
                $('#txtEmail').val('');
                $('#txtPhone').val('');
                $('#txtAddressLine1').val('');
                $('#txtAddressLine2').val('');
                $('#txtAddressLine3').val('');
                $('#txtAddressCity').val('');
                $('#txtAddressProvince').val('');
                $('#txtAddressPostalCode').val('');
                $('#txtCountry').val('');
                $('#btnNext').addClass('disBtn');
                $('#btnBack').addClass('hide');
                $('#radioCash').click();
                loadCreditCardDetail(null);
            }
        }

        function constituteChange() {
            var constitute = xrm.Page.data.entity.attributes.get("msnfp_constituentid").getValue();
            var donor = xrm.Page.data.entity.attributes.get("msnfp_customerid").getValue();

            if (constitute != null) {
                constituteId = xrm.Page.data.entity.attributes.get("msnfp_constituentid").getValue()[0].id;
                query = "contacts?";
                query += "$select=contactid,firstname,lastname,emailaddress1,telephone1,fullname&";
                query += "$filter=contactid eq " + XrmUtility.CleanGuid(constituteId) + "";

                var donorResult = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + query);
                selectedConstitute = donorResult[0];

                if (donor != null) {
                    if (donor[0].entityType == "account") {
                        $('#txtFirstName').val(donorResult[0].firstname != null ? donorResult[0].firstname : "");
                        $('#txtLastName').val(donorResult[0].lastname != null ? donorResult[0].lastname : "");
                        $('#txtEmail').val(donorResult[0].emailaddress1 != null ? donorResult[0].emailaddress1 : "");
                        $('#txtPhone').val(donorResult[0].telephone1 != null ? donorResult[0].telephone1 : "");
                        $('#btnNext').removeClass('disBtn');
                    }
                }
            }
            else {

                if (donor != null) {
                    if (donor[0].entityType == "account") {
                        $('#txtFirstName').val('');
                        $('#txtLastName').val('');
                        $('#txtEmail').val('');
                        $('#txtPhone').val('');
                        $('#btnNext').addClass('disBtn');
                    }
                }
            }
        }

        function setMandatoryEventPreference() {

            $('.table-preference .chkEventPreference').each(function () {
                var inputCheckbox = $(this);
                var thisRow = $(this).closest('tr')[0];

                if ($(inputCheckbox).is(':checked') == true) {
                    $(thisRow).find('div.dClass').addClass('mandatory');
                    $(thisRow).find('.txtOther').attr('aria-required', true);
                }
                else {
                    $(thisRow).find('div.dClass').removeClass('mandatory');
                    $(thisRow).find('.txtOther').attr('aria-required', false);
                }

            });
        }


        function validateMandatoryEventPreference() {

            var isValidate = true;

            $('.table-preference .chkEventPreference').each(function () {
                var inputCheckbox = $(this);
                var thisRow = $(this).closest('tr')[0];

                if ($(inputCheckbox).is(':checked') == true) {

                    if ($(thisRow).find('textarea.txtOther').val() == '') {
                        isValidate = false;
                        return false;
                    }
                }
            });

            return isValidate;
        }

        function clientAgree() {
            var r = true;

            $('#acknowledgment').removeClass('grey');
            $('.acknoledgemetnError').addClass('hide');

            $('.acknowledgement-list .chkClientAgree').each(function () {
                var inputCheckbox = $(this);
                if ($(inputCheckbox).is(':checked') == false)
                    r = false;
            });

            if (r) {
                if ($('#txtFirstName').val() != '' && $('#txtLastName').val() != '')
                    $('#btnNext').removeClass('disBtn');
                else
                    $('#btnNext').addClass('disBtn');
            }
            else {
                $('#btnNext').addClass('disBtn');
            }

            if ($('.acknowledgement-list .chkClientAgree').length == 0) {
                $('#acknowledgment').addClass('grey');
            }
        }

        function showHideGiftType() {
            if (configRecord != null) {
                if (configRecord.msnfp_event_cash == false) {
                    $('#radioCash').next('label').remove();
                    $('#radioCash').remove();
                }
                else if (!isNullOrUndefined(configRecord.msnfp_label_cash))
                    $('#radioCash').next('label')[0].innerText = configRecord.msnfp_label_cash;

                if (configRecord.msnfp_event_cheque == false) {
                    $('#radioCheque').next('label').remove();
                    $('#radioCheque').remove();
                }
                else if (!isNullOrUndefined(configRecord.msnfp_label_cheque))
                    $('#radioCheque').next('label')[0].innerText = configRecord.msnfp_label_cheque;

                if (configRecord.msnfp_event_wire_transfer == null || configRecord.msnfp_event_wire_transfer == false) {
                    $('#radioWire').next('label').remove();
                    $('#radioWire').remove();
                }
                else if (!isNullOrUndefined(configRecord.msnfp_label_wire))
                    $('#radioWire').next('label')[0].innerText = configRecord.msnfp_label_wire;

                if (configRecord.msnfp_event_credit == false) {
                    $('#radioCreditDebit').next('label').remove();
                    $('#radioCreditDebit').remove();
                }
                else if (!isNullOrUndefined(configRecord.msnfp_label_creditcard))
                    $('#radioCreditDebit').next('label')[0].innerText = configRecord.msnfp_label_creditcard;

                if (configRecord.msnfp_event_invoice == false) {
                    $('#radioInvoiceMe').next('label').remove();
                    $('#radioInvoiceMe').remove();

                    isEnableInvoiceMe = false;
                    $('.wizard').find('a#donation').css('display', 'inline-block');
                }
                else {
                    isEnableInvoiceMe = true;

                    if (!isNullOrUndefined(configRecord.msnfp_label_invoiceme))
                        $('#radioInvoiceMe').next('label')[0].innerText = configRecord.msnfp_label_invoiceme;

                    $('.wizard').find('a#donation').css('display', 'none');
                    $('.donation-detail').css('display', 'none');
                }

                if (configRecord.msnfp_event_discounts != null && configRecord.msnfp_event_discounts == true)
                    enableEventPackageDiscount = configRecord.msnfp_event_discounts;
            }
        }

        function showHideButtons() {
            if (configRecord != null) {

                if (configRecord.msnfp_event_printthankyou != null && configRecord.msnfp_event_printthankyou == true)
                    $('.print-thank-you').removeClass('hide');

                if (configRecord.msnfp_event_printreceipt != null && configRecord.msnfp_event_printreceipt == true)
                    $('.print-receipt').removeClass('hide');

            }
        }

        function validateRegistrationContact() {
            if (configRecord != null) {

                if (configRecord.msnfp_event_showname != null && configRecord.msnfp_event_showname == true) {
                    showName = true;                                       

                    $('.cFirstName').removeClass('hide');
                    $('.cLastName').removeClass('hide');

                    if (configRecord.msnfp_event_mandatename != null && configRecord.msnfp_event_mandatename == true) {
                        mandateName = true;
                        $('.cFirstName').closest('div').addClass('mandatory');
                        $('.cLastName').closest('div').addClass('mandatory');
                        $(".cFirstName").attr('aria-required', true);
                        $(".cLastName").attr('aria-required', true);
                    }
                }

                if (configRecord.msnfp_event_showemail != null && configRecord.msnfp_event_showemail == true) {
                    showEmail = true;
                    $('.cEmail').removeClass('hide');

                    if (configRecord.msnfp_event_mandateemail != null && configRecord.msnfp_event_mandateemail == true) {
                        mandateEmail = true;
                        $('.cEmail').closest('div').addClass('mandatory');
                        $(".cEmail").attr('aria-required', true);
                    }
                }

                if (configRecord.msnfp_event_showphone != null && configRecord.msnfp_event_showphone == true) {
                    showPhone = true;
                    $('.cPhone').removeClass('hide');

                    if (configRecord.msnfp_event_mandatephone != null && configRecord.msnfp_event_mandatephone == true) {
                        mandatePhone = true;
                        $('.cPhone').closest('div').addClass('mandatory');
                        $(".cPhone").attr('aria-required', true);
                    }
                }

                if (configRecord.msnfp_event_matchcontact != null && configRecord.msnfp_event_matchcontact == true) {
                    matchContact = true;

                    if (configRecord.msnfp_event_autocreatecontact != null && configRecord.msnfp_event_autocreatecontact == true)
                        autoCreateContact = true;

                }

                if (configRecord.msnfp_event_showcreatecontact != null && configRecord.msnfp_event_showcreatecontact == true) {
                    showCreateContact = true;
                    $('.addContact').removeClass('hide');
                    $('.addContactIcon').removeClass('hide');
                }

                if (configRecord.msnfp_event_matchnames != null && configRecord.msnfp_event_matchnames == true)
                    matchNames = true;

                if (configRecord.msnfp_event_matchemail != null && configRecord.msnfp_event_matchemail == true)
                    matchEmail = true;

                if (configRecord.msnfp_event_matchphone != null && configRecord.msnfp_event_matchphone == true)
                    matchPhone = true;

                if (configRecord.msnfp_event_matchaddress != null && configRecord.msnfp_event_matchaddress == true)
                    matchAddress = true;
            }
        }

        function loadEventPackage(currentID) {
            var selectQuery = "msnfp_eventpackages?";
            var filter = "$filter=(msnfp_eventpackageid eq " + currentID + ")";
            var result = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + selectQuery + filter);
            eventPackage = result[0];

            if (eventPackage != null) {
                donorId = eventPackage._msnfp_customerid_value;
                constituteId = eventPackage._msnfp_constituentid_value;

                $("input[name=paymentType][value='" + eventPackage.msnfp_paymenttype + "']").prop("checked", true);
                $("input[name=annonymousDonation][value='" + eventPackage.msnfp_anonymous + "']").prop("checked", true);
                $("input[name=giftSource][value='" + eventPackage.msnfp_giftsource + "']").prop("checked", true);

                $('#txtFirstName').val(eventPackage.msnfp_firstname);
                $('#txtLastName').val(eventPackage.msnfp_lastname);
                $('#txtOrganization').val(eventPackage.msnfp_organizationname);
                $('#txtEmail').val(eventPackage.msnfp_emailaddress1);
                $('#txtPhone').val(eventPackage.msnfp_telephone1);
                $('#txtAddressLine1').val(eventPackage.msnfp_billing_line1);
                $('#txtAddressLine2').val(eventPackage.msnfp_billing_line2);
                $('#txtAddressLine3').val(eventPackage.msnfp_billing_line3);
                $('#txtAddressCity').val(eventPackage.msnfp_billing_city);
                $('#txtAddressProvince').val(eventPackage.msnfp_billing_stateorprovince);
                $('#txtAddressPostalCode').val(eventPackage.msnfp_billing_postalcode);

                $('#txtChequeNumber').val(eventPackage.msnfp_chequenumber);
                $('#txtConfirmAmount').val(currencySymbol + addCommasonLoad(parseFloat(eventPackage.msnfp_amount).toFixed(2)));

                //var totalQuantity = 0;
                //if (eventPackage.msnfp_sum_sponsorships != null)
                //    totalQuantity = eventPackage.msnfp_sum_sponsorships;
                //if (eventPackage.msnfp_sum_ticketregistrations != null)
                //    totalQuantity += eventPackage.msnfp_sum_ticketregistrations;
                //if (eventPackage.msnfp_sum_products != null)
                //    totalQuantity += eventPackage.msnfp_sum_products;
                //if (eventPackage.msnfp_sum_donations != null)
                //    totalQuantity += eventPackage.msnfp_sum_donations;
                $('#txtQuantity').val(eventPackage.msnfp_quantity);


                var remainingBalance = eventPackage.msnfp_amount_balance != null ? parseFloat(eventPackage.msnfp_amount_balance) : 0;
                $('.successTxtAmountOwning').val(currencySymbol + addCommasonLoad(parseFloat(remainingBalance).toFixed(2)));

                if (remainingBalance != null && parseFloat(remainingBalance) > 0) {
                    $('.divPayForPackage').removeClass('hide');
                }

                var packageTotal = eventPackage.msnfp_amount != null ? parseFloat(eventPackage.msnfp_amount) : 0;
                $('.successTxtAmount').val(currencySymbol + addCommasonLoad(parseFloat(packageTotal).toFixed(2)));

                var packagePaid = eventPackage.msnfp_amount_paid != null ? parseFloat(eventPackage.msnfp_amount_paid) : 0;
                $('.successTxtAmountPaid').val(currencySymbol + addCommasonLoad(parseFloat(packagePaid).toFixed(2)));

                if (eventPackage.msnfp_chequenumber != null && eventPackage.msnfp_chequenumber != '') {
                    $('.divChequeNumber').removeClass('hide');
                    $('#successChequeNumber').val(eventPackage.msnfp_chequenumber);
                }

                // changing label for cheque/wire transfer
                if (eventPackage.msnfp_paymenttype != null) {
                    if (eventPackage.msnfp_paymenttype == PaymentType.Cheque) {
                        $('.spnDWireNumber').hide();
                        $('.spnDChequeNumber').show();
                    }
                    else if (eventPackage.msnfp_paymenttype == PaymentType.Wire) {
                        $('.spnDChequeNumber').hide();
                        $('.spnDWireNumber').show();
                    }
                }

                if (eventPackage.statuscode == 844060000 || eventPackage.statuscode == 844060001
                    || eventPackage.statuscode == 844060003 || eventPackage.statuscode == 844060004 || eventPackage.statuscode == 844060005) //Completed, Cancelled, Failed, Refund, InProgress
                {
                    currentStep = 7;
                    loadCurrentWizardDetails();
                    disableFields();
                }
                else
                    loadCurrentWizardDetails();

                $(".loader").fadeOut("slow");
            }
        }

        //Wizard Details
        function setTotalAmount() {
            wizardTotalAmount = 0;
            var totalQuantity = 0;
            totalDonationAmount = 0;

            $(listSponsorships).each(function () {
                if (this.quantity > 0) {
                    totalQuantity = totalQuantity + this.quantity;
                    wizardTotalAmount = wizardTotalAmount + this.payingToday;
                }
            });

            $(listTickets).each(function () {
                if (this.quantity > 0) {
                    totalQuantity = totalQuantity + this.quantity;
                    wizardTotalAmount = wizardTotalAmount + (this.totalAmount * this.quantity);
                }
            });

            $(listProducts).each(function () {
                if (this.quantity > 0) {
                    totalQuantity = totalQuantity + this.quantity;
                    wizardTotalAmount = wizardTotalAmount + (this.totalAmount * this.quantity);
                }
            });

            $(listDonations).each(function () {
                if (this.isSelected) {
                    totalQuantity = totalQuantity + 1;
                    totalDonationAmount += this.totalAmount;
                    wizardTotalAmount = wizardTotalAmount + this.totalAmount;
                }
            });

            var payingToday = wizardTotalAmount;
            if (enableEventPackageDiscount) {
                var discount = parseFloat($('#txtApplyDiscount').val().replace(currencySymbol, '').replace(/[^\d\.\-]/g, ""));
                if (discount != '') {
                    payingToday = wizardTotalAmount - discount;
                }
            }

            $('#txtQuantity').val(totalQuantity);

            $('#txtPayingToday').val(currencySymbol + addCommasonLoad(parseFloat(payingToday.toString()).toFixed(2)));
            $('#txtAmountOwning').val(currencySymbol + addCommasonLoad(parseFloat(payingToday.toString()).toFixed(2)));
            $('#txtConfirmAmount').val(currencySymbol + addCommasonLoad(parseFloat(payingToday.toString()).toFixed(2)));
        }

        function clearTotalAmount() {
            $('#txtQuantity').val('0');
            $('#txtApplyDiscount').val(currencySymbol + '0.00');
            $('#txtConfirmAmount').val(currencySymbol + '0.00');
            $('#txtAmountOwning').val(currencySymbol + '0.00');
            $('#txtPayingToday').val(currencySymbol + '0.00');
        }

        function loadEventPreferences() {

            eventPreferenceSelectHTML = "<table class='table-preference' role='presentation'><tr><td colspan='2'><h3>Event Preferences</h3></td></tr>";
            // Get the new event preference select box info:
            var objSelect = "msnfp_eventpreferences?$select=msnfp_eventpreferenceid,msnfp_freetext,msnfp_identifier&$expand=msnfp_PreferenceCategoryId($select=msnfp_name),msnfp_PreferenceId($select=msnfp_name)&$filter=_msnfp_eventid_value eq " + eventID + " and statecode eq 0 and msnfp_PreferenceCategoryId/msnfp_preferencecategoryid ne null and msnfp_PreferenceId/msnfp_preferenceid ne null";
            var objs = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + objSelect);

            for (var i = 0; i < objs.length; i++) {

                if (objs[i].msnfp_freetext == true)
                    eventPreferenceSelectHTML += " <tr style='border-bottom: 1px solid #cccccc;'><td valign='top'><input type='hidden' name='txtEventPreferenceID' value='" + objs[i].msnfp_eventpreferenceid + "' /><input type='checkbox' aria-label='" + objs[i].msnfp_PreferenceId.msnfp_name + "' name='chkEventPreference' onchange='setMandatoryEventPreference()' class='chkEventPreference' id='" + objs[i].msnfp_eventpreferenceid + "' /></td><td><div class='dClass'><span class='field-label'>" + objs[i].msnfp_PreferenceId.msnfp_name + "</span><textarea name='txtOtherPreference' aria-label='Details' class='txtOther form-control-textarea' cols='30' rows='2'></textarea></div></td></tr>";
                else
                    eventPreferenceSelectHTML += " <tr style='border-bottom: 1px solid #cccccc;'><td><input type='hidden' name='txtEventPreferenceID' value='" + objs[i].msnfp_eventpreferenceid + "' /><input type='checkbox' aria-label='" + objs[i].msnfp_PreferenceId.msnfp_name + "' name='chkEventPreference' onchange='setMandatoryEventPreference()' class='chkEventPreference' id='" + objs[i].msnfp_eventpreferenceid + "' /></td><td>" + objs[i].msnfp_PreferenceId.msnfp_name + "</td></tr>";
            }

            eventPreferenceSelectHTML += "</table>";
        }

        function loadCurrentWizardDetails() {
            var isDonorNull = xrm.Page.data.entity.attributes.get("msnfp_customerid").getValue() == null;
            $('#btnNext').html('Next <i class="button-icon fas fa-angle-right"></i>');
            $('#btnBack').removeClass('hide');
            $('.acknowledgement-detail, .sponsorship-detail, .ticket-detail, .attendee-detail, .preference-detail, .product-detail, .donation-detail, .payment-detail').addClass('hide');
            $('#acknowledgment, #sponsorship, #ticket, #attendee, #preference, #product, #donation, #payment').removeClass('clicked');
            //if (!isBack)
            //	$('#acknowledgment, #sponsorship, #ticket, #product, #donation, #payment').removeClass('current');
            if (currentStep == StepList.Acknowledgements) {
                $('#btnNext').addClass('disBtn');
                if (listAcknowledgement.length > 0) {
                    if (isBack) {
                        $('#btnNext').removeClass('disBtn');
                    }
                    if (isNew && isAcknowledgement) {
                        $('#btnBack').addClass('hide');
                        $('.acknowledgement-detail').removeClass('hide');
                        $('#acknowledgment').addClass('current');
                        $('#acknowledgment').addClass('clicked');
                    }
                }
                else {
                    $('#btnBack').addClass('hide');
                    currentStep = StepList.Sponsorship;
                }
            }

            if (currentStep == StepList.Sponsorship) {
                if (!isDonorNull)
                    $('#btnNext').removeClass('disBtn');
                if (listSponsorships.length > 0) {
                    $('.sponsorship-detail').removeClass('hide');
                    $('#acknowledgment, #sponsorship').addClass('current');
                    $('#sponsorship').addClass('clicked');
                }
                else if (isBack) {
                    currentStep = StepList.Acknowledgements;
                    loadCurrentWizardDetails();
                }
                else {
                    currentStep = StepList.Tickets;
                }
            }

            if (currentStep == StepList.Tickets) {
                if (!isDonorNull)
                    $('#btnNext').removeClass('disBtn');
                if (listTickets.length > 0) {
                    $('.ticket-detail').removeClass('hide');
                    $('#acknowledgment, #sponsorship, #ticket').addClass('current');
                    $('#ticket').addClass('clicked');
                }
                else if (isBack) {
                    currentStep = StepList.Sponsorship;
                    loadCurrentWizardDetails();
                }
                else {
                    currentStep = StepList.Attendees;
                }
            }

            if (currentStep == StepList.Attendees) {
                if (!isDonorNull)
                    $('#btnNext').removeClass('disBtn');
                if (listAttendees.length > 0) {
                    $('.attendee-detail').removeClass('hide');
                    $('#acknowledgment, #sponsorship, #ticket, #attendee').addClass('current');
                    $('#attendee').addClass('clicked');
                }
                else if (isBack) {
                    currentStep = StepList.Tickets;
                    loadCurrentWizardDetails();
                }
                else {
                    currentStep = StepList.Preference;
                }
            }

            if (currentStep == StepList.Preference) {
                if (!isDonorNull)
                    $('#btnNext').removeClass('disBtn');
                if (listAttendees.length > 0) {
                    $('.preference-detail').removeClass('hide');
                    $('#acknowledgment, #sponsorship, #ticket, #attendee, #preference').addClass('current');

                    loadPreferenceList();
                    $('#preference').addClass('clicked');
                }
                else if (isBack) {
                    currentStep = StepList.Attendees;
                    loadCurrentWizardDetails();
                }
                else {
                    currentStep = StepList.Products;
                }
            }

            if (currentStep == StepList.Products) {
                if (!isDonorNull)
                    $('#btnNext').removeClass('disBtn');
                if (listProducts.length > 0) {
                    $('.product-detail').removeClass('hide');
                    $('#acknowledgment, #sponsorship, #ticket, #product').addClass('current');
                    $('#product').addClass('clicked');
                }
                else if (isBack) {
                    currentStep = StepList.Preference;
                    loadCurrentWizardDetails();
                }
                else {
                    if (!isEnableInvoiceMe)
                        currentStep = StepList.Donation;
                    else
                        currentStep = StepList.Payment;
                }
            }

            if (currentStep == StepList.Donation) {
                if (!isDonorNull)
                    $('#btnNext').removeClass('disBtn');
                if (!isEnableInvoiceMe && listDonations.length > 0) {
                    $('.donation-detail').removeClass('hide');
                    $('#acknowledgment, #sponsorship, #ticket, #product, #donation').addClass('current');

                    $('#donation').addClass('clicked');
                }
                else if (isBack) {
                    currentStep = StepList.Products;
                    loadCurrentWizardDetails();
                }
                else {
                    currentStep = StepList.Payment;
                }
            }


            if (currentStep == StepList.Payment) {

                $('#btnNext').html('Purchase <i class="button-icon fas fa-angle-right"></i>');
                $('#btnNext').attr('aria-label', 'Purchase');
                $('.payment-detail').removeClass('hide');

                validateAmounts();

                $('#acknowledgment, #sponsorship, #ticket, #attendee, #preference, #product, #donation, #payment').addClass('current');

                $('#payment').addClass('clicked');

                if (enableEventPackageDiscount)
                    $('.applyDiscount').removeClass('hide');
            }
        }

        //Acknowledgement
        function getEventAcknowledgementCount(eventID) {

            var recCount = 0;

            var select = "msnfp_eventdisclaimers?$select=msnfp_eventdisclaimerid";
            var filter = "&$filter=(statecode eq 0 and _msnfp_eventid_value eq " + eventID + ")";
            var result = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + select + filter);
            if (result != null && result != undefined)
                recCount = result.length;

            return recCount;
        }

        function loadAcknowledgementList(eventID) {

            $('.acknowledgement-list').html('');
            var select = "msnfp_eventdisclaimers?$select=msnfp_eventdisclaimerid,msnfp_identifier,msnfp_description,_msnfp_eventid_value";
            var filter = "&$filter=(statecode eq 0 and _msnfp_eventid_value eq " + eventID + ")";
            var result = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + select + filter);
            if (result != null && result != undefined) {
                isAcknowledgement = true;
                successloadAcknowledgementList(result);
            }
            else {
                listAcknowledgement = [];
            }
        }

        function successloadAcknowledgementList(results) {

            listAcknowledgement = results;
            $(results).each(function () {
                var contentString = '';
                contentString = '<h3 style="margin-bottom: 0px !important;margin-top: 0px !important;"><b>' + (this.msnfp_identifier != null ? this.msnfp_identifier : "") + '</b></h3>';
                if (this.msnfp_description != null && this.msnfp_description != '') {
                    contentString += '<p>';
                    contentString += this.msnfp_description;
                    contentString += '</p>';
                }
                contentString += '<input aria-label="Constituent Accepts?" title="Constituent Accepts?" type="checkbox" class="chkClientAgree" role="checkbox" aria-required="true" onchange="clientAgree()" /><div id="lblConst" class="mandatory" style="display:inline-block;vertical-align:top;margin-top: 1px;"><span aria-label="Constituent Accepts?" title="Constituent Accepts?" style="vertical-align: top;">  Constituent Accepts?</span></div>';
                contentString += '<hr/>';
                $('.acknowledgement-list').append(contentString);
            });
        }

        //Sponsorship
        function getEventSponsorshipCount(eventID) {

            var recCount = 0;

            var select = "msnfp_eventsponsorships?$select=msnfp_eventsponsorshipid";
            var filter = "&$filter=(_msnfp_eventid_value eq " + eventID + " and (statuscode eq 844060001 or statuscode eq 844060002) and msnfp_sum_available ge 0)";
            var result = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + select + filter);
            if (result != null && result != undefined)
                recCount = result.length;

            return recCount;
        }

        function loadSponsorshipList(eventID) {
            $('.sponsorship-list').html('');

            var select = "msnfp_eventsponsorships?$select=msnfp_eventsponsorshipid,msnfp_amount,msnfp_amount_receipted,msnfp_amount_nonreceiptable,msnfp_amount_tax,msnfp_sum_available,msnfp_description,msnfp_identifier,_msnfp_eventid_value";
            var filter = "&$filter=(_msnfp_eventid_value eq " + eventID + " and (statuscode eq 844060001 or statuscode eq 844060002) and msnfp_sum_available ge 0)";

            var result = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + select + filter);
            if (result != null && result != undefined)
                successloadSponsorshipList(result);
            else
                listSponsorships = [];
        }

        function successloadSponsorshipList(result) {
            listSponsorships = [];
            $(result).each(function () {
                var newSponsorship =
                {
                    id: this.msnfp_eventsponsorshipid,
                    amount: this.msnfp_amount,
                    amountReceipted: this.msnfp_amount_receipted,
                    amountNonReceiptable: this.msnfp_amount_nonreceiptable,
                    amountTax: this.msnfp_amount_tax,
                    quantity: 0,
                    payingToday: 0,
                    discount: 0,
                    totalAmount: 0
                }
                listSponsorships.push(newSponsorship);

                var clonSponsorship = $('.clone-sponsorship').clone();
                $(clonSponsorship).removeClass('hide clone-sponsorship');
                $(clonSponsorship).addClass('sponsorship-item');

                var hiddenId = $(clonSponsorship).find('.hiddenSponsorshipId')[0];
                $(hiddenId).val(this.msnfp_eventsponsorshipid);

                var title = "Maximum " + this.msnfp_sum_available + " Available to Purchase";
                var sponsorshipTitle = $(clonSponsorship).find('.sponsorshipTitle')[0];

                $(sponsorshipTitle).html(title);

                var desc = this.msnfp_description;
                var sponsorshipDesc = $(clonSponsorship).find('.sponsorshipDescription')[0];
                $(sponsorshipDesc).html(desc);

                var sponsorshipAmount = $(clonSponsorship).find('.sponsorshipAmount')[0];
                $(sponsorshipAmount).html(currencySymbol + addCommasonLoad(parseFloat(this.msnfp_amount.toString()).toFixed(2)));

                var sponsorshipQuantity = $(clonSponsorship).find('.sponsorshipQuantity')[0];
                $(sponsorshipQuantity).attr('max', this.msnfp_sum_available);

                $('.sponsorship-list').append(clonSponsorship);
            });
        }

        function loadAttendeeList() {

            listAttendees = [];
            $('.attendee-list').html('');

            $(listTickets).each(function () {
                if (this.quantity > 0) {
                    // appending attendee header
                    //var headerHTML = $('.clone-attendee-header').html();
                    var headerHTML = "<div style='background-color:#cccccc; padding:5px height:20px'>Attendee List</div>";
                    $('.attendee-list').append(headerHTML);

                    var i = 0;
                    var ticketCount = 1;

                    for (i = 0; i < this.quantity; i++) {

                        var y = 0;
                        for (y = 0; y < this.registrationsPerTicket; y++) {

                            //var rId = RandomGuid();

                            var newAttendee = {
                                eventTicketId: this.id,
                                description: this.description,
                                eventId: eventID,
                                lastName: "",
                                firstNAme: ""
                            }
                            listAttendees.push(newAttendee);

                            var cloneAttendee = $('.clone-attendee').clone();
                            $(cloneAttendee).removeClass('hide clone-attendee');
                            $(cloneAttendee).addClass('attendee-item');

                            var hiddenId = $(cloneAttendee).find('.hdnEventTicketID')[0];
                            $(hiddenId).val(this.id);

                            // setting contact values - start
                            var txtRegFirstName = $(cloneAttendee).find('#txtRegFirstName')[0];
                            var txtRegLastName = $(cloneAttendee).find('#txtRegLastName')[0];
                            var txtRegEmail = $(cloneAttendee).find('#txtRegEmail')[0];
                            var txtRegPhone = $(cloneAttendee).find('#txtRegPhone')[0];
                            var recId = $(cloneAttendee).find('.hdnRecID')[0];

                            var valRegFirstName = "First Name";
                            var valRegLastName = "Last Name";
                            var valRegEmail = "Email";
                            var valRegPhone = "Phone";
                            var valRID = RandomGuid();

                            if (ticketCount == 1) {
                                valRegFirstName = $('#txtFirstName').val();
                                valRegLastName = $('#txtLastName').val();
                                valRegEmail = $('#txtEmail').val();
                                valRegPhone = $('#txtPhone').val();
                            }

                            if (listAttendeesEdited.length > 0) {  // loading previously saved attendees

                                var recFound = getAttendee(this.id, ticketCount.toString());

                                if (!isNullOrUndefined(recFound)) {
                                    valRegFirstName = recFound.firstName;
                                    valRegLastName = recFound.lastName;
                                    valRegEmail = recFound.email;
                                    valRegPhone = recFound.phone;
                                    valRID = recFound.rid;
                                }
                            }

                            $(txtRegFirstName).val(valRegFirstName);
                            $(txtRegLastName).val(valRegLastName);
                            $(txtRegEmail).val(valRegEmail);
                            $(txtRegPhone).val(valRegPhone);
                            $(recId).val(valRID);
                            // setting contact values - end

                            // replacing classes for empty field validation - start
                            var firstName = $(cloneAttendee).find('.cFirstName')[0];
                            $(firstName).removeClass('cFirstName');
                            $(firstName).addClass('cFirstNameValid');

                            var lastName = $(cloneAttendee).find('.cLastName')[0];
                            $(lastName).removeClass('cLastName');
                            $(lastName).addClass('cLastNameValid');

                            var email = $(cloneAttendee).find('.cEmail')[0];
                            $(email).removeClass('cEmail');
                            $(email).addClass('cEmailValid');

                            var phone = $(cloneAttendee).find('.cPhone')[0];
                            $(phone).removeClass('cPhone');
                            $(phone).addClass('cPhoneValid');
                            // replacing classes for empty field validation - end

                            var ticketCounter = $(cloneAttendee).find('.ticketCounter')[0];
                            $(ticketCounter).html(ticketCount);

                            ticketCount++;

                            $('.attendee-list').append(cloneAttendee);
                        }
                    }
                }
            });
        }

        function loadPreferenceList() {

            listAttendees = [];

            $('.preference-list').html('');

            // getting Attendees
            $('.attendee-item').each(function (i, row) {
                var $row = $(row),
                    $eventTicketID = $row.find('input[name*="hdnEventTicketID"]');
                $attendeeId = $row.find('input[name*="hdnRecID"]');
                $firstName = $row.find('input[name*="txtRegFirstName"]');
                $lastName = $row.find('input[name*="txtRegLastName"]');
                $email = $row.find('input[name*="txtRegEmail"]');
                $phone = $row.find('input[name*="txtRegPhone"]');
                $createContact = $row.find('input[type="checkbox"]');
                $ticketCounter = $row.find('span[class*="ticketCounter"]');


                var rId = RandomGuid();
                var attId = "";

                if ($attendeeId.length > 0)
                    attId = $attendeeId[0].value;

                var newAttendee = {
                    eventTicketId: $eventTicketID.val(),
                    rId: rId,
                    attendeeId: attId,
                    firstName: $firstName.val(),
                    lastName: $lastName.val(),
                    email: $email.val(),
                    phone: $phone.val(),
                    createContact: $createContact.prop("checked"),
                    ticketCounter: $ticketCounter.prop("innerText")
                }
                listAttendees.push(newAttendee);


                var clonePreferenceMain = $('.clone-preferences-main').clone();
                $(clonePreferenceMain).removeClass('hide clone-preferences-main');
                $(clonePreferenceMain).addClass('registration-item');

                var hdnAttendeeId = $(clonePreferenceMain).find('.hdnAttendeeID')[0];
                $(hdnAttendeeId).val(attId);

                var hiddenId = $(clonePreferenceMain).find('.hdnEventTicketID')[0];
                $(hiddenId).val(this.id);

                // setting default value - start
                var txtRID = $(clonePreferenceMain).find('#txtRID')[0];
                $(txtRID).val(rId);

                var txtPrefName = $(clonePreferenceMain).find('#txtPrefName')[0];
                var txtPrefCounter = $(clonePreferenceMain).find('#txtPrefCounter')[0];

                $(txtPrefName).text($firstName.val() + " " + $lastName.val());
                $(txtPrefCounter).text($ticketCounter.prop("innerText"));

                var editLink = $(clonePreferenceMain).find('.aLink')[0];
                $(editLink).attr("href", "javascript:showPreferenceDetails('" + rId + "');");

                var editLinkContent = $(clonePreferenceMain).find('.aLinkContent')[0];
                $(editLinkContent).attr("id", rId);

                $('.preference-list').append(clonePreferenceMain);

            });

            loadEventPreferences();
            $('.dContent').empty();
            $('.dContent').append(eventPreferenceSelectHTML);

            loadAttendeePreferences();
        }


        //Ticket
        function getEventTicketCount(eventID) {

            var recCount = 0;

            var select = "msnfp_eventtickets?$select=msnfp_eventticketid";
            var filter = "&$filter=(_msnfp_eventid_value eq " + eventID + " and (statuscode eq 1 or statuscode eq 844060001) and msnfp_sum_available ge 0)";
            var result = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + select + filter);
            if (result != null && result != undefined)
                recCount = result.length;

            return recCount;
        }

        function loadTicketList(eventID) {

            $('.ticket-list').html('');

            var select = "msnfp_eventtickets?$select=msnfp_eventticketid,msnfp_amount,msnfp_amount_receipted,msnfp_amount_nonreceiptable,msnfp_amount_tax,msnfp_advantage,msnfp_registrationsperticket,msnfp_maxspots,msnfp_identifier,msnfp_description,msnfp_sum_available,_msnfp_eventid_value";
            var filter = "&$filter=(_msnfp_eventid_value eq " + eventID + " and (statuscode eq 1 or statuscode eq 844060001) and msnfp_sum_available ge 0)";

            var result = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + select + filter);
            if (result != null && result != undefined) {
                successloadTicketList(result);
            }
            else {
                listTickets = [];
            }
        }

        function successloadTicketList(result) {

            listTickets = [];
            $(result).each(function () {
                var newTicket = {
                    id: this.msnfp_eventticketid,
                    amount: this.msnfp_amount,
                    amountReceipted: this.msnfp_amount_receipted,
                    amountNonReceiptable: this.msnfp_amount_nonreceiptable,
                    registrationsPerTicket: this.msnfp_registrationsperticket,
                    amountTax: this.msnfp_amount_tax,
                    quantity: 0,
                    totalAmount: 0,
                    description: this.msnfp_description,
                    advantage: this.msnfp_advantage,
                    name: this.msnfp_identifier
                }
                listTickets.push(newTicket);

                var cloneTicket = $('.clone-ticket').clone();
                $(cloneTicket).removeClass('hide clone-ticket');
                $(cloneTicket).addClass('ticket-item');

                var hiddenId = $(cloneTicket).find('.hiddenTicketId')[0];
                $(hiddenId).val(this.msnfp_eventticketid);

                var desc = this.msnfp_description;
                var ticketDesc = $(cloneTicket).find('.ticketDesc')[0];
                $(ticketDesc).html(desc);

                var ticketAmount = $(cloneTicket).find('.ticketAmount')[0];
                $(ticketAmount).html(currencySymbol + addCommasonLoad(parseFloat(this.msnfp_amount.toString()).toFixed(2)));

                let maxTicks = this.msnfp_sum_available;
                if (this.msnfp_maxspots > this.msnfp_sum_available) {
                    maxTicks = this.msnfp_sum_available;
                }
                else if (!isNullOrUndefined(this.msnfp_maxspots)) {
                    maxTicks = this.msnfp_maxspots;
                }

                var title = "Maximum " + maxTicks + " Available to Purchase";
                var ticketTitle = $(cloneTicket).find('.ticketTitle')[0];
                $(ticketTitle).html(title);

                var ticketQuantity = $(cloneTicket).find('.ticketQuantity')[0];
                $(ticketQuantity).attr('max', maxTicks);

                var ticketsAvailable = $(cloneTicket).find('.itemsAvailable')[0];

                if (this.msnfp_sum_available)
                    $(ticketsAvailable).val(this.msnfp_sum_available);

                $('.ticket-list').append(cloneTicket);
            });
        }

        //Product
        function getEventProductCount(eventID) {

            var recCount = 0;

            var select = "msnfp_eventproducts?$select=msnfp_eventproductid";
            var filter = "&$filter=(_msnfp_eventid_value eq " + eventID + " and statuscode eq 1 and msnfp_quantity ge 0)";
            var result = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + select + filter);
            if (result != null && result != undefined)
                recCount = result.length;

            return recCount;
        }

        function loadProductList(eventID) {
            $('.product-list').html('');

            var select = "msnfp_eventproducts?$select=msnfp_eventproductid,msnfp_identifier,msnfp_description,msnfp_quantity,msnfp_sum_available,msnfp_amount,msnfp_amount_receipted,msnfp_amount_nonreceiptable,msnfp_amount_tax,msnfp_quantity,msnfp_maxproducts,_msnfp_eventid_value";
            var filter = "&$filter=(_msnfp_eventid_value eq " + eventID + " and statuscode eq 1 and msnfp_quantity ge 0)";

            var result = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + select + filter);
            if (result != null && result != undefined)
                successloadProductList(result);
            else
                listProducts = [];
        }

        function successloadProductList(result) {

            $(result).each(function () {
                var newProduct =
                {
                    id: this.msnfp_eventproductid,
                    amount: this.msnfp_amount,
                    amountReceipted: this.msnfp_amount_receipted,
                    amountNonReceiptable: this.msnfp_amount_nonreceiptable,
                    amountTax: this.msnfp_amount_tax,
                    quantity: 0,
                    totalAmount: 0
                }
                listProducts.push(newProduct);

                var cloneProduct = $('.clone-product').clone();
                $(cloneProduct).removeClass('hide clone-product');
                $(cloneProduct).addClass('product-item');

                var hiddenId = $(cloneProduct).find('.hiddenProductId')[0];
                $(hiddenId).val(this.msnfp_eventproductid);

                if (this.msnfp_description != undefined) {
                    var productDescription = $(cloneProduct).find('.productDescription')[0];
                    $(productDescription).html(this.msnfp_description);
                }

                var productAmount = $(cloneProduct).find('.productAmount')[0];
                $(productAmount).html(currencySymbol + addCommasonLoad(parseFloat(this.msnfp_amount.toString()).toFixed(2)));

                let maxProds = this.msnfp_sum_available;
                if (this.msnfp_maxproducts > this.msnfp_sum_available) {
                    maxProds = this.msnfp_sum_available;
                }
                else if (!isNullOrUndefined(this.msnfp_maxproducts)) {
                    maxProds = this.msnfp_maxproducts;
                }

                var title = "Maximum " + maxProds + " Available to Purchase";
                var productTitle = $(cloneProduct).find('.productTitle')[0];
                $(productTitle).html(title);

                var productQuantity = $(cloneProduct).find('.productQuantity')[0];
                $(productQuantity).attr('max', maxProds);

                var productsAvailable = $(cloneProduct).find('.itemsAvailable')[0];

                if (this.msnfp_quantity)
                    $(productsAvailable).val(this.msnfp_quantity);

                $('.product-list').append(cloneProduct);
            });
        }

        //Donation
        function getEventDonationCount(eventID) {

            var recCount = 0;

            var select = "msnfp_eventdonations?$select=msnfp_eventdonationid";
            var filter = "&$filter=(_msnfp_eventid_value eq " + eventID + " and statuscode eq 844060000)";
            var result = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + select + filter);
            if (result != null && result != undefined)
                recCount = result.length;

            return recCount;
        }

        function loadDonationList(eventID) {
            $('.donation-list').html('');

            var select = "msnfp_eventdonations?$select=msnfp_eventdonationid,msnfp_amount,msnfp_identifier,msnfp_description,_msnfp_eventid_value";
            var filter = "&$filter=(_msnfp_eventid_value eq " + eventID + " and statuscode eq 844060000)";

            var result = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + select + filter);
            if (result != null && result != undefined)
                successloadDonationList(result);
            else
                listDonations = [];
        }

        function successloadDonationList(result) {

            $(result).each(function () {
                var newDonation =
                {
                    id: this.msnfp_eventdonationid,
                    amount: this.msnfp_amount,
                    totalAmount: this.msnfp_amount,
                    isSelected: false
                }
                listDonations.push(newDonation);

                var clonedonation = $('.clone-donation').clone();
                $(clonedonation).removeClass('hide clone-donation');
                $(clonedonation).addClass('donation-item');

                var hiddenId = $(clonedonation).find('.hiddenDonationId')[0];
                $(hiddenId).val(this.msnfp_eventdonationid);

                var donationDesc = $(clonedonation).find('.donationDesc')[0];
                $(donationDesc).html(this.msnfp_description);

                var donationAmount = $(clonedonation).find('.donationAmount')[0];

                if (!isNullOrUndefined(donationAmount)) {
                    $(donationAmount).html(currencySymbol + addCommasonLoad(parseFloat(this.msnfp_amount.toString()).toFixed(2)));
                }

                $('.donation-list').append(clonedonation);
            });
        }

        function setDonationAmount($this) {
            $this.removeClass('bgGray');

            //Clear all selected donations
            $(listDonations).each(function () {
                this.totalAmount = 0;
                this.isSelected = false;
            });

            var id = $($this.find('.hiddenDonationId')[0]).val();
            var result = $.grep(listDonations, function (e) { return e.id == id; });
            result = result[0];
            result.totalAmount = 0;
            result.isSelected = false;

            var isChecked = $($this.find('.chkDonationItem')[0]).is(':checked');
            if (isChecked) {

                if (result.isCustomamount) {
                    var amount = $($this.find('.donationCustomAmount')[0]).val();
                    if (amount > 0) {
                        $this.addClass('bgGray');
                        result.isSelected = true;
                        result.totalAmount = parseInt(amount);
                    }
                }
                else {
                    $this.addClass('bgGray');
                    result.isSelected = true;
                    result.totalAmount = result.amount;
                }
            }
            setTotalAmount();
        }

        function uncheckOtherDonations() {
            $('.chkDonationItem').each(function () {
                $(this).parents('div.donation-item').removeClass('bgGray');
                $(this).prop('checked', false);
            });
        }

        function loadCreditCardDetail(donorId) {
            if (isNullOrUndefined(donorId)) {
                $('#ddlExistingCard').find('option').remove().end().append('<option value="" role="option">--Select--</option>');
            }
            else {
                var selectQuery = "msnfp_paymentmethods?$select=msnfp_paymentmethodid,msnfp_bankname,msnfp_name,createdon,_msnfp_paymentprocessorid_value&$orderby=createdon desc&$filter=(statuscode eq 1 and msnfp_type eq 844060000 and _msnfp_customerid_value eq " + XrmUtility.CleanGuid(donorId) + ")";
                var result = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + selectQuery);
                if (result != null && result.length > 0) {
                    cardExists = true;
                    $('.credit-details .exists').hide();
                    $('.credit-details .notExists').show();

                    //Add Validation
                    addRemoveCardValidation();

                    $('#ddlExistingCard').find('option').remove().end().append('<option value="" role="option">--Select--</option>');
                    $.each(result, function (i, item) {

                        // Here we assign the payment processor name to the on hover of a credit card selection (useful in systems with multiple payment gateways).
                        let paymentProcessorName = "";
                        if (!isNullOrUndefined(item._msnfp_paymentprocessorid_value)) {
                            paymentProcessorName = getNameForPaymentProcessor(item._msnfp_paymentprocessorid_value);
                        }
                        $('#ddlExistingCard').
                            append('<option title="' + paymentProcessorName + '" value="' + item.msnfp_paymentmethodid + '" role="option">' + item.msnfp_name + '</option>');

                    });
                    $('#ddlExistingCard').append('<option value="-1" role="option">New Credit Card</option>');
                }
                else {
                    cardExists = false;
                    addRemoveCardValidation();
                }
            }
        }

        function addRemoveCardValidation() {
            $('#ddlExistingCard').closest('div').removeClass('mandatory');
            $('#txtCardNumber').closest('div').removeClass('mandatory');
            $('#txtCardName').closest('div').removeClass('mandatory');
            $('#ddlCardType').closest('div').removeClass('mandatory');
            $('#txtExpiry').closest('div').removeClass('mandatory');

            var selectedVal = $('input[name=paymentType]:checked').val();
            if (selectedVal == PaymentType.CreditDebit) {
                var requiredDetail = false;
                if (cardExists) {
                    $('#ddlExistingCard').closest('div').addClass('mandatory');
                    $('.card-details .notExists').removeClass('hide');
                    $('.card-details .exists').addClass('hide');
                    if ($('#ddlExistingCard').val() == '-1')
                        requiredDetail = true;
                }
                else {
                    requiredDetail = true;
                }

                if (requiredDetail) {
                    $('#txtCardNumber').closest('div').addClass('mandatory');
                    $('#txtCardName').closest('div').addClass('mandatory');
                    $('#ddlCardType').closest('div').addClass('mandatory');
                    $('#txtExpiry').closest('div').addClass('mandatory');

                }
            }
        }

        function resetPaymentFields() {
            var selectedVal = $('input[name=paymentType]:checked').val();
            if (selectedVal == PaymentType.CreditDebit) {
                $('#ddlExistingCard').val('');
                $('#txtCardNumber').val('');
                $('#txtCardName').val('');
                $('#ddlCardType').val('');
                $('#txtExpiry').val('');
            }
        }

        function getGiftType(giftType) {
            if (giftType == 844060000) { return 'Cash'; }
            if (giftType == 844060001) { return 'Check'; }
            if (giftType == 844060002) { return 'Credit / Debit Card'; }
            if (giftType == 844060003) { return 'Bank (Ach)'; }
            if (giftType == 844060004) { return 'In Kind'; }
            if (giftType == 844060005) { return 'Gift'; }
            if (giftType == 844060006) { return 'Stock'; }
            if (giftType == 844060007) { return 'Property'; }
            if (giftType == 844060008) { return 'Other'; }
            if (giftType == 844060013) { return 'Invoice Me'; }
            return '';
        }

        //Validate
        function validate() {
            var isValidate = true;
            var paymentType = $('input[name=paymentType]:checked').val();
            //$("#lblErrorValidation")[0].innerText = '';
            $('#lblErrorValidation').html('');
            $('#lblErrorExpiry').html('');
            $('.wizard-error').html('');
            $("#txtChequeNumber").removeClass('red-border');
            $("#txtCardNumber").removeClass('red-border');
            $("#txtCardName").removeClass('red-border');
            $("#ddlCardType").removeClass('red-border');
            $("#txtExpiry").removeClass('red-border');
            $("#ddlExistingCard").removeClass('red-border');

            if (paymentType == PaymentType.Cheque) {
                if ($("#txtChequeNumber").val() === "") {
                    isValidate = false;
                    $("#txtChequeNumber").addClass('red-border');
                    //$("#lblErrorValidation")[0].innerText = "Please enter the cheque number";
                    $('#lblErrorValidation').append('<p>Please enter the cheque number</p>');
                    return;
                }
            }
            else if (paymentType == PaymentType.Wire) {
                if ($("#txtChequeNumber").val() === "") {
                    isValidate = false;
                    $("#txtChequeNumber").addClass('red-border');
                    //$("#lblErrorValidation")[0].innerText = "Please enter the wire number";
                    $('#lblErrorValidation').append('<p>Please enter the wire number</p>');
                    return;
                }
            }
            else if (paymentType == PaymentType.CreditDebit) {
                if ($("#ddlExistingCard").val() === "-1") {
                    if ($("#txtCardNumber").val() === "" || !cardnumber()) {
                        isValidate = false;
                        $("#txtCardNumber").addClass('red-border');
                        //$("#lblErrorValidation")[0].innerText = "Please enter a valid credit card number";
                        $('#lblErrorValidation').append('<p>Please enter a valid credit card number</p>');
                        return;
                    }
                    if ($("#txtCardName").val() === "") {
                        isValidate = false;
                        $("#txtCardName").addClass('red-border');
                        //$("#lblErrorValidation")[0].innerText = "Please enter the name of the credit/debit card";
                        $('#lblErrorValidation').append('<p>Please enter the name of the credit/debit card</p>');
                        return;
                    }
                    if ($("#ddlCardType").val() === "") {
                        isValidate = false;
                        $("#ddlCardType").addClass('red-border');
                        //$("#lblErrorValidation")[0].innerText = "Please select Credit Card type";
                        $('#lblErrorValidation').append('<p>Please select Credit Card type</p>');
                        return;
                    }
                    if ($("#txtExpiry").val() === "" || !validateExpiry()) {
                        isValidate = false;
                        $("#txtExpiry").addClass('red-border');
                        //$("#lblErrorValidation")[0].innerText = "Please enter a valid expiry date";
                        $('#lblErrorValidation').append('<p>Please enter a valid expiry date</p>');
                        return;
                    }
                }
                else if ($("#ddlExistingCard").val() === "" && ($('#ddlExistingCard').closest('div').hasClass('mandatory'))) {

                    isValidate = false;
                    $("#ddlExistingCard").addClass('red-border');
                    //$("#lblErrorValidation")[0].innerText = "Please select or enter a credit/debit card";
                    $('#lblErrorValidation').append('<p>Please select or enter a credit/debit card</p>');
                    return;
                }
            }

            $('.manual-main div.mandatory input, .manual-main div.mandatory select').each(function () {
                var $this = $(this);
                if ($this.val() == '') {
                    isValidate = false;
                    return false;
                }
            });
            return isValidate;
        }


        //Validate Preferences
        function validateAttendees() {
            var isValidate = true;

            $('#lblErrorValidation').html('');
            $(".cFirstNameValid").removeClass('red-border');
            $(".cLastNameValid").removeClass('red-border');
            $(".cEmailValid").removeClass('red-border');
            $(".cPhoneValid").removeClass('red-border');

            if (mandateName) {
                $.each($('.cFirstNameValid'), function () {
                    if ($(this).val().length == 0 || $(this).val() == 'First Name') {
                        isValidate = false;
                        $(this).addClass('red-border');
                        $('#lblErrorValidation').append('<p>Please enter first name.</p>');
                        return false;
                    }
                });

                $.each($('.cLastNameValid'), function () {
                    if ($(this).val().length == 0 || $(this).val() == 'Last Name') {
                        isValidate = false;
                        $(this).addClass('red-border');
                        $('#lblErrorValidation').append('<p>Please enter last name.</p>');
                        return false;
                    }
                });
            }

            if (mandateEmail) {
                $.each($('.cEmailValid'), function () {
                    if ($(this).val().length == 0 || $(this).val() == 'Email') {
                        isValidate = false;
                        $(this).addClass('red-border');
                        $('#lblErrorValidation').append('<p>Please enter email address.</p>');
                        return false;
                    }
                });
            }

            if (mandatePhone) {
                $.each($('.cPhoneValid'), function () {
                    if ($(this).val().length == 0 || $(this).val() == 'Phone') {
                        isValidate = false;
                        $(this).addClass('red-border');
                        $('#lblErrorValidation').append('<p>Please enter phone.</p>');
                        return false;
                    }
                });
            }

            return isValidate;
        }


        function validateMaxQuantity($this) {
            var maxValue = parseInt($this.attr('max'));
            var currentValue = $this.val();
            if (currentValue != '') {
                currentValue = parseInt(currentValue);
                if (currentValue > maxValue) {
                    return false;
                }
            }
            return true;
        }

        function validateExpiry() {

            //$("#lblErrorExpiry")[0].innerText = '';
            $('#lblErrorExpiry').html('');

            var currentDate = new Date();
            var isExpValidate = true;
            var cardExp = $('#txtExpiry').val();

            var mm = parseInt(cardExp.substring(0, 2));
            var yy = parseInt(cardExp.substring(cardExp.length - 2));
            var currentMonth = parseInt(currentDate.getMonth() + 1);
            var currentYear = parseInt(currentDate.getFullYear().toString().substr(-2));

            if (mm > 12 || mm <= currentMonth) {
                if (yy == currentYear && mm >= currentMonth) {
                    isExpValidate = true;
                }
                else if (yy > currentYear && mm <= 12) {
                    isExpValidate = true;
                }
                else {
                    //$("#lblErrorExpiry")[0].innerText = "Month value must be 1 to 12 and greater than current month";
                    $('#lblErrorExpiry').append('<p>Month value must be 1 to 12 and greater than current month</p>');
                    isExpValidate = false;
                }
            }

            if (yy < currentYear) {
                //$("#lblErrorExpiry")[0].innerText = "Year value must be greater than or equal to current year";
                $('#lblErrorExpiry').append('<p>Year value must be greater than or equal to current year</p>');
                isExpValidate = false;
            }
            return isExpValidate;
        }

        function disableFields() {
            $('.switch-field input, .eventPackageFields input, .eventPackageFields select, ' +
                '.headerFields input, .headerFields select,' +
                '.donatoinSchedule input, .donatoinSchedule select').each(function () {
                    $(this).attr("disabled", "disabled");
                });

            $('#btnBack, #btnNext, .paying-info').hide();
            $('.payment-success').removeClass('hide');
        }

        function cardnumber() {
            var inputtxt = $("#txtCardNumber");

            var AE = /^(?:3[47][0-9]{13})$/;                 //Amercican Express
            var visa = /^(?:4[0-9]{12}(?:[0-9]{3})?)$/;      //Visa
            var MC = /^(?:5[1-5][0-9]{14})$/;                //Mastercard
            var Dis = /^(?:6(?:011|5[0-9][0-9])[0-9]{12})$/; //Discover
            var DC = /^(?:3(?:0[0-5]|[68][0-9])[0-9]{11})$/; //Dinners Club
            var JCB = /^(?:2131|1800|35\d{3})\d{11}$/;       //JCB
            var card_val = {
                "AE": 844060004,
                "visa": 844060000,
                "MC": 844060001,
                "Dis": 844060008,
                "DC": 844060005,
                "JCB": 844060006
            };

            var num = inputtxt.val();
            var match = true;
            var card_type = "";

            if (num.match(AE))
                card_type = "AE";
            else if (num.match(visa))
                card_type = "visa";
            else if (num.match(MC))
                card_type = "MC";
            else if (num.match(Dis))
                card_type = "Dis";
            else if (num.match(DC))
                card_type = "DC";
            else if (num.match(JCB))
                card_type = "JCB";
            else
                match = false;

            if (match) {
                inputtxt.removeClass('red-border');
                $('#ddlCardType').val(card_val[card_type]);
            }
            return match;
        }

        function checkLength(elem) {
            if ($(elem)[0].id == "txtCardExpiry") {
                if (elem.value.length < 4) {
                    $(elem).addClass('red-border');
                    $(elem).focus();
                    return false;
                }
            }
            else if ($(elem)[0].id == "txtCardCVV") {
                if (elem.value.length < 3) {
                    $(elem).addClass('red-border');
                    $(elem).focus();
                    return false;
                }
            }
            else if ($(elem)[0].id == "txtRoutingNumber") {
                $(elem).removeClass('red-border');
                if (elem.value.length != 9) {
                    $(elem).addClass('red-border');
                    $(elem).focus();
                    return false;
                }
            }
            else {
                $(elem).removeClass('red-border');
                return true;
            }
        }


        //Save Record
        function saveEventPackage() {

            var attributes = xrm.Page.data.entity.attributes.get();

            for (var i in attributes) { attributes[i].setSubmitMode("never"); }

            //$("#ajax-loader").show();
            var entity = {};
            //clickOnButton = true;
            //entity["msnfp_name"] = 'New Event Package';
            var annonymousDonation = $('input[name=annonymousDonation]:checked').val();
            if (annonymousDonation == 'true' && (selectedDonor == null || selectedDonor.length == 0)) {
                var announymousContactId = createAnnonymousContact();
                if (announymousContactId == null || announymousContactId == '')
                    return;
                entity["msnfp_CustomerId_contact@odata.bind"] = "/contacts(" + announymousContactId + ")";
                selectedDonor = {
                    contactid: announymousContactId,
                    isAccount: false,
                    Name: ($('#txtFirstName').val() + ' ' + $('#txtLastName').val())
                };
            }
            else {
                if (selectedDonor.isAccount)
                    entity["msnfp_CustomerId_account@odata.bind"] = "/accounts(" + selectedDonor.accountid + ")";
                else
                    entity["msnfp_CustomerId_contact@odata.bind"] = "/contacts(" + selectedDonor.contactid + ")";
            }

            if (selectedConstitute != null &&
                selectedConstitute.contactid != undefined &&
                selectedConstitute.contactid != '') {
                entity["msnfp_ConstituentId@odata.bind"] = "/contacts(" + selectedConstitute.contactid + ")";
            }
            else
                entity["msnfp_ConstituentId"] = null;

            if (eventID != null && eventID != '') {
                entity["msnfp_EventId@odata.bind"] = "/msnfp_events(" + eventID + ")";
            }
            else {
                entity["msnfp_EventId"] = null;
            }

            if (!isNullOrUndefined(xrm.Page.getControl("msnfp_campaigneventid"))) {
                var campaignEvent = xrm.Page.data.entity.attributes.get("msnfp_campaigneventid");
                if (!isNullOrUndefined(campaignEvent)) {
                    var campaignEventValue = campaignEvent.getValue();
                    if (!isNullOrUndefined(campaignEventValue)) {
                        var campaignEventID = XrmUtility.CleanGuid(campaignEventValue[0].id);
                        entity["msnfp_CampaignId@odata.bind"] = "/campaigns(" + campaignEventID + ")";
                    }
                }
            }

            entity["msnfp_date"] = DSTOffsetYYYYMMDD(new Date());

            var paymentType = $('input[name=paymentType]:checked').val();
            entity["msnfp_paymenttype"] = parseInt(paymentType);
            entity["msnfp_anonymous"] = $('input[name=annonymousDonation]:checked').val() == "true";

            if ($('input[name=giftSource]:checked').val() != undefined)
                entity["msnfp_dataentrysource"] = parseInt($('input[name=giftSource]:checked').val());

            entity["msnfp_firstname"] = $('#txtFirstName').val();
            entity["msnfp_lastname"] = $('#txtLastName').val();
            entity["msnfp_organizationname"] = $('#txtOrganization').val();
            entity["msnfp_emailaddress1"] = $('#txtEmail').val();
            entity["msnfp_telephone1"] = $('#txtPhone').val();
            entity["msnfp_billing_line1"] = $('#txtAddressLine1').val();
            entity["msnfp_billing_line2"] = $('#txtAddressLine2').val();
            entity["msnfp_billing_line3"] = $('#txtAddressLine3').val();
            entity["msnfp_billing_city"] = $('#txtAddressCity').val();
            entity["msnfp_billing_stateorprovince"] = $('#txtAddressProvince').val();
            entity["msnfp_billing_postalcode"] = $('#txtAddressPostalCode').val();
            entity["msnfp_quantity"] = $('#txtQuantity').val();
            entity["statuscode"] = parseInt(844060005); // In Progress

            if (paymentType == PaymentType.Cheque || paymentType == PaymentType.Wire)
                entity["msnfp_chequenumber"] = $('#txtChequeNumber').val();

            var totalPackageAmount = parseFloat($('#txtAmountOwning').val().replace(currencySymbol, '').replace(/[^\d\.\-]/g, ""));

            entity["msnfp_amount"] = totalPackageAmount;
            entity["msnfp_amount_balance"] = totalPackageAmount;
            entity["msnfp_amount_paid"] = 0;

            if (!isNullOrUndefined(xrm.Page.getControl("transactioncurrencyid"))) {
                var transactionCurrency = xrm.Page.data.entity.attributes.get("transactioncurrencyid").getValue();
                if (!isNullOrUndefined(transactionCurrency)) {
                    transactioncurrencyID = XrmUtility.CleanGuid(xrm.Page.data.entity.attributes.get("transactioncurrencyid").getValue()[0].id);

                    entity["transactioncurrencyid@odata.bind"] = "/transactioncurrencies(" + transactioncurrencyID + ")";
                }
                else {
                    entity["transactioncurrencyid"] = null;
                }
            }

            if (!isNullOrUndefined(configRecord)) {
                entity["msnfp_ConfigurationId@odata.bind"] = "/msnfp_configurations(" + configRecord.msnfp_configurationid + ")";
            }
            else {
                entity["msnfp_ConfigurationId"] = null;
            }

            xrm.Utility.showProgressIndicator("Processing Registration Package");

            if (currentID == undefined || currentID == '') {
                var qry = XrmServiceUtility.GetWebAPIUrl() + "msnfp_eventpackages";
                currentID = XrmServiceUtility.CreateRecordAsync(qry, entity, saveSuccess, errorFailure);
            }
            else {
                var qry = XrmServiceUtility.GetWebAPIUrl() + "msnfp_eventpackages(" + currentID + ")";
                currentID = XrmServiceUtility.UpdateRecordAsync(qry, entity, saveSuccess, errorFailure);
            }
        }

        function saveSuccess(currentID) {

            currentEventPackageID = currentID;
            var success = true;
            var paymentType = $('input[name=paymentType]:checked').val();
            if (success && currentID != '') {
                var selectQuery = "msnfp_eventpackages?";
                var filter = "$filter=(msnfp_eventpackageid eq " + currentID + ")";
                var result = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + selectQuery + filter);
                eventPackage = result[0];

                //if (paymentType == PaymentType.Bank || paymentType == PaymentType.CreditDebit) {
                //    success = checkPaymentStatus(currentID);
                //}

                parentEventRec = getEventRecord(eventID);
                if (!isNullOrUndefined(parentEventRec)) {
                    createSponsorships(currentID, parentEventRec);
                    createTickets(currentID, parentEventRec);
                    createAttendeesAndPreferences(currentID);
                    createProducts(currentID, parentEventRec);
                    createDonations(eventPackage, parentEventRec);

                    //setTimeout(createTickets(currentID, parentEventRec), 3000);
                    //setTimeout(createAttendeesAndPreferences(currentID), 3000);
                    //setTimeout(createProducts(currentID, parentEventRec), 3000);
                    //setTimeout(createDonations(eventPackage, parentEventRec), 3000);

                    // creating payment
                    if (paymentType != PaymentType.Invoice) {
                        createEventPackagePayment(currentID);
                    }
                }
                xrm.Utility.closeProgressIndicator();
                var parameters = {};
                xrm.Utility.openEntityForm("msnfp_eventpackage", currentID, parameters, true);
            }
            else {
                xrm.Utility.closeProgressIndicator();
                $('.error-payment').removeClass('hide');
                $('#lblPaymentFailed').html('');
                $('#lblPaymentFailed').append('<p>Payment Failed.</p>');
                $('.paying-info').addClass('hide');
                $('#btnNext').html('Retry <i class="button-icon fas fa-angle-right"></i>');
                $('#btnNext').attr('aria-label', 'Retry');
                isRetry = true;
            }
        }

        function getEventRecord(eventID) {
            var evt;
            var selectQuery = "msnfp_events?";
            var filter = "$filter=(msnfp_eventid eq " + eventID + ")";
            var result = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + selectQuery + filter);
            if (!isNullOrUndefined(result) && result.length > 0)
                evt = result[0];

            return evt;
        }

        function errorFailure(message) {
            xrm.Utility.closeProgressIndicator();

            //$('.error-payment').removeClass('hide');
            //$('.paying-info').addClass('hide');
            //$('#lblPaymentFailed').html('');
            //$('#lblPaymentFailed').append('<p>Payment Failed.</p>');
            //$('#btnNext').html('Retry <i class="button-icon fas fa-angle-right"></i>');
            //$('#btnNext').attr('aria-label', 'Retry');
            //isRetry = true;

            alert(message);
        }

        function createAnnonymousContact() {
            var contact = {};
            contact["firstname"] = $('#txtFirstName').val();
            contact["lastname"] = $('#txtLastName').val();
            var qry = XrmServiceUtility.GetWebAPIUrl() + "contacts";
            return XrmServiceUtility.CreateRecord(qry, contact);
        }

        function saveCreditCardDetails() {
            var invoiceIdentifier = "MIS" + RandomGuid().substring(0, 7).toUpperCase();

            if ($('.credit-details .notExists').is(':visible')) {
                if ($('#ddlExistingCard').val() != '-1') {
                    var select = "msnfp_paymentmethods?$select=msnfp_paymentmethodid,msnfp_ccbrandcode";
                    var filter = "&$filter=(msnfp_paymentmethodid eq " + $('#ddlExistingCard').val() + ")";
                    var result = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + select + filter);
                    if (result != null) {
                        result = result[0];
                        creditCardType = result.msnfp_ccbrandcode;
                    }
                    return $('#ddlExistingCard').val();
                }
            }

            var eEntity = {};

            if (selectedDonor.isAccount) {
                eEntity["msnfp_CustomerId_account@odata.bind"] = "/accounts(" + selectedDonor.accountid + ")";
            }
            else {
                eEntity["msnfp_CustomerId_contact@odata.bind"] = "/contacts(" + selectedDonor.contactid + ")";
            }

            var cardNo = $('#txtCardNumber').val();


            var totalPackageAmount = parseFloat($('#txtAmountOwning').val().replace(currencySymbol, '').replace(/[^\d\.\-]/g, ""));
            var packageAmountPaid = parseFloat($('#txtPayingToday').val().replace(currencySymbol, '').replace(/[^\d\.\-]/g, ""));

            if (totalPackageAmount == packageAmountPaid) {
                eEntity["msnfp_isreusable"] = false;
            }
            else {
                eEntity["msnfp_isreusable"] = true;
            }


            eEntity["msnfp_firstname"] = $('#txtFirstName').val();
            eEntity["msnfp_lastname"] = $('#txtLastName').val();
            eEntity["msnfp_nameonfile"] = $("#txtCardName").val();
            eEntity["msnfp_billing_line1"] = $('#txtAddressLine1').val();
            eEntity["msnfp_billing_line2"] = $('#txtAddressLine2').val();
            eEntity["msnfp_billing_line3"] = $('#txtAddressLine3').val();
            eEntity["msnfp_billing_city"] = $('#txtAddressCity').val();
            eEntity["msnfp_billing_postalcode"] = $('#txtAddressPostalCode').val();
            eEntity["msnfp_cclast4"] = cardNo;
            eEntity["msnfp_ccexpmmyy"] = formatExpiry($('#txtExpiry').val());
            eEntity["msnfp_ccbrandcode"] = $('#ddlCardType').val();
            creditCardType = $('#ddlCardType').val();
            var identifier = RandomGuid().substring(0, 8);
            eEntity["msnfp_identifier"] = identifier;
            eEntity["msnfp_name"] = $('#ddlCardType option:selected').text() + " - " + cardNo.substr(cardNo.length - 4);
            eEntity["msnfp_type"] = 844060000;
            eEntity["msnfp_PaymentProcessorId@odata.bind"] = "/msnfp_paymentprocessors(" + configRecord._msnfp_paymentprocessorid_value + ")";

            var query = XrmServiceUtility.GetWebAPIUrl() + "msnfp_paymentmethods";
            return XrmServiceUtility.CreateRecord(query, eEntity);
        }


        function createEventPackagePayment(currentID) {

            var payment = {};
            var dte = new Date();
            var month = ("0" + (dte.getMonth() + 1)).slice(-2);
            var date = ("0" + dte.getDate()).slice(-2);
            var year = dte.getFullYear();
            dte = month + date + year;
            var paymentType = $('input[name=paymentType]:checked').val();
            var payingToday = parseFloat($('#txtPayingToday').val().replace(currencySymbol, '').replace(/[^\d\.\-]/g, ""));

            if (payingToday > 0) {

                payment["msnfp_name"] = "PMNT" + dte + "_" + parseFloat($('#txtPayingToday').val().replace(currencySymbol, '').replace(/[^\d\.\-]/g, ""));
                payment["msnfp_amount"] = payingToday;
                payment["msnfp_amount_balance"] = payingToday;

                if (paymentType == PaymentType.Cheque) {
                    payment["msnfp_chequenumber"] = $('#txtChequeNumber').val();
                    payment["msnfp_paymenttype"] = 844060001;//Cheque
                }
                else if (paymentType == PaymentType.Wire) {
                    payment["msnfp_chequenumber"] = $('#txtChequeNumber').val();
                    payment["msnfp_paymenttype"] = 844060009;//Wire
                }
                else if (paymentType == PaymentType.Cash) {
                    payment["msnfp_paymenttype"] = 844060000;//Cash
                }
                else if (paymentType == PaymentType.CreditDebit) {
                    paymentMethodId = saveCreditCardDetails();
                    if (paymentMethodId != null) {
                        payment["msnfp_PaymentMethodId@odata.bind"] = "/msnfp_paymentmethods(" + paymentMethodId + ")";
                        payment["msnfp_paymenttype"] = 844060002;//Credit Card
                    }
                    else {
                        alert('Invalid Credit Card details.');
                        return;
                    }
                }

                if (!isNullOrUndefined(configRecord._msnfp_paymentprocessorid_value))
                    payment["msnfp_PaymentProcessorId@odata.bind"] = "/msnfp_paymentprocessors(" + configRecord._msnfp_paymentprocessorid_value + ")";

                if (selectedDonor.isAccount)
                    payment["msnfp_customerid_account@odata.bind"] = "/accounts(" + selectedDonor.accountid + ")";
                else
                    payment["msnfp_customerid_contact@odata.bind"] = "/contacts(" + selectedDonor.contactid + ")";

                payment["msnfp_bookdate"] = DSTOffsetYYYYMMDD(new Date());
                payment["statuscode"] = parseInt(844060000);//completed
                payment["msnfp_eventpackageid@odata.bind"] = "/msnfp_eventpackages(" + currentID + ")";

                // Save the configuration to the payment from the user:
                if (!isNullOrUndefined(userConfigID)) {
                    payment["msnfp_ConfigurationId@odata.bind"] = "/msnfp_configurations(" + userConfigID + ")";
                }

                if (!isNullOrUndefined(transactioncurrencyID))
                    payment["transactioncurrencyid@odata.bind"] = "/transactioncurrencies(" + transactioncurrencyID + ")";

                var qry = XrmServiceUtility.GetWebAPIUrl() + "msnfp_payments";
                XrmServiceUtility.CreateRecord(qry, payment);
            }
        }

        //related msnfp_sponsorships
        function createSponsorships(currentID, eventRec) {
            $(listSponsorships).each(function () {
                if (this.quantity > 0) {
                    for (var i = 0; i < this.quantity; i++) {
                        var eEntity = {};
                        eEntity["msnfp_amount"] = this.amount;
                        eEntity["msnfp_amount_receipted"] = this.amountReceipted;
                        eEntity["msnfp_amount_nonreceiptable"] = this.amountNonReceiptable;
                        eEntity["msnfp_amount_tax"] = this.amountTax;
                        eEntity["msnfp_date"] = DSTOffsetYYYYMMDD(new Date());
                        eEntity["statuscode"] = 844060003; //pending payment

                        if (selectedDonor.isAccount)
                            eEntity["msnfp_CustomerId_account@odata.bind"] = "/accounts(" + selectedDonor.accountid + ")";
                        else
                            eEntity["msnfp_CustomerId_contact@odata.bind"] = "/contacts(" + selectedDonor.contactid + ")";

                        eEntity["msnfp_EventId@odata.bind"] = "/msnfp_events(" + eventID + ")";
                        eEntity["msnfp_EventSponsorshipId@odata.bind"] = "/msnfp_eventsponsorships(" + this.id + ")";
                        eEntity["msnfp_EventPackageId@odata.bind"] = "/msnfp_eventpackages(" + currentID + ")";

                        if (!isNullOrUndefined(transactioncurrencyID))
                            eEntity["transactioncurrencyid@odata.bind"] = "/transactioncurrencies(" + transactioncurrencyID + ")";

                        var query = XrmServiceUtility.GetWebAPIUrl() + "msnfp_sponsorships";
                        XrmServiceUtility.CreateRecord(query, eEntity);
                        //XrmServiceUtility.CreateRecordAsync(query, eEntity, saveRelatedSuccess, errorFailure);
                    }
                }
            });
        }

        //related msnfp_tickets(Ticket)
        function createTickets(currentID, eventRec) {
            $(listTickets).each(function () {
                if (this.quantity > 0) {
                    var i = 0;
                    for (i = 0; i < this.quantity; i++) {
                        var eEntity = {};
                        eEntity["msnfp_amount"] = this.amount;
                        eEntity["msnfp_amount_receipted"] = this.amountReceipted;
                        eEntity["msnfp_amount_nonreceiptable"] = this.amountNonReceiptable;
                        eEntity["msnfp_amount_tax"] = this.amountTax;
                        eEntity["msnfp_registrationsperticket"] = this.registrationsPerTicket;
                        eEntity["msnfp_name"] = this.name;

                        if (selectedDonor.isAccount)
                            eEntity["msnfp_CustomerId_account@odata.bind"] = "/accounts(" + selectedDonor.accountid + ")";
                        else
                            eEntity["msnfp_CustomerId_contact@odata.bind"] = "/contacts(" + selectedDonor.contactid + ")";

                        eEntity["msnfp_EventId@odata.bind"] = "/msnfp_events(" + eventID + ")";
                        eEntity["msnfp_EventPackageId@odata.bind"] = "/msnfp_eventpackages(" + currentID + ")";
                        eEntity["msnfp_EventTicketId@odata.bind"] = "/msnfp_eventtickets(" + this.id + ")";

                        if (!isNullOrUndefined(transactioncurrencyID))
                            eEntity["transactioncurrencyid@odata.bind"] = "/transactioncurrencies(" + transactioncurrencyID + ")";

                        var query = XrmServiceUtility.GetWebAPIUrl() + "msnfp_tickets";
                        var ticketID = XrmServiceUtility.CreateRecord(query, eEntity);

                        createAttendeesAndPreferences(currentID, ticketID, this.id);
                        //var ticketID = XrmServiceUtility.CreateRecordAsync(query, eEntity, saveRelatedSuccess, errorFailure);
                    }
                }
            });
        }

        function createAttendeesAndPreferences(currentID, ticketID, eTicketID) {

            if (listAttendees.length > 0) {

                var totalRecordsCreated = 0;

                $(listAttendees).each(function (index) {

                    var currentrId = this.rId;
                    var eventTicketID = this.eventTicketId;
                    var firstName = this.firstName;
                    var lastName = this.lastName;
                    var email = this.email;
                    var phone = this.phone;
                    var createContact = this.createContact;

                    if (!isNullOrUndefined(eventTicketID) && eventTicketID == eTicketID) {

                        var contactID;
                        var tResult = $.grep(listTickets, function (e) { return e.id == eventTicketID; });

                        if (!isNullOrUndefined(tResult) && !isNullOrUndefined(tResult[0]) && !isNullOrUndefined(tResult[0].registrationsPerTicket)) {

                            var totalRegs = tResult[0].registrationsPerTicket;

                            if (totalRecordsCreated < totalRegs) {

                                if (matchContact && (matchNames || matchEmail || matchPhone)) {

                                    var select = "contacts?$select=contactid,lastname";
                                    var filter;

                                    if ((matchNames && firstName != undefined && lastName != undefined) && (matchEmail && email != undefined) && (matchPhone && phone != undefined))
                                        filter = "&$filter=(statecode eq 0 and firstname eq '" + firstName + "' and lastname eq '" + lastName + "' and emailaddress1 eq '" + email + "' and telephone1 eq '" + phone + "')";
                                    else if (matchNames && firstName != undefined && lastName != undefined)
                                        filter = "&$filter=(statecode eq 0 and firstname eq '" + firstName + "' and lastname eq '" + lastName + "')";
                                    else if (matchEmail && email != undefined)
                                        filter = "&$filter=(statecode eq 0 and emailaddress1 eq '" + email + "')";
                                    else if (matchPhone && phone != undefined)
                                        filter = "&$filter=(statecode eq 0 and telephone1 eq '" + phone + "')";

                                    var contactResult = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + select + filter);

                                    if (contactResult != undefined)
                                        contactID = contactResult[0].contactid;
                                }

                                // creating Contact record
                                if (isNullOrUndefined(contactID) && (createContact == true || autoCreateContact)) {

                                    var cEntity = {};

                                    if (firstName != "")
                                        cEntity["firstname"] = firstName;

                                    if (lastName != "")
                                        cEntity["lastname"] = lastName;

                                    if (email != "")
                                        cEntity["emailaddress1"] = email;

                                    if (phone != "")
                                        cEntity["telephone1"] = phone;

                                    var cQuery = XrmServiceUtility.GetWebAPIUrl() + "contacts";
                                    contactID = XrmServiceUtility.CreateRecord(cQuery, cEntity);
                                }

                                var rEntity = {};
                                rEntity["msnfp_date"] = DSTOffsetYYYYMMDD(new Date());
                                rEntity["msnfp_EventId@odata.bind"] = "/msnfp_events(" + eventID + ")";
                                rEntity["msnfp_EventPackageId@odata.bind"] = "/msnfp_eventpackages(" + currentID + ")";
                                rEntity["msnfp_EventTicketId@odata.bind"] = "/msnfp_eventtickets(" + eventTicketID + ")";
                                rEntity["statuscode"] = 1; //pending payment

                                rEntity["msnfp_TicketId@odata.bind"] = "/msnfp_tickets(" + ticketID + ")";

                                if (firstName != "")
                                    rEntity["msnfp_firstname"] = firstName;

                                if (lastName != "")
                                    rEntity["msnfp_lastname"] = lastName;

                                if (email != "")
                                    rEntity["msnfp_email"] = email;

                                if (phone != "")
                                    rEntity["msnfp_telephone"] = phone;

                                if (index == 0) {

                                    // first attendee - populating donors address
                                    if (firstName == $('#txtFirstName').val() && lastName == $('#txtLastName').val()) {
                                        rEntity["msnfp_address_line1"] = $('#txtAddressLine1').val();
                                        rEntity["msnfp_address_line2"] = $('#txtAddressLine2').val();
                                        rEntity["msnfp_address_city"] = $('#txtAddressCity').val();
                                        rEntity["msnfp_address_province"] = $('#txtAddressProvince').val();
                                        rEntity["msnfp_address_postalcode"] = $('#txtAddressPostalCode').val();
                                        rEntity["msnfp_address_country"] = $('#txtCountry').val();
                                    }
                                }

                                // populating Donor
                                if (selectedDonor.isAccount)
                                    rEntity["msnfp_customerid_account@odata.bind"] = "/accounts(" + selectedDonor.accountid + ")";
                                else
                                    rEntity["msnfp_customerid_contact@odata.bind"] = "/contacts(" + selectedDonor.contactid + ")";

                                // associating newly created Contact with Registration
                                if (contactID != null && contactID != undefined)
                                    rEntity["msnfp_ContactId@odata.bind"] = "/contacts(" + contactID + ")";

                                var rQuery = XrmServiceUtility.GetWebAPIUrl() + "msnfp_registrations";
                                var registrationID = XrmServiceUtility.CreateRecord(rQuery, rEntity);


                                if (!isNullOrUndefined(registrationID))
                                    totalRecordsCreated++;


                                if (registrationID != null) {

                                    $('.aLinkContent').each(function (index) {
                                        if ($(this).attr("id") == currentrId) {
                                            contents = $(this);

                                            contents.find('table.table-preference tbody tr').each(function () {
                                                var $this = $(this);

                                                $eventPreferenceID = $this.find('input[name*="txtEventPreferenceID"]');

                                                if ($eventPreferenceID.length > 0) {
                                                    $otherPreference = $this.find('textarea[name*="txtOtherPreference"]');
                                                    var chkCurrent = $this.find('input[name*="chkEventPreference"]');

                                                    // registration preference object
                                                    var newPreference = {};
                                                    newPreference["msnfp_EventId@odata.bind"] = "/msnfp_events(" + eventID + ")";
                                                    newPreference["msnfp_RegistrationId@odata.bind"] = "/msnfp_registrations(" + registrationID + ")";
                                                    newPreference["msnfp_EventPreference@odata.bind"] = "/msnfp_eventpreferences(" + $eventPreferenceID.val() + ")";

                                                    // event preference selected
                                                    if (chkCurrent.prop('checked'))
                                                        newPreference["msnfp_checkbox"] = true;

                                                    if ($otherPreference.val() != "" && $otherPreference.val() != undefined)
                                                        newPreference["msnfp_other"] = $otherPreference.val();

                                                    // Create new Registration Preference
                                                    var qry = XrmServiceUtility.GetWebAPIUrl() + "msnfp_registrationpreferences";
                                                    XrmServiceUtility.CreateRecord(qry, newPreference);
                                                }
                                            });
                                        }
                                    });
                                }

                                // removing event ticket id
                                this.eventTicketId = "";
                            }
                        }
                    }

                });
            }
        }

        //related msnfp_products
        function createProducts(currentID, eventRec) {

            $(listProducts).each(function () {
                if (this.quantity > 0) {

                    var i = 0;
                    for (i = 0; i < this.quantity; i++) {
                        var eEntity = {};
                        eEntity["msnfp_amount"] = this.totalAmount;
                        eEntity["msnfp_amount_receipted"] = this.amountReceipted;
                        eEntity["msnfp_amount_nonreceiptable"] = this.amountNonReceiptable;
                        eEntity["msnfp_amount_tax"] = this.amountTax;
                        eEntity["msnfp_date"] = DSTOffsetYYYYMMDD(new Date());

                        if (selectedDonor.isAccount)
                            eEntity["msnfp_CustomerId_account@odata.bind"] = "/accounts(" + selectedDonor.accountid + ")";
                        else
                            eEntity["msnfp_CustomerId_contact@odata.bind"] = "/contacts(" + selectedDonor.contactid + ")";

                        eEntity["msnfp_EventId@odata.bind"] = "/msnfp_events(" + eventID + ")";
                        eEntity["msnfp_EventProductId@odata.bind"] = "/msnfp_eventproducts(" + this.id + ")";
                        eEntity["msnfp_EventPackageId@odata.bind"] = "/msnfp_eventpackages(" + currentID + ")";

                        if (!isNullOrUndefined(transactioncurrencyID))
                            eEntity["transactioncurrencyid@odata.bind"] = "/transactioncurrencies(" + transactioncurrencyID + ")";

                        eEntity["statuscode"] = 1; //pending payment

                        var query = XrmServiceUtility.GetWebAPIUrl() + "msnfp_products";
                        XrmServiceUtility.CreateRecord(query, eEntity);
                        //XrmServiceUtility.CreateRecordAsync(query, eEntity, saveRelatedSuccess, errorFailure);
                    }
                }
            });
        }

        //related msnfp_transactions
        function createDonations(eventPackageEntity, eventRec) {
            $(listDonations).each(function () {

                if (this.isSelected) {
                    var entity = {};

                    if (selectedDonor.isAccount)
                        entity["msnfp_CustomerId_account@odata.bind"] = "/accounts(" + selectedDonor.accountid + ")";
                    else
                        entity["msnfp_CustomerId_contact@odata.bind"] = "/contacts(" + selectedDonor.contactid + ")";

                    if (eventPackageEntity._msnfp_constituentid_value != null)
                        entity["msnfp_RelatedConstituentId@odata.bind"] = "/contacts(" + eventPackageEntity._msnfp_constituentid_value + ")";

                    if (!isNullOrUndefined(eventPackageEntity._msnfp_eventid_value))
                        entity["msnfp_EventId@odata.bind"] = "/msnfp_events(" + eventPackageEntity._msnfp_eventid_value + ")";

                    entity["msnfp_EventPackageId@odata.bind"] = "/msnfp_eventpackages(" + eventPackageEntity.msnfp_eventpackageid + ")";
                    entity["msnfp_EventDonationId@odata.bind"] = "/msnfp_eventdonations(" + this.id + ")";

                    entity["msnfp_bookdate"] = DSTOffset(new Date());
                    entity["msnfp_typecode"] = 844060000; //Donation

                    entity["msnfp_firstname"] = eventPackageEntity["msnfp_firstname"];
                    entity["msnfp_lastname"] = eventPackageEntity["msnfp_lastname"];
                    entity["msnfp_organizationname"] = eventPackageEntity["msnfp_organizationname"];
                    entity["msnfp_emailaddress1"] = eventPackageEntity["msnfp_emailaddress1"];
                    entity["msnfp_telephone1"] = eventPackageEntity["msnfp_telephone1"];
                    entity["msnfp_billing_line1"] = eventPackageEntity["msnfp_billing_line1"];
                    entity["msnfp_billing_line2"] = eventPackageEntity["msnfp_billing_line2"];
                    entity["msnfp_billing_line3"] = eventPackageEntity["msnfp_billing_line3"];
                    entity["msnfp_billing_city"] = eventPackageEntity["msnfp_billing_city"];
                    entity["msnfp_billing_stateorprovince"] = eventPackageEntity["msnfp_billing_stateorprovince"];
                    entity["msnfp_billing_postalcode"] = eventPackageEntity["msnfp_billing_postalcode"];
                    entity["statuscode"] = parseInt(844060000);//completed

                    if (!isNullOrUndefined(eventRec._msnfp_campaignid_value))
                        entity["msnfp_OriginatingCampaignId@odata.bind"] = "/campaigns(" + eventRec._msnfp_campaignid_value + ")";

                    if (!isNullOrUndefined(eventRec._msnfp_appealid_value))
                        entity["msnfp_AppealId@odata.bind"] = "/msnfp_appeals(" + eventRec._msnfp_appealid_value + ")";

                    if (!isNullOrUndefined(eventRec._msnfp_packageid_value))
                        entity["msnfp_PackageId@odata.bind"] = "/msnfp_packages(" + eventRec._msnfp_packageid_value + ")";

                    if (!isNullOrUndefined(eventRec._msnfp_designationid_value))
                        entity["msnfp_DesignationId@odata.bind"] = "/msnfp_designations(" + eventRec._msnfp_designationid_value + ")";

                    entity["msnfp_amount_receipted"] = parseFloat(this.totalAmount);
                    entity["msnfp_amount"] = parseFloat(this.totalAmount);
                    entity["msnfp_chargeoncreate"] = false;

                    if (!isNullOrUndefined(configRecord)) {
                        entity["msnfp_ConfigurationId@odata.bind"] = "/msnfp_configurations(" + configRecord.msnfp_configurationid + ")";
                    }
                    else {
                        entity["msnfp_ConfigurationId"] = null;
                    }

                    if (!isNullOrUndefined(transactioncurrencyID))
                        entity["transactioncurrencyid@odata.bind"] = "/transactioncurrencies(" + transactioncurrencyID + ")";

                    var qry = XrmServiceUtility.GetWebAPIUrl() + "msnfp_transactions";
                    XrmServiceUtility.CreateRecord(qry, entity);
                    //XrmServiceUtility.CreateRecordAsync(qry, entity, saveRelatedSuccess, errorFailure);
                }
            });
        }

        //function errorFailure(message) { alert(message); }

        //function checkPaymentStatus(currentID) {
        //    $('.wizard-error').hide();

        //    var select = "msnfp_eventpackages?$select=msnfp_transactionresult,statuscode";
        //    var filter = "&$filter=(msnfp_eventpackageid eq " + currentID + ")";
        //    var result = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + select + filter);
        //    if (result != null) {
        //        result = result[0];
        //        if (result.statuscode == 844060000) {
        //            return true;
        //        }
        //        else {
        //            $('.wizard-error').show();
        //            $('.wizard-error').text(result.msnfp_transactionresult);
        //            return false;
        //        }
        //    }
        //    return false;
        //}

        //Print
        $('#btnPrintThankyou').click(function () {
            DownloadReceiptTemplete("Microsoft.Dynamics.CRM.msnfp_ActionEventPackageThankYou");
        });

        $('#btnPrintReceipt').click(function () {
            DownloadReceiptTemplete("Microsoft.Dynamics.CRM.msnfp_ActionEventPackageReceipt");
        });


        function ExecuteWorkflow(currentID, workflowId) {
            var functionName = "executeWorkflow >>";
            var query = "";
            try {
                //Define the query to execute the action
                query = "workflows(" + workflowId.replace("}", "").replace("{", "") + ")/Microsoft.Dynamics.CRM.ExecuteWorkflow";
                var data = { "EntityId": currentID };

                var req = new XMLHttpRequest();
                req.open("POST", XrmServiceUtility.GetWebAPIUrl() + query, true);
                req.setRequestHeader("Accept", "application/json");
                req.setRequestHeader("Content-Type", "application/json; charset=utf-8");
                req.setRequestHeader("OData-MaxVersion", "4.0");
                req.setRequestHeader("OData-Version", "4.0");

                req.onreadystatechange = function () {
                    if (this.readyState == 4) {
                        req.onreadystatechange = null;
                        if (this.status == 200) {
                            //success callback this returns null since no return value available.
                            var result = JSON.parse(this.response);
                            xrm.Utility.alertDialog("Mail sent successfully");
                        }
                        else {
                            //error callback
                            var error = JSON.parse(this.response).error;
                        }
                    }
                };
                req.send(JSON.stringify(data));
            }
            catch (e) {
                throwError(functionName, e);
            }
        }

        function getWorkflowId(workflowName) {
            var str = "workflows?$select=workflowid&$filter=statecode eq 1 and _parentworkflowid_value eq null and name eq \'" + workflowName + "\'";
            var workflowRecord = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + str);
            if (workflowRecord != undefined && workflowRecord != null) {
                return workflowRecord[0].workflowid;
            }
            return undefined;
        }

        function displayError(e) {
            alert(this.status);
        }

        function DownloadReceiptTemplete(requestName) {
            var entityId = xrm.Page.data.entity.getId().replace(/\{|\}/gi, '');

            try {
                var entity = {};

                var organizationUrl = xrm.Page.context.getClientUrl();
                var data = {};
                var query = "msnfp_eventpackages(" + entityId + ")/" + requestName;
                var req = new XMLHttpRequest();
                req.open("POST", organizationUrl + "/api/data/v8.0/" + query, true);
                req.setRequestHeader("Accept", "application/json");
                req.setRequestHeader("Content-Type", "application/json; charset=utf-8");
                req.setRequestHeader("OData-MaxVersion", "4.0");
                req.setRequestHeader("OData-Version", "4.0");
                req.onreadystatechange = function () {
                    if (this.readyState == 4) {
                        req.onreadystatechange = null;
                        if (this.status == 204) {
                            select = "annotations?$select=documentbody,createdon,subject,filename,notetext,_objectid_value,annotationid&$orderby=createdon desc&$top=1&$filter=(_objectid_value eq " + entityId + ")";
                            var result = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + select);
                            if (result != null && result.length > 0) {
                                download(base64ToArrayBuffer(result[0].documentbody), result[0].filename, "application/pdf");
                                XrmServiceUtility.DeleteRecord(result[0].annotationid, 'annotations');
                            }
                        }
                    }
                };
                req.send(window.JSON.stringify(data));
            }
            catch (error) {
                //errorHandler(error);
            }
        }

        function base64ToArrayBuffer(base64) {
            var binaryString = window.atob(base64);
            var len = binaryString.length;
            var bytes = new Uint8Array(len);
            for (var i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        //Helper Methods
        function unique(array) {
            return array.filter(function (el, index, arr) {
                return index === arr.indexOf(el);
            });
        }

        function getLookupGuid(fieldName) {
            var field = xrm.Page.data.entity.attributes.get(fieldName);
            if (field != null && field.getValue() != null) {
                return xrm.Page.data.entity.attributes.get(fieldName).getValue()[0].id.replace('{', '').replace('}', '');
            }
            return null;
        }

        function RandomGuid() {
            return s4() + s4() + '' + s4() + '' + s4() + '' +
                s4() + '' + s4() + s4() + s4();
        }

        function s4() {
            return Math.floor((1 + Math.random()) * 0x10000)
                .toString(16)
                .substring(1);
        }

        function isEmail(email) {
            var regex = /^([a-zA-Z0-9_.+-])+\@(([a-zA-Z0-9-])+\.)+([a-zA-Z0-9]{2,4})+$/;
            return regex.test(email);
        }

        function checkIt(evt) {
            evt = (evt) ? evt : window.event;
            var charCode = (evt.which) ? evt.which : evt.keyCode;
            if (charCode > 31 && (charCode < 48 || charCode > 57)) {
                return false;
            }
            return true;
        }

        //Pay for this Package
        $('#btnPayforPackage').click(function () {
            var windowOptions = { openInNewWindow: true, height: 770, width: 700 }
            xrm.Navigation.openWebResource("msnfp_/webpages/payforpackagepopup.html", windowOptions, "entityGUID=" + currentID);

        });

        var activeAjaxCount = 0;

        function updateAttendeeList() {  // saving attendees in temporary object in case user clicks back button

            listAttendeesEdited = [];

            $('.attendee-item').each(function (i, row) {
                var $row = $(row),
                    $eventTicketID = $row.find('input[name*="hdnEventTicketID"]');
                $rid = $row.find('input[name*="hdnRecID"]');
                $firstName = $row.find('input[name*="txtRegFirstName"]');
                $lastName = $row.find('input[name*="txtRegLastName"]');
                $email = $row.find('input[name*="txtRegEmail"]');
                $phone = $row.find('input[name*="txtRegPhone"]');
                $createContact = $row.find('input[type="checkbox"]');
                $ticketCounter = $row.find('span[class*="ticketCounter"]');

                var attendee = {
                    eventTicketId: $eventTicketID.val(),
                    rid: $rid.val(),
                    firstName: $firstName.val(),
                    lastName: $lastName.val(),
                    email: $email.val(),
                    phone: $phone.val(),
                    createContact: $createContact.prop("checked"),
                    ticketCounter: $ticketCounter.prop("innerText")
                }

                listAttendeesEdited.push(attendee);

            });
        }

        function updatePreferenceList() {  // saving preferences in temporary object in case user clicks back button

            listPreferencesEdited = [];
            $(listAttendees).each(function (index) {

                var currentrId = this.rId;
                var eventTicketID = this.eventTicketId;
                var attendeeID = this.attendeeId;

                if ((eventTicketID != null && eventTicketID != "") && (attendeeID != null && attendeeID != "")) {

                    $('.aLinkContent').each(function (index) {
                        if ($(this).attr("id") == currentrId) {
                            contents = $(this);

                            contents.find('table.table-preference tbody tr').each(function () {
                                var $this = $(this);

                                $eventPreferenceID = $this.find('input[name*="txtEventPreferenceID"]');

                                if ($eventPreferenceID.length > 0) {
                                    $otherPreference = $this.find('textarea[name*="txtOtherPreference"]');
                                    var chkCurrent = $this.find('input[name*="chkEventPreference"]');
                                    var prefChecked = false;

                                    if (chkCurrent.prop('checked'))
                                        prefChecked = true;

                                    var attendeePreference = {
                                        eventPreferenceID: $eventPreferenceID.val(),
                                        attendeeId: attendeeID,
                                        otherPreference: $otherPreference.val(),
                                        prefChecked: prefChecked
                                    }

                                    listPreferencesEdited.push(attendeePreference);

                                }
                            });
                        }
                    });
                }
            });
        }


        function loadAttendeePreferences() {  // loading previously selected event preferences

            if (listPreferencesEdited.length > 0) {

                $(listAttendees).each(function (index) {

                    var currentrId = this.rId;
                    var eventTicketID = this.eventTicketId;
                    var attendeeId = this.attendeeId;

                    if (eventTicketID != null && eventTicketID != "") {

                        $('.aLinkContent').each(function (index) {
                            if ($(this).attr("id") == currentrId) {
                                contents = $(this);

                                contents.find('table.table-preference tbody tr').each(function () {
                                    var $this = $(this);

                                    $eventPreferenceID = $this.find('input[name*="txtEventPreferenceID"]');

                                    var attnPrefFound = getAttendeePreference(attendeeId, $eventPreferenceID.val());

                                    if (!isNullOrUndefined(attnPrefFound)) {

                                        var otherPreference = $this.find('textarea[name*="txtOtherPreference"]');
                                        var chkEventPreference = $this.find('input[name*="chkEventPreference"]');

                                        $(otherPreference).val(attnPrefFound.otherPreference);

                                        if (attnPrefFound.prefChecked == true)
                                            $(chkEventPreference).prop('checked', true);
                                    }
                                });
                            }
                        });

                    }
                });
            }
        }

        function getAttendee(ticketId, tCounter) {

            var attObj = listAttendeesEdited.filter(function (result) {
                return result.eventTicketId === ticketId && result.ticketCounter === tCounter;
            });

            return attObj[0];
        }

        function getAttendeePreference(attendeeId, eventPreferenceId) {

            var prefObj = listPreferencesEdited.filter(function (result) {
                return result.attendeeId === attendeeId && result.eventPreferenceID === eventPreferenceId;
            });

            return prefObj[0];

        }

        function saveRelatedSuccess(recordID) {
            //this function is required for loading image when related tickets, products, donation save.
        }

        function getNameForPaymentProcessor(paymentProcessorId) {
            var retval = "";

            if (isNullOrUndefined(paymentProcessorId)) {
                return retval;
            }

            var selectPP = "msnfp_paymentprocessors?$select=msnfp_paymentprocessorid,msnfp_name,msnfp_paymentgatewaytype";
            filterPP = "&$filter=(msnfp_paymentprocessorid eq " + XrmUtility.CleanGuid(paymentProcessorId) + ")";
            var resultPP = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + selectPP + filterPP);

            if (resultPP != null) {
                if (resultPP[0].msnfp_name != null) {
                    retval = resultPP[0].msnfp_name;
                }
            }

            return retval;
        }

        function formatExpiry(val) {
            if (val.length === 4)
                return val;

            if (val.indexOf("/") > 0) {
                var s = val.split("/");
                var yr = "";
                if (s[1].length === 4)
                    yr = s[1].substring(0, 2);
                if (s[1].length === 2)
                    yr = s[1];
            }

            return s[0] + yr;
        }

        function isNullOrUndefined(value) {
            return (typeof (value) === "undefined" || value === null || value === "");
        }

        function getFormattedDate(date) {
            return ("0" + (date.getMonth() + 1)).slice(-2)
                + "/"
                + ("0" + date.getDate()).slice(-2)
                + "/"
                + date.getFullYear();
        }

        function addCommasonLoad(nStr) {
            if (nStr != 0) {
                nStr = nStr.replace(currencySymbol, '').replace(',', '');
                nStr += '';
                x = nStr.split('.');
                x1 = x[0];
                x2 = x.length > 1 ? '.' + x[1] : '';
                var rgx = /(\d+)(\d{3})/;
                while (rgx.test(x1)) {
                    x1 = x1.replace(rgx, '$1' + ',' + '$2');
                }
                return x1 + x2;
            }
            else return '0.00';
        }


        function DSTOffset(str) {
            if (str != null && str != undefined && userSettings != null && userSettings != undefined) {
                let dt = new Date(str);
                let start = new Date(dt.getYear(), userSettings.timezonedaylightmonth - 1, userSettings.timezonedaylightday);
                let end = new Date(dt.getYear(), userSettings.timezonestandardmonth - 1, userSettings.timezonestandardday);
                if (dt >= start && dt < end) dt.setMinutes(-userSettings.timezonedaylightbias);
                return dt;
            }
        }

        function DSTOffsetYYYYMMDD(str) {
            if (str != null && str != undefined && userSettings != null && userSettings != undefined) {
                let dt = new Date(str);
                let start = new Date(dt.getYear(), userSettings.timezonedaylightmonth - 1, userSettings.timezonedaylightday);
                let end = new Date(dt.getYear(), userSettings.timezonestandardmonth - 1, userSettings.timezonestandardday);
                if (dt >= start && dt < end) dt.setMinutes(-userSettings.timezonedaylightbias);
                return dt.getFullYear() + "-" + (dt.getMonth() + 1) + "-" + dt.getDate();
            }
        }
    </script>

</body></html>