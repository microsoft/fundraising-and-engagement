<html><!--/*************************************************************************
* Â© Microsoft. All rights reserved.
*/--><head>
    <meta charset="utf-8">
    <title>UPDATE CREDIT CARD</title>
    <script src="ClientGlobalContext.js.aspx" type="text/javascript"></script>
    <script src="../scripts/jQuery.js" type="text/javascript"></script>
    <link href="../scripts/common.css" rel="stylesheet">
    <script src="../scripts/common.js" type="text/javascript"></script>
<meta></head>
<body style="height: 255px; overflow-wrap: break-word;">
    <style type="text/css">
        table, th {
            border-collapse: collapse;
            color: #444444;
            font-family: 'Hind', sans-serif;
            font-size: 14px;
        }

        th, td {
            padding: 5px;
            text-align: left;
        }

        table, td {
            color: #444444;
            font-family: 'Hind', sans-serif;
            font-size: 14px;
            font-weight: 500;
        }

        input[type=text] {
            width: 190px;
        }

        input:disabled {
            opacity: 0.5;
        }

        .red-border {
            border: solid 2px #FF0000 !important;
        }

        .tabview {
            border-style: none;
            padding: 12px;
            position: relative;
            top: 0px;
            left: 0px;
            width: calc(100% - 22px);
            height: 33px;
            background-color: none;
            z-index: 1;
        }

        .fa, .fas, .far {
            font-size: 18px !important;
            vertical-align: middle;
        }

        .content-header h2 {
            color: #000000;
            font-size: 18px !important;
            margin-top: 10px;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .content-details input, .content-details select, .contDet input, .contDet select {
            margin: 2px;
            padding: .280rem .5rem;
            font-size: 14px;
            line-height: 1.5;
            color: #495057;
            background-color: #fff;
            background-clip: padding-box;
            border: 1px solid #ced4da;
            border-radius: .25rem;
            transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out;
            margin-top: 1px;
        }

        .form-container-head {
            background-color: white;
            padding-left: 20px;
            padding-top: 20px;
            border-top: 0.6em solid #243a5e;
            padding-right: 0px;
        }

        .form-container-headNBorder {
            background-color: white;
            padding-left: 20px;
            padding-top: 20px;
            padding-right: 0px;
        }

        .form-container {
            background-color: white;
            padding-left: 20px;
            padding-right: 0px;
        }

        .main-button {
            text-align: center !important;
            text-shadow: none !important;
            border: 1px solid #b4b4b4 !important;
            background-color: #cccccc !important;
            -webkit-transition: all 0.1s ease-in-out !important;
            -moz-transition: all 0.1s ease-in-out !important;
            -ms-transition: all 0.1s ease-in-out !important;
            -o-transition: all 0.1s ease-in-out !important;
            transition: all 0.1s ease-in-out !important;
            padding: 5px 6px 3px 6px !important;
            font-family: 'Hind', sans-serif !important;
            font-weight: bolder !important;
            text-transform: uppercase !important;
            font-size: 14px !important;
            color: #243a5e !important;
            cursor: pointer !important;
            border-radius: 0px !important;
            background-clip: initial !important;
            margin: 0 !important;
            margin-top: 0px !important;
            line-height: unset !important;
            margin-right: 5px !important;
            white-space: nowrap !important;
        }

            .main-button:hover {
                cursor: pointer !important;
                color: white !important;
                border: 1px solid #243a5e !important;
                background-color: #243a5e !important;
            }

            .main-button .button-icon {
                margin-left: 10px;
                text-rendering: optimizeLegibility;
            }

        .mandatory span:after {
            content: '*';
            color: red;
            font-weight: bold;
            font-size: 15px;
            padding-left: 3px;
        }
    </style>

    <table class="content-details" style="width: 100%; margin-top: 5px;" border="0" role="presentation">
        <tbody>
            <tr>
                <td style="padding-left: 0px;padding-right: 2px;">
                    <div class="tabview">
                        <div class="content-header" style="float:left;width: 220px;margin-top: 4px;">
                            <h2 class="noselect" style="margin: 0;">UPDATE CREDIT CARD</h2>
                        </div>
                    </div>
                    <table style="border-style:none;width:100%;" border="0" role="presentation">
                        <tbody>
                            <tr>
                                <td colspan="3" style="background:#ededed !important;padding: 13px;padding-top: 15px;padding-bottom: 15px;text-align:center;">
                                    <table style="border-style:none;width:99%;margin-left: 2px;" border="0" align="center" role="presentation">
                                        <tbody>
                                            <tr>
                                                <td style="width: 125px;" class="form-container-head"><label for="listCreditCard" title="Existing Card">Existing Card</label></td>
                                                <td class="form-container-head">
                                                    <select id="listCreditCard" style="width: 190px; height:32px;" aria-label="Existing Card" role="listbox">
                                                        <option value="" role="option"></option>
                                                    </select>
                                                    <!--<input type="text" id="txtExCardNumber" style="width: 265px;" disabled/>-->
                                                    <input type="hidden" id="hdCreditCardID">
                                                    <input type="hidden" id="hdAuthToken">
                                                    <input type="hidden" id="hdAuthNetProfile">
                                                    <input type="hidden" id="hdCustomerID">
                                                    <input type="hidden" id="hdCardType">
                                                    <select id="listCCType" hidden="hidden">
                                                        <option value="844060000">Visa</option>
                                                        <option value="844060001">Master Card</option>
                                                        <option value="844060002">Visa Debit</option>
                                                        <option value="844060003">Master Card Debit</option>
                                                        <option value="844060004">American Express</option>
                                                        <option value="844060005">Diners Club</option>
                                                        <option value="844060006">JCB</option>
                                                        <option value="844060007">Interact</option>
                                                    </select>
                                                </td>
                                            </tr>
                                            <tr class="trCard">
                                                <td class="form-container"><label for="txtCardNumber" title="The credit card number as it appears on the card without dashes">Card Number</label></td>
                                                <td class="form-container"><input type="text" id="txtCardNumber" aria-label="Card Number" onkeypress="return checkIt(event);"></td>
                                            </tr>
                                            <tr class="trCard">
                                                <td class="form-container"><span><label for="txtNameOnCard" title="The name of the individual as it pertains to there payment method such as the name on the card or the name on the bank account">Name on the Card</label></span></td>
                                                <td class="form-container"><input type="text" id="txtNameOnCard" aria-label="Name on the Card"></td>
                                            </tr>
                                            <tr class="trCard">
                                                <td class="form-container"><span><label for="listCardType" title="The type of card">Credit Card Type</label></span></td>
                                                <td class="form-container">
                                                    <select id="listCardType" style="width: 190px; height:32px;" aria-label="Credit Card Type" role="listbox">
                                                        <!--hidden="hidden">-->
                                                        <option value="" role="option"></option>
                                                        <option value="844060000" role="option">Visa</option>
                                                        <option value="844060001" role="option">Master Card</option>
                                                        <option value="844060002" role="option">Visa Debit</option>
                                                        <option value="844060003" role="option">Master Card Debit</option>
                                                        <option value="844060004" role="option">American Express</option>
                                                        <option value="844060005" role="option">Diners Club</option>
                                                        <option value="844060006" role="option">JCB</option>
                                                        <option value="844060007" role="option">Interact</option>
                                                    </select>
                                                </td>
                                            </tr>
                                            <tr class="trCard">
                                                <td class="form-container"><span><label for="txtCardExpiry" title="The expiry date of the credit card in the format of MMYY">Expiry</label></span></td>
                                                <td class="form-container"><input type="text" id="txtCardExpiry" aria-label="Expiry" placeholder="mmyy" maxlength="7"></td><!--onkeypress="return checkIt(event);" onblur="checkLength(this)" /></td>-->
                                            </tr>
                                            <tr>
                                                <td class="form-container" colspan="2">
                                                    <input type="button" id="btnUpdate" class="main-button" role="button" value="Update">
                                                    <input type="button" id="btnClose" class="main-button" role="button" value="Close">
                                                </td>
                                            </tr>
                                            <tr>
                                                <td colspan="2" class="form-container">
                                                    <span id="lblMsg" style="color: #e60000; display: block;" role="alert"></span>
                                                    <span id="lblErrorExpiry" style="color: #e60000; display: block;" role="alert"></span>
                                                    <span id="lblErrorValidation" style="color:#e60000; display: block;" role="alert"></span>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td class="form-container" style="height:10px;" colspan="2">
                                                    <br>
                                                    <select id="ddlPaymentGateway" hidden="hidden">
                                                        <option value=""></option>
                                                        <option value="844060000">Moneris</option>
                                                        <option value="844060001">Authorize.Net</option>
                                                        <option value="844060002">iATS</option>
                                                    </select>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </td>
            </tr>
        </tbody>
    </table>

    <script type="text/javascript">
        var CCList = "";
        var ccQuery = "";

        var entityName;
        var currentEntityGUID;
        var creditCardID;

        var configRecord = null;
        var xrm = XrmUtility.get_Xrm();
        //get Configuration record
        var currentuserID = xrm.Page.context.getUserId().replace('{', '').replace('}', '').toUpperCase();
        var userSelect = "systemusers?$select=systemuserid,_msnfp_configurationid_value"
        userSelect += "&$filter=systemuserid eq " + currentuserID;
        var user = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + userSelect);
        user = user[0];

        if (!isNullOrUndefined(user._msnfp_configurationid_value)) {
            var selectQuery = "msnfp_configurations?$select=msnfp_configurationid";
            var filterConfig = "&$filter=msnfp_configurationid eq " + user._msnfp_configurationid_value;
            var configresult = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + selectQuery + filterConfig);
            if (!isNullOrUndefined(configresult))
                configRecord = configresult[0];
        }

        function getParameters() {
            entityName = MissionFunctions.GetQueryStringParam("entityName");
            currentEntityGUID = MissionFunctions.GetQueryStringParam("entityGUID");
            if (entityName === "msnfp_transaction" || entityName === "msnfp_paymentschedule")
                creditCardID = MissionFunctions.GetQueryStringParam("creditCardID");
        }

        $(function () {
            getParameters();

            if (entityName === "msnfp_transaction" || entityName === "msnfp_paymentschedule") {
                ccQuery += "msnfp_paymentmethods?";
                ccQuery += "$select=msnfp_paymentmethodid,msnfp_cclast4,msnfp_ccbrandcode,_msnfp_customerid_value,msnfp_type,msnfp_name&";
                ccQuery += "$filter=(msnfp_paymentmethodid eq " + XrmUtility.CleanGuid(creditCardID) + ") and (msnfp_type eq 844060000)"; // 844060000 == Credit Card
            }
            else if (entityName === "contact" || entityName === "account") {
                ccQuery += "msnfp_paymentmethods?";
                ccQuery += "$select=msnfp_paymentmethodid,msnfp_cclast4,msnfp_ccbrandcode,_msnfp_customerid_value,msnfp_type,msnfp_name&";
                ccQuery += "$filter=(_msnfp_customerid_value eq " + currentEntityGUID + ") and (msnfp_type eq 844060000)";
            }

            CCList = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + ccQuery);

            if (!isNullOrUndefined(CCList)) {
                $("tr.trCard").show();
                $.each(CCList, function (key, value) {
                    $('#listCreditCard').append($("<option role='option'></option>").attr("value", value.msnfp_paymentmethodid).text(value.msnfp_name));

                    if (entityName === "msnfp_donationpledge") {
                        $('#listCreditCard').val(value.msnfp_paymentmethodid);
                        $('#hdCustomerID').val(value._msnfp_customerid_value);
                        $('#hdCardType').val(value.msnfp_ccbrandcode);
                        $('#listCardType').val(value.msnfp_ccbrandcode);
                    }
                });
            }
            else {
                $("tr.trCard").hide();
                $("#btnUpdate").hide();
                //$('#lblMsg').html('No related credit cards exists.');
                $('#lblMsg').append('<p>No related credit cards exists.</p>');
            }

            if (entityName === "msnfp_donationpledge") {
                $("#listCreditCard").attr('disabled', 'disabled');
            }
        });

        $("#btnClose").click(function () {
            window.close();
        });

        $("#listCreditCard").change(function () {
            var ccRec = "";
            var ccQuery = "";

            $('#lblMsg').html('');

            if ($("#listCreditCard").val() !== "") {
                ccQuery += "msnfp_paymentmethods?";
                ccQuery += "$select=msnfp_paymentmethodid,msnfp_cclast4,msnfp_ccbrandcode,_msnfp_customerid_value,msnfp_type,msnfp_name&";
                ccQuery += "$filter=(msnfp_paymentmethodid eq " + $(this).val() + ") and (msnfp_type eq 844060000)";

                ccRec = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + ccQuery);

                if (!isNullOrUndefined(ccRec)) {
                    $('#hdCustomerID').val(ccRec[0]._msnfp_customerid_value);
                    $('#hdCardType').val(ccRec[0].msnfp_ccbrandcode);
                    $('#listCardType').val(ccRec[0].msnfp_ccbrandcode);
                }
            }
        });

        $('#txtCardNumber').blur(function () {
            //$("#lblErrorValidation")[0].innerText = "";
            $('#lblErrorValidation').html('');

            if (!isNullOrUndefined($(this).val())) {
                if (cardnumber($('#txtCardNumber'))) {
                    $('#txtNameOnCard').closest('tr').addClass('mandatory');
                    $('#listCardType').closest('tr').addClass('mandatory');
                    $('#txtCardExpiry').closest('tr').addClass('mandatory');

                    $('#txtNameOnCard').attr('disabled', false);
                    $('#listCardType').attr('disabled', false);

                    $('#txtNameOnCard').attr('aria-required', true);
                    $('#listCardType').attr('aria-required', true);
                    $('#txtCardExpiry').attr('aria-required', true);
                }
                else {
                    //$("#lblErrorValidation")[0].innerText = "Please enter a valid credit card number.";
                    $('#lblErrorValidation').append('<p>Please enter a valid credit card number.</p>');
                }
            }
            else {
                $('#txtCardExpiry').closest('tr').addClass('mandatory');

                $('#txtNameOnCard').removeClass('red-border');
                $('#listCardType').removeClass('red-border');

                $('#txtNameOnCard').closest('tr').removeClass('mandatory');
                $('#listCardType').closest('tr').removeClass('mandatory');

                $('#txtNameOnCard').attr('disabled', 'disabled');
                $('#listCardType').attr('disabled', 'disabled');

                $('#txtNameOnCard').attr('aria-required', false);
                $('#listCardType').attr('aria-required', false);
                $('#txtCardExpiry').attr('aria-required', false);
            }
        });

        function checkIt(evt) {
            evt = (evt) ? evt : window.event;
            var charCode = (evt.which) ? evt.which : evt.keyCode;
            if (charCode > 31 && (charCode < 48 || charCode > 57)) {
                status = "This field accepts numbers only."
                return false;
            }
            status = "";
            return true;
        }

        function cardnumber(inputtxt) {
            var AE = /^(?:3[47][0-9]{13})$/;                 //Amercican Express
            var visa = /^(?:4[0-9]{12}(?:[0-9]{3})?)$/;      //Visa
            var MC = /^(?:5[1-5][0-9]{14})$/;                //Mastercard
            var Dis = /^(?:6(?:011|5[0-9][0-9])[0-9]{12})$/; //Discover
            var DC = /^(?:3(?:0[0-5]|[68][0-9])[0-9]{11})$/; //Dinners Club

            if (inputtxt.val().match(AE)) {
                $(inputtxt).removeClass('red-border');
                return true;
            }
            else if (inputtxt.val().match(visa)) {
                $(inputtxt).removeClass('red-border');
                return true;
            }
            else if (inputtxt.val().match(MC)) {
                $(inputtxt).removeClass('red-border');
                return true;
            }
            else if (inputtxt.val().match(Dis)) {
                $(inputtxt).removeClass('red-border');
                return true;
            }
            else if (inputtxt.val().match(DC)) {
                $(inputtxt).removeClass('red-border');
                return true;
            }
        }

        function validate() {
            var isValidate = true;
            //$("#lblMsg")[0].innerText = '';
            //$("#lblErrorValidation")[0].innerText = '';

            $('#lblMsg').html('');
            $('#lblErrorValidation').html('');

            $('#listCreditCard').attr('aria-required', false);
            $('#txtNameOnCard').attr('aria-required', false);
            $('#txtNameOnCard').attr('aria-required', false);
            $('#listCardType').attr('aria-required', false);
            $('#txtCardExpiry').attr('aria-required', false);
            
            if ($("#listCreditCard").val() === "") {
                isValidate = false;
                $("#listCreditCard").addClass('red-border');
                $('#listCreditCard').attr('aria-required', true);
                //$("#lblMsg")[0].innerText = "Please select credit/debit card";
                $('#lblMsg').append('<p>Please select credit/debit card</p>');
                return;
            }
            else {
                $("#listCreditCard").removeClass('red-border');
                if (!isNullOrUndefined($('#txtCardNumber').val())) {
                    if (!cardnumber($("#txtCardNumber"))) {
                        isValidate = false;
                        $("#txtCardNumber").addClass('red-border');
                        $('#listCreditCard').attr('aria-required', true);
                    }
                    else {
                        $("#txtCardNumber").removeClass('red-border');
                    }

                    if ($("#txtNameOnCard").val() === "") {
                        isValidate = false;
                        $("#txtNameOnCard").addClass('red-border');
                        $('#txtNameOnCard').attr('aria-required', true);
                        //$("#lblErrorValidation")[0].innerText = "Please enter the name of the credit/debit card.";
                        $('#lblErrorValidation').append('<p>Please enter name on the card.</p>');
                        return;
                    }
                    else {
                        $("#txtNameOnCard").removeClass('red-border');
                    }

                    if ($("#listCardType").val() === "") {
                        isValidate = false;
                        $("#listCardType").addClass('red-border');
                        $('#listCardType').attr('aria-required', true);
                        //$("#lblErrorValidation")[0].innerText = "Please select Credit Card type.";
                        $('#lblErrorValidation').append('<p>Please select Credit Card type.</p>');
                        return;
                    }
                    else {
                        $("#listCardType").removeClass('red-border');
                    }

                    if ($("#txtCardExpiry").val() === "" || !validateExpiry()) {
                        isValidate = false;
                        $("#txtCardExpiry").addClass('red-border');
                        $('#txtCardExpiry').attr('aria-required', true);
                        //$("#lblErrorValidation")[0].innerText = "Please enter a valid expiry date.";
                        $('#lblErrorValidation').append('<p>Please enter a valid expiry date.</p>');
                        return;
                    }
                    else {
                        $("#txtCardExpiry").removeClass('red-border');
                    }

                    $('tr.mandatory input, tr.mandatory select').each(function () {
                        var $this = $(this);
                        if ($this.val() == '') {
                            isValidate = false;
                            $this.addClass('red-border');
                        }
                        else {
                            $this.removeClass('red-border');
                        }
                    });
                }
                else {
                    $('#txtNameOnCard').removeClass('red-border');
                    $('#listCardType').removeClass('red-border');

                    $('#txtNameOnCard').closest('tr').removeClass('mandatory');
                    $('#listCardType').closest('tr').removeClass('mandatory');

                    $('#txtNameOnCard').attr('disabled', 'disabled');
                    $('#listCardType').attr('disabled', 'disabled');

                    $('#txtNameOnCard').attr('aria-required', false);
                    $('#listCardType').attr('aria-required', false);


                    if ($("#txtCardExpiry").val() === "" || !validateExpiry()) {
                        isValidate = false;
                        $("#txtCardExpiry").addClass('red-border');
                        //$("#lblErrorValidation")[0].innerText = "Please enter a valid expiry date.";
                        $('#lblErrorValidation').append('<p>Please enter a valid expiry date.</p>');
                        return;
                    }
                    else {
                        $("#txtCardExpiry").removeClass('red-border');
                    }
                }
            }
            return isValidate;
        }

        function validateExpiry() {
            //$("#lblErrorExpiry")[0].innerText = '';
            $('#lblErrorExpiry').html('');

            var currentDate = new Date();
            var isExpValidate = true;
            var cardExp = $('#txtCardExpiry').val();
            var mm = parseInt(cardExp.substring(0, 2));
            var yy = parseInt(cardExp.substring(cardExp.length - 2));
            var currentMonth = parseInt(currentDate.getMonth() + 1);
            var currentYear = parseInt(currentDate.getFullYear().toString().substr(-2));

            if (mm > 12 || mm <= currentMonth) {
                if (yy == currentYear && mm >= currentMonth) {
                    isExpValidate = true;
                }
                else if (yy > currentYear && mm < 12) {
                    isExpValidate = true;
                }
                else {
                    //$("#lblErrorExpiry")[0].innerText = "Month value must be 1 to 12 and greater than current month.";
                    $('#lblErrorExpiry').append('<p>Month value must be 1 to 12 and greater than current month.</p>');
                    isExpValidate = false;
                }
            }

            if (yy < currentYear) {
                //$("#lblErrorExpiry")[0].innerText = "Year value must be greater than or equal to current year.";
                $('#lblErrorExpiry').append('<p>Year value must be greater than or equal to current year.</p>');
                isExpValidate = false;
            }
            return isExpValidate;
        }

        function checkLength(elem) {
            if ($(elem)[0].id === "txtCardExpiry") {
                if (elem.value.length < 4) {
                    $(elem).addClass('red-border');
                    $(elem).focus();
                    return false;
                }
                else {
                    $(elem).removeClass('red-border');
                    return true;
                }
            }
        }

        $.as_VerifyEmpty = function (elem) {
            var r = false;
            if (elem) {
                r = $.trim(elem.val()).length > 0;
                if (!r)
                    elem.addClass('red-border').val('');
                else
                    elem.removeClass('red-border');
            }
            return r;
        }

        $("#btnUpdate").click(function () {
            if (validate()) {
                var eEntity = {};

                var cardNo = $('#txtCardNumber').val();
                if (isNullOrUndefined(cardNo)) {
                    eEntity["msnfp_cclast4"] = "****";
                    eEntity["msnfp_ccbrandcode"] = $('#hdCardType').val();
                }
                else {
                    eEntity["msnfp_cclast4"] = $('#txtCardNumber').val();
                    eEntity["msnfp_ccbrandcode"] = $('#listCardType').val();
                    eEntity["msnfp_nameonfile"] = $("#txtNameOnCard").val();
                    eEntity["msnfp_name"] = $('#listCardType option:selected').text() + " - " + cardNo.substr(cardNo.length - 4);
                }

                eEntity["msnfp_ccexpmmyy"] = $('#txtCardExpiry').val();
                eEntity["msnfp_type"] = 844060000; // Credit Card

                if (entityName === "account") {
                    eEntity["msnfp_CustomerId_account@odata.bind"] = "/accounts(" + $('#hdCustomerID').val() + ")";
                }
                else if (entityName === "contact") {
                    eEntity["msnfp_CustomerId_contact@odata.bind"] = "/contacts(" + $('#hdCustomerID').val() + ")";
                }

                var str = XrmServiceUtility.GetWebAPIUrl() + "msnfp_paymentmethods(" + $('#listCreditCard').val() + ")";

                var recordID = XrmServiceUtility.UpdateRecord(str, eEntity);

                if (recordID != null || recordID != undefined) {
                    $("#btnUpdate").hide();
                    //$('#lblMsg').html('Credit Card Updated Successfully.');
                    $('#lblMsg').append('<p>Credit Card Updated Successfully.</p>');
                    $('#lblMsg').css('color', 'green');
                    //$("#btnClose").show();
                }
                else {
                    //$('#lblMsg').html('An error has occured, please close this window and try again.');
                    $('#lblMsg').append('<p>An error has occured, please close this window and try again.</p>');
                    $('#lblMsg').css('color', '#e60000');
                }
            }
        });

        function isNullOrUndefined(value) {
            return (typeof (value) === "undefined" || value === null || value === "");
        }
    </script>



</body></html>