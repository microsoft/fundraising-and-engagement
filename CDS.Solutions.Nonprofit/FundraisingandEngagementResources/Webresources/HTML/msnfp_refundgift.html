<html>
<!--/*************************************************************************
* © Microsoft. All rights reserved.
*/-->
<head>
    <meta charset="utf-8">
    <title></title>
    <script src="ClientGlobalContext.js.aspx" type="text/javascript"></script>
    <link href="../scripts/jquery_ui.css" rel="stylesheet">
    <link href="../scripts/common.css" rel="stylesheet">
    <script src="../scripts/jQuery.js" type="text/javascript"></script>
    <script src="../scripts/jquery_ui.js" type="text/javascript"></script>
    <script src="../scripts/common.js" type="text/javascript"></script>
    <meta>
    <meta>
    <meta>
    <meta>
    <meta>
    <meta>
</head>
<body style="overflow-wrap: break-word;">
    <style type="text/css">
        table, th {
            border-collapse: collapse;
            color: #444444;
            font-family: 'Hind', sans-serif;
            font-size: 14px;
            font-weight: 500;
        }

        th, td {
            padding: 5px;
            text-align: left;
        }

        table, td {
            color: #444444;
            font-family: 'Hind', sans-serif;
            font-size: 14px;
            font-weight: 500;
        }

        input[type=text] {
            width: 140px;
            text-align: right;
        }

        .red-border {
            border: solid 1px #CD2828 !important;
        }

        .tabview {
            border-style: none;
            padding: 12px;
            position: relative;
            top: 0px;
            left: 0px;
            width: calc(100% - 22px);
            height: 33px;
            background-color: #ededed;
            z-index: 1;
        }

        .tab {
            display: block;
            text-align: center;
            text-shadow: none;
            border: 1px solid #b4b4b4;
            -webkit-transition: all 0.1s ease-in-out;
            -moz-transition: all 0.1s ease-in-out;
            -ms-transition: all 0.1s ease-in-out;
            -o-transition: all 0.1s ease-in-out;
            transition: all 0.1s ease-in-out;
            -webkit-box-shadow: none;
            box-shadow: none;
            font-weight: bolder;
            color: #243a5e;
            font-family: 'Hind', sans-serif;
            font-size: 14px;
            background-color: #cccccc;
            padding: 5px 8px 3px 8px;
            text-transform: uppercase;
            text-decoration: none !important;
            cursor: pointer !important;
            white-space: nowrap;
            float: left;
        }

            .tab:hover {
                cursor: pointer;
                color: white;
                border: 1px solid #243a5e;
                background-color: #243a5e;
            }

        .tab-active {
            color: white;
            border: 1px solid #243a5e;
            background-color: #243a5e;
            opacity: 1;
            cursor: pointer !important;
        }

        .tab-disable {
            opacity: 0.3;
            cursor: default !important;
        }

        .fa, .fas, .far {
            font-size: 18px !important;
            vertical-align: middle;
        }

        .tab-disable:hover {
            opacity: 0.3;
            cursor: default !important;
            background-color: #cccccc;
            color: black;
        }

        .tab:first-of-type {
            border-radius: 0px;
        }

        .tab:last-of-type {
            border-radius: 0px;
        }

        .content-header h2 {
            color: #000000;
            font-size: 17px !important;
            text-transform: uppercase !important;
        }

        input:disabled {
            opacity: 0.5;
        }

        .content-details input, .content-details select, .contDet input, .contDet select {
            margin: 2px;
            padding: .280rem .5rem;
            font-size: 14px;
            line-height: 1.5;
            color: #495057;
            background-color: #fff;
            background-clip: padding-box;
            border: 1px solid #ced4da;
            border-radius: .25rem;
            transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out;
            margin-top: 1px;
        }

        .form-container-head {
            background-color: white;
            padding-left: 20px;
            padding-top: 20px;
            border-top: 0.6em solid #243a5e;
            padding-right: 0px;
        }

        .form-container-headNBorder {
            background-color: white;
            padding-left: 20px;
            padding-top: 20px;
            padding-right: 0px;
        }

        .form-container {
            background-color: white;
            padding-left: 20px;
            padding-right: 0px;
        }

        .main-button {
            text-align: center !important;
            text-shadow: none !important;
            border: 1px solid #b4b4b4 !important;
            background-color: #cccccc !important;
            -webkit-transition: all 0.1s ease-in-out !important;
            -moz-transition: all 0.1s ease-in-out !important;
            -ms-transition: all 0.1s ease-in-out !important;
            -o-transition: all 0.1s ease-in-out !important;
            transition: all 0.1s ease-in-out !important;
            padding: 5px 6px 3px 6px !important;
            font-family: 'Hind', sans-serif !important;
            font-weight: bolder !important;
            text-transform: uppercase !important;
            font-size: 14px !important;
            color: #243a5e !important;
            cursor: pointer !important;
            border-radius: 0px !important;
            background-clip: initial !important;
            margin: 0 !important;
            margin-top: 0px !important;
            line-height: unset !important;
            margin-right: 5px !important;
            white-space: nowrap !important;
        }

            .main-button:hover {
                cursor: pointer !important;
                color: white !important;
                border: 1px solid #243a5e !important;
                background-color: #243a5e !important;
            }

            .main-button .button-icon {
                margin-left: 10px;
                text-rendering: optimizeLegibility;
            }

        .alertJs-dialog-height {
            height: 450px !important;
        }

        .divloader {
            position: fixed;
            width: 100%;
            height: 100%;
            text-align: center;
            background: lightgrey;
            opacity: 0.8;
            filter: alpha(opacity=40);
            /*background: lightGrey url("../scripts/ajaxLoader.gif") no-repeat center center;*/
            z-index: 2000;
            margin-top: -8px;
            margin-left: -8px;
        }

        #lblErrorAmount, #lblError {
            color: red;
        }

        #lblResult {
            color: green;
        }
    </style>
    <div class="divloader" id="ajaxLoader" style="display: none; font-family: undefined;">
        <img id="ajax-loader" src="../images/ajaxloader.gif" style="margin: 25% 49%; display: block;">
    </div>
    <div id="tblRefundProcess" style="font-family: undefined;">
        <table class="content-details" style="width: 100%; margin-top: 5px;" border="0" role="presentation">
            <tbody>
                <tr>
                    <td>
                        <div class="tabview">
                            <a class="tab tab-active" href="javascript:void(0)" id="TabCC" title="CC" tabindex="0">Credit Card</a>
                            <a class="tab" href="javascript:void(0)" id="TabCheque" title="Check" tabindex="1">Check</a>
                            <a class="tab" href="javascript:void(0)" id="TabBank" title="Bank" tabindex="2">Bank</a>
                            <a class="tab" href="javascript:void(0)" id="TabCash" title="Cash" tabindex="3">Cash</a>
                            <a class="tab" href="javascript:void(0)" id="TabWireTransfer" title="WireTransfer" tabindex="4">Wire Transfer</a>
                            <a class="tab" href="javascript:void(0)" id="TabExtCC" title="ExtCC" tabindex="5">Ext. Credit / Debit Card</a>
                            <a class="tab" href="javascript:void(0)" id="TabOther" title="Other" tabindex="6">Other</a>
                        </div>
                        <table style="border-style:none;width:100%;" border="0">
                            <tbody>
                                <tr style="background:#fff;">
                                </tr>
                            </tbody>
                        </table><table style="border-style:none;width:99%;margin-left: 2px;" border="0" align="center" role="presentation">
                            <tbody>
                                <tr>
                                    <td colspan="2">
                                        <div class="content-header">
                                            <h2 class="noselect" style="margin-left: 23px;margin-bottom: 0px;">Available Amount</h2>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="content-header">
                                            <h2 class="noselect" style="margin-left: 29px;margin-bottom: 0px;">Amount Refunded</h2>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td style="width: 157px;"></td>
                                    <td style="width: 30%;"></td>
                                    <td></td>
                                </tr>
                            </tbody>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td colspan="3" style="background:#ededed !important;padding: 13px;padding-top: 15px;padding-bottom: 15px;text-align:center;">
                        <table style="border-style:none;width:99%;margin-left: 2px;" border="0" align="center" role="presentation">
                            <tbody>
                                <tr>
                                    <td style="width: 157px;" class="form-container-head"><label for="txtGiftAmount" aria-label="This is the amount (typically dollar value although this application is capable of multiple currencies) of the donation." title="This is the amount (typically dollar value although this application is capable of multiple currencies) of the donation.">Gift Amount</label></td>
                                    <td style="width: 30%;" class="form-container-head">
                                        <input type="text" id="txtGiftAmount" disabled="" readonly>
                                    </td>
                                    <td class="form-container-head">
                                        <input type="text" id="txtGiftAmountRefunded" aria-label="Gift Amount Refunded" role="textbox" autocomplete="off" required>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="form-container"><label for="txtMembershipAmount" aria-label="This is the amount (typically dollar value although this application is capable of multiple currencies) of the membership amount being paid today." title="This is the amount (typically dollar value although this application is capable of multiple currencies) of the membership amount being paid today.">Membership Amount</label></td>
                                    <td class="form-container">
                                        <input type="text" id="txtMembershipAmount" disabled="" readonly>
                                    </td>
                                    <td class="form-container">
                                        <input type="text" id="txtMembershipAmountRefunded" aria-label="Membership Amount Refunded" required>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="form-container"><label for="txtAmountNonreceiptable" aria-label="The non-receiptable portion of the total header amount" title="The non-receiptable portion of the total header amount">Amount Non-receiptable</label></td>
                                    <td class="form-container">
                                        <input type="text" id="txtAmountNonreceiptable" disabled="" readonly>
                                    </td>
                                    <td class="form-container">
                                        <input type="text" id="txtAmountNonreceiptableRefunded" aria-label="Amount Non-receiptable Refunded" required>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="form-container"><label for="txtAmountTax" aria-label="The amount of tax attributed towards this transaction record, used when combining memberships or products in transactions" title="The amount of tax attributed towards this transaction record, used when combining memberships or products in transactions">Amount (Tax)</label></td>
                                    <td class="form-container">
                                        <input type="text" id="txtAmountTax" disabled="" readonly>
                                    </td>
                                    <td class="form-container">
                                        <input type="text" id="txtAmountTaxRefunded" aria-label="Amount (Tax) Refunded" required>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="form-container"><label for="txtAmountRefunded" aria-label="Amount Refunded" title="Amount Refunded">Amount Refunded</label></td>
                                    <td class="form-container">
                                        <input type="text" id="txtAmountRefunded" disabled="" readonly>
                                    </td>
                                    <td class="form-container"><br></td>
                                </tr>
                                <tr id="trCheque">
                                    <td class="form-container"><label for="txtChequeNumber" aria-label="The check number of the payment process, mandatory if the user selected Check form the payment type." title="The check number of the payment process, mandatory if the user selected Check form the payment type.">Check Number</label></td>
                                    <td class="form-container">
                                        <input type="text" id="txtChequeNumber" onkeypress="return checkIt(event);" autocomplete="off">
                                    </td>
                                    <td class="form-container"><br></td>
                                </tr>
                                <tr>
                                    <td class="form-container"><label for="txtVendorNumber" aria-label="The vendor number for this account (Financial Integration)" title="The vendor number for this account (Financial Integration)">Vendor Number</label></td>
                                    <td class="form-container">
                                        <input type="text" id="txtVendorNumber" disabled="">
                                    </td>
                                    <td class="form-container"><br></td>
                                </tr>
                                <tr>
                                    <td class="form-container" style="height:10px;" colspan="3"><br></td>
                                </tr>
                            </tbody>
                        </table>
                    </td>
                </tr>
            </tbody>
        </table>
        <div style="height:20px;border-style:none;">&nbsp;</div>
        <table style="width:100%;border-style:none;" class="contDet" border="0" role="presentation">
            <tbody>
                <tr>
                    <td colspan="3" style="background:#ededed !important;padding: 13px;padding-top: 15px;padding-bottom: 15px;text-align:center;">
                        <table style="border-style:none;width:99%;margin-left: 2px;" border="0" align="center" role="presentation">
                            <tbody>
                                <tr>
                                    <td class="form-container-headNBorder" style="width: 157px;"><label for="txtRefundAvailable" aria-label="Refund Available" title="Refund Available" role="none">Refund Available</label></td>
                                    <td class="form-container-headNBorder" style="width: 30%;"><input type="text" id="txtRefundAvailable" disabled="" readonly></td>
                                    <td class="form-container-headNBorder"><br></td>
                                </tr>
                                <tr>
                                    <td class="form-container"><label for="txtRefundAmount" aria-label="Refund Amount" title="Refund Amount" role="none">Refund Amount</label></td>
                                    <td class="form-container">
                                        <input type="text" id="txtRefundAmount" disabled="" readonly>
                                    </td>
                                    <td class="form-container"><br></td>
                                </tr>
                                <tr>
                                    <td class="form-container"><label for="txtRefundDate" aria-label="Refund Date (mm/dd/yyyy)" title="Refund Date (mm/dd/yyyy)">Refund Date</label></td>
                                    <td class="form-container">
                                        <input type="text" id="txtRefundDate" style="background: white;" required>
                                    </td>
                                    <td class="form-container">
                                        <input type="button" class="main-button" value="Process" id="btnProcess" role="button">
                                        <input type="button" class="main-button" value="Close" id="btnClose" role="button">
                                    </td>
                                </tr>
                                <tr>
                                    <td class="form-container" colspan="3">
                                        <label id="lblErrorAmount" role="alert"></label>
                                        <label id="lblResult" role="alert"></label>
                                        <label id="lblError" role="alert"></label>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </td>
                </tr>
            </tbody>
        </table>




    </div>

    <script type="text/javascript">
        var GiftType = {
            Cash: 844060000,
            Cheque: 844060001,
            Credit_Debit_Card: 844060002,
            Bank_Ach: 844060003,
            In_Kind: 844060004,
            Gift: 844060005,
            Stock: 844060006,
            Property: 844060007,
            Other: 844060008,
            Wire_or_Transfer: 844060009,
            Direct_Debit: 844060010,
            Fund_Transfer: 844060011,
            Ext_CreditCard: 844060012,
        }

        var currentEntityGUID;
        var transactionType;
        var pluralName;
        var currencySymbol;
        var isoCurrencyCode;
        var currentGift;
        var configRecord;

        function getParameters() {
            currentEntityGUID = getDataParam("entityGUID");
        }

        function getDataParam(keyToFind) {
            //Get the any query string parameters and load them
            //into the vals array
            var vals = new Array();
            var found = false;
            if (location.search != "") {
                // For some reason the query is being double encoded. Need to investigate further to see if Dynamics is now doing auto-encoding in Xrm.Utility.openWebResource params field.
                vals = decodeURIComponent(location.search).substr(1).split("&");
                //vals = location.search.substr(1).split("&");
                for (var i in vals) {
                    vals[i] = vals[i].replace(/\+/g, " ").split("=");
                }
                // Look for the Dynamics 365 parameter named 'data'
                for (var i in vals) {
                    if (vals[i][0].toLowerCase() == "data") {
                        var paramvals = new Array();
                        // From the 'data' string, get the parameters into a new array seperated by & symbol:
                        paramvals = decodeURIComponent(vals[i][1]).split("&");
                        for (var i in paramvals) {
                            // For each parameter, split it on '=' symbol to get key-value pairs:
                            paramvals[i] = paramvals[i].replace(/\+/g, " ").split("=");

                            // If this is the keyToFind, return the value and exit:
                            if (paramvals[i][0].toLowerCase() == keyToFind.toLowerCase()) {
                                found = true;
                                return paramvals[i][1];
                            }
                        }
                    }
                }
            }
            if (!found) {
                alert("Data parameter '" + keyToFind + "' was not passed to this page. Please try again.")
                return null;
            }
        }


        $(function () {
            $("#txtRefundDate").datepicker({
                dateFormat: 'mm/dd/yy',
            });

            $('#txtRefundDate').val(getFormattedDate(new Date()));

            //$('#btnClose').hide();

            $("#trCheque").hide();
            $("#TabCC").hide();
            $("#TabBank").hide();

            getParameters();

            var str = "msnfp_transactions(" + currentEntityGUID + ")?";
            str += "$select=msnfp_transactionid,msnfp_amount_receipted,msnfp_ref_amount_receipted,msnfp_amount_membership,msnfp_ref_amount_membership,msnfp_amount_nonreceiptable,msnfp_ref_amount_nonreceiptable,msnfp_amount_tax,msnfp_ref_amount_tax,msnfp_paymenttypecode,msnfp_amount,msnfp_ref_amount,_transactioncurrencyid_value,_msnfp_customerid_value,_msnfp_configurationid_value&";
            str += "$expand=msnfp_CustomerId_contact($select=msnfp_vendorid),msnfp_CustomerId_account($select=msnfp_vendorid)";

            currentGift = XrmServiceUtility.ExecuteQueryWithExpand(XrmServiceUtility.GetWebAPIUrl() + str);

            if (!isNullOrUndefined(currentGift)) {
                if (!isNullOrUndefined(currentGift._msnfp_configurationid_value)) {
                    var select = "msnfp_configurations?$select=msnfp_configurationid,";
                    select += "msnfp_label_creditcard,msnfp_label_cheque,msnfp_label_bankach,";
                    select += "msnfp_label_cash,msnfp_label_wire,msnfp_label_extcreditcard,msnfp_label_other,msnfp_tran_forcefullrefund";
                    var filter = "&$filter=(statuscode eq 1 and msnfp_configurationid eq " + currentGift._msnfp_configurationid_value + ")";
                    var configResult = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + select + filter);
                    configRecord = configResult[0];

                    if (!isNullOrUndefined(configRecord.msnfp_label_creditcard))
                        $('#TabCC')[0].innerText = configRecord.msnfp_label_creditcard;
                    if (!isNullOrUndefined(configRecord.msnfp_label_cheque))
                        $('#TabCheque')[0].innerText = configRecord.msnfp_label_cheque;
                    if (!isNullOrUndefined(configRecord.msnfp_label_bankach))
                        $('#TabBank')[0].innerText = configRecord.msnfp_label_bankach;
                    if (!isNullOrUndefined(configRecord.msnfp_label_cash))
                        $('#TabCash')[0].innerText = configRecord.msnfp_label_cash;
                    if (!isNullOrUndefined(configRecord.msnfp_label_wire))
                        $('#TabWireTransfer')[0].innerText = configRecord.msnfp_label_wire;
                    if (!isNullOrUndefined(configRecord.msnfp_label_extcreditcard))
                        $('#TabExtCC')[0].innerText = configRecord.msnfp_label_extcreditcard;
                    if (!isNullOrUndefined(configRecord.msnfp_label_other))
                        $('#TabOther')[0].innerText = configRecord.msnfp_label_other;
                }

                if (currentGift.msnfp_paymenttypecode == GiftType.Credit_Debit_Card) {
                    $("#TabCC").show();
                    $(".tabview").find('a#TabCC').addClass('tab-active');

                    $(".tabview").find('a#TabCheque').removeClass('tab-active');
                    $(".tabview").find('a#TabBank').removeClass('tab-active');
                    $(".tabview").find('a#TabCash').removeClass('tab-active');
                    $(".tabview").find('a#TabWireTransfer').removeClass('tab-active');
                    $(".tabview").find('a#TabExtCC').removeClass('tab-active');
                    $(".tabview").find('a#TabOther').removeClass('tab-active');
                }
                else if (currentGift.msnfp_paymenttypecode == GiftType.Cheque) {
                    $(".tabview").find('a#TabCheque').addClass('tab-active');

                    $(".tabview").find('a#TabCC').removeClass('tab-active');
                    $(".tabview").find('a#TabBank').removeClass('tab-active');
                    $(".tabview").find('a#TabCash').removeClass('tab-active');
                    $(".tabview").find('a#TabWireTransfer').removeClass('tab-active');
                    $(".tabview").find('a#TabExtCC').removeClass('tab-active');
                    $(".tabview").find('a#TabOther').removeClass('tab-active');
                    $("#trCheque").show();
                }
                else if (currentGift.msnfp_paymenttypecode == GiftType.Bank_Ach) {
                    $("#TabBank").show();

                    $(".tabview").find('a#TabBank').addClass('tab-active');

                    $(".tabview").find('a#TabCC').removeClass('tab-active');
                    $(".tabview").find('a#TabCheque').removeClass('tab-active');
                    $(".tabview").find('a#TabCash').removeClass('tab-active');
                    $(".tabview").find('a#TabWireTransfer').removeClass('tab-active');
                    $(".tabview").find('a#TabExtCC').removeClass('tab-active');
                    $(".tabview").find('a#TabOther').removeClass('tab-active');
                }
                else if (currentGift.msnfp_paymenttypecode == GiftType.Cash) {
                    $(".tabview").find('a#TabCash').addClass('tab-active');

                    $(".tabview").find('a#TabCC').removeClass('tab-active');
                    $(".tabview").find('a#TabCheque').removeClass('tab-active');
                    $(".tabview").find('a#TabBank').removeClass('tab-active');
                    $(".tabview").find('a#TabWireTransfer').removeClass('tab-active');
                    $(".tabview").find('a#TabExtCC').removeClass('tab-active');
                    $(".tabview").find('a#TabOther').removeClass('tab-active');
                }
                else if (currentGift.msnfp_paymenttypecode == GiftType.Wire_or_Transfer) {
                    $(".tabview").find('a#TabWireTransfer').addClass('tab-active');

                    $(".tabview").find('a#TabCC').removeClass('tab-active');
                    $(".tabview").find('a#TabBank').removeClass('tab-active');
                    $(".tabview").find('a#TabCash').removeClass('tab-active');
                    $(".tabview").find('a#TabCheque').removeClass('tab-active');
                    $(".tabview").find('a#TabExtCC').removeClass('tab-active');
                    $(".tabview").find('a#TabOther').removeClass('tab-active');
                    $("#trCheque").show();
                }
                else if (currentGift.msnfp_paymenttypecode == GiftType.Ext_CreditCard) {
                    $(".tabview").find('a#TabExtCC').addClass('tab-active');

                    $(".tabview").find('a#TabCC').removeClass('tab-active');
                    $(".tabview").find('a#TabBank').removeClass('tab-active');
                    $(".tabview").find('a#TabCash').removeClass('tab-active');
                    $(".tabview").find('a#TabCheque').removeClass('tab-active');
                    $(".tabview").find('a#TabWireTransfer').removeClass('tab-active');
                    $(".tabview").find('a#TabOther').removeClass('tab-active');
                }
                else if (currentGift.msnfp_paymenttypecode == GiftType.Other) {
                    $(".tabview").find('a#TabOther').addClass('tab-active');

                    $(".tabview").find('a#TabCC').removeClass('tab-active');
                    $(".tabview").find('a#TabBank').removeClass('tab-active');
                    $(".tabview").find('a#TabCash').removeClass('tab-active');
                    $(".tabview").find('a#TabCheque').removeClass('tab-active');
                    $(".tabview").find('a#TabWireTransfer').removeClass('tab-active');
                    $(".tabview").find('a#TabExtCC').removeClass('tab-active');
                }

                if (!isNullOrUndefined(currentGift.msnfp_CustomerId_contact))
                    $('#txtVendorNumber').val(currentGift.msnfp_CustomerId_contact.msnfp_vendorid);

                if (!isNullOrUndefined(currentGift.msnfp_CustomerId_account))
                    $('#txtVendorNumber').val(currentGift.msnfp_CustomerId_account.msnfp_vendorid);

                var amount = !isNullOrUndefined(currentGift.msnfp_amount_receipted) ? currentGift.msnfp_amount_receipted : 0;
                var amountMembership = !isNullOrUndefined(currentGift.msnfp_amount_membership) ? currentGift.msnfp_amount_membership : 0;
                var amountNonReceiptable = !isNullOrUndefined(currentGift.msnfp_amount_nonreceiptable) ? currentGift.msnfp_amount_nonreceiptable : 0;
                var amountTax = !isNullOrUndefined(currentGift.msnfp_amount_tax) ? currentGift.msnfp_amount_tax : 0;

                var amountRefunded = !isNullOrUndefined(currentGift.msnfp_ref_amount_receipted) ? currentGift.msnfp_ref_amount_receipted : 0;
                var amountMembershipRefunded = !isNullOrUndefined(currentGift.msnfp_ref_amount_membership) ? currentGift.msnfp_ref_amount_membership : 0;
                var amountNonReceiptableRefunded = !isNullOrUndefined(currentGift.msnfp_ref_amount_nonreceiptable) ? currentGift.msnfp_ref_amount_nonreceiptable : 0;
                var amountTaxRefunded = !isNullOrUndefined(currentGift.msnfp_ref_amount_tax) ? currentGift.msnfp_ref_amount_tax : 0;

                // NFP CHANGE:
                var totalRefunded = !isNullOrUndefined(currentGift.msnfp_ref_amount) ? currentGift.msnfp_ref_amount : 0;

                getCurrencySymbol(currentGift._transactioncurrencyid_value);

                $('#txtGiftAmount').val(currencySymbol + amount.toFixed(2));
                $('#txtMembershipAmount').val(currencySymbol + amountMembership.toFixed(2));
                $('#txtAmountNonreceiptable').val(currencySymbol + amountNonReceiptable.toFixed(2));
                $('#txtAmountTax').val(currencySymbol + amountTax.toFixed(2));
                $('#txtAmountRefunded').val(currencySymbol + totalRefunded.toFixed(2));

                $('#txtGiftAmountRefunded').val(currencySymbol + amount.toFixed(2));
                $('#txtMembershipAmountRefunded').val(currencySymbol + amountMembership.toFixed(2));
                $('#txtAmountNonreceiptableRefunded').val(currencySymbol + amountNonReceiptable.toFixed(2));
                $('#txtAmountTaxRefunded').val(currencySymbol + amountTax.toFixed(2));

                if (amount == 0 || configRecord.msnfp_tran_forcefullrefund == true)
                    $('#txtGiftAmountRefunded').attr('disabled', 'disabled').removeAttr("required");

                if (amountMembership == 0 || configRecord.msnfp_tran_forcefullrefund == true)
                    $('#txtMembershipAmountRefunded').attr('disabled', 'disabled').removeAttr("required");

                if (amountNonReceiptable == 0 || configRecord.msnfp_tran_forcefullrefund == true)
                    $('#txtAmountNonreceiptableRefunded').attr('disabled', 'disabled').removeAttr("required");

                if (amountTax == 0 || configRecord.msnfp_tran_forcefullrefund == true)
                    $('#txtAmountTaxRefunded').attr('disabled', 'disabled').removeAttr("required");

                var totalHeader = !isNullOrUndefined(currentGift.msnfp_amount) ? currentGift.msnfp_amount : 0;
                var totalAmountRefunded = amountRefunded + amountMembershipRefunded + amountNonReceiptableRefunded + amountTaxRefunded;

                if (totalHeader != 0 && totalHeader > totalAmountRefunded)
                    $('#txtRefundAvailable').val(currencySymbol + (totalHeader - totalAmountRefunded).toFixed(2));
                else
                    $('#txtRefundAvailable').val(currencySymbol + 0.00);

                $('#txtRefundAmount').val(currencySymbol + (totalHeader - totalAmountRefunded).toFixed(2));

            }

            $('#txtGiftAmountRefunded').focusout(function () {
                var amountAvailable = !isNullOrUndefined($('#txtGiftAmount').val()) ? $('#txtGiftAmount').val().replace(currencySymbol, '') : 0;
                var amountRefund = !isNullOrUndefined($('#txtGiftAmountRefunded').val()) ? $('#txtGiftAmountRefunded').val().replace(currencySymbol, '') : 0;
                var amountMembershipRefund = !isNullOrUndefined($('#txtMembershipAmountRefunded').val()) ? $('#txtMembershipAmountRefunded').val().replace(currencySymbol, '') : 0;
                var amountNonReceiptableRefund = !isNullOrUndefined($('#txtAmountNonreceiptableRefunded').val()) ? $('#txtAmountNonreceiptableRefunded').val().replace(currencySymbol, '') : 0;
                var amountTaxRefund = !isNullOrUndefined($('#txtAmountTaxRefunded').val()) ? $('#txtAmountTaxRefunded').val().replace(currencySymbol, '') : 0;

                $("#lblErrorAmount").text('');

                if (isNaN(parseFloat(amountRefund))) {
                    $(this).addClass('red-border');
                    $(this).focus();
                    $(this).val('');

                    $("#lblErrorAmount").append("Invalid entry:  Gift Amount");
                    return;
                }
                else if (parseFloat(amountRefund) > parseFloat(amountAvailable)) {
                    $(this).addClass('red-border');
                    $(this).focus();
                    $("#lblErrorAmount").append("Gift amount for refund can not be greater than available refund.");
                }
                else {
                    $(this).removeClass('red-border');
                    $('#txtRefundAmount').val(currencySymbol + (parseFloat(amountRefund) + parseFloat(amountMembershipRefund) + parseFloat(amountNonReceiptableRefund) + parseFloat(amountTaxRefund)).toFixed(2));
                }

                $(this).val(addDollarSign($(this).val()));
            });

            $('#txtMembershipAmountRefunded').focusout(function () {
                $("#lblErrorAmount").text('');
                var amountMembershipAvailable = !isNullOrUndefined($('#txtMembershipAmount').val()) ? $('#txtMembershipAmount').val().replace(currencySymbol, '') : 0;
                var amountRefund = !isNullOrUndefined($('#txtGiftAmountRefunded').val()) ? $('#txtGiftAmountRefunded').val().replace(currencySymbol, '') : 0;
                var amountMembershipRefund = !isNullOrUndefined($('#txtMembershipAmountRefunded').val()) ? $('#txtMembershipAmountRefunded').val().replace(currencySymbol, '') : 0;
                var amountNonReceiptableRefund = !isNullOrUndefined($('#txtAmountNonreceiptableRefunded').val()) ? $('#txtAmountNonreceiptableRefunded').val().replace(currencySymbol, '') : 0;
                var amountTaxRefund = !isNullOrUndefined($('#txtAmountTaxRefunded').val()) ? $('#txtAmountTaxRefunded').val().replace(currencySymbol, '') : 0;

                if (isNaN(parseFloat(amountMembershipRefund))) {
                    $(this).addClass('red-border');
                    $(this).focus();

                    $(this).val('');

                    $("#lblErrorAmount").append("Invalid entry:  Membership Amount");
                    return;
                }
                else if (parseFloat(amountMembershipRefund) > parseFloat(amountMembershipAvailable)) {
                    $(this).addClass('red-border');
                    $(this).focus();
                    $("#lblErrorAmount").append("Membership amount for refund can not be greater than available refund.");
                }
                else {
                    $(this).removeClass('red-border');
                    $('#txtRefundAmount').val(currencySymbol + (parseFloat(amountRefund) + parseFloat(amountMembershipRefund) + parseFloat(amountNonReceiptableRefund) + parseFloat(amountTaxRefund)).toFixed(2));
                }

                if ($(this).val().indexOf(".") == -1) {
                    $(this).val($(this).val() + ".00");
                }

                $(this).val(addDollarSign($(this).val()));
            });

            $('#txtAmountNonreceiptableRefunded').focusout(function () {
                $("#lblErrorAmount").text('');
                var amountNonReceiptableAvailable = !isNullOrUndefined($('#txtAmountNonreceiptable').val()) ? $('#txtAmountNonreceiptable').val().replace(currencySymbol, '') : 0;
                var amountRefund = !isNullOrUndefined($('#txtGiftAmountRefunded').val()) ? $('#txtGiftAmountRefunded').val().replace(currencySymbol, '') : 0;
                var amountMembershipRefund = !isNullOrUndefined($('#txtMembershipAmountRefunded').val()) ? $('#txtMembershipAmountRefunded').val().replace(currencySymbol, '') : 0;
                var amountNonReceiptableRefund = !isNullOrUndefined($('#txtAmountNonreceiptableRefunded').val()) ? $('#txtAmountNonreceiptableRefunded').val().replace(currencySymbol, '') : 0;
                var amountTaxRefund = !isNullOrUndefined($('#txtAmountTaxRefunded').val()) ? $('#txtAmountTaxRefunded').val().replace(currencySymbol, '') : 0;

                if (isNaN(parseFloat(amountNonReceiptableRefund))) {
                    $(this).addClass('red-border');
                    $(this).focus();

                    $(this).val('');

                    $("#lblErrorAmount").append("Invalid entry:  Amount Non-receiptable");
                    return;
                }
                else if (parseFloat(amountNonReceiptableRefund) > parseFloat(amountNonReceiptableAvailable)) {
                    $(this).addClass('red-border');
                    $(this).focus();
                    $("#lblErrorAmount").append("Amount non-receiptable for refund can not be greater than available refund.");
                }
                else {
                    $(this).removeClass('red-border');
                    $('#txtRefundAmount').val(currencySymbol + (parseFloat(amountRefund) + parseFloat(amountMembershipRefund) + parseFloat(amountNonReceiptableRefund) + parseFloat(amountTaxRefund)).toFixed(2));
                }

                if ($(this).val().indexOf(".") == -1) {
                    $(this).val($(this).val() + ".00");
                }

                $(this).val(addDollarSign($(this).val()));
            });

            $('#txtAmountTaxRefunded').focusout(function () {
                $("#lblErrorAmount").text('');
                var amountTaxAvailable = !isNullOrUndefined($('#txtAmountTax').val()) ? $('#txtAmountTax').val().replace(currencySymbol, '') : 0;
                var amountRefund = !isNullOrUndefined($('#txtGiftAmountRefunded').val()) ? $('#txtGiftAmountRefunded').val().replace(currencySymbol, '') : 0;
                var amountMembershipRefund = !isNullOrUndefined($('#txtMembershipAmountRefunded').val()) ? $('#txtMembershipAmountRefunded').val().replace(currencySymbol, '') : 0;
                var amountNonReceiptableRefund = !isNullOrUndefined($('#txtAmountNonreceiptableRefunded').val()) ? $('#txtAmountNonreceiptableRefunded').val().replace(currencySymbol, '') : 0;
                var amountTaxRefund = !isNullOrUndefined($('#txtAmountTaxRefunded').val()) ? $('#txtAmountTaxRefunded').val().replace(currencySymbol, '') : 0;

                if (isNaN(parseFloat(amountTaxRefund))) {
                    $(this).addClass('red-border');
                    $(this).focus();

                    $(this).val('');

                    $("#lblErrorAmount").append("Invalid entry:  Amount (Tax)");
                    return;
                }
                else if (parseFloat(amountTaxRefund) > parseFloat(amountTaxAvailable)) {
                    $(this).addClass('red-border');
                    $(this).focus();
                    $("#lblErrorAmount").append("Amount(tax) for refund can not be greater than available refund.");
                }
                else {
                    $(this).removeClass('red-border');
                    $('#txtRefundAmount').val(currencySymbol + (parseFloat(amountRefund) + parseFloat(amountMembershipRefund) + parseFloat(amountNonReceiptableRefund) + parseFloat(amountTaxRefund)).toFixed(2));
                }

                if ($(this).val().indexOf(".") == -1) {
                    $(this).val($(this).val() + ".00");
                }

                $(this).val(addDollarSign($(this).val()));
            });

            $('.tabview').children('a').each(function () {
                $(this).click(function (e) {
                    manageTab(this);
                });
            });

            $('#btnProcess').click(function () {
                var refundAvailable = $('#txtRefundAvailable').val();
                var refundAmount = $('#txtRefundAmount').val();
                $("#lblErrorAmount").text('');

                refundAvailable = parseFloat(refundAvailable.replace(currencySymbol, ''));
                refundAmount = parseFloat(refundAmount.replace(currencySymbol, ''));

                if (isNaN(refundAmount) || refundAmount <= 0) {
                    $("#lblErrorAmount").append("Invalid entry : Gift Amount");
                }
                else if (parseFloat(refundAmount) > parseFloat(refundAvailable)) {
                    $("#lblErrorAmount").append("Refund Amount can not be greater than Refund Available.");
                }
                else {
                    if (Validate()) {
                        $(".divloader").css('display', 'block');

                        var refund = {};

                        if ($('.tabview').find('#TabCC').hasClass('tab-active'))
                            refund["msnfp_refundtypecode"] = GiftType.Credit_Debit_Card;
                        else if ($('.tabview').find('#TabBank').hasClass('tab-active'))
                            refund["msnfp_refundtypecode"] = GiftType.Bank_Ach;
                        else if ($('.tabview').find('#TabCheque').hasClass('tab-active')) {
                            refund["msnfp_refundtypecode"] = GiftType.Cheque;
                            refund["msnfp_chequenumber"] = $('#txtChequeNumber').val();
                        }
                        else if ($('.tabview').find('#TabCash').hasClass('tab-active'))
                            refund["msnfp_refundtypecode"] = GiftType.Cash;
                        else if ($('.tabview').find('#TabWireTransfer').hasClass('tab-active')) {
                            refund["msnfp_refundtypecode"] = GiftType.Wire_or_Transfer;
                            refund["msnfp_chequenumber"] = $('#txtChequeNumber').val();
                        }
                        else if ($('.tabview').find('#TabExtCC').hasClass('tab-active'))
                            refund['msnfp_refundtypecode'] = GiftType.Ext_CreditCard;
                        else if ($('.tabview').find('#TabOther').hasClass('tab-active'))
                            refund['msnfp_refundtypecode'] = GiftType.Other;

                        console.log("refund code: " + refund['msnfp_refundtypecode']);

                        // Customer:
                        // See if it is an account or contact:
                        if (!isNullOrUndefined(currentGift.msnfp_CustomerId_contact)) {
                            console.log("Contact");
                            refund["msnfp_CustomerId_contact@odata.bind"] = "/contacts(" + currentGift._msnfp_customerid_value + ")";
                            //refund['msnfp_refundtypecode'] = GiftType.Other;
                        }
                        if (!isNullOrUndefined(currentGift.msnfp_CustomerId_account)) {
                            console.log("Account");
                            refund["msnfp_CustomerId_account@odata.bind"] = "/accounts(" + currentGift._msnfp_customerid_value + ")";
                        }


                        // Refund totals:
                        refund["msnfp_ref_amount_receipted"] = !isNullOrUndefined($('#txtGiftAmountRefunded').val()) ? parseFloat($('#txtGiftAmountRefunded').val().replace(currencySymbol, '')) : 0;
                        refund["msnfp_ref_amount_membership"] = !isNullOrUndefined($('#txtMembershipAmountRefunded').val()) ? parseFloat($('#txtMembershipAmountRefunded').val().replace(currencySymbol, '')) : 0;
                        refund["msnfp_ref_amount_nonreceiptable"] = !isNullOrUndefined($('#txtAmountNonreceiptableRefunded').val()) ? parseFloat($('#txtAmountNonreceiptableRefunded').val().replace(currencySymbol, '')) : 0;
                        refund["msnfp_ref_amount_tax"] = !isNullOrUndefined($('#txtAmountTaxRefunded').val()) ? parseFloat($('#txtAmountTaxRefunded').val().replace(currencySymbol, '')) : 0;
                        refund["msnfp_ref_amount"] = !isNullOrUndefined($('#txtRefundAmount').val()) ? parseFloat($('#txtRefundAmount').val().replace(currencySymbol, '')) : 0;


                        // Original totals:
                        refund["msnfp_amount_receipted"] = !isNullOrUndefined(currentGift.msnfp_amount_receipted) ? parseFloat(currentGift.msnfp_amount_receipted) : 0;
                        refund["msnfp_amount_membership"] = !isNullOrUndefined(currentGift.msnfp_amount_membership) ? parseFloat(currentGift.msnfp_amount_membership) : 0;
                        refund["msnfp_amount_nonreceiptable"] = !isNullOrUndefined(currentGift.msnfp_amount_nonreceiptable) ? parseFloat(currentGift.msnfp_amount_nonreceiptable) : 0;
                        refund["msnfp_amount_tax"] = !isNullOrUndefined(currentGift.msnfp_amount_tax) ? parseFloat(currentGift.msnfp_amount_tax) : 0;

                        var giftTotalHeader = !isNullOrUndefined(currentGift.msnfp_amount) ? parseFloat(currentGift.msnfp_amount) : 0;
                        var giftTotalRefunded = !isNullOrUndefined(currentGift.msnfp_ref_amount) ? parseFloat(currentGift.msnfp_ref_amount) : 0;

                        console.log("giftTotalRefunded = " + giftTotalRefunded);

                        refund["msnfp_amount"] = giftTotalHeader - giftTotalRefunded;

                        var date = new Date($('#txtRefundDate').val());
                        //var str = getFormattedDate(date); //returns mnth/date/fullyear
                        //str = str.split('/');
                        refund["msnfp_bookdate"] = date.getFullYear() + '-' + (date.getMonth() + 1) + '-' + date.getDate();
                        //refund["msnfp_refunddate"] = new Date($('#txtRefundDate').val());

                        refund["msnfp_TransactionId@odata.bind"] = "/msnfp_transactions(" + currentEntityGUID + ")";

                        var qry = XrmServiceUtility.GetWebAPIUrl() + "msnfp_refunds";

                        XrmServiceUtility.CreateRecordAsync(qry, refund, saveSuccess, errorFailure);
                    }
                }
            });
        });

        function manageTab(current) {
            $('.tabview').children('a').each(function () {
                if (this === current) {
                    $(this).addClass('tab-active');

                    if (this.id == 'TabCheque' || this.id == 'TabWireTransfer')
                        $('#trCheque').show();
                    else
                        $('#trCheque').hide();
                }
                else {
                    $(this).removeClass('tab-active');
                }
            });
        }

        function getCurrencySymbol(transactionCurrencyID) {
            if (!isNullOrUndefined(transactionCurrencyID)) {
                var currencySelect = "transactioncurrencies?$select=transactioncurrencyid,currencysymbol,isocurrencycode"
                currencySelect += "&$filter=transactioncurrencyid eq " + transactionCurrencyID;
                var currencyRec = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + currencySelect);
                if (!isNullOrUndefined(currencyRec))
                    currencyRec = currencyRec[0];

                if (!isNullOrUndefined(currencyRec)) {
                    currencySymbol = currencyRec.currencysymbol;
                    isoCurrencyCode = currencyRec.isocurrencycode;
                }
            }
        }

        function Validate() {
            $("#lblErrorAmount").text('');
            var isValidate = true;

            if ($('.tabview').find('#TabCheque').hasClass('tab-active') && isNullOrUndefined($('#txtChequeNumber').val())) {
                $("#lblErrorAmount").append("Please enter cheque number.");
                isValidate = false;
            }

            if (isNullOrUndefined($('#txtRefundDate').val()) || isNaN(Date.parse($('#txtRefundDate').val()))) {
                $("#lblErrorAmount").append("Please select or enter Refund Date.").after('\n');
                isValidate = false;
            }


            var amountRefund = !isNullOrUndefined($('#txtGiftAmountRefunded').val()) ? parseFloat($('#txtGiftAmountRefunded').val().replace(currencySymbol, '')) : 0;
            var amountMembershipRefund = !isNullOrUndefined($('#txtMembershipAmountRefunded').val()) ? parseFloat($('#txtMembershipAmountRefunded').val().replace(currencySymbol, '')) : 0;
            var amountNonreceitableRefund = !isNullOrUndefined($('#txtAmountNonreceiptableRefunded').val()) ? parseFloat($('#txtAmountNonreceiptableRefunded').val().replace(currencySymbol, '')) : 0;
            var amountTaxRefund = !isNullOrUndefined($('#txtAmountTaxRefunded').val()) ? $('#txtAmountTaxRefunded').val().replace(currencySymbol, '') : 0;

            var amount = !isNullOrUndefined(currentGift.msnfp_amount_receipted) ? parseFloat(currentGift.msnfp_amount_receipted) : 0;
            var amountMembership = !isNullOrUndefined(currentGift.msnfp_amount_membership) ? parseFloat(currentGift.msnfp_amount_membership) : 0;
            var amountNonreceiptable = !isNullOrUndefined(currentGift.msnfp_amount_nonreceiptable) ? parseFloat(currentGift.msnfp_amount_nonreceiptable) : 0;
            var amountTaxAvailable = !isNullOrUndefined($('#txtAmountTax').val()) ? $('#txtAmountTax').val().replace(currencySymbol, '') : 0;


            if (amountRefund > amount) {
                isValidate = false;
                $("#lblErrorAmount").append("Gift amount for refund can not be greater than available refund.");
            }
            if (amountMembershipRefund > amountMembership) {
                isValidate = false;
                $("#lblErrorAmount").append("Membership amount for refund can not be greater than available refund.");
            }
            if (amountNonreceitableRefund > amountNonreceiptable) {
                isValidate = false;
                $("#lblErrorAmount").append("Amount non-receiptable for refund can not be greater than available refund.");
            }
            if (amountTaxRefund > amountTaxAvailable) {
                isValidate = false;
                $("#lblErrorAmount").append("Amount(tax) for refund can not be greater than available refund.");
            }

            return isValidate;
        }

        function formatdigits(val) {
            val = val.toString();
            return val.length === 1 ? "0" + val : val;
        }

        function checkIt(evt) {
            evt = (evt) ? evt : window.event;
            var charCode = (evt.which) ? evt.which : evt.keyCode;
            if (charCode > 31 && (charCode < 48 || charCode > 57)) {
                status = "This field accepts numbers only."
                return false;
            }
            status = "";
            return true;
        }

        function saveSuccess(recordID) {
            if (!isNullOrUndefined(recordID)) {
                $("#lblResult")[0].innerText = "Refund Successful.";
                if (isParentAccessible())
                    parent.window.opener.location.reload(true);
                window.close();

            }
            else {
                $("#lblError")[0].innerText = "Refund Failed.";
            }
            $(".divloader").css('display', 'none');
            //$('#btnClose').show();
            $('#btnProcess').hide();
        }

        function errorFailure(message) {
            $("#lblError")[0].innerText = message;
            $(".divloader").css('display', 'none');
        }

        function isParentAccessible() {
            try {
                parent.window.opener.location;
                return true;
            }
            catch (err) {
                return false;
            }
        }


        Date.prototype.mmddyy = function () {
            var mm = this.getMonth() + 1; // getMonth() is zero-based
            var dd = this.getDate();

            return [(mm > 9 ? '' : '0') + mm,
            (dd > 9 ? '' : '0') + dd,
            this.getFullYear().toString().substr(-2)
            ].join('');
        };

        $("#btnClose").click(function () {
            window.close();
        });

        function isNullOrUndefined(value) {
            return (typeof (value) === "undefined" || value === null || value === "");
        }

        function getFormattedDate(date) {
            return ("0" + (date.getUTCMonth() + 1)).slice(-2)
                + "/"
                + ("0" + date.getUTCDate()).slice(-2)
                + "/"
                + date.getUTCFullYear();
        }

        function addDollarSign(value) {
            if (value != null && value != undefined && currencySymbol != null && currencySymbol != "") {
                if (value.substring(0, 1) != currencySymbol.substring(0, 1))
                    value = currencySymbol + value;
            }

            return value;
        }

        function removeDollarSign(value) {
            if (value != null && value != undefined && currencySymbol != null && currencySymbol != "") {
                if (value.substring(0, 1) == currencySymbol.substring(0, 1))
                    value = value.substr(currencySymbol.length);
            }

            return value;
        }

    </script>


</body>
</html>