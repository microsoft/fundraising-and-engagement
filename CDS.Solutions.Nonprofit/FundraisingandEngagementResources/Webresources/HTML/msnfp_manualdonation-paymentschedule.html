<html>
<!--/*************************************************************************
* © Microsoft. All rights reserved.
*/-->
<head>
    <title></title>
    <meta charset="utf-8">
    <link href="../scripts/jquery_ui.css" rel="stylesheet">
    <link href="../scripts/jquery.dataTables.min.css" rel="stylesheet">
    <link href="../scripts/bootstrap.min.css" rel="stylesheet">
    <link href="../scripts/common.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Hind:500" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
    <script src="../scripts/jQuery.js" type="text/javascript"></script>
    <script src="../scripts/jquery_ui.js" type="text/javascript"></script>
    <script src="../scripts/jquery.dataTables.min.js" type="text/javascript"></script>
    <script src="../scripts/dataTables.cellEdit.js" type="text/javascript"></script>
    <script src="../scripts/jquery.autocomplete.js"></script>
    <script src="../scripts/common.js" type="text/javascript"></script>
    <script src="../scripts/savepaymentvalues.js" type="text/javascript"></script>

    <style type="text/css">
        html, body {
            margin: 0px;
            padding: 0px;
            font-family: SegoeUI, "Segoe UI", "Helvetica Neue",Arial,"Noto Sans",sans-serif;
        }


        /*Note that several items below override bootstrap for this page.*/
        .container {
            padding-right: 0;
            padding-left: 10;
            margin-right: 0;
            margin-left: 0;
            background-color: #ededed;
            width: 100%;
            max-width: 20000px; /*In some environments the container width does not adhere to bootstrap in the same way, so this prevents issues where the page would be too narrow*/
        }

        .form-row {
            margin-right: 0;
        }

            .form-row > .col {
                padding-top: 10px;
            }

        b {
            font-size: 1.1em;
        }

        .notExists {
            width: 100%;
        }

        .badge-success {
            color: #fff;
            background-color: #243a5e;
        }

        #spanAddMembershipButton {
            cursor: pointer;
        }

        #txtRecurringInstance {
            width: 40px;
            min-width: 40px;
            margin-right: 2px;
        }

        #txtScheduleInstance {
            width: 40px;
            min-width: 40px;
            margin-right: 2px;
        }

        #ddlRecurringEveryDayType {
            width: 136px;
            min-width: 136px;
        }

        #ddlScheduleEveryDayType {
            width: 136px;
            min-width: 136px;
        }

        #txtAmount {
            max-width: 180px;
            min-width: 180px;
        }

        #ddlExistingCard {
            max-width: 180px;
            min-width: 180px;
        }

        #txtAmountTax {
            max-width: 180px;
            min-width: 180px;
        }

        #txtTotalAmount {
            max-width: 180px;
            min-width: 180px;
        }

        #txtScheduleStartDate {
            max-width: 180px;
            min-width: 180px;
        }

        #btnProcess {
            width: auto;
        }

        #btnRecurringNextDonation {
            width: 70px;
        }

        #txtCancelDonationNote {
            padding: 5px;
            border-color: rgb(206, 212, 218);
            width: 230px;
        }

        #btnRegeneratePledge {
            margin-top: 5px;
        }

        #btnSavePledgeAllocation {
            max-width: 180px;
            margin-top: 5px;
        }

        #btnRecurringCancelDonation {
            margin-top: 10px;
            height: calc((1.5em + 0.75rem) + 2px);
        }

        #btnRecurringNextDonationAmount {
            width: 80px;
        }

        #btnDepositDateAll {
            min-width: 120px;
        }


        [type=button], [type=reset], [type=submit], button {
            -webkit-appearance: none;
        }

        .spanFundTransferedfromGift {
            width: 100%;
            max-width: 450px;
        }

        .spanExistingPledge {
            width: 100%;
            overflow: hidden;
            max-width: 450px;
            white-space: normal;
            overflow-wrap: break-word;
        }

        label {
            display: inline-block;
            margin-bottom: .5rem;
            width: 130px;
            text-align: right;
            margin-right: 0.5em;
            font-size: 1.2em;
            margin-top: 0.5em;
            z-index: 1; /*This fixes an issue where labels may overlap a text box.*/
        }

        .form-group {
            margin-bottom: 0.8rem; /*1rem*/
        }

        .form-control {
            display: block;
            width: 50%;
            z-index: 2; /*This fixes an issue where labels may overlap a text box.*/
            min-width: 50%;
            height: calc((1.5em + 0.75rem) + 2px);
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            color: rgb(73, 80, 87);
            background-color: rgb(255, 255, 255);
            background-clip: padding-box;
            padding: 0.375rem 0.75rem;
            border-width: 1px;
            border-style: solid;
            border-color: rgb(206, 212, 218);
            border-image: initial;
            border-radius: 0.25rem;
            transition: border-color 0.15s ease-in-out 0s, box-shadow 0.15s ease-in-out 0s;
        }


        .row {
            margin-right: 0;
            margin-left: 0;
        }

        .col {
            padding-right: 0;
            padding-left: 0;
        }

        .mb20 {
            padding-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }

        .pt20 {
            padding-top: 13px;
        }

        .switch-field {
            overflow: hidden;
        }

            .switch-field input {
                position: absolute !important;
                clip: rect(0, 0, 0, 0);
                height: 1px;
                width: 1px;
                border: 0;
                overflow: hidden;
            }

        input:disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .subsequent-buttons.recurringDonation-success.hide.mb20 {
            text-align: left !important;
        }

        .recurringDonation-last.hide.mb20 {
            text-align: left !important;
        }

        select:disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .switch-field label {
            float: left;
            display: block;
            text-align: center;
            text-shadow: none;
            border: 1px solid #b4b4b4;
            -webkit-transition: all 0.1s ease-in-out;
            -moz-transition: all 0.1s ease-in-out;
            -ms-transition: all 0.1s ease-in-out;
            -o-transition: all 0.1s ease-in-out;
            transition: all 0.1s ease-in-out;
            -webkit-box-shadow: none;
            box-shadow: none;
            font-weight: bolder;
            color: #243a5e;
            font-family: 'Hind', sans-serif;
            font-size: 14px;
            background-color: #cccccc;
            padding: 5px 6px 3px 6px;
            text-transform: uppercase;
            cursor: pointer !important;
            white-space: nowrap;
            width: auto;
            margin-right: 0em;
        }

            .switch-field label:hover {
                cursor: pointer;
                color: white;
                border: 1px solid #243a5e;
                background-color: #243a5e;
            }

        .switch-field input:disabled + label {
            opacity: 0.3;
            cursor: default !important;
            pointer-events: none;
        }

        .switch-field input:checked + label {
            color: white;
            border: 1px solid #243a5e;
            background-color: #243a5e;
            opacity: 1;
            cursor: pointer !important;
        }

        .switch-field label:first-of-type {
            border-radius: 0px;
        }

        .switch-field label:last-of-type {
            border-radius: 0px;
        }

        .table-details {
            background-color: #ededed;
            padding-top: 5%;
        }

        .table td {
            border: 1px solid #ced4da;
        }

        .content-details {
            margin-right: 0.5%;
        }

            .content-details input, .content-details select {
                font-size: 14px;
                line-height: 1.5;
                color: #495057;
                background-color: #fff;
                background-clip: padding-box;
                border: 1px solid #ced4da;
                border-radius: .25rem;
                transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out;
                margin-top: 1px;
            }

        .form-container {
            margin-bottom: 20px;
            background-color: white;
            border-top: 0.6em solid #243a5e;
            padding: 20px;
            margin-right: 8px;
            align-self: center;
        }

        .main-button {
            text-align: center !important;
            text-shadow: none !important;
            border: 1px solid #b4b4b4 !important;
            background-color: #cccccc !important;
            -webkit-transition: all 0.1s ease-in-out !important;
            -moz-transition: all 0.1s ease-in-out !important;
            -ms-transition: all 0.1s ease-in-out !important;
            -o-transition: all 0.1s ease-in-out !important;
            transition: all 0.1s ease-in-out !important;
            padding: 5px 6px 3px 6px !important;
            font-family: 'Hind', sans-serif !important;
            font-weight: bolder !important;
            text-transform: uppercase !important;
            font-size: 14px !important;
            color: #243a5e !important;
            cursor: pointer !important;
            border-radius: 0px !important;
            background-clip: initial !important;
            margin: 0;
            margin-top: 0px;
            line-height: unset !important;
            margin-right: 5px !important;
            white-space: nowrap !important;
            min-width: 100px;
        }

            .main-button:hover {
                cursor: pointer !important;
                color: white !important;
                border: 1px solid #243a5e !important;
                background-color: #243a5e !important;
            }

            .main-button:disabled {
                opacity: 0.3 !important;
                pointer-events: none !important;
            }

        .main-button-lnk {
            text-align: center !important;
            text-shadow: none !important;
            border: 1px solid #b4b4b4 !important;
            background-color: #cccccc !important;
            -webkit-transition: all 0.1s ease-in-out !important;
            -moz-transition: all 0.1s ease-in-out !important;
            -ms-transition: all 0.1s ease-in-out !important;
            -o-transition: all 0.1s ease-in-out !important;
            transition: all 0.1s ease-in-out !important;
            padding: 5px 6px 3px 6px !important;
            font-family: 'Hind', sans-serif !important;
            font-weight: bolder !important;
            text-transform: uppercase !important;
            font-size: 14px !important;
            color: #243a5e !important;
            cursor: pointer !important;
            border-radius: 0px !important;
            margin-top: 0px !important;
            background-clip: initial !important;
            margin: 0 !important;
            line-height: unset !important;
            margin-right: 5px !important;
            display: inline-block;
        }

            .main-button-lnk:hover {
                cursor: pointer !important;
                color: white !important;
                border: 1px solid #243a5e !important;
                background-color: #243a5e !important;
            }

            .main-button-lnk:disabled {
                opacity: 0.3 !important;
                pointer-events: none !important;
            }

            .main-button-lnk:before {
                font-family: "Font Awesome 5 Free";
                content: "\f0c1";
                opacity: 0.8 !important;
                margin-right: 5px;
            }

        .content-header h2 {
            color: #000000;
            margin-top: 3px;
            margin-bottom: 3px;
            margin-right: 0px;
            padding-top: 10px;
            font-size: 17px;
            padding-bottom: 1%;
            background: #ededed;
        }

        .mandatory span:after {
            content: '*';
            color: red;
            font-weight: bold;
            font-size: 15px;
            padding-left: 3px;
        }

        .mandatory label:after {
            content: '*';
            color: red;
            font-weight: bold;
            font-size: 15px;
            padding-left: 3px;
        }

        .red-border {
            border: solid 1px #CD2828 !important;
        }

        .subsequent-main {
            max-width: 613px;
        }

        .spacebetween {
            margin-right: 50px;
        }

        .errorMSG {
            color: red;
            padding: 5px 15px;
            font-weight: bold;
            width: 100%;
            text-align: left;
        }

        @media only screen and (max-width: 1030px) {
            .msg-div {
                width: 100%;
            }
        }

        @media only screen and (min-width: 1030px) {
            .msg-div {
                width: 50%;
            }
        }

        .field-label {
            padding-right: 0px;
        }

        div.divSection {
            height: 105px;
            width: 100%;
            max-width: 450px;
            background-color: #f2f2f2;
            font-family: SegoeUI, "Segoe UI", "Helvetica Neue",Arial,"Noto Sans",sans-serif;
            background-position: right -15px;
            background-repeat: no-repeat;
            border-bottom-width: 5px;
            border-bottom-style: solid;
            margin-bottom: 3%;
        }

        .boldCaps {
            font-weight: 700;
            font-size: 14px !important;
            text-transform: uppercase;
            padding-left: 7px;
            padding-top: 4%;
            color: black;
        }

        div.emptyDiv {
            line-height: 15px;
        }

        .spanHighlighted {
            color: #000000;
            padding-left: 3px;
            padding-right: 3px;
        }

        .header2 {
            font-size: 16px;
            padding-left: 6%;
            line-height: 1.4;
        }

        .header3 {
            font-size: 16px;
            line-height: 1.3;
            padding-left: 5%;
        }

        .newMembership {
            background-position: 98% 95% !important;
            background-size: 15%;
            color: black;
        }

        a:link {
            color: black;
        }

        a:visited {
            color: black;
        }

        table, th {
            border-collapse: collapse;
            font-family: 'Hind', sans-serif;
            font-size: 12px;
        }

        th, td {
            text-align: left;
        }

        table, td {
            color: #444444;
            font-family: 'Hind', sans-serif;
            font-size: 14px;
            font-weight: 500;
        }


        .tab {
            background-color: #e6e6e4;
            text-decoration: none;
            color: black;
            text-align: center;
            display: inline-block;
            min-width: 50px;
        }

        .tab-active {
            color: white !important;
            border: 1px solid #243a5e !important;
            background-color: #243a5e !important;
        }

        .tabview a.tab {
            margin-right: -3px;
            text-align: center;
            text-shadow: none;
            border: 1px solid #b4b4b4;
            -webkit-transition: all 0.1s ease-in-out;
            -moz-transition: all 0.1s ease-in-out;
            -ms-transition: all 0.1s ease-in-out;
            -o-transition: all 0.1s ease-in-out;
            transition: all 0.1s ease-in-out;
            -webkit-box-shadow: none;
            box-shadow: none;
            font-weight: bolder;
            color: #243a5e;
            font-family: 'Hind', sans-serif;
            font-size: 14px;
            background-color: #cccccc;
            padding: 5px 8px 3px 8px;
            text-transform: uppercase;
            cursor: pointer !important;
            white-space: nowrap;
        }

            .tabview a.tab:hover {
                cursor: pointer;
                color: white;
                border: 1px solid #243a5e;
                background-color: #243a5e;
            }

        .content {
            width: 450px;
            margin: auto;
            background-color: white;
            padding: 15px;
        }

        .fieldWrap {
            width: 100%;
            clear: both;
        }

        .seperator {
            margin-bottom: 15px;
            display: none;
        }

        .outputArea {
            display: none;
            padding-left: 5px;
        }

        /* The Modal (background) */

        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 3; /* Sit on top of other labels and buttons */
            padding-top: 100px; /* Location of the box */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgb(0,0,0); /* Fallback color */
            background-color: rgba(0,0,0,0.1); /* Black w/ opacity */
        }

        /* Modal Content */
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 60%;
        }

        /* The Close Button */
        .closeBtn {
            color: #aaaaaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

            .closeBtn:hover,
            .closeBtn:focus {
                color: #000;
                text-decoration: none;
                cursor: pointer;
            }

        .modal-header {
            display: -ms-flexbox;
            display: flex;
            -ms-flex-align: start;
            align-items: flex-start;
            -ms-flex-pack: justify;
            justify-content: space-between;
            border-bottom: 1px solid #e4e7ea;
            border-top-left-radius: .3rem;
            border-top-right-radius: .3rem;
        }

        /*End of Modal styling*/

    </style>
    <meta>
</head>
<body style="word-wrap: break-word; margin: 1px;">

    <!-- The Modal -->
    <div id="membershipModal" class="modal">
        <!-- Modal content -->
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Membership</h2>
                <span class="closeBtn">×</span>
            </div>
            <div id="divSelectMembership" style="width: 100%; display: none;">
                <table style="width: 100%; margin-top: 5px; float: right;" role="presentation">
                    <tbody>
                        <tr>
                            <td style="padding-left: 0px;padding-right: 0px;">
                                <div class="tabview">
                                </div>
                                <br>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <br>
                <table style="width: 100%;" role="presentation">
                    <tbody>
                        <tr>
                            <td style="width: 30%;">
                                <label id="lblMembershipMsg"></label>
                                <br>
                            </td>
                            <td style="width: 70%;">
                                <div style="float:right;width:100%;text-align: right;">
                                    <input type="button" id="btnAddToGift" class="main-button" value="Add to Gift" role="button">
                                    <input type="button" id="btnMembershipCancel" class="main-button" value="Cancel" style="margin-left: 1%;" role="button">
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div class="membershipGroup-clone">
                    <table class="table stripe hover" style="font-family: 'Hind', sans-serif; font-weight: normal; font-size: 12px; width: 100%;" aria-hidden="true" hidden="" role="presentation">
                        <thead>
                            <tr>
                                <th style="width: 15% !important;">Select</th>
                                <th style="text-align: left; width: 55% !important; padding-left: 10px;">Membership</th>
                                <th style="text-align: left; width: 30% !important; padding-left: 10px;">Cost</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <!--Pledge Schedule Modal-->
    <div id="PledgeScheduleModal" class="modal">
        <!-- Modal content -->
        <div class="modal-content">
            <div class="modal-header">
                <h2>Pledge Schedule</h2>
                <span class="closeBtn">×</span>
            </div>
            <div id="divPledgeScheduleModalDiv" style="width: 100%; display: none;">
                <table id="pledgeScheduleTableModal" class="table stripe hover" style="width: 100%;" role="presentation">
                    <thead>
                        <tr>
                            <th style="width: 21% !important;">
                                Remove?
                            </th>
                            <th class="sorting_asc" style="width: 19% !important;">
                                Date
                            </th>
                            <th style="width: 19% !important;">
                                Amount
                            </th>
                            <th style="width: 19% !important;">
                                Balance
                            </th>
                            <th style="width: 19% !important;">
                                Amount Paid
                            </th>
                            <th style="width: 19% !important;">
                                Status
                            </th>
                            <th style="width: 20% !important;"><br></th>
                        </tr>
                    </thead>
                </table>
            </div>
        </div>
    </div>
    <div class="container manual-main">
        <div style="border-style:none;background:#ededed;padding:6px;padding-top:10px;padding-bottom:3px;margin-bottom: 3px;">
            <div class="content-header" style="display: inline-block;width: 125px;vertical-align: top;">
                <h2 class="noselect">GIFT DETAILS</h2>
            </div>
            <div class="content-details switch-field" style="display: inline-block;">
                <input name="donationPledgeType" id="radioRecurringDonation" checked="" type="radio" value="5" aria-label="Recurring Donation">
                <label for="radioRecurringDonation">Recurring Donation</label>
                <input name="donationPledgeType" id="radioPledgeSchedule" type="radio" value="6" aria-label="Pledge Schedule">
                <label for="radioPledgeSchedule">Pledge Schedule</label>
            </div>
        </div>
        <div style="border-style:none;background:#ededed;padding:6px;padding-top: 10px;padding-bottom: 2px;margin-bottom: 3px;">
            <div class="content-header" style="display: inline-block;width: 125px;vertical-align: top;">
                <h2 class="noselect">PROCESS GIFTS</h2>
            </div>
            <div class="content-details switch-field" style="display: inline-block;margin-bottom:3px;">
                <input type="radio" id="radioCash" name="paymentType" value="844060000" aria-label="Cash">
                <label for="radioCash">Cash</label>
                <input type="radio" id="radioCreditDebit" name="paymentType" checked="" value="844060002" aria-label="Credit / Debit">
                <label for="radioCreditDebit">Credit / Debit</label>
                <input type="radio" id="radioBankACH" name="paymentType" value="844060003" aria-label="Bank (ACH)">
                <label for="radioBankACH">Bank (ACH)</label>
                <input name="anonymousDonation" id="radioVisibleDonation" type="radio" checked="" value="844060000" aria-label="Visible">
                <label class="lblAnonymousDonation" style="margin-left: 15px;" for="radioVisibleDonation">Visible</label>
                <input name="anonymousDonation" id="radioAnonymous" type="radio" value="844060001" aria-label="Anonymous">
                <label class="lblAnonymous" for="radioAnonymous">Anonymous</label>
                <input name="giftSource" id="radioPhone" type="radio" checked="" value="844060000" aria-label="Phone">
                <label class="lblPhone" style="margin-left: 15px;" for="radioPhone">Phone</label>
                <input name="giftSource" id="radioMail" type="radio" value="844060002" aria-label="Mail">
                <label class="lblMail" for="radioMail">Mail</label>
                <input name="giftSource" id="radioInPerson" type="radio" value="844060001" aria-label="In Person">
                <label class="lblInPerson" for="radioInPerson">In Person</label>
                <input name="giftSource" id="radioOnline" type="radio" value="844060003" aria-label="Online">
                <label class="lblOnline" for="radioOnline">Online</label>
                <input name="giftSource" id="radioSocial" type="radio" value="844060004" aria-label="Social">
                <label class="lblSource" for="radioSocial">Social</label>

                <div id="divReceiptPreference">
                    <input name="receiptPreference" id="radioDoNotReceipt" type="radio" value="844060000" aria-label="DO NOT RECEIPT">
                    <label style="margin-left: 15px;" for="radioDoNotReceipt">DO NOT RECEIPT</label>
                    <input name="receiptPreference" id="radioReceiptEmail" type="radio" value="844060001" aria-label="Email">
                    <label for="radioReceiptEmail">Email</label>
                    <input name="receiptPreference" id="radioReceiptPrint" type="radio" value="844060002" aria-label="Print">
                    <label for="radioReceiptPrint">Print</label>
                    <input name="receiptPreference" id="radioReceiptBoth" type="radio" value="844060003" aria-label="Both">
                    <label for="radioReceiptBoth">Both</label>
                </div>
            </div>
        </div>

        <div class="row form-container">
            <div class="col-sm-3">
                <div class="donationFields" style="width: 100%;">
                    <div class="divDisableAmount hide form-group">
                        <label for="txtDisableAmount"> Amount (Gift)</label>
                        <input type="text" class="form-control" id="txtDisableAmount">
                    </div>
                    <div class="divDisableAmountNonreceiptable hide form-group">
                        <label for="txtDisableAmountNonreceiptable">Amount (Nonreceiptable)</label>
                        <input type="text" class="form-control" id="txtDisableAmountNonreceiptable">
                    </div>
                    <div class="hide form-group">
                        <label for="txtDisableAmountMembership">Amount (Member)</label>
                        <input type="text" class="form-control" id="txtDisableAmountMembership">
                    </div>
                    <div class="divDisableTotal hide form-group">
                        <label for="txtDisableTotal">Total</label>
                        <input type="text" class="form-control" id="txtDisableTotal">
                    </div>
                    <div class="hide form-group" style="display:none !important;">
                        <label for="txtDisableDonorName">Receiptable Name</label>
                        <input type="text" class="form-control" id="txtDisableDonorName">
                    </div>
                    <div class="mandatory form-group" style="display: flex;">
                        <label for="txtFirstName">First Name</label>
                        <input type="text" class="form-control" id="txtFirstName" aria-label="First Name" aria-required="true">
                    </div>
                    <div class="mandatory form-group" style="display: flex;">
                        <label for="txtLastName">Last Name</label>
                        <input type="text" class="form-control" id="txtLastName" aria-label="Last Name" aria-required="true">
                    </div>
                    <div class="divEmail form-group">
                        <label for="txtEmail">Email</label>
                        <input type="text" class="form-control" id="txtEmail" aria-label="Email">
                    </div>
                    <div class="divPhone form-group">
                        <label for="txtPhone">Phone</label>
                        <input type="text" class="form-control" id="txtPhone" aria-label="Phone">
                    </div>
                    <div class="divAltPhone form-group">
                        <label for="txtAltPhone">Alt. Phone</label>
                        <input type="text" class="form-control" id="txtAltPhone" aria-label="Alt. Phone">
                    </div>
                    <div class="divMobilePhone form-group">
                        <label for="txtMobilePhone">Mobile</label>
                        <input type="text" class="form-control" id="txtMobilePhone" aria-label="Mobile">
                    </div>
                    <div class="divInHonour form-group">
                        <label for="txtInHonorMemoryOf">In Honor/Memory of</label>
                        <input type="text" class="form-control" id="txtInHonorMemoryOf" aria-label="In Honor/Memory of">
                    </div>
                    <div id="divTransactionIdentifier" aria-hidden="true" hidden="">
                        <label for="txtTransactionIdentifier">Gateway ID</label>
                        <input type="tel" id="txtTransactionIdentifier">
                    </div>
                    <div id="divSourceIdentifier" aria-hidden="true" hidden="">
                        <label for="txtSourceIdentifier">Source Identifier</label>
                        <input type="text" id="txtSourceIdentifier">
                    </div>
                    <div id="divCreditCard" aria-hidden="true" hidden="">
                        <label for="txtCreditCard">Credit<span style="font-size:1px;"> </span>/<span style="font-size:1px;"> </span>Debit Card</label>
                        <input type="text" id="txtCreditCard" aria-label="Credit/Debit Card">
                    </div>
                    <div id="divBankAccount" aria-hidden="true" hidden="">
                        <label for="txtBankAccount">Bank Account</label>
                        <input type="tel" id="txtBankAccount" aria-label="Bank Account">
                    </div>
                </div>
            </div>

            <div class="col-sm-3">
                <div class="donationFields">
                    <div class="form-group" style="display: flex;">
                        <label for="txtOrganization">Organization</label>
                        <input type="text" class="form-control" id="txtOrganization" aria-label="Organization">
                    </div>
                    <div class="divAddressFields form-group">
                        <label for="txtAddressLine1">Street 1</label>
                        <input type="text" class="form-control" id="txtAddressLine1" aria-label="Street 1">
                    </div>
                    <div class="divAddressFields form-group">
                        <label for="txtAddressLine2">Street 2</label>
                        <input type="text" class="form-control" id="txtAddressLine2" aria-label="Street 2">
                    </div>
                    <div class="divAddressFields form-group">
                        <label for="txtAddressLine3">Street 3</label>
                        <input type="text" class="form-control" id="txtAddressLine3" aria-label="Street 3">
                    </div>
                    <div class="divAddressFields form-group">
                        <label for="txtAddressCity">City</label>
                        <input type="text" class="form-control" id="txtAddressCity" aria-label="City">
                    </div>
                    <div class="divAddressFields form-group">
                        <label for="txtAddressProvince">State</label>
                        <input type="text" class="form-control" id="txtAddressProvince" aria-label="State">
                    </div>
                    <div class="divAddressFields form-group">
                        <label for="txtAddressPostalCode">Zip Code</label>
                        <input type="text" class="form-control" id="txtAddressPostalCode" aria-label="Zip Code">
                    </div>
                    <div class="divAddressFields form-group">
                        <label for="txtAddressCountry">Country</label>
                        <input type="text" class="form-control" id="txtAddressCountry" aria-label="Country">
                    </div>
                    <div class="content">
                        <div class="fieldWrap">
                            <div class="error" id="errorMessage"></div>
                        </div>
                        <div class="fieldWrap">
                            <div id="result"></div>
                        </div>
                        <div class="seperator" id="seperator"></div>
                        <div class="fieldWrap">
                            <div class="outputArea" id="output"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-sm-6">
                <div class="form-row">
                    <div id="donationInfo">
                        <div class="form-group" style="display:none !important;">
                            <label for="txtDonorName">Receiptable Name</label>
                            <input type="text" class="form-control" id="txtDonorName" aria-label="Receiptable Name">
                        </div>
                        <div class="donationCheque hide">
                            <div class="form-group" style="display:flex;">
                                <label for="txtChequeDate" class="spnChequeDate field-label hide">Check Date</label>
                                <label for="txtChequeDate" class="spnWireDate field-label hide">Wire Date</label>
                                <input type="text" class="form-control" id="txtChequeDate" aria-label="Check/Wire Date">
                            </div>
                            <div class="form-group" style="display: flex;
">
                                <label class="spnChequeNumber field-label hide">Check Number</label>
                                <label class="spnWireNumber field-label hide">Wire Number</label>
                                <input class="form-control" type="text" id="txtChequeNumber" onkeypress="return checkIt(event);" aria-label="Check/Wire Number">
                            </div>
                        </div>
                        <div class="form-group donationInKind hide">
                            <div class="form-group" style="display:flex;">
                                <label for="txtDescription">Description</label>
                                <input class="form-control" type="text" id="txtDescription" aria-label="Description">
                            </div>
                            <div class="form-group" style="display:flex;">
                                <label for="txtApraiser">Appraiser</label>
                                <input class="form-control" type="text" id="txtApraiser" aria-label="Appraiser">
                            </div>
                        </div>
                        <div class="form-group donationCreditCard hide">
                            <div class="form-group notExists" style="display:flex;">
                                <label for="ddlExistingCard">Existing Card</label>
                                <select class="form-control" id="ddlExistingCard" aria-label="Existing Credit Card" role="listbox">
                                    <option value="0">--Select--</option>
                                </select>
                            </div>
                            <div class="exists">
                                <div class="form-group" style="display:flex;">
                                    <label for="txtCardName" title="The name of the individual as it pertains to there payment method such as the name on the card or the name on the bank account">Name on the Card</label>
                                    <input class="form-control" type="text" id="txtCardName" aria-label="Name on the Card" aria-required="true">
                                </div>
                                <div class="form-group" style="display:flex;">
                                    <label for="txtCardNumber" title="The credit card number as it appears on the card without dashes">Card Number</label>
                                    <input class="form-control" type="text" id="txtCardNumber" onkeypress="return checkIt(event);" aria-label="Card Number" aria-required="true">
                                </div>
                                <div class="form-group" style="display:flex;">
                                    <label for="ddlCardType" title="The type of card">Credit Card Type</label>
                                    <select class="form-control" id="ddlCardType" role="listbox" aria-label="Credit Card Type" aria-required="true">
                                        <option value="0"></option>
                                        <option value="844060000">Visa</option>
                                        <option value="844060001">Master Card</option>
                                        <option value="844060002">Visa Debit</option>
                                        <option value="844060003">Master Card Debit</option>
                                        <option value="844060004">American Express</option>
                                        <option value="844060005">Diners Club</option>
                                        <option value="844060008">Discover</option>
                                        <option value="844060006">JCB</option>
                                        <option value="844060007">Interact</option>
                                    </select>
                                </div>
                                <div class="form-group" style="display:flex;">
                                    <label for="txtExpiry" title="The expiry date of the credit card in the format of MMYY">Expiry</label>
                                    <input class="form-control" type="text" id="txtExpiry" placeholder="mmyy" maxlength="4" aria-label="Expiry" aria-required="true">
                                </div>
                            </div>
                        </div>
                        <div class="donationBankAccount" style="display:none;">
                            <div class="form-group notExists" style="display:flex;">
                                generate
                                <label for="ddlExistingBank" title="Existing Bank Account">Existing Bank</label>
                                <select class="form-control" id="ddlExistingBank" aria-label="Existing Bank Account" role="listbox">
                                    <option value="0">--Select--</option>
                                </select>
                            </div>
                            <div class="exists">
                                <div class="form-group" style="display:flex;">
                                    <label for="txtBankName" title="The name of the Bank">Bank Name</label>
                                    <input class="form-control" type="text" id="txtBankName" aria-label="Name of the Bank" aria-required="true">
                                </div>
                                <div class="form-group" style="display:flex;">
                                    <label for="txtAccountNumber" title="Bank Account Number">Account Number</label>
                                    <input class="form-control" type="text" id="txtAccountNumber" onkeypress="return checkIt(event);" aria-label="Account Number" aria-required="true">
                                </div>
                                <div class="form-group" style="display:flex;">
                                    <label for="txtRoutingNumber" title="Routing Number">Routing Number</label>
                                    <input class="form-control" type="text" id="txtRoutingNumber" onkeypress="return checkIt(event);" aria-label="Routing Number" aria-required="true">
                                </div>
                                <div class="form-group" style="display:flex;">
                                    <label for="txtBankUserName" title="User Name">Name</label>
                                    <input class="form-control" type="text" id="txtBankUserName" aria-label="Bank User Name" aria-required="true">
                                </div>
                                <div class="form-group" style="display:flex;">
                                    <label for="ddlAccountType" title="Bank Account Type">Account Type</label>
                                    <select class="form-control" id="ddlAccountType" aria-label="Bank Account Type" role="listbox" aria-required="true">
                                        <option value="0">--Select--</option>
                                        <option value="844060000">CHECKING</option>
                                        <option value="844060001">SAVING</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="donatoinRecurring hide">
                            <div class="form-group" style="display:flex;">
                                <label for="txtRecurringStartDate" title="Start Date (mm/dd/yyyy)">Start Date</label>
                                <input class="form-control" type="text" id="txtRecurringStartDate" aria-label="Start Date" aria-required="true">
                                <div class="inputError" style="color: red;"></div>
                            </div>
                            <div class="form-group" style="display:flex;">
                                <label for="txtRecurringEndDate" title="End Date (mm/dd/yyyy)">End Date</label>
                                <input class="form-control" type="text" id="txtRecurringEndDate" aria-label="End Date">
                                <div class="inputError" style="color: red;"></div>
                            </div>
                            <div class="form-group" style="display:flex;">
                                <label for="txtRecurringInstance">Every</label>
                                <input class="form-control" type="text" id="txtRecurringInstance" onkeypress="return isNumber(event)">
                                <select class="form-control" id="ddlRecurringEveryDayType" aria-label="Frequency" role="listbox">
                                    <option value="">--Select--</option>
                                    <option value="844060000">Days</option>
                                    <option value="844060001">Weeks</option>
                                    <option value="844060002">Months</option>
                                    <option value="844060003">Years</option>
                                </select>
                            </div>
                            <div class="form-group" style="display:flex;">
                                <label for="ddlRecurrenceStart">Recurrence Start</label>
                                <select class="form-control" id="ddlRecurrenceStart" disabled="" aria-label="Recurrence Start" role="listbox">
                                    <option value="">--Select--</option>
                                    <option value="844060000">Start Day</option>
                                    <option value="844060001">1st of the Month</option>
                                    <option value="844060002">15th of the Month</option>
                                </select>
                            </div>
                        </div>
                        <div class="donationPledgeSchedule hide">
                            <div class="form-group" style="display:flex;">
                                <label for="txtScheduleStartDate">Start Date</label>
                                <input class="form-control" type="text" id="txtScheduleStartDate" aria-label="Start Date">
                                <div class="inputError" style="color: red;"></div>
                            </div>
                            <div class="form-group" style="display:flex;">
                                <label for="txtScheduleInstance">Over</label>
                                <input class="form-control" type="text" id="txtScheduleInstance" onkeypress="return isNumber(event)">
                                <select class="form-control" id="ddlScheduleEveryDayType" aria-label="Frequency" role="listbox">
                                    <option value="">--Select--</option>
                                    <option value="844060000">Days</option>
                                    <option value="844060001">Weeks</option>
                                    <option value="844060002">Months</option>
                                    <option value="844060003">Years</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group divDepositDate">
                            <label for="txtDepositDate">Deposit Date</label>
                            <input class="form-control" type="text" id="txtDepositDate" aria-label="Deposit Date">
                        </div>
                        <div class="form-group divAmount clearfix">
                            <div class="mandatory" style="display:flex;">
                                <label for="txtAmount">Gift Amount</label>
                                <input class="form-control" type="text" id="txtAmount" onkeypress="return validateFloatKeyPress(this, event)" aria-label="Gift Amount" aria-required="true">
                            </div>
                        </div>
                        <div class="form-group divAmountNonReceiptable clearfix" style="display: none;">
                            <label for="txtAmountNonReceiptable">Fair Market Value</label>
                            <input class="form-control" type="text" id="txtAmountNonReceiptable" onkeypress="return validateFloatKeyPress(this, event)" aria-label="Fair Market Value">
                        </div>
                        <div class="form-group divMembershipFields">
                            <div class="form-group divMembershipAmount">
                                <label for="txtMembershipAmount"><span id="spanAddMembershipButton" class="badge badge-success" tabindex="0" title="Add Membership">Add +</span> Membership Amount</label>
                                <input class="form-control" type="text" id="txtMembershipAmount" disabled="" aria-label="Membership Amount">
                            </div>
                            <div class="form-group divMembershipCommittedAmount" aria-hidden="true" hidden="">
                                <label for="txtMembershipAmountCommitted">Membership Amount</label>
                                <input class="form-control" type="text" id="txtMembershipAmountCommitted" disabled="" aria-label="Membership Amount">
                            </div>
                            <input class="form-control" type="text" id="txtMembershipAmountPaid" hidden="" aria-hidden="true">
                            <input class="form-control" type="text" id="txtMembershipAmountOwing" hidden="" aria-hidden="true">
                            <input class="form-control" type="text" id="txtMembershipAmountBalance" hidden="" aria-hidden="true">
                            <input class="form-control" type="hidden" id="hdnMembershipAmount" aria-hidden="true">
                            <input class="form-control" type="hidden" id="hdnMembershipAmountTax" aria-hidden="true">

                            <div class="form-group divAmountTax" style="display: none;">
                                <label for="txtAmountTax">Amount (Tax)</label>
                                <input class="form-control" type="text" id="txtAmountTax" onkeypress="return validateFloatKeyPress(this, event)" disabled="" aria-label="Amount (Tax)">
                            </div>
                            <div class="form-group divTotalAmount">
                                <label for="txtTotalAmount">Total Amount</label>
                                <input class="form-control" type="text" id="txtTotalAmount" disabled="" aria-label="Total Amount">
                            </div>
                        </div>
                        <div class="form-group pledgeScheduleList hide">
                            <table id="pledgeScheduleTable" class="table stripe hover" style="width: 100%;" role="presentation">
                                <thead>
                                    <tr role="row">
                                        <th style="width: 21% !important;" role="columnheader">
                                            Remove?
                                        </th>
                                        <th class="sorting_asc" style="width: 19% !important;" role="columnheader">
                                            Date
                                        </th>
                                        <th style="width: 19% !important;" role="columnheader">
                                            Amount
                                        </th>
                                        <th style="width: 19% !important;">
                                            Balance
                                        </th>
                                        <th style="width: 19% !important;">
                                            Amount Paid
                                        </th>
                                        <th style="width: 19% !important;" role="columnheader">
                                            Status
                                        </th>
                                        <th style="width: 20% !important;" role="columnheader"><br></th>
                                    </tr>
                                </thead>
                            </table>
                            <input class="form-control float-right main-button" id="btnSavePledgeAllocation" type="button" value="Save Changes" role="button">
                            <input class="form-control float-left main-button" id="btnRegeneratePledge" type="button" value="Regenerate Pledge Allocations >" disabled="" role="button">
                            <label id="lblErrorPledgeTotal" class="errorMsg" role="alert"></label>
                            <br>
                        </div>

                        <div class="form-group divProcess clearfix" style="display: flex;flex-flow: column wrap;align-items: center;">
                            <input class="form-control float-left main-button" id="btnProcess" type="button" value="Process >" role="button">
                        </div>
                        <div class="form-group divRecurringNext hide">
                            <input class="form-control float-left main-button hide" type="button" value="Exclude" id="btnExclude" role="button">
                            <input class="form-control float-left main-button hide" type="button" value="Include" id="btnInclude" role="button">
                            <input class="form-control main-button" id="btnRecurringNext" type="button" value="Next >" role="button">
                        </div>

                    </div>


                    <div class="form-group subsequent-main hide" style="width: 100%;">
                        <div class="form-group cancelDonation-success hide">
                            <label style="color: red;width: 200px;"><b>This donation has been cancelled or archived.</b></label>
                            <br>
                            <b><label id="lblCancelDonationReason" style="color: red;width: 200px;"></label></b>
                            <div id="form-group divUpdateCancelReason" hidden="">
                                <select id="ddlUpdateCancelDonationReason">
                                    <option value="0"></option>
                                </select>
                                <textarea type="text" id="txtUpdateCancelReason"></textarea>
                                <input type="button" id="btnUpdateCancelReason" class="form-control main-button" value="Update">
                                <br><br><br>
                                <label class="lblUpdateCancelReason" style="color: red; font-weight: bold;"></label>
                                <div class="clearfix"></div>
                            </div>
                        </div>
                        <div class="default-subsequent" style="width: 100%;">
                            <div class="form-group subsequent-buttons giftFundTransfer hide">
                                <label class="spanFundTransferedfromGift main-button-lnk"></label>
                            </div>
                            <div class="form-group subsequent-buttons divUpdateDepositDateMain">
                                <div>
                                    <b>
                                        Deposit Date : <input type="button" id="btnDepositDateAll" class="main-button" value="" role="button">
                                    </b>
                                </div>
                                <div id="divUpdateDepositDateAll" class="form-group" style="display:none;">
                                    <input class="" type="text" id="txtNewDepositDateAll" readonly="" style="background: white;">
                                    <input class="main-button" type="button" id="btnUpdateDepositDateAll" value="Update" role="button"><br>
                                    <label id="lblDepositDateAllError" style="display:none;color:red">Please select the Date</label>
                                </div>
                            </div>
                            <div class="form-group subsequent-buttons divUpdateChequeDepositDate">
                                <div class="row" style="width:100%;">
                                    <div class="col-md-4" style="display:flex;">
                                        <label>Check Date</label><input class="form-control main-button" style="margin-top:0.5em; width: 250px;" type="button" id="btnChequeDate" value="" role="button">
                                    </div>
                                    <div class="col-md-4" style="display:flex;">
                                        <label>Deposit Date</label><input class="form-control main-button" style="margin-top:0.5em; width: 250px;" type="button" id="btnDepositDate" value="" role="button">
                                    </div>
                                    <div class="col-md-4" style="display:flex;">
                                        <label>Check Number</label><input class="form-control main-button" style="margin-top:0.5em; width: 250px;" type="button" id="btnChequeNumber" value="" role="button">
                                    </div>
                                </div>
                            </div>
                            <div class="form-group subsequent-buttons mb20">
                                <div id="divUpdateChequeDate" class="form-group" style="display: none;width:440px;">
                                    <input class="form-control" type="text" id="txtNewChequeDate" placeholder="Select a Check Date" readonly="" style="background: white;margin-right: 10px;" aria-label="Select a Check Date">
                                    <input class="form-control main-button" type="button" id="btnUpdateChequeDate" value="Update" role="button">
                                </div>
                                <div id="divUpdateDepositDate" class="form-group" style="display: none;width:440px;">
                                    <input class="form-control" type="text" id="txtNewDepositDate" placeholder="Select a Deposit Date" readonly="" style="background: white;margin-right: 10px;" aria-label="Select a Deposit Date">
                                    <input class="form-control main-button" type="button" id="btnUpdateDepositDate" value="Update" role="button">
                                </div>
                                <div id="divUpdateChequeNumber" class="form-group" style="display: none;width:440px;">
                                    <input class="form-control" type="text" id="txtNewChequeNumber" placeholder="Enter a Check Number" style="margin-left: 0px;margin-right: 10px;" onkeypress="return checkIt(event);" aria-label="Enter a Check Number">
                                    <input class="form-control main-button" type="button" id="btnUpdateChequeNumber" value="Update" role="button">
                                </div>
                            </div>
                            <div class="form-group subsequent-buttons divUpdateWireDepositDate mb20">
                                <div class="form-group">
                                    <b>
                                        Wire Date : <input class="form-control main-button" type="button" id="btnWireDate" value="">
                                        Deposit Date : <input class="form-control main-button" type="button" id="btnWireDepositDate" value="">
                                        Wire Number : <input class="form-control main-button" type="button" id="btnWireNumber" value="">
                                    </b>
                                </div>
                                <div class="form-group" id="divUpdateWireDate" hidden="" aria-hidden="true">
                                    <input class="form-control" type="text" id="txtNewWireDate" readonly="" style="background: white;">
                                    <input class="form-control main-button" type="button" id="btnUpdateWireDate" value="Update">
                                </div>
                                <div class="form-group" id="divUpdateWireDepositDate" hidden="" aria-hidden="true">
                                    <input class="form-control" type="text" id="txtNewWireDepositDate" readonly="" style="background: white;">
                                    <input class="form-control main-button" type="button" id="btnUpdateWireDepositDate" value="Update">
                                </div>
                                <div class="form-group" id="divUpdateWireNumber" hidden="" aria-hidden="true">
                                    <input class="form-control" type="text" id="txtNewWireNumber" onkeypress="return checkIt(event);">
                                    <input class="form-control main-button" type="button" id="btnUpdateWireNumber" value="Update">
                                </div>
                            </div>


                            <div id="divMembershipContainer" class="form-row" style="display:none;margin-left: 0px;">
                                <div class="content-details switch-field" style="padding-left:0px;">
                                    <div class="divSection" id="divGivingRoom" style="display:none; border-bottom-color: #878786;">
                                        <div class="boldCaps">Giving Room</div>
                                        <div class="emptyDiv">&nbsp;</div>
                                        <div class="header2"><span class="spanAmount"></span></div>
                                    </div>
                                    <div class="divSection" id="divLeadership" style="display:none; border-bottom-color: #878786;">
                                        <div class="boldCaps">Leadership Giving Room</div>
                                        <div class="emptyDiv">&nbsp;</div>
                                        <div class="header2"><span class="spanAmount"></span></div>
                                    </div>
                                    <a id="newMembershipToDonation" href="javascript:void(0);" style="text-decoration: none;">
                                        <div class="divSection newMembership" id="divMembership" style="background-image: url('msnfp_/images/SolicitationAdd32');border-bottom-color: #878786;background-size: auto;">
                                            <div class="boldCaps">Membership</div>
                                            <div class="header3"><span class="spanMembership spanHighlighted"></span></div>
                                            <div class="header2"><span class="spanDate"></span></div>
                                        </div>
                                    </a>
                                </div>
                            </div>


                            <div class="form-group divLinkExistingPledgeNull">
                                <div class="form-group">
                                    <label style="width:100%;text-align:left;">Currently this donation is not associated to a pledge:</label>
                                    <br>
                                    <input id="btnLinkNoPledge" class="form-control main-button" style="width:250px;" type="button" value="Link to an existing Pledge >">
                                </div>
                                <div class="error-msg">
                                    <label role="alert" id="errormsg">No related pledge found.</label>
                                </div>
                            </div>
                            <div class="form-group subsequent-buttons divLinkExistingPledge mb20">
                                <div class="form-group">
                                    <b style="float:left;margin-bottom: 10px;">This donation is linked to pledge:</b>
                                    <br>
                                    <label class="spanExistingPledge main-button-lnk"></label>
                                </div>
                                <table>
                                    <tbody>
                                        <tr>
                                            <td style="padding-left: 0px;">
                                                <input class="form-control float-left main-button" style="width:100%;" id="btnRemoveLink" type="button" value="Remove Link >">
                                            </td>
                                            <td>
                                                <input id="btnLinkExistingPledge" class="form-control float-right main-button" style="width:100%;" type="button" value="Link to an different Pledge >">
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="form-group subsequent-buttons refund-donation hide mb20">
                                <div>
                                    <b>This Donation has been successfully processed:</b>
                                </div>
                                <div class="form-group clearfix">
                                    <input class="form-control float-right main-button" id="btnRefundDonation" type="button" value="Refund this Donation >">
                                </div>
                            </div>
                            <div class="form-group subsequent-buttons refund-donation-sucess hide mb20">
                                <div class="form-group">
                                    <b>This Donation has been refunded:</b>
                                </div>
                                <table>
                                    <tbody>
                                        <tr>
                                            <td>
                                                <div class="form-group" style="display:flex;">
                                                    <label style="width:50px;">On</label>
                                                    <input class="form-control" type="text" id="txtRefundSucessOn" value="" disabled="disabled">
                                                </div>
                                            </td>
                                            <td>
                                                <div class="form-group" style="display:flex;">
                                                    <label>Refund Amount</label>
                                                    <input class="form-control" type="text" id="txtRefundSuccessAmount" value="" disabled="disabled">
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="form-group subsequent-buttons recurringDonation-success hide mb20">
                                <div class="form-group divNextDonation">
                                    <div class="form-group" style="display:flex;">
                                        <b style="width:200px; text-align: right; margin-right: 10px;">Next donation will be taken on</b>
                                        <input class="form-control main-button" type="button" id="btnRecurringNextDonation" value="">
                                        <b style="margin-right: 5px;margin-top: 6px;">for</b>
                                        <input class="form-control main-button" type="button" id="btnRecurringNextDonationAmount" value="">
                                        <input class="form-control main-button" type="button" id="btnRecurringChargeDonationNow" value="Charge this Donation Now >">
                                    </div>
                                    <div class="form-group" style="display:flex;">
                                        <div class="form-group" id="divUpdateNextRecurringDate" style="display:none;">
                                            <input class="form-control" type="text" placeholder="Next Date" id="txtNextRecurringDate" readonly="" style="background: white;display:inline;width:45%;">
                                            <input class="form-control main-button" type="button" style="display:inline;width:45%;" id="btnUpdateNextRecurringDate" value="Update"><br>
                                            <label id="lblNextDateError" style="display:none;color:red">Please select the Date</label>
                                        </div>
                                        <div class="form-group" id="divUpdateNextRecurringAmount" style="display:none;">
                                            <input class="form-control" type="text" placeholder="Recurring Amount" id="txtNextRecurringAmount" style="display:inline;width:45%;" onkeypress="return validateFloatKeyPress(this, event);">
                                            <input class="form-control main-button" style="display:inline;width:45%;" type="button" id="btnUpdateNextRecurringAmount" value="Update"><br>
                                            <label id="lblNextRecurringAmountError" style="display:none;color:red">Please select the Amount</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group recurringDonation-last hide mb20">
                                <div class="recurringDonationLastList">
                                </div>
                                <div class="form-group" style="text-align:right;">
                                    <input class="main-button" id="btnRecurringCancelDonation" type="button" value="Cancel This Donation >">
                                </div>
                            </div>
                            <div class="form-group subsequent-buttons clearfix">
                                <label for="emailReceipt" style="display: none !important;"><b>Email Receipt To</b></label>
                                <input type="text" class="form-control float-right" id="emailReceipt" style="display: none !important;margin-right: 5px; width: 425px;">
                            </div>

                            <div class="row">
                                <div class="col-sm-4" style="padding-left: 0px;">
                                    <input class="form-control main-button" style="width:110px" type="button" id="btnPrintReceipt" value="Print Receipt">
                                </div>
                                <div class="col-sm-4" style="padding-left: 0px;">
                                    <input class="form-control main-button" style="width:135px" type="button" id="btnThankyou" value="Print Thank You">
                                </div>
                            </div>

                        </div>

                        <div class="form-group existing-pledge hide">
                            <table id="searchResult" class="table table-striped table-bordered">
                                <thead>
                                    <tr>
                                        <th></th>
                                        <th>Date</th>
                                        <th style="min-width:250px;">Installment</th>
                                        <th>Amount</th>
                                        <th>Balance</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                            <div class="subsequent-buttons clearfix" style="padding-top:5px;">
                                <input id="btnComplete" class="float-right main-button" type="button" value="Complete">
                            </div>
                            <div class="error-msg">
                                Please select donation.
                            </div>
                        </div>

                        <div class="form-group refund-donation-process hide">
                            <div class="mb20 hide">
                                <input class="form-control" type="text" disabled="disabled" id="txtRefundFailed">
                            </div>
                            <div class="form-group mb20">
                                Refund Type
                                <select class="form-control" id="selectRefundType" disabled="disabled"></select>
                            </div>
                            <div class="form-group mb20 hide">
                                <label class="spnChequeNumberRefund hide">Check Number</label>
                                <label class="spnWireNumberRefund hide">Wire Number</label>
                                <input class="form-control" type="text" id="txtChequeNumberRefund" disabled="disabled">
                            </div>
                            <div class="form-group mb20">
                                Confirmed Amount
                                <input class="form-control" type="text" id="txtConfirmedAmount" disabled="disabled">
                                <input class="form-control float-right main-button" id="btnProcessRefund" type="button" value="Process Refund">
                            </div>
                        </div>

                        <div class="form-group cancelDonation hide">
                            <div class="form-group" style="display:flex;">
                                <label for="ddlCancelDonationReason">Reason</label>
                                <select class="form-control" id="ddlCancelDonationReason">
                                    <option value=""></option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="txtCancelDonationNote">Note</label>
                                <textarea id="txtCancelDonationNote"></textarea>
                            </div>
                            <div class="error-msg-cancel hide" style="color: red; font-weight: bold;"></div>
                            <div class="form-group" style="display:flex;">
                                <input type="button" id="btnCancelDonation" class="form-control main-button" value="Cancel This Donation">
                                <input type="button" id="btnCancelDonationBack" class="form-control main-button" value="Back">
                            </div>
                        </div>
                    </div>

                    <div class="form-group msg-div">
                        <!--Bootstrap error message--->
                        <div id="divErrorMessageContainer" style="display:none; margin-left:10px;" class="alert alert-danger">
                            <strong>Error:</strong> <label id="lblErrorMessageText" class="errorMSG" role="alert"></label>
                        </div>

                        <!--Legacy Ways to display errors, to be transitioned to the above-->
                        <div class="error-msg"></div>
                        <div class="form-group payment-failed-msg hide">
                            <label class="field-label errorMsg">Payment Failed</label>
                            <label id="payment-failed-block"></label>
                            <div class="clearfix">
                                <input class="form-control float-right main-button" id="btnTryAgain" type="button" value="Try Again >">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        console.debug("msnfp_ManualDonation_PaymentSchedule.html");

        const relatedDonationFields = ["msnfp_AppealId", "msnfp_PackageId", "msnfp_DesignationId"];

        var DonationPledgeType =
        {
            Donation: 84406000,
            Pledge: 844060002,
            PledgeSchedule: 844060005,
            Grant: 844060001,
            MatchedGiftDonation: 844060009,
            MatchedGiftPledge: 844060010,
            RecurringDonation: 844060003,
            SoftCreditDonation: 844060006,
            SoftCreditPledge: 844060007,
            Membership: 844060008
        }

        var DonationPledgeTypeForm = {
            Donation: 1,
            Grant: 2,
            Pledge: 3,
            SoftCredit: 4,
            RecurringDonation: 5,
            PledgeSchedule: 6,
            Membership: 8
        }

        var DonationOccurrence = {
            PostDated: 84406000,
            Recurring: 84406001,
            Instant: 84406002
        }

        var PaymentType = {
            Cash: 844060000,
            Cheque: 844060001,
            CreditDebit: 844060002,
            Bank: 844060003,
            InKind: 844060004,
            Gift: 844060005,
            Stock: 844060006,
            Property: 844060007,
            Other: 844060008,
            WireTransfer: 844060009,
            DirectDebit: 844060010,
            FundTrasfer: 844060011,
            ExternalCreditDebit: 844060012
        }


        var RecurrenceStart = {
            CurrentDay: 844060000,
            FirstOftheMonth: 844060001,
            FifteenoOftheMonth: 844060002
        }

        var MembershipDuration = {
            Lifetime: { value: 844060008, name: "Lifetime" },
            Year10: { value: 844060007, name: "10 Years" },
            Year5: { value: 844060006, name: "5 Years" },
            Year4: { value: 844060005, name: "4 Years" },
            Year3: { value: 844060004, name: "3 Years" },
            Month24: { value: 844060003, name: "24 Month" },
            Month12: { value: 844060002, name: "12 Month" },
            Month6: { value: 844060001, name: "6 Month" },
            Month3: { value: 844060000, name: "3 Month" },
            NotApplicable: { value: 844060009, name: "Not Applicable" }
        };

        var Anonymity = {
            No: 844060000,
            Yes: 844060001
        };

        var xrm;
        var formType;
        var currentID;
        var selectedDonor = null;
        var userSettings;
        var donorId = null;
        var donationPledge = [];
        var selectedConstitute = null;
        var constituteId = null;
        var campaignEventID = null;
        var primaryDesignationID = null;
        var psAppealID = null;
        var psPackageID = null;
        var cardExists = false;
        var bankExists = false;

        //Refund
        var customerId;// = getLookupGuid('msnfp_customerid');
        var existingPledgeLoaded = false;
        var relatedPledgeId;
        var noResult = false;

        //14.	Recurring Donations
        var nextDonationDate;
        var relatedDonationId;
        var relatedDonationEntity;
        var createRelatedEntity = false;

        //Pledge Schedule
        var searchTable;
        var isActive = false;
        var configRecord = null;
        var select = "";
        var expand = "";
        var filter = "";

        var bankid;
        var cardid;
        var parentGiftID;
        var parentTypeWhenTransferGiftAmount;
        var parentGiftAmount;
        var cancelReasonOptions = [];
        var currencySymbol = "";
        var isoCurrencyCode;
        var isIncludeMembership;
        var clickedIncludeOrExcludeMembership = false;
        var finalAmount = 0;
        var selectedMembershipAmount = 0;
        var isAmexCard = false;
        var userConfigID = null;
        // The membership instance used on this donation. This will be assigned to child donations (if applicable):
        var membershipInstanceID;

        // Modal content starts here. Note that modal is used for the Membership section.
        // Get the Membership Modal:
        var membershipModal = document.getElementById("membershipModal");
        var PledgeScheduleModal = document.getElementById("PledgeScheduleModal");

        // Get the <span> element that closes the modal:
        var closeButtonSpan = document.getElementsByClassName("closeBtn")[0];
        var closeButtonSpanPledge = document.getElementsByClassName("closeBtn")[1];

        // When the user clicks on <span> (x), close the modal:
        closeButtonSpan.onclick = function () {
            membershipModal.style.display = "none";
        }
        closeButtonSpanPledge.onclick = function () {
            PledgeScheduleModal.style.display = "none";
            $('#pledgeScheduleTableModal').DataTable().clear();
            $('#pledgeScheduleTableModal').DataTable().destroy();

        }

        // When the user clicks anywhere outside of the modal, close it:
        window.onclick = function (event) {
            if (event.target == membershipModal) {
                membershipModal.style.display = "none";
            }
            if (event.target == PledgeScheduleModal) {
                PledgeScheduleModal.style.display = "none";
                $('#pledgeScheduleTableModal').DataTable().clear();
                $('#pledgeScheduleTableModal').DataTable().destroy();
            }
        }

        // Modal content ends here.

        $(document).ready(function () {

            jQuery.ajax({
                url: `${parent.Xrm.Page.context.getClientUrl()}/api/data/v9.1/usersettingscollection(${MissionFunctions.GetCurrentUserID()})`,
                success: function (result) {
                    userSettings = result;
                },
                async: false
            });

            // First, setup all the datepickers:
            $("#txtNextRecurringDate").datepicker({
                dateFormat: 'mm/dd/yy',
                minDate: 0
            });

            $("#txtRecurringStartDate").datepicker({
                dateFormat: 'mm/dd/yy',
                minDate: 0
            });

            $('#txtRecurringEndDate').datepicker({
                dateFormat: 'mm/dd/yy',
                minDate: 0
            });

            $('#txtScheduleStartDate').datepicker({
                dateFormat: 'mm/dd/yy',
                minDate: 0
            });

            $('#txtChequeDate').datepicker({
                dateFormat: 'mm/dd/yy',
            });

            $('#txtDepositDate').datepicker({
                dateFormat: 'mm/dd/yy',
            });

            $('#txtNewChequeDate').datepicker({
                dateFormat: 'mm/dd/yy',
            });

            $('#txtNewDepositDate').datepicker({
                dateFormat: 'mm/dd/yy',
            });

            $('#txtNewWireDate').datepicker({
                dateFormat: 'mm/dd/yy',
            });

            $('#txtNewWireDepositDate').datepicker({
                dateFormat: 'mm/dd/yy',
            });

            $('#txtNewDepositDateAll').datepicker({
                dateFormat: 'mm/dd/yy',
            });

            xrm = XrmUtility.get_Xrm();
            formType = parent.Xrm.Page.ui.getFormType();

            // Fill in the date field for new gifts to now:
            if (formType == FormType.Create)
                parent.Xrm.Page.getAttribute('msnfp_bookdate').setValue(new Date());

            // Current ID of the gift page we are on:
            currentID = parent.Xrm.Page.data.entity.getId().replace('{', '').replace('}', '');
            customerId = getLookupGuid('msnfp_customerid');

            // Get cancellation reasons and put them into the drop down:
            cancelReasonOptions = parent.Xrm.Page.getAttribute('msnfp_cancelationcode').getOptions();
            $('#ddlCancelDonationReason').find('option').remove().end().append('<option value="0">--Select--</option>');

            $.each(cancelReasonOptions, function (i, item) {
                $('#ddlCancelDonationReason').
                    append($('<option>',
                        {
                            value: this.value,
                            text: this.text
                        }));
            });

            $('#ddlUpdateCancelDonationReason').find('option').remove().end().append('<option value="0">--Select--</option>');

            $.each(cancelReasonOptions, function (i, item) {
                $('#ddlUpdateCancelDonationReason').
                    append($('<option>',
                        {
                            value: this.value,
                            text: this.text
                        }));
            });

            var currentuserID = MissionFunctions.GetCurrentUserID();

            console.log("currentuserID: " + currentuserID);

            var userSelect = "systemusers?$select=systemuserid,_msnfp_configurationid_value"
            userSelect += "&$filter=systemuserid eq " + currentuserID;
            var user = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + userSelect);
            user = user[0];


            getCurrencySymbol();

            // Initialize money fields as 0.00:
            $('#txtMembershipAmount').val(currencySymbol + '0.00');
            $('#txtMembershipAmountCommitted').val(currencySymbol + '0.00');
            $('#txtAmountNonReceiptable').val(currencySymbol + '0.00');
            $('#txtAmountTax').val(currencySymbol + '0.00');
            $('#txtTotalAmount').val(currencySymbol + '0.00');


            // If the configuration record is found for the user, show/hide several fields:
            if (!isNullOrUndefined(user._msnfp_configurationid_value)) {
                userConfigID = user._msnfp_configurationid_value;
                loadConfiguration(user._msnfp_configurationid_value);

                // Show the correct payment info as Donation is NOT an option so we must change it immediately:
                paymentTypeChange();
                donationPledgeTypechange();
                showHidePaymentType(configRecord);

                if (isNullOrUndefined(configRecord.msnfp_tran_anonymous) || configRecord.msnfp_tran_anonymous == false) {
                    $('#radioVisibleDonation').next('label').remove();
                    $('#radioVisibleDonation').remove();
                    $('#radioAnonymous').next('label').remove();
                    $('#radioAnonymous').remove();
                }

                if (!isNullOrUndefined(configRecord.msnfp_tran_showamounttax) && configRecord.msnfp_tran_showamounttax == true) {
                    $('.divAmountTax').css("display", "flex");
                }

                $('#ddlRecurrenceStart').val(configRecord.msnfp_sche_recurrencestart);

                if (!isNullOrUndefined(configRecord.msnfp_tran_membership) && configRecord.msnfp_tran_membership) {
                    $('#newMembershipToDonation').show();
                    $('#divMembership').show();
                }
                else {
                    $('#newMembershipToDonation').hide();
                    $('#divMembership').hide();
                }

                customerChange();
            }

            // Populate fields with existing data in the evenet of an existing record:
            if (formType === FormType.Update || formType === FormType.Disabled || formType === FormType.ReadOnly) {
                loadDonationPledge();
            }

            showHideControlsAndLabelChange();

            // Bind the inputs to their respective function calls:
            $('input[name=donationPledgeType]').change(function () {
                donationPledgeTypechange();
            });

            $('input[name=paymentType]').change(function () {
                paymentTypeChange();
            });

            $('input[name=anonymousDonation]').change(function () {
                manageTab(this);
                var selectedVal = $('input[name=anonymousDonation]:checked').val();
                if (selectedVal == Anonymity.Yes) {
                    parent.Xrm.Page.getAttribute("msnfp_customerid").setRequiredLevel("none");
                    parent.Xrm.Page.getAttribute("msnfp_constituentid").setRequiredLevel("none");
                }
                else {
                    parent.Xrm.Page.getAttribute("msnfp_customerid").setRequiredLevel("required");
                }
            });

            $('input[name=giftSource]').change(function () {
                manageTab(this);
            });

            $('#ddlExistingBank').change(function () {
                if ($(this).val() == '-1') {
                    $('.donationBankAccount .exists').show();
                    $('.manual-main .error-msg').hide();
                    $('.manual-main .error-msg').html('');
                }
                else if ($(this).val() != "0") {
                    $('.manual-main .error-msg').hide();
                    $('.manual-main .error-msg').html('');
                    $('.donationBankAccount .exists').hide();
                }
                else if ($(this).val() == "0") {
                    $('.manual-main .error-msg').hide();
                    $('.manual-main .error-msg').html('');
                }


                addRemoveBankValidation();
            });

            $('#ddlExistingCard').change(function () {

                console.log("$(this).val() == '-1' == " + $(this).val());
                console.log(($(this).val() == '-1' || $(this).val() == -1));

                if ($(this).val() == '-1') {
                    $('.donationCreditCard .exists').show();
                    $('.manual-main .error-msg').hide();
                    $('.manual-main .error-msg').html('');
                }
                else if ($(this).val() != "0") {
                    $('.manual-main .error-msg').hide();
                    $('.manual-main .error-msg').html('');
                    console.log("Hide card fields");
                    $('.donationCreditCard .exists').hide();
                }
                else if ($(this).val() == "0") {
                    $('.manual-main .error-msg').hide();
                    $('.manual-main .error-msg').html('');
                }

                addRemoveCardValidation();
            });



            // When the final process button is clicked, validate the data and save/update:
            $('#btnProcess').click(function () {
                $('.manual-main .error-msg').hide();
                //$('#lblErrorMessageText')[0].innerText = '';
                $('#lblErrorMessageText').html('');
                $("#divErrorMessageContainer").hide();
                // Validate fields (moved to validate function):
                if (validate()) {
                    var paymentType = $('input[name=paymentType]:checked').val();
                    var selectedType = parseInt($('input[name=donationPledgeType]:checked').val());

                    xrm.Utility.showProgressIndicator("Processing Transaction");

                    var attributes = parent.Xrm.Page.data.entity.attributes.get();
                    var entity = MissionFunctions.GetEntityLookups(msnfp_entity_lookups);

                    var anonymity = parseInt($('input[name=anonymousDonation]:checked').val());
                    entity['msnfp_anonymity'] = anonymity;

                    if (parent.Xrm.Page.getAttribute("msnfp_name").getValue() == null) {
                        var namePrefix = "Recurring";
                        if (selectedType == DonationPledgeTypeForm.PledgeSchedule)
                            namePrefix = "Pledge";

                        parent.Xrm.Page.getAttribute("msnfp_name").setValue(namePrefix + " - " + RandomGuid().substring(0, 6).toUpperCase());
                    }

                    entity["msnfp_name"] = parent.Xrm.Page.getAttribute("msnfp_name").getValue();

                    var giftAmount = parseFloat($('#txtAmount').val().replace(currencySymbol, '').replace(/[^\d\.\-]/g, ""));
                    entity["msnfp_amount_receipted"] = giftAmount;
                    entity["msnfp_bookdate"] = DSTOffsetYYYYMMDD(parent.Xrm.Page.getAttribute("msnfp_bookdate").getValue());

                    if ($('#ddlCardType').val() > 0) {
                        entity["msnfp_ccbrandcode"] = parseInt($('#ddlCardType').val());
                    }

                    if (!isNullOrUndefined($('#txtDepositDate').val())) {
                        entity["msnfp_depositdate"] = DSTOffsetYYYYMMDD($('#txtDepositDate').val());
                    }

                    // Save the configuration to the gift from the user:
                    if (!isNullOrUndefined(userConfigID)) {
                        entity["msnfp_ConfigurationId@odata.bind"] = "/msnfp_configurations(" + userConfigID + ")";
                    }

                    // Amount - Not Receiptable:
                    var nonReceiptableAmount = 0;
                    if (!isNullOrUndefined($('#txtAmountNonReceiptable').val())) {
                        nonReceiptableAmount = parseFloat($('#txtAmountNonReceiptable').val().replace(currencySymbol, '').replace(/[^\d\.\-]/g, ""));
                        entity["msnfp_amount_nonreceiptable"] = nonReceiptableAmount;
                    }

                    // Amount - Tax:
                    var amountTax = 0;
                    if (!isNullOrUndefined($('#txtAmountTax').val())) {
                        //amountTax = parseFloat($('#txtAmountTax').val());
                        //entity["msnfp_amount_tax"] = parseFloat($('#txtAmountTax').val());

                        amountTax = parseFloat($('#txtAmountTax').val().replace(currencySymbol, '').replace(/[^\d\.\-]/g, ""));
                        entity["msnfp_amount_tax"] = amountTax;
                    }

                    // Amount - Membership:
                    //var membershipAmount = !isNullOrUndefined($('#txtMembershipAmountCommitted').val()) ? parseFloat($('#txtMembershipAmountCommitted').val()) : 0;
                    var membershipAmount = !isNullOrUndefined($('#hdnMembershipAmount').val()) ? parseFloat($('#hdnMembershipAmount').val().replace(currencySymbol, '').replace(/[^\d\.\-]/g, "")) / 12 : 0;

                    if (membershipAmount <= amountTax) {
                        entity["msnfp_amount_membership"] = 0;
                    }
                    else {
                        entity["msnfp_amount_membership"] = membershipAmount;//+ amountTax; //here memberhsipAmount is Base Cost of Membership
                    }

                    // Total Header:
                    if (!isNullOrUndefined(parentGiftID)) {
                        entity["msnfp_recurringamount"] = 0;
                    }
                    else {
                        if (membershipAmount > 0) {
                            entity["msnfp_recurringamount"] = giftAmount + membershipAmount + nonReceiptableAmount;
                        }
                        else {
                            entity["msnfp_recurringamount"] = giftAmount + nonReceiptableAmount + amountTax;
                        }
                    }

                    console.log('entity["msnfp_recurringamount"] = ' + entity["msnfp_recurringamount"]);

                    for (var i in attributes) { attributes[i].setSubmitMode("never"); }

                    if (!isNullOrUndefined(relatedDonationId)) {
                        createRelatedDonation();
                        return;
                    }

                    // Get the payment processor from the config file:
                    if (configRecord._msnfp_paymentprocessorid_value != null) {
                        entity["msnfp_PaymentProcessorId@odata.bind"] = "/msnfp_paymentprocessors(" + XrmUtility.CleanGuid(configRecord._msnfp_paymentprocessorid_value) + ")";
                    }

                    // Assign the contact/account:
                    var anonymousDonation = $('input[name=anonymousDonation]:checked').val();
                    if (anonymousDonation == Anonymity.Yes && (selectedDonor == null || selectedDonor.length == 0)) {
                        var anonymousContactId = createAnonymousContact();

                        if (isNullOrUndefined(anonymousContactId))
                            return;

                        entity["msnfp_CustomerId_contact@odata.bind"] = "/contacts(" + anonymousContactId + ")";
                        selectedDonor = {
                            contactid: anonymousContactId,
                            isAccount: false,
                            Name: ($('#txtFirstName').val() + ' ' + $('#txtLastName').val())
                        };
                    }
                    else if (selectedDonor != null) {
                        if (selectedDonor.isAccount) {
                            entity["msnfp_CustomerId_account@odata.bind"] = "/accounts(" + selectedDonor.accountid + ")";
                        }
                        else {
                            entity["msnfp_CustomerId_contact@odata.bind"] = "/contacts(" + selectedDonor.contactid + ")";
                        }
                    }

                    // Assign the constitute, campaign and fund (if applicable):
                    let cons = getConstituent();
                    if (cons) entity["msnfp_ConstituentId@odata.bind"] = cons;

                    // Campaign:
                    campaignEventID = XrmUtility.CleanGuid(parent.Xrm.Page.data.entity.attributes.get("msnfp_originatingcampaignid").getValue()[0].id);
                    //if (!isNullOrUndefined(campaignEventID)) {
                    //    entity["msnfp_OriginatingCampaignId@odata.bind"] = "/campaigns(" + campaignEventID + ")";
                    //}
                    //else {
                    //    entity["msnfp_OriginatingCampaignId"] = null;
                    //}

                    //// Primary Designation:
                    //if (parent.Xrm.Page.data.entity.attributes.get("msnfp_designationid").getValue() != null) {
                    //    primaryDesignationID = XrmUtility.CleanGuid(parent.Xrm.Page.data.entity.attributes.get("msnfp_designationid").getValue()[0].id);
                    //    if (!isNullOrUndefined(primaryDesignationID)) {
                    //        entity["msnfp_DesignationId@odata.bind"] = "/msnfp_designations(" + primaryDesignationID + ")";
                    //    }
                    //    else {
                    //        entity["msnfp_DesignationId"] = null;
                    //    }
                    //}
                    //else {
                    //    entity["msnfp_DesignationId"] = null;
                    //}


                    //// Appeal ID:
                    //if (!isNullOrUndefined(parent.Xrm.Page.data.entity.attributes.get("msnfp_appealid").getValue())) {
                    //    var appealID = XrmUtility.CleanGuid(parent.Xrm.Page.data.entity.attributes.get("msnfp_appealid").getValue()[0].id);
                    //    if (!isNullOrUndefined(appealID)) {
                    //        entity["msnfp_AppealId@odata.bind"] = "/msnfp_appeals(" + appealID + ")";
                    //    }
                    //}

                    //// Package ID:
                    //if (!isNullOrUndefined(parent.Xrm.Page.data.entity.attributes.get("msnfp_packageid").getValue())) {
                    //    var packageID = XrmUtility.CleanGuid(parent.Xrm.Page.data.entity.attributes.get("msnfp_packageid").getValue()[0].id);
                    //    if (!isNullOrUndefined(packageID)) {
                    //        entity["msnfp_PackageId@odata.bind"] = "/msnfp_packages(" + packageID + ")";
                    //    }
                    //}

                    // Recurring specific tasks:
                    if (selectedType == DonationPledgeTypeForm.RecurringDonation) {

                        if (parent.Xrm.Page.data.entity.attributes.get("msnfp_chargeoncreate").getValue() != null) {
                            if (formType == FormType.Create && parent.Xrm.Page.data.entity.attributes.get("msnfp_chargeoncreate").getValue() == true && paymentType != PaymentType.Bank) {
                                createRelatedEntity = true;
                            }
                            else if (formType == FormType.Create && (parent.Xrm.Page.data.entity.attributes.get("msnfp_chargeoncreate").getValue() != true || paymentType == PaymentType.Bank)) {
                                createRelatedEntity = false;
                            }
                        }

                        var startDate = new Date($('#txtRecurringStartDate').val());

                        if (startDate == null) {
                            console.log("Could not find recurring start date on save, setting to todays date.");
                            startDate = new Date();
                        }

                        var str1 = getFormattedDate(startDate);
                        str1 = str1.split('/');
                        entity["msnfp_firstpaymentdate"] = str1[2] + '-' + str1[0] + '-' + str1[1];

                        console.log("msnfp_firstpaymentdate = " + entity["msnfp_firstpaymentdate"]);

                        if (!isNullOrUndefined($('#txtRecurringEndDate').val()))
                            entity["msnfp_endondate"] = resetTimeZoneOffset($('#txtRecurringEndDate').val());
                        else
                            entity["msnfp_endondate"] = null;

                        entity["msnfp_frequencyinterval"] = parseInt($('#txtRecurringInstance').val());
                        entity["msnfp_frequency"] = $('#ddlRecurringEveryDayType').val();

                        entity["msnfp_chargeoncreate"] = parent.Xrm.Page.data.entity.attributes.get("msnfp_chargeoncreate").getValue();

                        // Do not charge on create of a Bank transaction EVER. This is done by the Bank Run:
                        if (paymentType == PaymentType.Bank) {
                            entity["msnfp_chargeoncreate"] = false;
                        }

                        entity["statuscode"] = 1;
                        entity["msnfp_frequencystartcode"] = $('#ddlRecurrenceStart').val();

                        if (!isNullOrUndefined(isIncludeMembership) && !isNullOrUndefined(selectedMembershipAmount) && clickedIncludeOrExcludeMembership) {
                            //var membershipAmount = !isNullOrUndefined($('#txtMembershipAmountCommitted').val()) ? parseFloat($('#txtMembershipAmountCommitted').val()) : 0;
                            var devidedAmount = selectedMembershipAmount / 12;

                            if (isIncludeMembership) {
                                //entity["msnfp_amount_membership"] = devidedAmount;
                                entity["msnfp_recurringamount"] = giftAmount + devidedAmount;
                            }
                            else {
                                //entity["msnfp_amount_membership"] = devidedAmount;
                                entity["msnfp_recurringamount"] = giftAmount + devidedAmount;
                            }
                        }
                        else if (isNullOrUndefined(entity["msnfp_recurringamount"])) {
                            entity["msnfp_recurringamount"] = giftAmount;
                        }

                        entity = updateLastDonationDateFromIframe(entity, true);

                        // After the date is configured, we see if we need to change it to the start date if it is not being created now.
                        var currentDate = getFormattedDate(new Date());
                        var sDt = getFormattedDate(startDate);

                        if (sDt > currentDate) {
                            startDate = startDate.getUTCFullYear() + '-' + (startDate.getUTCMonth() + 1) + '-' + startDate.getUTCDate();
                            entity["msnfp_nextpaymentdate"] = new Date(new Date(sDt).getFullYear(), new Date(sDt).getMonth(), new Date(sDt).getDate(), 12);

                            // Do not create the related donation now as we haven't hit the start date:
                            createRelatedEntity = false;
                        }

                        let nextDonation = DSTOffsetYYYYMMDD(new Date(entity["msnfp_nextpaymentdate"]));
                        //entity["msnfp_nextpaymentdate"] = new Date(new Date(nextDonation).getFullYear(), new Date(nextDonation).getMonth(), new Date(nextDonation).getDate(), 12);
                        entity["msnfp_nextpaymentdate"] = nextDonation;
                        console.log("entity['msnfp_nextpaymentdate'] = " + entity["msnfp_nextpaymentdate"]);
                    }
                    else if (selectedType == DonationPledgeTypeForm.PledgeSchedule) {
                        var str1 = getFormattedDate(new Date($('#txtScheduleStartDate').val()));
                        str1 = str1.split('/');
                        entity["msnfp_firstpaymentdate"] = str1[2] + '-' + str1[0] + '-' + str1[1];

                        entity["msnfp_frequencyinterval"] = parseInt($('#txtScheduleInstance').val());
                        entity["msnfp_frequency"] = $('#ddlScheduleEveryDayType').val();
                        entity["msnfp_recurringamount"] = giftAmount + nonReceiptableAmount + amountTax;
                    }


                    if ($('input[name=giftSource]:checked').val() != undefined) {
                        entity["msnfp_dataentrysource"] = $('input[name=giftSource]:checked').val();
                    }

                    if ($('input[name=receiptPreference]:checked').val() != undefined) {
                        entity["msnfp_receiptpreferencecode"] = $('input[name=receiptPreference]:checked').val();
                    }

                    entity["msnfp_firstname"] = $('#txtFirstName').val();
                    entity["msnfp_lastname"] = $('#txtLastName').val();
                    entity["msnfp_organizationname"] = $('#txtOrganization').val();
                    entity["msnfp_emailaddress1"] = $('#txtEmail').val();
                    entity["msnfp_telephone1"] = $('#txtPhone').val();
                    entity["msnfp_telephone2"] = $('#txtAltPhone').val();
                    entity["msnfp_mobilephone"] = $('#txtMobilePhone').val();
                    entity["msnfp_billing_line1"] = $('#txtAddressLine1').val();
                    entity["msnfp_billing_line2"] = $('#txtAddressLine2').val();
                    entity["msnfp_billing_line3"] = $('#txtAddressLine3').val();
                    entity["msnfp_billing_city"] = $('#txtAddressCity').val();
                    entity["msnfp_billing_stateorprovince"] = $('#txtAddressProvince').val();
                    entity["msnfp_billing_postalcode"] = $('#txtAddressPostalCode').val();
                    entity["msnfp_billing_country"] = $('#txtAddressCountry').val();

                    // Add a membership if applicable:
                    if (!isNullOrUndefined(parent.Xrm.Page.getAttribute("msnfp_membershipcategoryid").getValue())) {
                        entity["msnfp_MembershipCategoryId@odata.bind"] = "/msnfp_membershipcategories(" + XrmUtility.CleanGuid(parent.Xrm.Page.data.entity.attributes.get("msnfp_membershipcategoryid").getValue()[0].id) + ")";
                    }

                    if (selectedType == DonationPledgeTypeForm.RecurringDonation) {
                        entity["msnfp_scheduletypecode"] = 844060003;
                    }
                    else if (selectedType == DonationPledgeTypeForm.PledgeSchedule) {
                        entity["msnfp_scheduletypecode"] = 844060005;
                    }


                    // Set the status code to complete on save if it is not one of these payment types:
                    if (selectedType != DonationPledgeTypeForm.PledgeSchedule && paymentType != PaymentType.Bank && paymentType != PaymentType.CreditDebit) {
                        entity["statuscode"] = parseInt(844060000);
                    }

                    entity["msnfp_paymenttypecode"] = parseInt(paymentType);

                    // Save/Create the credit card if necessary:
                    if (paymentType == PaymentType.CreditDebit && selectedType != DonationPledgeTypeForm.PledgeSchedule) {
                        cardid = saveCreditCardDetails();
                        console.log("CCId- " + cardid);
                        // Then link it to this record:
                        if (cardid != null) {
                            entity["msnfp_PaymentMethodId@odata.bind"] = "/msnfp_paymentmethods(" + cardid + ")";
                        }
                        else {
                            $('#lblErrorMessageText').append('<p>An error occured while saving Credit Card.</p>');
                            $("#divErrorMessageContainer").show();
                            // $(this).addClass('red-border');

                            // alert('Error credit card save');
                            return;
                        }
                    }
                    // Save/Create the bank account if necessary:
                    else if (paymentType == PaymentType.Bank) {
                        bankid = saveBankDetails(paymentType);
                        if (bankid != null) {
                            entity["msnfp_PaymentMethodId@odata.bind"] = "/msnfp_paymentmethods(" + bankid + ")";
                        }
                        else {
                            //alert('An error has occured when saving the bank details.');
                            $('#lblErrorMessageText').append('<p>An error occured while saving Bank details.</p>');
                            $("#divErrorMessageContainer").show();
                            // $(this).addClass('red-border');
                            return;
                        }
                    }

                    // If we are doing a recurring donation in the saveSuccess method, we save all the fields to that relatedDonationEntity record:
                    if (createRelatedEntity == true) {
                        relatedDonationEntity = entity;
                    }

                    console.log('entity["msnfp_recurringamount"] = ' + entity["msnfp_recurringamount"]);

                    // Now either create or update this gift record:
                    if (isNullOrUndefined(currentID)) {
                        var qry = XrmServiceUtility.GetWebAPIUrl() + "msnfp_paymentschedules";
                        XrmServiceUtility.CreateRecordAsync(qry, entity, saveSuccess, errorFailure);
                    }
                    else {
                        var qry = XrmServiceUtility.GetWebAPIUrl() + "msnfp_paymentschedules(" + currentID + ")";
                        XrmServiceUtility.UpdateRecordAsync(qry, entity, saveSuccess, errorFailure);
                    }
                }
                else {
                    //alert("Please Complete all Mandatory Fields Prior to Processing a Gift");
                    $('#lblErrorMessageText').append('<p>Please Complete all Mandatory Fields Prior to Processing a Gift</p>');
                    $("#divErrorMessageContainer").show();
                }
            });

            $('#btnExclude').click(function () {
                isIncludeMembership = false;
                clickedIncludeOrExcludeMembership = true;

                var giftAmount = finalAmount;
                var devidedAmount = 0;

                if (!isNullOrUndefined(selectedMembershipAmount))
                    devidedAmount = selectedMembershipAmount / 12;

                $('#txtAmount').val(currencySymbol + addCommasonLoad(parseFloat(finalAmount).toFixed(2)));
                //$('#txtTotalAmount').val((giftAmount + devidedAmount).toFixed(2));
                $('#txtTotalAmount').val(currencySymbol + addCommasonLoad(parseFloat(giftAmount + devidedAmount).toFixed(2)));
                //$('#txtMembershipAmountCommitted').val(devidedAmount.toFixed(2));
                $('#txtMembershipAmountCommitted').val(currencySymbol + addCommasonLoad(parseFloat(devidedAmount).toFixed(2)));
            });

            $('#btnInclude').click(function () {
                isIncludeMembership = true;
                clickedIncludeOrExcludeMembership = true;

                var giftAmount = finalAmount;
                var devidedAmount = 0;

                if (!isNullOrUndefined(selectedMembershipAmount))
                    devidedAmount = selectedMembershipAmount / 12;

                //$('#txtAmount').val((giftAmount - devidedAmount).toFixed(2));
                $('#txtAmount').val(currencySymbol + addCommasonLoad(parseFloat(giftAmount - devidedAmount).toFixed(2)));
                //$('#txtTotalAmount').val(giftAmount.toFixed(2));
                $('#txtTotalAmount').val(currencySymbol + addCommasonLoad(parseFloat(giftAmount).toFixed(2)));
                //$('#txtMembershipAmountCommitted').val(devidedAmount.toFixed(2));
                $('#txtMembershipAmountCommitted').val(currencySymbol + addCommasonLoad(parseFloat(devidedAmount).toFixed(2)));
            });

            $('#btnTryAgain').click(function () {
                var paymentType = $('input[name=paymentType]:checked').val();

                if (paymentType == PaymentType.Bank) {
                    if (selectedDonor.isAccount) {
                        loadBankDetail(selectedDonor.accountid);
                    }
                    else {
                        loadBankDetail(selectedDonor.contactid);
                    }

                    $('#ddlExistingBank').val(bankid);
                    $('.donationBankAccount').show();
                }
                else if (paymentType == PaymentType.CreditDebit) {
                    if (selectedDonor.isAccount) {
                        loadCreditCardDetail(selectedDonor.accountid);
                    }
                    else {
                        loadCreditCardDetail(selectedDonor.contactid);
                    }

                    $('#ddlExistingCard').val(cardid);
                    $('.donationCreditCard').show();
                }
                $('.divAmount').show();
                $('.divProcess').show();
                $('.payment-failed-msg').hide();
                $('#payment-failed-block').text('');
            });

            $('#btnThankyou').click(function () {
                if (donationPledge.statuscode == 844060004) { // refund
                    DownloadThankYouTemplate("Microsoft.Dynamics.CRM.msnfp_ActionGiftRefund");
                }
                else {
                    DownloadThankYouTemplate("Microsoft.Dynamics.CRM.msnfp_ActionPaymentScheduleThankYou");
                }
            });

            $('#btnPrintReceipt').click(function () {
                var processName = "msnfp_ActionPaymentScheduleReceipt";
                if (donationPledge.statuscode == 844060004) { // refund
                    DownloadReceiptTemplate("Microsoft.Dynamics.CRM.msnfp_ActionGiftRefund");
                }
                else {
                    DownloadReceiptTemplate("Microsoft.Dynamics.CRM." + processName);
                }
            });

            //8. Assign a donation to an Existing Pledge
            $('.btnLinkExistingPledge').click(function () {
                $('.divLinkExistingPledgeNull').find('.error-msg').hide();
                if (existingPledgeLoaded == false) {
                    loadRelatedPledge();
                    existingPledgeLoaded = true;
                }
                else {
                    if (!noResult) {
                        $('.existing-pledge').show();
                        $('.default-subsequent').hide();
                    }
                    else {
                        $('.divLinkExistingPledgeNull').find('.error-msg').show();
                    }
                }
            });

            $('#btnComplete').click(function () {
                $('.existing-pledge .error-msg').hide();
                var selectedPledge = $('input[name=radioExistingPledge]:checked').val();
                if (selectedPledge == undefined || selectedPledge == '') {
                    $('.existing-pledge .error-msg').show();
                }
                else {
                    updateDonationPledge(selectedPledge, false);
                }
            });

            $('#btnRemoveLink').click(function () {
                var pledgeId = $('.spanExistingPledge').data('id');
                updateDonationPledge(pledgeId, true);
            });

            $('.spanExistingPledge').click(function () {
                var donationId = $(this).data('id');
                if (donationId != '') {
                    var parameters = {};
                    xrm.Utility.openEntityForm("msnfp_donorcommitment", donationId, parameters, true);
                }
            });

            $('.spanFundTransferedfromGift').click(function () {
                var donationId = $(this).data('id');
                if (donationId != '') {
                    var parameters = {};
                    xrm.Utility.openEntityForm("msnfp_donationpledge", donationId, parameters, true);
                }
            });

            $('#btnProcessRefund').click(function () {
                var entity = {};
                var refundAmount = $('#txtConfirmedAmount').val();

                if (!isNullOrUndefined(refundAmount)) {
                    refundAmount = parseFloat(refundAmount.replace(currencySymbol, ''));
                    entity["msnfp_amount_refunded"] = refundAmount;
                }

                entity["msnfp_isrefunded"] = true;

                var qry = XrmServiceUtility.GetWebAPIUrl() + "msnfp_transactions(" + currentID + ")";
                var updatedID = XrmServiceUtility.UpdateRecord(qry, entity);
                if (updatedID != null) {
                    successDonationPledgeRefund(updatedID);
                }
            });


            $('.spanConvertedDonation').click(function () {
                var donationId = $(this).data('id');
                if (donationId != '') {
                    var parameters = {};
                    xrm.Utility.openEntityForm("msnfp_donationpledge", donationId, parameters, true);
                }
            });

            //14.	Recurring Donations
            $('#btnRecurringNext').click(function () {
                $('#lblErrorMessageText').html('');
                $("#divErrorMessageContainer").hide();
                $('.manual-main .error-msg').hide();

                var isValidate = true;

                if ($("#txtAmount").val() == '') {
                    isValidate = false;
                }

                $('.donatoinRecurring .mandatory input, .donatoinRecurring .mandatory select').each(function () {
                    var $this = $(this);
                    if ($this.val() == '') {
                        isValidate = false;
                    }
                });

                if (isValidate) {

                    addRemoveBankValidation();
                    addRemoveCardValidation();

                    $('.divRecurringNext').hide();
                    $('.donatoinRecurring').hide();
                    $("#btnProcess").show();

                    var selectedVal = $('input[name=paymentType]:checked').val();
                    if (selectedVal == PaymentType.CreditDebit) {
                        // Show new card fields:
                        $('.donationCreditCard').show();
                        $('.donationCreditCard .exists').css("display", "block");
                        addRemoveCardValidation();
                        showNextForCreditBank(false);

                        $('.donationCreditCard .notexists').show();

                        // Make fields mandatory:
                        $('#txtCardNumber').closest('div').addClass('mandatory');
                        $('#txtCardName').closest('div').addClass('mandatory');
                        $('#ddlCardType').closest('div').addClass('mandatory');
                        $('#txtExpiry').closest('div').addClass('mandatory');

                    }
                    else if (selectedVal == PaymentType.Bank) {
                        // Show new bank fields:
                        $('.donationBankAccount').show();
                        $('.donationBankAccount .exists').css("display", "block");
                        addRemoveBankValidation();
                        showNextForCreditBank(false);

                        // Make fields mandatory:
                        $('#txtBankName').closest('div').addClass('mandatory');
                        $('#txtAccountNumber').closest('div').addClass('mandatory');
                        $('#txtRoutingNumber').closest('div').addClass('mandatory');
                        $('#txtBankUserName').closest('div').addClass('mandatory');
                        $('#ddlAccountType').closest('div').addClass('mandatory');

                        $('#ddlExistingBank').closest('div.notExists').removeClass('mandatory');
                    }
                }
                else {
                    $('#lblErrorMessageText').append('<p>Please complete all mandatory fields.</p>');
                    $("#divErrorMessageContainer").show();
                    //$(this).addClass('red-border');
                    // $('.manual-main .error-msg').show();
                    //$('.manual-main .error-msg').html('Please complete all mandatory fields.');
                }
            });

            $('#btnRecurringChargeDonationNow').click(function () {
                var message = "Are you sure you want to charge this donation now?";
                xrm.Utility.confirmDialog(message, recurringChargeDonationNowOK, cancelClick);
            });

            $('#btnRecurringCancelDonation').click(function () {
                $('#ddlCancelDonationReason').closest('div').addClass('mandatory');
                $('#txtCancelDonationNote').closest('div').addClass('mandatory');

                $('.default-subsequent').hide();
                $('.cancelDonation').show();
            });

            $('#btnCancelDonation').click(function () {
                $('cancelDonation .error-msg-cancel').hide();
                var isValidate = true;
                $('.cancelDonation div.mandatory input, .cancelDonation div.mandatory textarea, .cancelDonation div.mandatory select').each(function () {
                    var $this = $(this);
                    if ($this.val() == '') {
                        isValidate = false;
                        return false;
                    }
                });

                if (isValidate) {
                    var message = "Selecting OK will Cancel This Recurring Donation";
                    xrm.Utility.confirmDialog(message, CancelDonationOK, cancelClick);
                }
                else {
                    $('.cancelDonation .error-msg-cancel').show();
                    $('.cancelDonation .error-msg-cancel').html('Please Enter a Cancellation Note');
                }
            });

            //Back Button Cancel Donation
            $('#btnCancelDonationBack').click(function () {
                $('#txtCancelDonationNote').val('');
                $('#ddlCancelDonationReason').val(0);

                $('.default-subsequent').show();

                //if (donationPledge.statuscode == 844060001) {
                $('.cancelDonation').hide();
                //}
                $('.cancelDonation .error-msg-cancel').hide();
            });

            //Pledge Allocations
            $('#btnRegeneratePledge').click(function () {
                var message = "Recreating the Pledge Allocations will completely remove the existing pledge records, any links between pledges and completed donations will be lost. You will have to manually re-link these records, do you want to proceed?";
                xrm.Utility.confirmDialog(message, regeneratePledgeRecords, cancelClick);
            });


            parent.Xrm.Page.getAttribute("msnfp_customerid").addOnChange(customerChange);
            parent.Xrm.Page.getAttribute("msnfp_constituentid").addOnChange(constituteChange);
            if (!isNullOrUndefined(parent.Xrm.Page.getControl("msnfp_receiptpreference"))) {
                parent.Xrm.Page.getAttribute("msnfp_receiptpreference").addOnChange(receiptPreferenceChange);
            }

            $('#btnRecurringNextDonation').click(function () {
                $('#divUpdateNextRecurringDate').toggle();
            });

            $('#btnRecurringNextDonationAmount').click(function () {
                $('#divUpdateNextRecurringAmount').toggle();
            });

            $('#btnUpdateNextRecurringDate').click(function () {
                var donationPledge = {};
                if (!isNullOrUndefined($('#txtNextRecurringDate').val())) {
                    //var nextDonationDate = getDateWithLocalTime($('#txtNextRecurringDate').val());
                    var nextDonationDate = DSTOffsetYYYYMMDD($('#txtNextRecurringDate').val());
                    donationPledge["msnfp_nextpaymentdate"] = nextDonationDate;

                    var qry = XrmServiceUtility.GetWebAPIUrl() + "msnfp_paymentschedules(" + currentID + ")";
                    XrmServiceUtility.UpdateRecordAsync(qry, donationPledge, reloadOnUpdateSuccess, errorFailure);
                } else {
                    $('#lblNextDateError').show();
                }
            });

            $('#btnUpdateNextRecurringAmount').click(function () {
                var updateEntity = {};

                if (!isNullOrUndefined($('#txtNextRecurringAmount').val())) {
                    //var newAmount = parseFloat($('#txtNextRecurringAmount').val());
                    var newAmount = parseFloat($('#txtNextRecurringAmount').val().replace(currencySymbol, '').replace(/[^\d\.\-]/g, ""));

                    updateEntity["msnfp_amount_receipted"] = newAmount;
                    updateEntity["msnfp_recurringamount"] = newAmount;

                    var qry = XrmServiceUtility.GetWebAPIUrl() + "msnfp_paymentschedules(" + currentID + ")";
                    XrmServiceUtility.UpdateRecordAsync(qry, updateEntity, reloadOnUpdateSuccess, errorFailure);
                } else {
                    $('#lblNextRecurringAmountError').show();
                }
            });

            $('#txtNextRecurringAmount').change(function () {
                var recurringAmount = !isNullOrUndefined($(this).val()) ? parseFloat($('#txtNextRecurringAmount').val().replace(currencySymbol, '').replace(/[^\d\.\-]/g, "")) : 0;
                $(this).val(currencySymbol + addCommasonLoad(parseFloat(recurringAmount.toString().replace(currencySymbol, '').replace(/[^\d\.\-]/g, "")).toFixed(2)));
            });

            $('#txtAmount').change(function () {
                var amount = !isNullOrUndefined($(this).val()) ? parseFloat($('#txtAmount').val().replace(currencySymbol, '').replace(/[^\d\.\-]/g, "")) : 0;
                var membershipAmount = 0;
                if (!isNullOrUndefined($('#hdnMembershipAmount').val())) {
                    membershipAmount = parseFloat($('#hdnMembershipAmount').val());
                }

                var amountTax = 0;
                if (!isNullOrUndefined($('#hdnMembershipAmountTax').val())) {
                    amountTax = parseFloat($('#hdnMembershipAmountTax').val());
                }

                var amountNonReceiptable = 0;
                if (!isNullOrUndefined($('#txtAmountNonReceiptable').val())) {
                    amountNonReceiptable = parseFloat($('#txtAmountNonReceiptable').val().replace(currencySymbol, '').replace(/[^\d\.\-]/g, ""));
                }

                $('#txtTotalAmount').val(currencySymbol + addCommasonLoad(parseFloat(amount + membershipAmount + amountNonReceiptable + amountTax).toFixed(2)));

                var selectedType = parseInt($('input[name=donationPledgeType]:checked').val());
                if (selectedType == DonationPledgeTypeForm.PledgeSchedule) {
                    $('#btnRegeneratePledge').attr('disabled', false);
                }

                //$(this).val(amount.toFixed(2));
                $(this).val(currencySymbol + addCommasonLoad(parseFloat(amount.toString()).toFixed(2)));


                if (!isNullOrUndefined(parentGiftAmount)) {
                    if (amount > parentGiftAmount) {
                        //$("#lblErrorMessageText")[0].innerText = "Amount should not exceed " + parentGiftAmount + " amount of the parent gift.";
                        $('#lblErrorMessageText').append('<p>Amount should not exceed ' + parentGiftAmount + ' amount of the parent gift.</p>');
                        $("#divErrorMessageContainer").show();
                        $(this).addClass('red-border');
                    }
                    else {
                        $("#lblErrorMessageText").html('');
                        $("#divErrorMessageContainer").hide();
                        $(this).removeClass('red-border');
                    }
                }

                finalAmount = parseFloat($(this).val().replace(currencySymbol, '').replace(/[^\d\.\-]/g, ""));
                $('#btnExclude').click();
            });

            $('#txtAmountNonReceiptable').change(function () {
                var amount = 0;
                var amountMembership = 0;
                var amountNonReceiptable = 0;
                var amountTax = 0;

                if (!isNullOrUndefined($('#txtAmount').val())) {
                    amount = parseFloat($('#txtAmount').val().replace(currencySymbol, '').replace(/[^\d\.\-]/g, ""));
                }

                if (!isNullOrUndefined($('#hdnMembershipAmount').val())) {
                    amountMembership = parseFloat($('#hdnMembershipAmount').val());
                }

                if (!isNullOrUndefined($('#hdnMembershipAmountTax').val())) {
                    amountTax = parseFloat($('#hdnMembershipAmountTax').val());
                }

                amountNonReceiptable = !isNullOrUndefined($(this).val()) ? parseFloat($(this).val().replace(currencySymbol, '').replace(/[^\d\.\-]/g, "")) : 0;
                $(this).val(currencySymbol + addCommasonLoad(parseFloat(amountNonReceiptable.toString()).toFixed(2)));

                $('#txtTotalAmount').val(currencySymbol + addCommasonLoad(parseFloat(amount + amountMembership + amountNonReceiptable + amountTax).toFixed(2)));
            });

            $('#txtAmountTax').change(function () {
                var amount = 0;
                var amountMembership = 0;
                var amountNonReceiptable = 0;
                var amountTax = 0;

                if (!isNullOrUndefined($('#txtAmount').val())) {
                    amount = parseFloat($('#txtAmount').val().replace(currencySymbol, '').replace(/[^\d\.\-]/g, ""));
                }

                if (!isNullOrUndefined($('#hdnMembershipAmount').val())) {
                    amountMembership = parseFloat($('#hdnMembershipAmount').val());
                }

                if (!isNullOrUndefined($('#txtAmountNonReceiptable').val())) {
                    amountNonReceiptable = parseFloat($('#txtAmountNonReceiptable').val().replace(currencySymbol, '').replace(/[^\d\.\-]/g, ""));
                }

                amountTax = !isNullOrUndefined($(this).val()) ? parseFloat($(this).val()) : 0;
                //$(this).val(amountTax.toFixed(2));
                $(this).val(currencySymbol + addCommasonLoad(parseFloat(amountTax.toString()).toFixed(2)));

                $('#txtTotalAmount').val(currencySymbol + addCommasonLoad(parseFloat(amount + amountMembership + amountNonReceiptable + amountTax).toFixed(2)));
            });

            $('#ddlRecurringEveryDayType').change(function () {
                if ($(this).val() != 844060002)//Months
                {
                    $('#ddlRecurrenceStart').val(RecurrenceStart.CurrentDay);
                    $('#ddlRecurrenceStart').attr('disabled', 'disabled');
                }
                else {
                    $('#ddlRecurrenceStart').attr('disabled', false);
                }
            });


            $('#spanAddMembershipButton').click(function () {
                if (!isNullOrUndefined(selectedDonor)) {
                    $("#divErrorMessageContainer").hide();
                    $("#lblErrorMessageText").html('');
                    loadGroupOrderList();
                    membershipModal.style.display = "block";
                    document.getElementById("divSelectMembership").style.display = "block";
                }
                else {
                    $("#divErrorMessageContainer").show();
                    //$("#lblErrorMessageText")[0].innerText = "Please select a Donor before trying to add a membership.";
                    $('#lblErrorMessageText').append('<p>Please select a Donor before trying to add a membership.</p>');

                }
            });

            $('#divMembership').click(function () {
                if ($(this).hasClass('newMembership')) {
                    if (!isNullOrUndefined(selectedDonor)) {
                        loadGroupOrderList();
                        membershipModal.style.display = "block";
                        document.getElementById("divSelectMembership").style.display = "block";
                    }
                }
            });

            // Here we add the selected membership category to this gift:
            $('#btnAddToGift').click(function () {
                var selectedTab = $('.tabview').find('a.tab-active');
                var tblID = selectedTab[0].title.replace('div', 'tbl');
                var dt = $('#' + tblID).DataTable();

                var selectedRow = dt.$(".chkMembership:checked", { "page": "all" });

                if (selectedRow.length == 0) {
                    parent.Xrm.Page.getAttribute("msnfp_membershipcategoryid").setValue(null);
                    selectedMembershipAmount = 0;
                    $('#txtMembershipAmount').val(currencySymbol + '0.00');
                    $('#txtMembershipAmountCommitted').val(currencySymbol + '0.00');
                    $('#txtAmountTax').val(currencySymbol + '0.00');
                    $('#hdnMembershipAmount').val(0);
                    $('#hdnMembershipAmountTax').val(0);
                    $('#txtAmount').val(currencySymbol + addCommasonLoad(parseFloat(finalAmount).toFixed(2)));
                    $('#txtTotalAmount').val(currencySymbol + addCommasonLoad(parseFloat(finalAmount).toFixed(2)));

                    $('.divRecurringNext #btnExclude').addClass('hide');
                    $('.divRecurringNext #btnInclude').addClass('hide');
                }
                else {
                    selectedRow.each(function (index, elem) {
                        var isChecked = $(elem).prop('checked');
                        var membershipID = $(elem).data('id');

                        if (isChecked && !isNullOrUndefined(membershipID)) {
                            var query = "msnfp_membershipcategories?";
                            query += "$select=msnfp_membershipcategoryid,msnfp_amount,msnfp_amount_membership,msnfp_amount_tax,msnfp_name&";
                            query += "$filter=msnfp_membershipcategoryid eq " + membershipID;
                            var result = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + query);

                            if (!isNullOrUndefined(result)) {
                                var membershipName = result[0].msnfp_name;

                                // Set the membership category to the selected category:
                                parent.Xrm.Page.getAttribute("msnfp_membershipcategoryid").setValue([{ id: membershipID, name: membershipName, entityType: "msnfp_membershipcategory" }]);

                                var baseCost = 0;
                                if (isNullOrUndefined(result[0].msnfp_amount) || parseFloat(result[0].msnfp_amount) == 0) {
                                    baseCost = 0;
                                }
                                else {
                                    baseCost = parseFloat(result[0].msnfp_amount);
                                }

                                var amountTax = 0;
                                if (isNullOrUndefined(result[0].msnfp_amount_tax) || parseFloat(result[0].msnfp_amount_tax) == 0) {
                                    amountTax = 0;
                                }
                                else {
                                    amountTax = parseFloat(result[0].msnfp_amount_tax);
                                }

                                var amountMembership = !isNullOrUndefined(result[0].msnfp_amount_membership) ? parseFloat(result[0].msnfp_amount_membership) : 0;

                                //$('#txtMembershipAmount').val(baseCost.toFixed(2));
                                $('#txtMembershipAmount').val(currencySymbol + addCommasonLoad(parseFloat(baseCost / 12).toFixed(2)));
                                //$('#txtMembershipAmountCommitted').val(baseCost.toFixed(2));
                                $('#txtMembershipAmountCommitted').val(currencySymbol + addCommasonLoad(parseFloat(baseCost).toFixed(2)));
                                //$('#txtTotalAmount').val(baseCost.toFixed(2));
                                $('#txtTotalAmount').val(currencySymbol + addCommasonLoad(parseFloat(baseCost / 12).toFixed(2)));
                                //$('#txtAmountTax').val(amountTax.toFixed(2));
                                $('#txtAmountTax').val(currencySymbol + addCommasonLoad(parseFloat(amountTax / 12).toFixed(2)));
                                $('#hdnMembershipAmount').val(amountMembership);
                                $('#hdnMembershipAmountTax').val(amountTax);
                                selectedMembershipAmount = baseCost;
                                console.log("selectedMembershipAmount = " + selectedMembershipAmount);
                            }
                        }
                    });

                    $('.divRecurringNext #btnExclude').removeClass('hide');
                    $('.divRecurringNext #btnInclude').removeClass('hide');
                }

                $('#btnExclude').click();

                //var selectedType = parseInt($('input[name=donationPledgeType]:checked').val());
                //if (selectedType != DonationPledgeTypeForm.Membership) {
                //    $('#txtAmount').change();
                //}

                membershipModal.style.display = "none";
            });

            $('#btnMembershipCancel').click(function () {
                parent.Xrm.Page.getAttribute("msnfp_membershipcategoryid").setValue(null);
                $('#txtMembershipAmount').val(currencySymbol + '0.00');

                $('#txtMembershipAmountCommitted').val(currencySymbol + '0.00');

                //$('#txtAmount').change();
                membershipModal.style.display = "none";
            });


            // Save all updated donor commitments:
            $('#btnSavePledgeAllocation').click(function () {
                var dt = $("#pledgeScheduleTable").DataTable();
                var giftAmount = parseFloat($('#txtAmount').val().replace(currencySymbol, '').replace(/[^\d\.\-]/g, ""));
                var isAmountEqual = false;

                var tot = 0;
                for (var i = 0; i < dt.rows().count(); i++) {
                    var currentRowAmount = (dt.cell(i, 2).nodes().to$().find('input').val()).replace(currencySymbol, '').replace(/[^\d\.\-]/g, "");
                    tot = tot + parseFloat((currentRowAmount * 10) / 10); //  roundoff error workaround for large numbers
                }

                tot = parseFloat(tot).toFixed(2);

                if (tot == giftAmount) {
                    isAmountEqual = true;
                    //$('#lblErrorPledgeTotal')[0].innerText = '';
                    $('#lblErrorPledgeTotal').html('');
                }
                else {
                    // $('#lblErrorPledgeTotal')[0].innerText = 'Pledge allocation total must equal to Gift Amount.';
                    $('#lblErrorPledgeTotal').append('<p>Pledge allocation total must equal to Gift Amount.</p>');

                }

                if (isAmountEqual) {
                    for (var i = 0; i < dt.rows().count(); i++) {
                        var currentAllocationID = $(dt.row(i).data()[0]).data('id');
                        var date = dt.cell(i, 1).nodes().to$().find('input').val();
                        var currentRowAmount = (dt.cell(i, 2).nodes().to$().find('input').val()).replace(currencySymbol, '').replace(/[^\d\.\-]/g, "");
                        var paidAmount = (dt.cell(i, 4).nodes().to$().find('input').val()).replace(currencySymbol, '').replace(/[^\d\.\-]/g, "");

                        var pledgeAllocation = {};
                        date = new Date(date);
                        pledgeAllocation["msnfp_bookdate"] = date.getFullYear() + '-' + (date.getMonth() + 1) + '-' + date.getDate();
                        pledgeAllocation["msnfp_totalamount"] = parseFloat(currentRowAmount);
                        pledgeAllocation["msnfp_totalamount_balance"] = parseFloat(currentRowAmount - paidAmount);

                        var qry = XrmServiceUtility.GetWebAPIUrl() + "msnfp_donorcommitments(" + currentAllocationID + ")";
                        XrmServiceUtility.UpdateRecord(qry, pledgeAllocation);
                    }

                    reloadOnUpdateSuccess();
                }
            });

            $('#txtRecurringStartDate').change(function () {
                parent.Xrm.Page.getAttribute('msnfp_bookdate').setValue(new Date($(this).val()));
            });

            $('#txtScheduleStartDate').change(function () {
                parent.Xrm.Page.getAttribute('msnfp_bookdate').setValue(new Date($(this).val()));
            });

            $('#btnChequeDate').click(function () {
                $('#divUpdateChequeDate').toggle();
            });

            $('#btnDepositDate').click(function () {
                $('#divUpdateDepositDate').toggle();
            });

            $('#btnUpdateChequeDate').click(function () {
                var donationPledge = {};
                if ($('#txtNewChequeDate').val() != null) {
                    donationPledge["msnfp_chequewiredate"] = DSTOffsetYYYYMMDD(new Date($('#txtNewChequeDate').val()));

                    var qry = XrmServiceUtility.GetWebAPIUrl() + "msnfp_transactions(" + currentID + ")";
                    XrmServiceUtility.UpdateRecordAsync(qry, donationPledge, reloadOnUpdateSuccess, errorFailure);
                }
            });

            $('#btnUpdateDepositDate').click(function () {
                var donationPledge = {};
                if ($('#txtNewDepositDate').val() != null) {
                    donationPledge["msnfp_depositdate"] = DSTOffsetYYYYMMDD($('#txtNewDepositDate').val());

                    var qry = XrmServiceUtility.GetWebAPIUrl() + "msnfp_transactions(" + currentID + ")";
                    XrmServiceUtility.UpdateRecordAsync(qry, donationPledge, reloadOnUpdateSuccess, errorFailure);
                }
            });

            $('#btnChequeNumber').click(function () {
                $('#divUpdateChequeNumber').toggle();
            });

            $('#btnUpdateChequeNumber').click(function () {
                var donationPledge = {};

                if ($('#txtNewChequeNumber').val() != null) {
                    donationPledge["msnfp_chequenumber"] = $('#txtNewChequeNumber').val();

                    var qry = XrmServiceUtility.GetWebAPIUrl() + "msnfp_transactions(" + currentID + ")";
                    XrmServiceUtility.UpdateRecordAsync(qry, donationPledge, reloadOnUpdateSuccess, errorFailure);
                }
            });

            //Wire Trasfer ///
            $('#btnWireDate').click(function () {
                $('#divUpdateWireDate').toggle();
            });

            $('#btnWireDepositDate').click(function () {
                $('#divUpdateWireDepositDate').toggle();
            });

            $('#btnWireNumber').click(function () {
                $('#divUpdateWireNumber').toggle();
            });

            $('#btnDepositDateAll').click(function () {
                $('#divUpdateDepositDateAll').toggle();
            });

            $('#btnUpdateWireDate').click(function () {
                var donationPledge = {};
                if ($('#txtNewWireDate').val() != null) {
                    donationPledge["msnfp_chequewiredate"] = new Date($('#txtNewWireDate').val());

                    var qry = XrmServiceUtility.GetWebAPIUrl() + "msnfp_transactions(" + currentID + ")";
                    XrmServiceUtility.UpdateRecordAsync(qry, donationPledge, reloadOnUpdateSuccess, errorFailure);
                }
            });

            $('#btnUpdateWireDepositDate').click(function () {
                var donationPledge = {};
                if ($('#txtNewWireDepositDate').val() != null) {
                    donationPledge["msnfp_depositdate"] = DSTOffsetYYYYMMDD($('#txtNewWireDepositDate').val());

                    var qry = XrmServiceUtility.GetWebAPIUrl() + "msnfp_transactions(" + currentID + ")";
                    XrmServiceUtility.UpdateRecordAsync(qry, donationPledge, reloadOnUpdateSuccess, errorFailure);
                }
            });

            $('#btnUpdateDepositDateAll').click(function () {
                var donationPledge = {};
                if (!isNullOrUndefined($('#txtNewDepositDateAll').val())) {
                    donationPledge["msnfp_depositdate"] = DSTOffsetYYYYMMDD($('#txtNewDepositDateAll').val());

                    var qry = XrmServiceUtility.GetWebAPIUrl() + "msnfp_transactions(" + currentID + ")";
                    XrmServiceUtility.UpdateRecordAsync(qry, donationPledge, reloadOnUpdateSuccess, errorFailure);
                } else {
                    $('#lblDepositDateAllError').show();
                }
            });

            $('#btnUpdateWireNumber').click(function () {
                var donationPledge = {};
                if ($('#txtNewWireNumber').val() != null) {
                    donationPledge["msnfp_chequenumber"] = $('#txtNewWireNumber').val();

                    var qry = XrmServiceUtility.GetWebAPIUrl() + "msnfp_transactions(" + currentID + ")";
                    XrmServiceUtility.UpdateRecordAsync(qry, donationPledge, reloadOnUpdateSuccess, errorFailure);
                }
            });

            $('#lblCancelDonationReason').click(function () {
                $('#divUpdateCancelReason').toggle();
            });

            $('#btnUpdateCancelReason').click(function () {
                $('.lblUpdateCancelReason').hide();

                var donationPledge = {};

                if (isNullOrUndefined($('#txtUpdateCancelReason').val()) || $('#ddlUpdateCancelDonationReason').val() == "0") {
                    $('.lblUpdateCancelReason').show();
                    $('.lblUpdateCancelReason').html('Please Enter a Cancellation Note');
                    return false;
                }
                else {
                    donationPledge["msnfp_cancellationnote"] = $('#txtUpdateCancelReason').val();
                    donationPledge["msnfp_cancelationcode"] = parseInt($('#ddlUpdateCancelDonationReason').val());

                    var qry = XrmServiceUtility.GetWebAPIUrl() + "msnfp_paymentschedules(" + currentID + ")";
                    XrmServiceUtility.UpdateRecordAsync(qry, donationPledge, reloadOnUpdateSuccess, errorFailure);
                }
            });

            parent.Xrm.Page.getAttribute("transactioncurrencyid").addOnChange(getCurrencySymbol);

            if (!isNullOrUndefined(parentGiftID)) {
                parent.Xrm.Page.getAttribute("msnfp_paymenttypecode").setValue(844060011);//Fund Trasfer
                hideOtherPaymentType();
                $("input[name=paymentType][value='" + 844060011 + "']").prop("checked", true);

                if (parentTypeWhenTransferGiftAmount == DonationPledgeType.Donation) {
                    $("input[name=donationPledgeType][value='" + DonationPledgeTypeForm.Donation + "']").prop("checked", true);
                }
                else if (parentTypeWhenTransferGiftAmount == DonationPledgeType.Pledge) {
                    $("input[name=donationPledgeType][value='" + DonationPledgeTypeForm.Pledge + "']").prop("checked", true);
                }
                else if (parentTypeWhenTransferGiftAmount == DonationPledgeType.PledgeSchedule) {
                    $("input[name=donationPledgeType][value='" + DonationPledgeTypeForm.Pledge + "']").prop("checked", true);
                }

                $("input[name=donationPledgeType]").each(function () {
                    $(this).attr("disabled", "disabled");
                });

                $("input[name=anonymousDonation]").each(function () {
                    $(this).attr("disabled", "disabled");
                });

                $("input[name=giftSource]").each(function () {
                    $(this).attr("disabled", "disabled");
                });
            }
        });

        $('#radioAnonymous').click(function () {

            $('#lblErrorMessageText').html('');
            $("#divErrorMessageContainer").hide();

        });

        function receiptPreferenceChange() {
            if (!isNullOrUndefined(parent.Xrm.Page.getControl("msnfp_receiptpreferencecode"))) {
                var receiptPref = parent.Xrm.Page.data.entity.attributes.get("msnfp_receiptpreferencecode").getValue();

                $("input[name=receiptPreference][value='" + receiptPref + "']").prop("checked", true);
            }
        }

        function showHideControlsAndLabelChange() {

            // In Honour
            if (!isNullOrUndefined(configRecord.msnfp_transaction_inhonour) && configRecord.msnfp_transaction_inhonour) {
                $('.divInHonour').css('display', 'flex');
            }
            else {
                $('.divInHonour').css('display', 'none');
            }

            if (!isNullOrUndefined(configRecord.msnfp_label_inhonourmemoryof)) {
                $('.divInHonour').find('label').text(configRecord.msnfp_label_inhonourmemoryof);
            }

            // Address
            if (!isNullOrUndefined(configRecord.msnfp_transaction_showaddress) && configRecord.msnfp_transaction_showaddress) {
                $('.divAddressFields').css('display', 'flex');

                if (!isNullOrUndefined(configRecord.msnfp_label_line1)) {
                    $('#txtAddressLine1').prev('label').text(configRecord.msnfp_label_line1);
                }

                if (!isNullOrUndefined(configRecord.msnfp_label_line2)) {
                    $('#txtAddressLine2').prev('label').text(configRecord.msnfp_label_line2);
                }

                if (!isNullOrUndefined(configRecord.msnfp_label_line3)) {
                    $('#txtAddressLine3').prev('label').text(configRecord.msnfp_label_line3);
                }

                if (!isNullOrUndefined(configRecord.msnfp_label_city)) {
                    $('#txtAddressCity').prev('label').text(configRecord.msnfp_label_city);
                }

                if (!isNullOrUndefined(configRecord.msnfp_label_stateorprovince)) {
                    $('#txtAddressProvince').prev('label').text(configRecord.msnfp_label_stateorprovince);
                }

                if (!isNullOrUndefined(configRecord.msnfp_label_postalcode)) {
                    $('#txtAddressPostalCode').prev('label').text(configRecord.msnfp_label_postalcode);
                }

                if (!isNullOrUndefined(configRecord.msnfp_label_country)) {
                    $('#txtAddressCountry').prev('label').text(configRecord.msnfp_label_country);
                }
            }
            else {
                $('.divAddressFields').css('display', 'none');
            }

            // Email
            if (!isNullOrUndefined(configRecord.msnfp_transaction_showemail) && configRecord.msnfp_transaction_showemail) {
                $('.divEmail').css('display', 'flex');
            }
            else {
                $('.divEmail').css('display', 'none');
            }

            // Phone
            if (!isNullOrUndefined(configRecord.msnfp_transaction_showtelephone) && configRecord.msnfp_transaction_showtelephone) {
                $('.divPhone').css('display', 'flex');
                $('.divAltPhone').css('display', 'flex');
                $('.divMobilePhone').css('display', 'flex');
                if (!isNullOrUndefined(configRecord.msnfp_label_telephone1)) {
                    $('.divPhone').find('label').text(configRecord.msnfp_label_telephone1);
                }
                if (!isNullOrUndefined(configRecord.msnfp_label_telephone2)) {
                    $('.divAltPhone').find('label').text(configRecord.msnfp_label_telephone2);
                }
                if (!isNullOrUndefined(configRecord.msnfp_label_telephone3)) {
                    $('.divMobilePhone').find('label').text(configRecord.msnfp_label_telephone3);
                }
            }
            else {
                $('.divPhone').css('display', 'none');
                $('.divAltPhone').css('display', 'none');
                $('.divMobilePhone').css('display', 'none');
            }

            // Receipt Preference
            if (!isNullOrUndefined(configRecord.msnfp_tran_showreceiptpreference) && configRecord.msnfp_tran_showreceiptpreference) {
                $('#divReceiptPreference').css('display', 'flex');
            }
            else {
                $('#divReceiptPreference').css('display', 'none');
            }

            // Gift Details
            if (!isNullOrUndefined(configRecord.msnfp_label_recurringdonation)) {
                $('#radioRecurringDonation').next('label')[0].innerText = configRecord.msnfp_label_recurringdonation;
            }

            if (!isNullOrUndefined(configRecord.msnfp_label_pledgeschedule)) {
                $('#radioPledgeSchedule').next('label')[0].innerText = configRecord.msnfp_label_pledgeschedule;
            }

            // Amounts
            if (!isNullOrUndefined(configRecord.msnfp_label_amount_receipted)) {
                $('.divAmount').find('label').text(configRecord.msnfp_label_amount_receipted);
                $('.divDisableAmount').find('label').text(configRecord.msnfp_label_amount_receipted);
            }

            if (!isNullOrUndefined(configRecord.msnfp_label_amount_nonreceiptable)) {
                $('.divAmountNonReceiptable').find('label').text(configRecord.msnfp_label_amount_nonreceiptable);
                $('.divDisableAmountNonreceiptable').find('label').text(configRecord.msnfp_label_amount_nonreceiptable);
            }

            if (!isNullOrUndefined(configRecord.msnfp_label_amount)) {
                $('.divDisableTotal').find('label').text(configRecord.msnfp_label_amount);
                $('.divTotalAmount').find('label').text(configRecord.msnfp_label_amount);
            }

            if (!isNullOrUndefined(configRecord.msnfp_label_amount_tax)) {
                $('.divAmountTax').find('label').text(configRecord.msnfp_label_amount_tax);
            }

            // Memberhip amount with add membership button
            if (!isNullOrUndefined(configRecord.msnfp_label_amount_membership)) {
                $('.divMembershipAmount').find('label')[0].innerHTML = '<span id="spanAddMembershipButton" class="badge badge-success">Add +</span>' + configRecord.msnfp_label_amount_membership;
                $('label[for="txtDisableAmountMembership"]').text(configRecord.msnfp_label_amount_membership);
            }
        }

        function getCurrencySymbol() {
            var currencyField = parent.Xrm.Page.data.entity.attributes.get("transactioncurrencyid").getValue();
            if (!isNullOrUndefined(currencyField)) {
                var currencyid = parent.Xrm.Page.data.entity.attributes.get("transactioncurrencyid").getValue()[0].id;
                var currencySelect = "transactioncurrencies?$select=transactioncurrencyid,currencysymbol,isocurrencycode"
                currencySelect += "&$filter=transactioncurrencyid eq " + XrmUtility.CleanGuid(currencyid);
                var currencyRec = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + currencySelect);
                if (!isNullOrUndefined(currencyRec)) {
                    currencyRec = currencyRec[0];
                }

                if (!isNullOrUndefined(currencyRec)) {
                    currencySymbol = currencyRec.currencysymbol;
                    isoCurrencyCode = currencyRec.isocurrencycode;
                }
            }
        }

        function GenerateEmailReciept() {
            var emailId = $('#emailReceipt').val();
            if (emailId != '') {
                workflowName = "WF - Payment Schedule- Email Receipt";
                var workflowId = getWorkflowId(workflowName);
                if (workflowId != undefined && workflowId != null) {
                    ExecuteWorkflow(currentID, workflowId);
                }
            }
        }

        // Cancel Donation
        function CancelDonationOK() {
            var entity = {};

            entity["statuscode"] = 844060001;
            entity["msnfp_cancelationcode"] = parseInt($('#ddlCancelDonationReason').val());
            entity["msnfp_cancellationnote"] = $('#txtCancelDonationNote').val();
            entity["msnfp_cancelledon"] = DSTOffsetYYYYMMDD(new Date());

            var qry = XrmServiceUtility.GetWebAPIUrl() + "msnfp_paymentschedules(" + currentID + ")";
            XrmServiceUtility.UpdateRecord(qry, entity);
            $('.cancelDonation-success').css("display", "flex");
            parent.Xrm.Page.data.refresh(true);

            var cancelDonationReasonNote = $("#ddlCancelDonationReason option:selected").text() + " - " + $('#txtCancelDonationNote').val();

            $('#lblCancelDonationReason')[0].innerText = cancelDonationReasonNote;

            $('.default-subsequent').show();
            $('.subsequent-main').css("display", "block");

            $('.cancelDonation').hide();
            $('.recurringDonation-success').hide();
            $('#btnRecurringCancelDonation').hide();
        }

        function recurringChargeDonationNowOK() {
            xrm.Utility.showProgressIndicator("Processing Transaction");
            mapRelatedDonationFields();
            createRelatedDonation();
        }

        function errorFailure(message) {
            xrm.Utility.closeProgressIndicator();
            // alert(message);
            $('#lblErrorMessageText').html('');
            $('#lblErrorMessageText').append('<p>' + message + '</p>');
            $("#divErrorMessageContainer").show();

        }

        function showHidePaymentType(configRec) {
            if (isNullOrUndefined(configRec.msnfp_tran_cash) || configRec.msnfp_tran_cash == false) {
                $('#radioCash').next('label').remove();
                $('#radioCash').remove();
                $('#radioCash').attr("aria-hidden", "true");
                // $('#radioCash').attr("tabindex", "-1");


            }
            else if (!isNullOrUndefined(configRec.msnfp_label_cash)) {
                $('#radioCash').next('label')[0].innerText = configRec.msnfp_label_cash;
                //$('#radioCash').attr("aria-hidden", "false");

            }

            if (isNullOrUndefined(configRec.msnfp_tran_creditcard) || configRec.msnfp_tran_creditcard == false) {
                $('#radioCreditDebit').next('label').remove();
                $('#radioCreditDebit').remove();
                $('#radioCreditDebit').attr("aria-hidden", "true");
                $('#radioCreditDebit').attr("tabindex", "-1");

            }
            else if (!isNullOrUndefined(configRec.msnfp_label_creditcard)) {
                $('#radioCreditDebit').next('label')[0].innerText = configRec.msnfp_label_creditcard;
                //$('#radioCreditDebit').attr("aria-hidden", "false");

            }

            if (isNullOrUndefined(configRec.msnfp_tran_bank) || configRec.msnfp_tran_bank == false) {
                $('#radioBankACH').next('label').remove();
                $('#radioBankACH').remove();
                $('#radioBankACH').attr("aria-hidden", "true");
                $('#radioBankACH').attr("tabindex", "-1");


            }
            else if (!isNullOrUndefined(configRec.msnfp_label_bankach)) {
                $('#radioBankACH').next('label')[0].innerText = configRec.msnfp_label_bankach;
                //$('#radioBankACH').attr("aria-hidden", "false");

            }

            // show or hide Gift Details: Pledge Schedule
            if (isNullOrUndefined(configRec.msnfp_sche_pledgeschedule) || configRec.msnfp_sche_pledgeschedule == false) {
                $('#radioPledgeSchedule').next('label').remove();
                $('#radioPledgeSchedule').remove();
                $('#radioPledgeSchedule').attr("aria-hidden", "true");
            }
        }

        function hideOtherPaymentType() {
            $('#radioCash').next('label').remove();
            $('#radioCash').remove();
            $('#radioCash').attr("aria-hidden", "true");


            $('#radioCreditDebit').next('label').remove();
            $('#radioCreditDebit').remove();
            $('#radioCreditDebit').attr("aria-hidden", "true");

            $('#radioBankACH').next('label').remove();
            $('#radioBankACH').remove();
            $('#radioBankACH').attr("aria-hidden", "true");

        }


        function showHideMembership(isTrue) {
            var monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            if (!isNullOrUndefined(selectedDonor)) {
                if (!isNullOrUndefined(selectedDonor._msnfp_primarymembershipid_value)) {
                    var mQuery = "msnfp_memberships?";
                    mQuery += "$select=msnfp_membershipid,msnfp_name,msnfp_enddate&";
                    mQuery += "$filter=msnfp_membershipid eq " + selectedDonor._msnfp_primarymembershipid_value + "";

                    var mRecord = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + mQuery);

                    if (!isNullOrUndefined(mRecord[0].msnfp_enddate)) {
                        var utcYear = new Date(mRecord[0].msnfp_enddate).getUTCFullYear();
                        var utcMonth = new Date(mRecord[0].msnfp_enddate).getUTCMonth();
                        var utcDate = new Date(mRecord[0].msnfp_enddate).getUTCDate();

                        var nextDt = new Date(utcYear, utcMonth, utcDate);
                        month = nextDt.getMonth();
                        suffix = getSuffix(nextDt.getDate());

                        $('#divMembership').find('.spanDate')[0].innerHTML = monthNames[month].toUpperCase() + " " + nextDt.getDate() + ", " + nextDt.getFullYear();
                        $("#divMembership").css("background-image", "url('msnfp_/images/SolicitationAdd32')");
                        var currentDt = new Date();
                        currentDt = new Date(currentDt.getFullYear(), currentDt.getMonth(), currentDt.getDate());

                        if (nextDt < currentDt) {
                            if (isTrue) {
                                if (donationPledge.length > 0 && donationPledge.statuscode != 844060000) {
                                    $("#divMembership").css("border-bottom-color", "#FD3211");//red
                                }
                                else {
                                    $("#divMembership").css("background-image", 'none');
                                }
                            }
                            else {
                                $("#divMembership").css("border-bottom-color", "#FD3211");//red
                                $("#divMembership").css("background-image", 'none');
                                $('#divMembership').removeClass('newMembership');
                                $($("#divMembership").find('.spanDate')[0]).css("color", "black");
                            }
                        }
                        else if (nextDt <= currentDt.setDate(currentDt.getDate() + 30)) {
                            if (isTrue) {
                                if (donationPledge.length > 0 && donationPledge.statuscode != 844060000) {
                                    $("#divMembership").css("border-bottom-color", "#F49F25");//orange
                                }
                            }
                            else {
                                $("#divMembership").css("border-bottom-color", "#F49F25");//orange
                                $($("#divMembership").find('.spanDate')[0]).css("color", "black");
                            }
                        }
                        else if (nextDt > currentDt) {
                            if (isTrue) {
                                $("#divMembership").css("border-bottom-color", "#243a5e");//green
                                if (isNullOrUndefined($('#divMembership').closest('a')[0])) {
                                    $('#divMembership').addClass('newMembership');
                                    $("#divMembership").wrap("<a id='newMembershipToDonation' href='javascript:void(0);' style='text-decoration: none;'></a>");
                                }
                            }
                            else {
                                $("#divMembership").css("background-image", 'none');
                                $('#divMembership').removeClass('newMembership');
                                $('#divMembership').closest('a#newMembershipToDonation').contents().unwrap();
                                $('#divSelectMembership').hide();
                            }
                        }
                    }

                    $("#divMembership").find('.spanMembership')[0].innerHTML = mRecord[0].msnfp_name != null ? mRecord[0].msnfp_name : "";
                }
                else {
                    $("#divMembership").find('.spanMembership')[0].innerHTML = "No Membership on File";
                    $('#divMembership').find('.spanDate')[0].innerHTML = "";
                    $($('#divMembership').find('.spanMembership')[0]).css('color', '000000');
                    if (!isNullOrUndefined(donationPledge.statuscode) && donationPledge.statuscode != 844060000) {
                        $("#divMembership").css("background-image", 'none');
                        $('#divMembership').removeClass('newMembership');
                    }
                    else {
                        $("#divMembership").css("border-bottom-color", "#FD3211");//red
                        $("#divMembership").css("background-image", "url('msnfp_/images/SolicitationAdd32')");

                        $('#divMembership').addClass('newMembership');
                        if (isNullOrUndefined($('#divMembership').closest('a')))
                            $('#divMembership').wrap('<a id="newMembershipToDonation" href="javascript:void(0);" style="text-decoration: none;"></a>');
                    }
                }
            }
        }


        function resetTimeZoneOffset(value) {
            var dtValue = new Date(value + ' UTC');

            var _userOffset = dtValue.getTimezoneOffset() * 60 * 1000;
            var _centralOffset = 6 * 60 * 60 * 1000;
            return _date = new Date(dtValue.getTime() - _userOffset + _centralOffset);
        }

        function getDateWithLocalTime(strDate) {
            var localDateIme = new Date();

            if (strDate !== null && strDate.length > 1) {
                var selectedDate = new Date(Date.parse(strDate));
                return new Date(selectedDate.getUTCFullYear(), selectedDate.getUTCMonth(), selectedDate.getUTCDate(), localDateIme.getUTCHours(), localDateIme.getUTCMinutes(), localDateIme.getUTCSeconds(), localDateIme.getUTCMilliseconds())
            }
            else {
                return new Date(Date.parse(localDateIme.toUTCString()));
            }
        }

        function reloadOnUpdateSuccess() {
            var parameters = {};
            xrm.Utility.openEntityForm("msnfp_paymentschedule", currentID, parameters, true);
        }

        function cancelClick() {
        }

        function manageTab(current) {
            $(this).children('label').each(function () {
                if (this == current) {
                    $(this).toggleClass('back-color');
                }
                else {
                    $(this).removeClass('back-color');
                }
            });
        }

        function base64ToArrayBuffer(base64) {
            var binaryString = window.atob(base64);
            var len = binaryString.length;
            var bytes = new Uint8Array(len);
            for (var i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function DownloadThankYouTemplate(requestName) {
            var entityId = parent.Xrm.Page.data.entity.getId().replace(/\{|\}/gi, '');

            try {
                var organizationUrl = parent.Xrm.Page.context.getClientUrl();
                var data = {};
                var query = "msnfp_paymentschedules(" + entityId + ")/" + requestName;
                var req = new XMLHttpRequest();
                req.open("POST", organizationUrl + "/api/data/v8.0/" + query, true);
                req.setRequestHeader("Accept", "application/json");
                req.setRequestHeader("Content-Type", "application/json; charset=utf-8");
                req.setRequestHeader("OData-MaxVersion", "4.0");
                req.setRequestHeader("OData-Version", "4.0");
                req.onreadystatechange = function () {
                    if (this.readyState == 4) {
                        req.onreadystatechange = null;
                        if (this.status == 204) {
                            select = "annotations?$select=documentbody,createdon,subject,filename,notetext,_objectid_value,annotationid&$orderby=createdon desc&$top=1&$filter=(_objectid_value eq " + entityId + ")";
                            var result = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + select);
                            if (result != null && result.length > 0) {
                                download(base64ToArrayBuffer(result[0].documentbody), result[0].filename, "application/vnd.openxmlformats-officedocument.wordprocessingml.document");
                                XrmServiceUtility.DeleteRecord(result[0].annotationid, 'annotations');
                            }
                        }
                    }
                };
                req.send(window.JSON.stringify(data));
            }
            catch (error) {
                console.log("Receipt Template Error: " + error);
            }
        }


        function DownloadReceiptTemplate(requestName) {
            var entityId = parent.Xrm.Page.data.entity.getId().replace(/\{|\}/gi, '');
            $('#lblErrorMessageText').html('');
            $("#divErrorMessageContainer").hide();

            try {
                var organizationUrl = parent.Xrm.Page.context.getClientUrl();
                var data = {};
                var query = "msnfp_paymentschedules(" + entityId + ")/" + requestName;
                console.debug(organizationUrl + "/api/data/v8.0/" + query);
                var req = new XMLHttpRequest();
                req.open("POST", organizationUrl + "/api/data/v8.0/" + query, true);
                req.setRequestHeader("Accept", "application/json");
                req.setRequestHeader("Content-Type", "application/json; charset=utf-8");
                req.setRequestHeader("OData-MaxVersion", "4.0");
                req.setRequestHeader("OData-Version", "4.0");
                req.onreadystatechange = function () {
                    if (this.readyState == 4) {
                        req.onreadystatechange = null;
                        console.debug(this);
                        console.debug(this.status);
                        if (this.status == 204 || this.status == 200) {

                            var selectReceipt =
                                "msnfp_paymentschedules?$select=_msnfp_taxreceiptid_value&$filter=(msnfp_paymentscheduleid eq " +
                                entityId +
                                ")";
                            console.debug(XrmServiceUtility.GetWebAPIUrl() + selectReceipt);
                            var receiptResult =
                                XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + selectReceipt);
                            console.debug(receiptResult);
                            if (receiptResult != null && receiptResult.length > 0) {
                                var receiptId = receiptResult[0]._msnfp_taxreceiptid_value;
                                if (receiptId != null) {
                                    select =
                                        "annotations?$select=documentbody,createdon,subject,filename,notetext,_objectid_value,annotationid&$orderby=createdon desc&$top=1&$filter=(_objectid_value eq " +
                                        receiptId +
                                        ")";
                                    console.debug(XrmServiceUtility.GetWebAPIUrl() + select);
                                    var result =
                                        XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + select);
                                    if (result != null && result.length > 0) {
                                        download(base64ToArrayBuffer(result[0].documentbody),
                                            result[0].filename,
                                            "application/vnd.openxmlformats-officedocument.wordprocessingml.document");
                                        XrmServiceUtility.DeleteRecord(result[0].annotationid, 'annotations');
                                    }
                                } else {
                                    //alert("No receipt found for this record.");
                                    $('#lblErrorMessageText').append('<p>No receipt found for this record.</p>');
                                    $("#divErrorMessageContainer").show();
                                }
                            } else {
                                //alert("No receipt found for this record.");
                                $('#lblErrorMessageText').append('<p>No receipt found for this record.</p>');
                                $("#divErrorMessageContainer").show();
                            }
                        } else {
                            //alert("Error Getting Receipts. Please contact support.");
                            $('#lblErrorMessageText').append('<p>Error Getting Receipts. Please contact support.</p>');
                            $("#divErrorMessageContainer").show();

                        }
                    }
                };
                req.send(window.JSON.stringify(data));
            }
            catch (error) {
                console.log("Receipt Template Error: " + error);
            }
        }


        function customerChange() {

            var donor = parent.Xrm.Page.data.entity.attributes.get("msnfp_customerid").getValue();
            if (donor != null) {
                donorId = parent.Xrm.Page.data.entity.attributes.get("msnfp_customerid").getValue()[0].id;
                if (donor[0].entityType == "account") {
                    select = "accounts(" + XrmUtility.CleanGuid(donorId) + ")?$select=accountid,name,address1_line1,address1_line2,address1_line3,address1_city,address1_stateorprovince,address1_country,address1_postalcode,telephone1,telephone2,telephone3,emailaddress1,_primarycontactid_value,_msnfp_primarymembershipid_value,msnfp_anonymity,msnfp_receiptpreferencecode,msnfp_accounttype";
                    expand = "&$expand=primarycontactid($select=contactid,fullname,firstname,lastname)";

                    selectedDonor = XrmServiceUtility.ExecuteQueryWithExpand(XrmServiceUtility.GetWebAPIUrl() + select + expand);

                    if (selectedDonor.msnfp_accounttype !== null && selectedDonor.msnfp_accounttype !== undefined && selectedDonor.msnfp_accounttype === 844060000) {
                        parent.Xrm.Page.data.entity.attributes.get("msnfp_customerid").setValue(null);
                        return;
                    }

                    if (selectedDonor.primarycontactid != null) {
                        var primaryContactID = selectedDonor.primarycontactid.contactid;
                        var primaryContactName = selectedDonor.primarycontactid.fullname;
                        var primaryContactType = "contact";

                        if (!parent.Xrm.Page.getAttribute("msnfp_constituentid").getValue())
                            parent.Xrm.Page.getAttribute("msnfp_constituentid").setValue([{ id: primaryContactID, name: primaryContactName, entityType: primaryContactType }]);
                        $('#txtFirstName').val(selectedDonor.primarycontactid.firstname != null ? selectedDonor.primarycontactid.firstname : "");
                        $('#txtLastName').val(selectedDonor.primarycontactid.lastname != null ? selectedDonor.primarycontactid.lastname : "");
                    }
                    else {
                        $('#txtFirstName').val('');
                        $('#txtLastName').val('');
                    }
                    selectedDonor.isAccount = true;
                    $('#txtFirstName').closest('div').removeClass('mandatory');
                    $('#txtLastName').closest('div').removeClass('mandatory');
                    $('#txtOrganization').closest('div').addClass('mandatory');
                    $('#txtOrganization').val(selectedDonor.name != null ? selectedDonor.name : "");
                    $('#txtCardName').val(selectedDonor.name != null ? selectedDonor.name : "");
                    $('#txtBankUserName').val(selectedDonor.name != null ? selectedDonor.name : "");
                    $('#txtMobilePhone').val(selectedDonor.telephone3 != null ? selectedDonor.telephone3 : "");
                }
                else if (donor[0].entityType == "contact") {
                    select = "contacts(" + XrmUtility.CleanGuid(donorId) + ")?$select=contactid,firstname,lastname,fullname,address1_line1,address1_line2,address1_line3,address1_city,address1_stateorprovince,address1_country,address1_postalcode,telephone1,telephone2,mobilephone,emailaddress1,_parentcustomerid_value,_msnfp_primarymembershipid_value,msnfp_anonymity,msnfp_receiptpreferencecode";

                    selectedDonor = XrmServiceUtility.ExecuteQueryWithExpand(XrmServiceUtility.GetWebAPIUrl() + select);

                    if (selectedDonor.parentcustomerid_account == null) {
                        $('#txtOrganization').val('');
                    }

                    selectedDonor.isAccount = false;

                    $('#txtFirstName').val(selectedDonor.firstname != null ? selectedDonor.firstname : "");
                    $('#txtLastName').val(selectedDonor.lastname != null ? selectedDonor.lastname : "");
                    $('#txtCardName').val(selectedDonor.fullname != null ? selectedDonor.fullname : "");
                    $('#txtBankUserName').val(selectedDonor.fullname != null ? selectedDonor.fullname : "");

                    $('#txtFirstName').closest('div').addClass('mandatory');
                    $('#txtLastName').closest('div').addClass('mandatory');
                    $('#txtOrganization').closest('div').removeClass('mandatory');
                    $('#txtMobilePhone').val(selectedDonor.mobilephone != null ? selectedDonor.mobilephone : "");
                }

                $('#txtEmail').val(selectedDonor.emailaddress1 != null ? selectedDonor.emailaddress1 : "");
                $('#txtPhone').val(selectedDonor.telephone1 != null ? selectedDonor.telephone1 : "");
                $('#txtAltPhone').val(selectedDonor.telephone2 != null ? selectedDonor.telephone2 : "");
                $('#txtAddressLine1').val(selectedDonor.address1_line1 != null ? selectedDonor.address1_line1 : "");
                $('#txtAddressLine2').val(selectedDonor.address1_line2 != null ? selectedDonor.address1_line2 : "");
                $('#txtAddressLine3').val(selectedDonor.address1_line3 != null ? selectedDonor.address1_line3 : "");
                $('#txtAddressCity').val(selectedDonor.address1_city != null ? selectedDonor.address1_city : "");
                $('#txtAddressProvince').val(selectedDonor.address1_stateorprovince != null ? selectedDonor.address1_stateorprovince : "");
                $('#txtAddressPostalCode').val(selectedDonor.address1_postalcode != null ? selectedDonor.address1_postalcode.replace(/\s/g, '') : "");
                $('#txtAddressCountry').val(selectedDonor.address1_country != null ? selectedDonor.address1_country : "");
                $("input[name=anonymousDonation][value='" + selectedDonor.msnfp_anonymity + "']").prop("checked", true);

                if (!isNullOrUndefined(selectedDonor.msnfp_receiptpreferencecode)) {
                    $("input[name=receiptPreference][value='" + selectedDonor.msnfp_receiptpreferencecode + "']").prop("checked", true);

                    if (!isNullOrUndefined(parent.Xrm.Page.getControl("msnfp_receiptpreferencecode"))) {
                        parent.Xrm.Page.getAttribute("msnfp_receiptpreferencecode").setValue(selectedDonor.msnfp_receiptpreferencecode);
                    }
                }

                loadBankDetail(donorId);
                loadCreditCardDetail(donorId);
                showHideMembership(true);
            }
            else {
                $('#txtFirstName').val('');
                $('#txtLastName').val('');
                $('#txtOrganization').val('');
                $('#txtEmail').val('');
                $('#txtPhone').val('');
                $('#txtAltPhone').val('');
                $('#txtMobilePhone').val('');
                $('#txtAddressLine1').val('');
                $('#txtAddressLine2').val('');
                $('#txtAddressLine3').val('');
                $('#txtAddressCity').val('');
                $('#txtAddressProvince').val('');
                $('#txtAddressPostalCode').val('');
                $('#txtAddressCountry').val('');
                $('#txtDonorName').val('');
                $('#txtInHonorMemoryOf').val('');
                $('#txtChequeNumber').val('');
                $('#txtDescription').val('');
                $('#txtApraiser').val('');

                $('#txtChequeDate').val('');
                $('#txtChequeNumber').val('');
                $('#txtCardName').val('');
                $('#txtCardNumber').val('');
                $('#txtExpiry').val('');
                $('#txtBankName').val('');
                $('#txtAccountNumber').val('');
                $('#txtRoutingNumber').val('');
                $('#txtBankUserName').val('');
                $("#radioCreditDebit").click();
                loadBankDetail(null);
                loadCreditCardDetail(null);
            }
        }

        function constituteChange() {
            var constitute = parent.Xrm.Page.data.entity.attributes.get("msnfp_constituentid").getValue();
            if (constitute != null) {
                constituteId = parent.Xrm.Page.data.entity.attributes.get("msnfp_constituentid").getValue()[0].id;
                select = "contacts?$select=contactid,fullname,firstname,lastname,emailaddress1&";
                filter = "$filter=contactid eq " + XrmUtility.CleanGuid(constituteId) + "";

                var donorResult = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + select + filter);
                selectedConstitute = donorResult[0];
                if (!isNullOrUndefined(selectedDonor) && selectedDonor.isAccount) {
                    $('#txtEmail').val(selectedConstitute.emailaddress1 != null ? selectedConstitute.emailaddress1 : "");
                    $('#txtFirstName').val(selectedConstitute.firstname != null ? selectedConstitute.firstname : "");
                    $('#txtLastName').val(selectedConstitute.lastname != null ? selectedConstitute.lastname : "");
                }
            }
        }

        // Populate the fields with existing data:
        function loadDonationPledge() {
            selectQuery = "msnfp_paymentschedules(" + currentID + ")?";
            donationPledge = XrmServiceUtility.ExecuteQueryWithExpand(XrmServiceUtility.GetWebAPIUrl() + selectQuery);

            mapRelatedDonationFields();

            $(donationPledge).each(function () {
                donorId = this.msnfp_customerid;

                if (!isNullOrUndefined(this.msnfp_receiptpreferencecode)) {
                    $("input[name=receiptPreference][value='" + this.msnfp_receiptpreferencecode + "']").prop("checked", true);
                }

                if (parent.Xrm.Page.data.entity.attributes.get("msnfp_scheduletypecode").getValue() != null) {
                    var donationPledgeSelectedType = parent.Xrm.Page.data.entity.attributes.get("msnfp_scheduletypecode").getValue();

                    if (donationPledgeSelectedType == DonationPledgeType.RecurringDonation)
                        $("input[name=donationPledgeType][value='" + DonationPledgeTypeForm.RecurringDonation + "']").prop("checked", true);
                    else if (donationPledgeSelectedType == DonationPledgeType.PledgeSchedule)
                        $("input[name=donationPledgeType][value='" + DonationPledgeTypeForm.PledgeSchedule + "']").prop("checked", true);
                }

                $("input[name=paymentType][value='" + this.msnfp_paymenttypecode + "']").prop("checked", true);
                $("input[name=anonymousDonation][value='" + this.msnfp_anonymity + "']").prop("checked", true);
                $("input[name=giftSource][value='" + this.msnfp_dataentrysource + "']").prop("checked", true);

                if (this.msnfp_type == 84406000 || this.msnfp_type == 84406014) {
                    $('.divUpdateDepositDateMain').show();
                    if (!isNullOrUndefined(this.msnfp_depositdate)) {
                        var utcYear1 = new Date(this.msnfp_depositdate).getFullYear();
                        var utcMonth1 = new Date(this.msnfp_depositdate).getMonth();
                        var utcDate1 = new Date(this.msnfp_depositdate).getDate();

                        var depositDt = new Date(utcYear1, utcMonth1, utcDate1);
                        $('#btnDepositDateAll').val(getFormattedDate(depositDt));
                    }
                    else {
                        $('#btnDepositDateAll').val("Not Selected");
                    }
                }
                else {
                    $('.divUpdateDepositDateMain').hide();
                }

                //Specify the Pledge Allocation
                relatedPledgeId = this._msnfp_relatedpledgeid_value;

                if (this.msnfp_bookdate != null && this.msnfp_bookdate != '') {
                    var str = this.msnfp_bookdate.split('-');
                    var _date = new Date(str[0] + '-' + str[1] + '-' + str[2]);
                    var _utcdate = new Date(_date.getUTCFullYear(), _date.getUTCMonth(), _date.getUTCDate(), _date.getUTCHours(), _date.getUTCMinutes(), _date.getUTCSeconds());
                    $('#txtDate').val(getFormattedDate(_utcdate));
                }


                $('#txtFirstName').val(this.msnfp_firstname);
                $('#txtLastName').val(this.msnfp_lastname);
                $('#txtOrganization').val(this.msnfp_organizationname);
                if (!isNullOrUndefined(this.msnfp_organizationname)) {
                    $('#txtOrganization').closest('div').show();
                }
                else {
                    $('#txtOrganization').closest('div').removeClass('mandatory');
                    $('#txtOrganization').closest('div').hide();
                }
                $('#txtEmail').val(this.msnfp_emailaddress1);
                $('#emailReceipt').val(this.msnfp_emailaddress1);
                $('#txtPhone').val(this.msnfp_telephone1);
                $('#txtAltPhone').val(this.msnfp_telephone2);
                $('#txtMobilePhone').val(this.msnfp_mobilephone);
                $('#txtAddressLine1').val(this.msnfp_billing_line1);
                $('#txtAddressLine2').val(this.msnfp_billing_line2);
                $('#txtAddressLine3').val(this.msnfp_billing_line3);
                $('#txtAddressCity').val(this.msnfp_billing_city);
                $('#txtAddressProvince').val(this.msnfp_billing_stateorprovince);
                $('#txtAddressPostalCode').val(this.msnfp_billing_postalcode);
                $('#txtAddressCountry').val(this.msnfp_billing_country);
                $('#txtDonorName').val();

                if (!isNullOrUndefined(this.msnfp_amount_receipted)) {
                    if (this.msnfp_amount_receipted > 0) {
                        $('#txtAmount').val(currencySymbol + addCommasonLoad(parseFloat(this.msnfp_amount_receipted).toFixed(2)));
                    } else {
                        $('#txtAmount').val(currencySymbol + '0.00');
                    }
                }
                else {
                    $('#txtAmount').val(currencySymbol + '0.00');

                }

                $('#txtDisableAmountMembership').closest('div').hide();
                $('#txtMembershipAmount').val(currencySymbol + '0.00');

                // Set the credit card drop down:
                if (!isNullOrUndefined(parent.Xrm.Page.data.entity.attributes.get("msnfp_paymentmethodid").getValue())) {
                    $('#ddlExistingCard').val(XrmUtility.CleanGuid(parent.Xrm.Page.data.entity.attributes.get("msnfp_paymentmethodid").getValue()[0].id).toLowerCase());
                }

                if ((!isNullOrUndefined(configRecord.msnfp_tran_nonreceiptable) && configRecord.msnfp_tran_nonreceiptable == true) &&
                    (!isNullOrUndefined(this.msnfp_amount_nonreceiptable) && parseFloat(this.msnfp_amount_nonreceiptable) > 0)) {
                    $('#txtAmountNonReceiptable').val(currencySymbol + addCommasonLoad(parseFloat(this.msnfp_amount_nonreceiptable).toFixed(2)));
                    $('#txtDisableAmountNonreceiptable').closest('div').css("display", "flex");
                    $('#txtDisableAmountNonreceiptable').val(currencySymbol + addCommasonLoad(parseFloat(this.msnfp_amount_nonreceiptable).toFixed(2)));
                }
                else {
                    $('#txtDisableAmountNonreceiptable').closest('div').hide();
                }

                if (!isNullOrUndefined(this.msnfp_recurringamount) && parseFloat(this.msnfp_recurringamount) > 0) {
                    $('#txtDisableTotal').closest('div').css("display", "flex");
                    $('#txtDisableTotal').val(currencySymbol + addCommasonLoad(parseFloat(this.msnfp_recurringamount).toFixed(2)));
                    //$('#txtDisableTotal').val(parseFloat(this.msnfp_recurringamount).toFixed(2));
                }
                else {
                    $('#txtDisableTotal').closest('div').hide();
                }

                if (!isNullOrUndefined(this.msnfp_recurringamount)) {
                    //$('#txtTotalAmount').val(parseFloat(this.msnfp_recurringamount).toFixed(2));
                    $('#txtTotalAmount').val(currencySymbol + addCommasonLoad(parseFloat(this.msnfp_recurringamount).toFixed(2)));
                }
                else {
                    $('#txtTotalAmount').val(currencySymbol + '0.00');
                }

                $('#txtChequeNumber').val(this.msnfp_chequenumber);
                $('.divUpdateChequeDepositDate').hide();
                $('.divUpdateWireDepositDate').hide();

                // Show the respective divs based on the gift type:
                if (this.msnfp_paymenttypecode == 844060001)//cheque
                {
                    $('.divUpdateChequeDepositDate').show();
                    $('.divUpdateDepositDateMain').hide();

                    if (!isNullOrUndefined(this.msnfp_chequenumber)) {
                        $('#btnChequeNumber').val(this.msnfp_chequenumber);
                    }
                    else {
                        $('#btnChequeNumber').val("Not Entered");
                    }
                }
                else if (this.msnfp_paymenttypecode == 844060009)//Wire Trasfer
                {
                    $('.divUpdateWireDepositDate').show();
                    $('.divUpdateDepositDateMain').hide();
                    if (!isNullOrUndefined(this.msnfp_chequenumber)) {
                        $('#btnWireNumber').val(this.msnfp_chequenumber);
                    }
                    else {
                        $('#btnWireNumber').val("Not Entered");
                    }
                }
                else if (this.msnfp_paymenttypecode == 844060002)//credit card
                {
                    $('#divCreditCard').show();
                    $('#divSourceIdentifier').show();
                    $('#divTransactionIdentifier').show();

                    if (!isNullOrUndefined(this.msnfp_sourceidentifier)) {
                        $('#txtSourceIdentifier').val(this.msnfp_sourceidentifier);
                    }
                    if (!isNullOrUndefined(this.msnfp_transactionidentifier)) {
                        $('#txtTransactionIdentifier').val(this.msnfp_transactionidentifier);
                    }
                }
                else if (this.msnfp_paymenttypecode == 844060003)//bank account
                {
                    $('#divBankAccount').show();
                    $('#divSourceIdentifier').show();
                    $('#divTransactionIdentifier').show();
                    var bankAccount = parent.Xrm.Page.data.entity.attributes.get("msnfp_paymentmethodid").getValue();
                    if (!isNullOrUndefined(bankAccount)) {
                        var bankAccountName = parent.Xrm.Page.data.entity.attributes.get("msnfp_paymentmethodid").getValue()[0].name;
                        $('#txtBankAccount').val(bankAccountName);
                    }
                    if (!isNullOrUndefined(this.msnfp_sourceidentifier)) {
                        $('#txtSourceIdentifier').val(this.msnfp_sourceidentifier);
                    }
                    if (!isNullOrUndefined(this.msnfp_transactionidentifier)) {
                        $('#txtTransactionIdentifier').val(this.msnfp_transactionidentifier);
                    }
                }

                var selectedDonation = $('input[name=donationPledgeType]:checked').val();

                var cancelReasonMessage;
                $(cancelReasonOptions).each(function () {
                    if (this.value == donationPledge.msnfp_cancelationcode) {
                        cancelReasonMessage = this.text;
                    }
                });

                if (configRecord.msnfp_tran_receipt) {
                    $('#btnPrintReceipt').css('display', 'flex');
                }
                else {
                    $('#btnPrintReceipt').css('display', 'none');
                }

                if (configRecord.msnfp_transaction_thankyou) {
                    $('#btnThankyou').css('display', 'flex');
                }
                else {
                    $('#btnThankyou').css('display', 'none');
                }

                if (this.statecode == 1)//inactive
                {
                    relatedPledgeId = this._msnfp_relatedpledgeid_value;
                    disableFields();

                    $('.subsequent-main').css("display", "flex");
                    $('#donationInfo').hide();
                    $('.cancelDonation-success').css("display", "flex");
                    $('#lblCancelDonationReason')[0].innerText = cancelReasonMessage + " - " + donationPledge.msnfp_cancellationnote;
                    bindRecurringDonation();
                    $('.refund-donation').hide();
                    $('.recurringDonation-success').hide();
                    $('.recurringDonation-last').css("display", "flex");
                    $('#btnRecurringCancelDonation').hide();
                    $('.divLinkExistingPledgeNull').hide();
                    $('.divUpdateChequeDepositDate').hide();
                    $('.divUpdateWireDepositDate').hide();
                    $('.divLinkExistingPledge').hide();
                }
                else if (this.statuscode == 844060000 || this.statuscode == 844060004 || this.statuscode == 844060001
                    || ((selectedDonation == DonationPledgeTypeForm.RecurringDonation || selectedDonation == DonationPledgeTypeForm.PledgeSchedule)
                        && this.statuscode == 1)) {
                    relatedPledgeId = this._msnfp_relatedpledgeid_value;

                    if (this.statuscode == 844060001) {
                        $('.subsequent-main').css("display", "block");
                    }
                    else {
                        $('.subsequent-main').css("display", "flex");
                    }

                    $('#donationInfo').hide();

                    if (this.statuscode == 844060001) {
                        $('.cancelDonation-success').css("display", "flex");
                        $('#lblCancelDonationReason')[0].innerText = cancelReasonMessage + " - " + donationPledge.msnfp_cancellationnote;
                        bindRecurringDonation();
                        $('.refund-donation').hide();
                        $('.recurringDonation-success').hide();
                        $('.recurringDonation-last').css("display", "flex");
                        $('#btnRecurringCancelDonation').hide();
                        $('.divLinkExistingPledgeNull').hide();
                        $('.divUpdateChequeDepositdate').hide();
                        $('.divUpdateWireDepositDate').hide();
                        $('.divLinkExistingPledge').hide();

                        if (!isNullOrUndefined(this.msnfp_amount) && this.msnfp_amount > 0)
                            $('#btnRefundDonation').attr('disabled', false);
                        else
                            $('#btnRefundDonation').attr('disabled', 'disabled');
                    }
                    else {
                        bindRefundMethods();

                        if (relatedPledgeId != null) {
                            bindRelatedPledge();
                            $('.divLinkExistingPledge').css("display", "block");
                            $('.divLinkExistingPledgeNull').hide();
                        }
                        else {
                            $('.divLinkExistingPledge').hide();
                        }

                        bindChequeWireFields(donationPledge);
                        nextDonationDate = new Date(donationPledge.msnfp_nextpaymentdate);
                        bindRecurringDonation();

                        isActive = true;
                        bindDonation_PledgeSchedule();
                    }
                    donationPledgeTypechange();
                    disableFields();

                    //Add Manual Membership Button
                    $("#divMembership").css("background-image", 'none');
                    $('#divMembership').removeClass('newMembership');
                    $('#divMembership').closest('a#newMembershipToDonation').contents().unwrap();
                }
                else if (this.statuscode == 844060003 || this.statuscode == 1)//failed or active
                {
                    paymentTypeChange();
                }
            });

        }

        function loadConfiguration(configID) {
            if (isNullOrUndefined(configID))
                configID = userConfigID;
            // Get Configuration record
            select = "msnfp_configurations?$select=msnfp_configurationid,msnfp_tran_anonymous,_msnfp_paymentprocessorid_value,";
            select += "msnfp_tran_softcredit,msnfp_sche_pledgeschedule,msnfp_comm_pledge,msnfp_tran_donation,";
            select += "msnfp_tran_cash,msnfp_tran_cheque,msnfp_tran_wireortransfer,msnfp_tran_creditcard,msnfp_tran_bank,msnfp_tran_inkind,msnfp_tran_property,msnfp_tran_stock,";
            select += "msnfp_sche_graceperiod,msnfp_sche_recurrencestart,";
            select += "msnfp_transaction_other,msnfp_tran_extcreditcard,msnfp_label_bankach,msnfp_label_cash,msnfp_label_cheque,msnfp_label_creditcard,";
            select += "msnfp_label_donation,msnfp_label_extcreditcard,msnfp_label_inkind,msnfp_label_membership,msnfp_label_other,msnfp_tran_membership,";
            select += "msnfp_label_pledge,msnfp_label_pledgeschedule,msnfp_label_property,msnfp_label_recurringdonation,msnfp_label_securities,msnfp_label_softcredit,msnfp_label_wire,";
            select += "msnfp_tran_nonreceiptable,msnfp_tran_receipt,msnfp_transaction_thankyou,msnfp_transaction_email,msnfp_label_inhonourmemoryof,msnfp_transaction_inhonour,msnfp_transaction_showaddress,msnfp_transaction_showemail,";
            select += "msnfp_transaction_showtelephone,msnfp_label_telephone1,msnfp_label_telephone2,msnfp_label_telephone3,msnfp_label_line1,msnfp_label_line2,msnfp_label_line3,";
            select += "msnfp_label_city,msnfp_label_stateorprovince,msnfp_label_postalcode,msnfp_label_country,msnfp_tran_showreceiptpreference,msnfp_tran_showamounttax,";
            select += "msnfp_label_amount_receipted,msnfp_label_amount_nonreceiptable,msnfp_label_amount,msnfp_label_amount_tax,msnfp_label_amount_membership";
            select += "&$expand=msnfp_PaymentProcessorId($select=msnfp_testmode,msnfp_avsvalidation)";
            select += "&$filter=msnfp_configurationid eq " + configID;

            var configresult = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + select);
            configRecord = configresult[0];
        }

        function bindChequeWireFields(donationPledge) {
            if (donationPledge.msnfp_paymenttypecode == 844060001)//cheque
            {
                $('.divUpdateChequeDepositDate').show();

                if (!isNullOrUndefined(donationPledge.msnfp_chequewiredate)) {
                    var utcYear = new Date(donationPledge.msnfp_chequewiredate).getFullYear();
                    var utcMonth = new Date(donationPledge.msnfp_chequewiredate).getMonth();
                    var utcDate = new Date(donationPledge.msnfp_chequewiredate).getDate();

                    var chequeDt = new Date(utcYear, utcMonth, utcDate);
                    $('#btnChequeDate').val(getFormattedDate(chequeDt));
                }
                else {
                    $('#btnChequeDate').val("Not Selected");
                }

                if (!isNullOrUndefined(donationPledge.msnfp_depositdate)) {
                    var utcYear1 = new Date(donationPledge.msnfp_depositdate).getFullYear();
                    var utcMonth1 = new Date(donationPledge.msnfp_depositdate).getMonth();
                    var utcDate1 = new Date(donationPledge.msnfp_depositdate).getDate();

                    var depositDt = new Date(utcYear1, utcMonth1, utcDate1);
                    $('#btnDepositDate').val(getFormattedDate(depositDt));
                }
                else {
                    $('#btnDepositDate').val("Not Selected");
                }
            }
            else if (donationPledge.msnfp_paymenttypecode == 844060009) {

                $('.divUpdateWireDepositDate').show();

                if (!isNullOrUndefined(donationPledge.msnfp_chequewiredate)) {
                    var utcYear = new Date(donationPledge.msnfp_chequewiredate).getFullYear();
                    var utcMonth = new Date(donationPledge.msnfp_chequewiredate).getMonth();
                    var utcDate = new Date(donationPledge.msnfp_chequewiredate).getDate();

                    var chequeDt = new Date(utcYear, utcMonth, utcDate);
                    $('#btnWireDate').val(getFormattedDate(chequeDt));
                }
                else {
                    $('#btnWireDate').val("Not Selected");
                }

                if (!isNullOrUndefined(donationPledge.msnfp_depositdate)) {
                    var utcYear1 = new Date(donationPledge.msnfp_depositdate).getFullYear();
                    var utcMonth1 = new Date(donationPledge.msnfp_depositdate).getMonth();
                    var utcDate1 = new Date(donationPledge.msnfp_depositdate).getDate();

                    var depositDt = new Date(utcYear1, utcMonth1, utcDate1);
                    $('#btnWireDepositDate').val(getFormattedDate(depositDt));
                }
                else {
                    $('#btnWireDepositDate').val("Not Selected");
                }
            }
        }

        function paymentTypeChange() {
            $("#lblErrorMessageText").html('');
            $("#divErrorMessageContainer").hide();
            var selectedVal = $('input[name=paymentType]:checked').val();
            $('.donationCheque, .donationInKind, .donationCreditCard, .donationBankAccount').hide();
            $('#txtChequeNumber').closest('div').removeClass('mandatory');
            $('#txtDescription').closest('div').removeClass('mandatory');

            addRemoveBankValidation();
            addRemoveCardValidation();

            if (selectedVal == PaymentType.Cash) {
                $('#txtDepositDate').val('');
            }
            else if (selectedVal == PaymentType.Cheque) {
                $('.spnChequeDate').show();
                $('.spnChequeNumber').show();
                $('.spnWireNumber').hide()
                $('.spnWireDate').hide();

                var selectedPledgeType = $('input[name=donationPledgeType]:checked').val();
                if (selectedPledgeType == DonationPledgeTypeForm.Pledge) {
                    $('.donationCheque').hide();
                }
                else {
                    $('.donationCheque').show();
                    $('#txtChequeNumber').closest('div').addClass('mandatory');
                }
                $('#txtDepositDate').val('');
            }
            else if (selectedVal == PaymentType.WireTransfer) {
                $('.spnChequeDate').hide();
                $('.spnChequeNumber').hide();
                $('.spnWireNumber').show()
                $('.spnWireDate').show();

                var selectedPledgeType = $('input[name=donationPledgeType]:checked').val();
                if (selectedPledgeType == DonationPledgeTypeForm.Pledge) {
                    $('.donationCheque').hide();
                }
                else {
                    $('.donationCheque').show();
                }
                $('#txtDepositDate').val('');
            }
            else if (selectedVal == PaymentType.CreditDebit) {
                addRemoveCardValidation();
                $('#ddlExistingCard').change();
                $('.divDepositDate').hide();

                var dDate = parent.Xrm.Page.getAttribute('msnfp_bookdate').getValue();

                if (dDate != null && dDate != '') {
                    $('#txtDepositDate').val(getFormattedDate(dDate));
                }

            }
            else if (selectedVal == PaymentType.Bank) {
                addRemoveBankValidation();
                $('#ddlExistingBank').change();
                $('#txtDepositDate').val('');
            }
            else if (selectedVal == PaymentType.InKind) {
                $('#txtDescription').closest('div').addClass('mandatory');
                $('.donationInKind').show();
                $('#txtDepositDate').val('');
            }
            else if (selectedVal == PaymentType.Gift) {
                $('#txtDescription').closest('div').addClass('mandatory');
                $('.donationInKind').show();
            }
            else if (selectedVal == PaymentType.Stock) {
                $('#txtDescription').closest('div').addClass('mandatory');
                $('.donationInKind').show();
                $('#txtDepositDate').val('');
            }
            else if (selectedVal == PaymentType.Property) {
                $('#txtDescription').closest('div').addClass('mandatory');
                $('.donationInKind').show();
                $('#txtDepositDate').val('');
            }

            //Recurring Donation
            addRemoveRecurringDonationFields();

            //Pledge Schedule
            addRemoveScheduleFields();

            $('label.errorMSG').each(function () {
                $(this).text('');
            });
        }

        function donationPledgeTypechange() {
            $('input[name=paymentType]').each(function () {
                $(this).next('label').show();
            });

            var selectedVal = $('input[name=donationPledgeType]:checked').val();

            addRemoveRecurringDonationFields();
            addRemoveScheduleFields();

            $('#radioCreditDebit').next('label').css('border-radius', '0');
            $('#radioBankACH').next('label').css('border-radius', '0');


            if (isNullOrUndefined(configRecord.msnfp_tran_membership) || configRecord.msnfp_tran_membership == false) {
                $('.divMembershipAmount').hide();
            }
            else {
                $('.divMembershipAmount').show();
                $('.divMembershipAmount').css("display", "flex");
            }


            if (selectedVal == DonationPledgeTypeForm.RecurringDonation) {
                $('#txtAmount').closest('div').addClass('mandatory');
                $('input[name=paymentType]').each(function () {
                    if ($(this).attr('id') != 'radioCreditDebit' && $(this).attr('id') != 'radioBankACH') {
                        $(this).next('label').hide();
                        $(this).attr("tabindex", "-1");
                        $(this).attr("hidden", "");
                    }

                });

                $('#radioBankACH').attr("aria-hidden", "false");
                $('#radioBankACH').attr("tabindex", "0");

                $('#radioCreditDebit').attr("aria-hidden", "false");
                $('#radioCreditDebit').attr("tabindex", "0");


                if (donationPledge.msnfp_paymenttypecode == 844060003) {
                    $("#radioBankACH").click();
                }
                else {
                    $("#radioCreditDebit").click();
                }

                paymentTypeChange();

                $('.donationPledgeSchedule').hide();

                showHideMembership(true);
                $('.divMembershipFields').show();
                if (isNullOrUndefined(configRecord.msnfp_tran_membership) || configRecord.msnfp_tran_membership == false) {
                    $('.divMembershipCommittedAmount').hide();
                    $('.divRecurringNext #btnExclude').addClass('hide');
                    $('.divRecurringNext #btnInclude').addClass('hide');
                }
                else {
                    $('.divMembershipCommittedAmount').show();
                    $('.divRecurringNext #btnExclude').removeClass('hide');
                    $('.divRecurringNext #btnInclude').removeClass('hide');
                }

                $('.divTotalAmount').css("display", "flex");
                $('.divDepositDate').hide();

                $('.divAmountNonReceiptable').hide();
            }
            else if (selectedVal == DonationPledgeTypeForm.PledgeSchedule) {
                $('#txtAmount').closest('div').addClass('mandatory');
                $('#radioCreditDebit').next('label').hide();
                $('#radioCreditDebit').attr("aria-hidden", "true");
                $('#radioCreditDebit').attr("tabindex", "-1");

                $('#radioBankACH').next('label').hide();
                $('#radioBankACH').attr("aria-hidden", "true");
                $('#radioBankACH').attr("tabindex", "-1");

                $('.donationPledgeSchedule').show();
                $('#btnPrintReceipt').hide();

                $("#radioCash").click();
                $('#radioCash').attr("aria-hidden", "true");
                $('#radioCash').next('label').hide();
                $('#radioCash').attr("tabindex", "-1");

                paymentTypeChange();

                showHideMembership(false);
                $('.divMembershipFields').hide();
                $('.donationCreditCard').hide();
                $('.divMembershipAmount').hide();
                $('.divMembershipCommittedAmount').hide();
                $('.divDepositDate').hide();
            }
        }

        function saveSuccess(recordID) {
            $('.payment-failed-msg').hide();
            $('#payment-failed-block').text('');

            if (recordID != null && recordID != '') {
                currentID = recordID;

                if (!isNullOrUndefined(parentGiftID)) {
                    //related to transfer gift amount functionality
                    select = "msnfp_transactions?$select=msnfp_donationpledgeid,msnfp_amount_transfer,_msnfp_fund_value";
                    filter = "&$filter=(msnfp_donationpledgeid eq " + parentGiftID + ")";
                    var result = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + select + filter);
                    if (result != null) {
                        result = result[0];
                    }
                    var parentAmountTransfer = !isNullOrUndefined(result.msnfp_amount_transfer) ? parseFloat(result.msnfp_amount_transfer) : 0;
                    var parentDonationPledge = {};
                    parentDonationPledge["msnfp_amount_transfer"] = parentAmountTransfer + parseFloat($('#txtAmount').val().replace(currencySymbol, '').replace(/[^\d\.\-]/g, ""));
                    var qryPD = XrmServiceUtility.GetWebAPIUrl() + "msnfp_transactions(" + XrmUtility.CleanGuid(parentGiftID) + ")";
                    XrmServiceUtility.UpdateRecord(qryPD, parentDonationPledge);

                    //Added FundAllocation Record
                    var entity = {};
                    var giftAmount = parseFloat($('#txtAmount').val().replace(currencySymbol, '').replace(/[^\d\.\-]/g, ""));
                    entity["msnfp_donationpledgeid@odata.bind"] = "/msnfp_transactions(" + parentGiftID + ")";

                    if (!isNullOrUndefined(result._msnfp_fund_value)) {
                        entity["msnfp_fund@odata.bind"] = "/msnfp_funds(" + result._msnfp_fund_value + ")";
                    }

                    var qry = XrmServiceUtility.GetWebAPIUrl() + "msnfp_fundallocations";
                    XrmServiceUtility.CreateRecord(qry, entity);
                }

                // Create the instance of the membership if there was a membership category added on create:
                if (!isNullOrUndefined(parent.Xrm.Page.getAttribute("msnfp_membershipcategoryid").getValue())) {
                    createMembershipFromMembershipCategory(XrmUtility.CleanGuid(parent.Xrm.Page.data.entity.attributes.get("msnfp_membershipcategoryid").getValue()[0].id))
                }

                var paymentType = $('input[name=paymentType]:checked').val();
                if (paymentType == PaymentType.Bank && !createRelatedEntity) {
                    var parameters = {};
                    xrm.Utility.openEntityForm("msnfp_paymentschedule", currentID, parameters, true);
                }

                if (createRelatedEntity) {
                    // We are creating a related donation:
                    createRelatedDonation();
                }
                else {
                    var selectedDonationPledgeType = parseInt($('input[name=donationPledgeType]:checked').val());
                    if (paymentType == PaymentType.Bank) {
                        savedDonationSuccessfully();
                        xrm.Utility.closeProgressIndicator();
                    }
                    else {
                        if (selectedDonationPledgeType == DonationPledgeTypeForm.PledgeSchedule) {
                            generatePledgeRecords();
                        }
                        savedDonationSuccessfully();
                    }
                }
            }
            else {
                relatedDonationId = null;
                $('.payment-failed-msg').show();
                $('#payment-failed-block').text('An Error Occurred, please check the response logs for details.');
                $('.donationBankAccount, .donationCreditCard, .divAmount, .divProcess').hide();
                xrm.Utility.closeProgressIndicator();
            }
        }

        function savedDonationSuccessfully() {
            updatePrimaryContacttoAccount();
            xrm.Utility.closeProgressIndicator();

            var donationId = $(this).data('id');

            if (donationId != '') {
                var parameters = {};
                var selectedDonationPledgeType = parseInt($('input[name=donationPledgeType]:checked').val());
                if (selectedDonationPledgeType == DonationPledgeTypeForm.PledgeSchedule) {
                    xrm.Utility.openEntityForm("msnfp_paymentschedule", currentID, parameters, true);
                }
                else {

                    if (formType == FormType.Create && (parent.Xrm.Page.data.entity.attributes.get("msnfp_chargeoncreate").getValue() != true || !createRelatedEntity)) {
                        xrm.Utility.openEntityForm("msnfp_paymentschedule", currentID, parameters, true);
                    }
                    else {
                        xrm.Utility.openEntityForm("msnfp_transaction", currentID, parameters, true);
                    }

                }
            }
        }

        function createAnonymousContact() {
            var conatct = {};
            conatct["firstname"] = $('#txtFirstName').val();
            conatct["lastname"] = $('#txtLastName').val();
            var qry = XrmServiceUtility.GetWebAPIUrl() + "contacts";
            return XrmServiceUtility.CreateRecord(qry, conatct);
        }

        function saveBankDetails(paymentType) {
            if ($('.donationBankAccount .notExists').is(':visible')) {
                if ($('#ddlExistingBank').val() != '-1' && $('#ddlExistingBank').val() != '0') {
                    return $('#ddlExistingBank').val();
                }
            }
            var eEntity = {};
            if (selectedDonor.isAccount) {
                eEntity["msnfp_CustomerId_account@odata.bind"] = "/accounts(" + selectedDonor.accountid + ")";
            }
            else {
                eEntity["msnfp_CustomerId_contact@odata.bind"] = "/contacts(" + selectedDonor.contactid + ")";
            }

            var accountNo = $('#txtAccountNumber').val();

            eEntity["msnfp_firstname"] = $('#txtFirstName').val();
            eEntity["msnfp_lastname"] = $('#txtLastName').val();
            eEntity["msnfp_emailaddress1"] = $('#txtEmail').val();
            eEntity["msnfp_telephone1"] = $('#txtPhone').val();
            eEntity["msnfp_billing_line1"] = $('#txtAddressLine1').val();
            eEntity["msnfp_billing_line2"] = $('#txtAddressLine2').val();
            eEntity["msnfp_billing_line3"] = $('#txtAddressLine3').val();
            eEntity["msnfp_billing_city"] = $('#txtAddressCity').val();
            eEntity["msnfp_billing_postalcode"] = $('#txtAddressPostalCode').val();
            eEntity["msnfp_bankname"] = $('#txtBankName').val();
            eEntity["msnfp_bankactnumber"] = accountNo;
            eEntity["msnfp_bankactrtnumber"] = $('#txtRoutingNumber').val();
            eEntity["msnfp_nameonfile"] = $('#txtBankUserName').val();
            eEntity["msnfp_banktypecode"] = $('#ddlAccountType').val();
            eEntity["msnfp_identifier"] = RandomGuid().substring(0, 8);
            eEntity["msnfp_name"] = $('#txtBankName').val() + " - " + accountNo.substr(accountNo.length - 4);

            // Get the payment processor from the config file:
            if (configRecord._msnfp_paymentprocessorid_value != null) {
                eEntity["msnfp_PaymentProcessorId@odata.bind"] = "/msnfp_paymentprocessors(" + XrmUtility.CleanGuid(configRecord._msnfp_paymentprocessorid_value) + ")";
            }
            // Any cards added here need to be reusable:
            eEntity["msnfp_isreusable"] = true;
            // Type = Bank Account:
            eEntity["msnfp_type"] = 844060001;

            var query = XrmServiceUtility.GetWebAPIUrl() + "msnfp_paymentmethods";
            return XrmServiceUtility.CreateRecord(query, eEntity);
        }

        function saveCreditCardDetails() {
            // If it exist already, return that value:
            if ($('.donationCreditCard .notExists').is(':visible')) {
                if ($('#ddlExistingCard').val() != '-1' && $('#ddlExistingCard').val() != '0') {
                    var select = "msnfp_paymentmethods?$select=msnfp_paymentmethodid,msnfp_ccbrandcode";
                    var filter = "&$filter=(msnfp_paymentmethodid eq " + $('#ddlExistingCard').val() + ")";
                    var result = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + select + filter);
                    if (result != null) {
                        result = result[0];
                    }
                    return $('#ddlExistingCard').val();
                }
            }

            var eEntity = {};

            if (selectedDonor.isAccount) {
                eEntity["msnfp_CustomerId_account@odata.bind"] = "/accounts(" + selectedDonor.accountid + ")";
            }
            else {
                eEntity["msnfp_CustomerId_contact@odata.bind"] = "/contacts(" + selectedDonor.contactid + ")";
            }

            var cardNo = $('#txtCardNumber').val();
            eEntity["msnfp_firstname"] = $('#txtFirstName').val();
            eEntity["msnfp_lastname"] = $('#txtLastName').val();
            eEntity["msnfp_nameonfile"] = $("#txtCardName").val();
            eEntity["msnfp_emailaddress1"] = $('#txtEmail').val();
            eEntity["msnfp_telephone1"] = $('#txtPhone').val();
            eEntity["msnfp_billing_line1"] = $('#txtAddressLine1').val();
            eEntity["msnfp_billing_line2"] = $('#txtAddressLine2').val();
            eEntity["msnfp_billing_line3"] = $('#txtAddressLine3').val();
            eEntity["msnfp_billing_city"] = $('#txtAddressCity').val();
            eEntity["msnfp_billing_state"] = $("#txtAddressProvince").val();
            eEntity["msnfp_billing_country"] = $("#txtAddressCountry").val();
            eEntity["msnfp_billing_postalcode"] = $('#txtAddressPostalCode').val();
            eEntity["msnfp_cclast4"] = cardNo;
            eEntity["msnfp_ccexpmmyy"] = $('#txtExpiry').val();

            try {
                var expiryMMYY = $('#txtExpiry').val();
                var expiryMM = expiryMMYY.substring(0, 2);
                var expiryYY = expiryMMYY.substring(2, 4);

                // Here we need to get the date value of the above:
                d = new Date();
                d.setFullYear(parseInt(expiryYY) + 2000, parseInt(expiryMM), 0);
                eEntity["msnfp_expirydate"] = d.getFullYear() + "-" + (d.getMonth() + 1) + "-" + d.getDate();
            }
            catch
            {
            }

            // Get the payment processor from the config file:
            if (configRecord._msnfp_paymentprocessorid_value != null) {
                eEntity["msnfp_PaymentProcessorId@odata.bind"] = "/msnfp_paymentprocessors(" + XrmUtility.CleanGuid(configRecord._msnfp_paymentprocessorid_value) + ")";
            }
            // Any cards added here need to be reusable:
            eEntity["msnfp_isreusable"] = true;
            // Type = Credit card:
            eEntity["msnfp_type"] = 844060000;
            eEntity["msnfp_ccbrandcode"] = parseInt($('#ddlCardType').val());
            var identifier = RandomGuid().substring(0, 8);
            eEntity["msnfp_identifier"] = identifier;
            eEntity["msnfp_name"] = $('#ddlCardType option:selected').text() + " - " + cardNo.substr(cardNo.length - 4);

            var query = XrmServiceUtility.GetWebAPIUrl() + "msnfp_paymentmethods";
            var recordId = XrmServiceUtility.CreateRecord(query, eEntity);

            return recordId;
        }


        //Specify the acknowledgement constituent
        function updatePrimaryContacttoAccount() {
            if (selectedDonor.isAccount && selectedDonor.primarycontactid == null && selectedConstitute != null) {
                var account = {};
                account["primarycontactid@odata.bind"] = "/contacts(" + selectedConstitute.contactid + ")";
                var qry = XrmServiceUtility.GetWebAPIUrl() + "accounts(" + selectedDonor.accountid + ")";
                XrmServiceUtility.UpdateRecord(qry, account);
            }
        }

        //Validations
        function disableFields() {
            $('.switch-field input, .donationFields input, .donationFields select, ' +
                '.headerFields input, .headerFields select,' +
                '.donationPledgeSchedule input, .donationPledgeSchedule select').each(function () {
                    $(this).attr("disabled", "disabled");
                });

            var dName = parent.Xrm.Page.data.entity.attributes.get("msnfp_firstname").getValue() + " " + parent.Xrm.Page.data.entity.attributes.get("msnfp_lastname").getValue();
            if (dName != null && parent.Xrm.Page.data.entity.attributes.get("msnfp_firstname").getValue() != null && parent.Xrm.Page.data.entity.attributes.get("msnfp_lastname").getValue() != null) {
                $('#txtDisableDonorName').val(dName);
                $('#txtDisableDonorName').closest('div').css("display", "flex");
            }
            else {
                $('#txtDisableDonorName').closest('div').hide();
            }

            $('#txtDisableAmount').val($('#txtAmount').val());
            $('#txtDisableAmount').closest('div').css("display", "flex");
        }

        function validate() {
            var isValidate = true;

            //$("#lblErrorMessageText")[0].innerText = '';
            $("#lblErrorMessageText").html('');
            $("#divErrorMessageContainer").hide();

            var campaignField = parent.Xrm.Page.data.entity.attributes.get("msnfp_originatingcampaignid").getValue();
            var dateField = parent.Xrm.Page.data.entity.attributes.get("msnfp_bookdate").getValue();
            var donorField = parent.Xrm.Page.data.entity.attributes.get("msnfp_customerid").getValue();

            var isAnonSelected = $('input[name=anonymousDonation]:checked').val();
            if (isAnonSelected != Anonymity.Yes && isNullOrUndefined(donorField)) {
                //$("#lblErrorMessageText")[0].innerText = "Could not retrieve the donor field.";
                $("#lblErrorMessageText").append('<p>Could not retrieve the donor field.</p>');

                $("#divErrorMessageContainer").show();
                isValidate = false;
            }

            if (isNullOrUndefined(campaignField)) {
                // $("#lblErrorMessageText")[0].innerText = "Could not retrieve the campaign field.";
                $("#lblErrorMessageText").append('<p>Could not retrieve the campaign field</p>');

                $("#divErrorMessageContainer").show();
                isValidate = false;
            }

            if (isNullOrUndefined(dateField)) {
                //$("#lblErrorMessageText")[0].innerText = "Could not retrieve date field.";
                $("#lblErrorMessageText").append('<p>Could not retrieve date field</p>');

                $("#divErrorMessageContainer").show();
                isValidate = false;
            }

            $('.manual-main div.mandatory input, .manual-main div.mandatory select').each(function () {
                var $this = $(this);
                if ($this.val() == '') {
                    isValidate = false;
                    $this.addClass('red-border');
                    console.log("Mandatory field incomplete: " + $(this)[0].id);
                }
                else {
                    $this.removeClass('red-border');
                }
            });

            return isValidate;
        }

        function validateExpiry() {
            $("#lblErrorMessageText").html('');
            $("#divErrorMessageContainer").hide();

            var currentDate = new Date();
            var isExpValidate = true;
            var cardExp = $('#txtExpiry').val();
            var mm = parseInt(cardExp.substring(0, 2));
            var yy = parseInt(cardExp.substring(cardExp.length - 2));
            var currentMonth = parseInt(currentDate.getMonth() + 1);
            var currentYear = parseInt(currentDate.getFullYear().toString().substr(-2));

            if (mm > 12 || mm <= currentMonth) {
                if (yy == currentYear && mm >= currentMonth) {
                    isExpValidate = true;
                }
                else if (yy > currentYear && mm < 12) {
                    isExpValidate = true;
                }
                else {
                    //$("#lblErrorMessageText")[0].innerText = "Month value must be 1 to 12 and greater than current month.";
                    $("#lblErrorMessageText").append('<p>Month value must be 1 to 12 and greater than current month.</p>');

                    $("#divErrorMessageContainer").show();
                    isExpValidate = false;
                }
            }

            if (yy < currentYear) {
                //$("#lblErrorMessageText")[0].innerText = "Year value must be greater than or equal to current year.";
                $("#lblErrorMessageText").append('<p>Year value must be greater than or equal to current year.</p>');

                $("#divErrorMessageContainer").show();
                isExpValidate = false;
            }
            return isExpValidate;
        }

        function checkIt(evt) {
            evt = (evt) ? evt : window.event;
            var charCode = (evt.which) ? evt.which : evt.keyCode;
            if (charCode > 31 && (charCode < 48 || charCode > 57)) {
                status = "This field accepts numbers only."
                return false;
            }
            status = "";
            return true;
        }


        // We only show this for credit/banks:
        function showNextForCreditBank(shouldDisplay) {
            console.log("showNextForCreditBank? == " + shouldDisplay);

            if (shouldDisplay) {
                $(".btnRecurringNext").css("display", "flex");
                $(".divProcess").css("display", "none");
            }
            else {
                $(".btnRecurringNext").css("display", "none");
                $(".divProcess").css("display", "flex");
            }

            if (!$('#donationCreditCard exists').is(':visible') && !$('#donationCreditCard notExists').is(':visible')) {
                $('.donationCreditCard').css("margin-bottom", "0px");
            }
            else {
                $('.donationCreditCard').css("margin-bottom", "5px");
            }
        }

        function addRemoveBankValidation() {
            $('#ddlExistingBank').closest('div').removeClass('mandatory');
            $('#txtBankName').closest('div').removeClass('mandatory');
            $('#txtAccountNumber').closest('div').removeClass('mandatory');
            $('#txtRoutingNumber').closest('div').removeClass('mandatory');
            $('#txtBankUserName').closest('div').removeClass('mandatory');
            $('#ddlAccountType').closest('div').removeClass('mandatory');

            var selectedVal = $('input[name=paymentType]:checked').val();
            if (selectedVal == PaymentType.Bank) {
                var requiredDetail = false;
                if (bankExists) {
                    $('#ddlExistingBank').closest('div').addClass('mandatory');
                    $('.donationBankAccount .exists').hide();
                    if ($('#ddlExistingBank').val() == '-1') {
                        requiredDetail = true;
                        $('.donationBankAccount .exists').show();
                        console.log("Show New Bank Fields");
                    }
                }
                else {
                    $('#ddlExistingBank').closest('div.notExists').removeClass('mandatory');
                    $('#ddlExistingBank').closest('div.notExists').hide();
                    requiredDetail = true;
                }

                if (requiredDetail) {
                    $('#txtBankName').closest('div').addClass('mandatory');
                    $('#txtAccountNumber').closest('div').addClass('mandatory');
                    $('#txtRoutingNumber').closest('div').addClass('mandatory');
                    $('#txtBankUserName').closest('div').addClass('mandatory');
                    $('#ddlAccountType').closest('div').addClass('mandatory');
                }
            }
        }

        function addRemoveCardValidation() {
            $('#ddlExistingCard').closest('div').removeClass('mandatory');
            $('#txtCardNumber').closest('div').removeClass('mandatory');
            $('#txtCardName').closest('div').removeClass('mandatory');
            $('#ddlCardType').closest('div').removeClass('mandatory');
            $('#txtExpiry').closest('div').removeClass('mandatory');

            // If this is a pledge schedule, we don't care about the payment type as we never show cards on pledges:
            var selectedType = parseInt($('input[name=donationPledgeType]:checked').val());
            // We don't save this on pledges:
            if (selectedType != DonationPledgeTypeForm.PledgeSchedule) {
                var selectedVal = $('input[name=paymentType]:checked').val();
                if (selectedVal == PaymentType.CreditDebit) {
                    var requiredDetail = false;
                    if (cardExists && $('#ddlExistingCard').val() != "-1") {
                        $('.donationCreditCard .exists').hide();

                        $('#ddlExistingCard').closest('div.notExists').addClass('mandatory');
                        if ($('#ddlExistingCard').val() == '-1')
                            requiredDetail = true;
                    }
                    else {
                        $('#ddlExistingCard').closest('div.notExists').removeClass('mandatory');
                        requiredDetail = true;
                    }

                    if (requiredDetail) {
                        $('#txtCardNumber').closest('div').addClass('mandatory');
                        $('#txtCardName').closest('div').addClass('mandatory');
                        $('#ddlCardType').closest('div').addClass('mandatory');
                        $('#txtExpiry').closest('div').addClass('mandatory');
                    }
                }
            }
        }


        function setDonationPledgeType(type, occurencetype) {
            if (type == DonationPledgeType.Donation && occurencetype == DonationOccurrence.Instant)
                $("input[name=donationPledgeType][value='" + DonationPledgeTypeForm.Donation + "']").prop("checked", true);
            else if (type == DonationPledgeType.Grant && occurencetype == DonationOccurrence.Instant)
                $("input[name=donationPledgeType][value='" + DonationPledgeTypeForm.Grant + "']").prop("checked", true);
            else if (type == DonationPledgeType.Pledge && occurencetype == DonationOccurrence.Instant)
                $("input[name=donationPledgeType][value='" + DonationPledgeTypeForm.Pledge + "']").prop("checked", true);
            else if (type == DonationPledgeType.SoftCreditDonation && (occurencetype == DonationOccurrence.Instant || isNullOrUndefined(occurencetype)))
                $("input[name=donationPledgeType][value='" + DonationPledgeTypeForm.SoftCredit + "']").prop("checked", true);
            else if (type == DonationPledgeType.RecurringDonation && occurencetype == DonationOccurrence.Recurring)
                $("input[name=donationPledgeType][value='" + DonationPledgeTypeForm.RecurringDonation + "']").prop("checked", true);
            else if (type == DonationPledgeType.PledgeSchedule && occurencetype == DonationOccurrence.Recurring)
                $("input[name=donationPledgeType][value='" + DonationPledgeTypeForm.PledgeSchedule + "']").prop("checked", true);
            else if (type == DonationPledgeType.Membership && occurencetype == DonationOccurrence.Instant)
                $("input[name=donationPledgeType][value='" + DonationPledgeTypeForm.Membership + "']").prop("checked", true);
        }


        function successLoadPledgeAllocationList(result) {
            if (result != undefined) {
                var listArray = $.map(result, function (element, index) {
                    return { value: element.msnfp_pledgeallocationid, text: element.msnfp_title };
                });

                var resultArray = [];
                $.each(listArray, function (i, v) {
                    var isExists = false;
                    $.each(resultArray, function (index, item) {
                        if (v.text == item.text) {
                            isExists = true;
                            return;
                        }
                    });
                    if (!isExists) {
                        resultArray.push(v);
                    }
                });
            }
        }


        function loadBankDetail(donorId) {
            if (!isNullOrUndefined(donorId)) {
                select = "msnfp_paymentmethods?$select=msnfp_bankname,msnfp_name,createdon&$orderby=createdon desc&$filter=(statuscode eq 1 and _msnfp_customerid_value eq " + XrmUtility.CleanGuid(donorId) + " and msnfp_type eq 844060001)"; // Filter out cards by type
                var result = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + select);

                if (result != null && result.length > 0) {
                    bankExists = true;
                    $('.donationBankAccount .exists').hide();
                    $('.donationBankAccount .notExists').css("display", "flex");

                    //Add Validation
                    addRemoveBankValidation();

                    $('#ddlExistingBank').find('option').remove().end().append('<option value="">--Select--</option>');
                    $.each(result, function (i, item) {
                        try {
                            // If this is a new gift this will fail:
                            var bankAccountName = parent.Xrm.Page.data.entity.attributes.get("msnfp_PaymentMethodId").getValue()[0].name;
                            if (bankAccountName == item.msnfp_name) {
                                $('#ddlExistingBank').
                                    append('<option value="' + item.msnfp_paymentmethodid + '" selected="selected">' + item.msnfp_title + '</option>');
                            }
                            else {
                                $('#ddlExistingBank').
                                    append($('<option>',
                                        {
                                            value: item.msnfp_paymentmethodid,
                                            text: item.msnfp_name
                                        }));
                            }

                        }
                        catch
                        {
                            $('#ddlExistingBank').
                                append($('<option>',
                                    {
                                        value: item.msnfp_paymentmethodid,
                                        text: item.msnfp_name
                                    }));
                        }
                    });

                    $('#ddlExistingBank').append('<option value="-1">New Bank Account</option>');
                }
                else {
                    bankExists = false;
                    addRemoveBankValidation();
                }
            }
            else {
                $('#ddlExistingBank').find('option').remove().end().append('<option value="0">--Select--</option>');
            }
        }

        function loadCreditCardDetail(donorId) {
            if (!isNullOrUndefined(donorId)) {

                select = "msnfp_paymentmethods?$select=msnfp_cclast4,msnfp_name,createdon,_msnfp_paymentprocessorid_value&$orderby=createdon desc&$filter=(statuscode eq 1 and _msnfp_customerid_value eq " + XrmUtility.CleanGuid(donorId) + " and msnfp_type eq 844060000)"; // Filter out banks by type
                var result = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + select);

                if (result != null && result.length > 0) {
                    cardExists = true;
                    $('.donationCreditCard .exists').hide();
                    $('.donationCreditCard .notExists').css("display", "flex");

                    //Add Validation
                    addRemoveCardValidation();

                    $('#ddlExistingCard').find('option').remove().end().append('<option value="0">--Select--</option>');
                    $.each(result, function (i, item) {

                        // Here we assign the payment processor name to the on hover of a credit card selection (useful in systems with multiple payment gateways).
                        let paymentProcessorName = "";
                        if (!isNullOrUndefined(item._msnfp_paymentprocessorid_value)) {
                            paymentProcessorName = getNameForPaymentProcessor(item._msnfp_paymentprocessorid_value);
                        }
                        $('#ddlExistingCard').
                            append('<option title="' + paymentProcessorName + '" value="' + item.msnfp_paymentmethodid + '">' + item.msnfp_name + '</option>');

                    });
                    $('#ddlExistingCard').append('<option value="-1">New Credit Card</option>');
                }
                else {
                    cardExists = false;
                    $('.donationCreditCard .notExists').hide();
                    $('#ddlExistingCard').append('<option value="-1" selected>New Credit Card</option>');

                    addRemoveCardValidation();
                }
            }
            else {
                $('#ddlExistingCard').find('option').remove().end().append('<option value="0">--Select--</option>');
            }
        }

        function getWorkflowId(workflowName) {
            select = "workflows?$select=workflowid&$filter=statecode eq 1 and _parentworkflowid_value eq null and name eq \'" + workflowName + "\'";
            var workflowRecord = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + select);
            if (workflowRecord != undefined && workflowRecord != null) {
                return workflowRecord[0].workflowid;
            }
            return undefined;
        }

        function ExecuteWorkflow(currentID, workflowId) {
            var functionName = "executeWorkflow >>";
            var query = "";
            try {
                //Define the query to execute the action
                query = "workflows(" + workflowId.replace("}", "").replace("{", "") + ")/Microsoft.Dynamics.CRM.ExecuteWorkflow";
                var data = { "EntityId": currentID };

                var req = new XMLHttpRequest();
                req.open("POST", XrmServiceUtility.GetWebAPIUrl() + query, true);
                req.setRequestHeader("Accept", "application/json");
                req.setRequestHeader("Content-Type", "application/json; charset=utf-8");
                req.setRequestHeader("OData-MaxVersion", "4.0");
                req.setRequestHeader("OData-Version", "4.0");

                req.onreadystatechange = function () {
                    if (this.readyState == 4) {
                        req.onreadystatechange = null;
                        if (this.status == 200) {
                            //success callback this returns null since no return value available.
                            var result = JSON.parse(this.response);
                            xrm.Utility.alertDialog("Mail is now queued to be sent");
                        }
                        else {
                            //error callback
                            var error = JSON.parse(this.response).error;
                            console.log(error);
                        }
                    }
                };
                req.send(JSON.stringify(data));
            }
            catch (e) {
                console.log("ExecuteWorkflow: " + e);
            }
        }

        //8. Assign a donation to an Existing Pledge
        function loadRelatedPledge() {
            select = "msnfp_transactions?$select=msnfp_transactionid,msnfp_bookdate,msnfp_installmentno,msnfp_amount,msnfp_amountowing,msnfp_amountpaid,msnfp_type,statecode";
            filter = "&$filter=statecode eq 0 and msnfp_type eq 84406001 and _msnfp_customerid_value eq " + customerId + "";
            var result = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + select + filter);

            $(result).each(function () {
                var radioButton = "<input type='radio' value='" + this.msnfp_transactionid + "' name='radioExistingPledge' />";

                var amountowing = (this.msnfp_amountowing != null ? this.msnfp_amountowing : 0);
                var amountpaid = (this.msnfp_amountpaid != null ? this.msnfp_amountpaid : 0);
                var date = new Date(this.msnfp_bookdate).getMonth() + 1 + '/' + new Date(this.msnfp_bookdate).getDate() + '/' + new Date(this.msnfp_bookdate).getFullYear();
                searchTable.row.add([
                    radioButton,
                    date,
                    this.msnfp_installmentno,
                    this.msnfp_amount,
                    amountowing,
                    amountpaid
                ]).draw(false);
            });

            if (result == undefined || result.length == 0) {
                $('.divLinkExistingPledgeNull').find('.error-msg').show();
                noResult = true;
            }
            else {
                $('.existing-pledge').show();
                $('.default-subsequent').hide();
            }
        }

        function updateDonationPledge(pledgeId, isRemoved) {
            var donationPledge = {};

            if (isRemoved) {
                var relationshipName = "msnfp_pledge_donation";
                XrmServiceUtility.DisassociateEntities(XrmUtility.CleanGuid(currentID), "msnfp_transactions", XrmUtility.CleanGuid(pledgeId), relationshipName, successDisassociate, errorFailure);
                relatedPledgeId = null;
            }
            else {
                donationPledge["msnfp_relatedpledgeid@odata.bind"] = "/msnfp_transactions(" + pledgeId + ")";

                var qry = XrmServiceUtility.GetWebAPIUrl() + "msnfp_transactions(" + currentID + ")";
                XrmServiceUtility.UpdateRecord(qry, donationPledge);
                relatedPledgeId = pledgeId;
            }

            if (!isRemoved) {
                bindRelatedPledge();
                $('.divLinkExistingPledge').show();
                $('.divLinkExistingPledgeNull').hide();
            }
            else {
                $('.divLinkExistingPledge').hide();
                $('.divLinkExistingPledgeNull').show();
            }

            $('.existing-pledge').hide();
            $('.default-subsequent').show();
        }

        function successDisassociate() { }

        function bindRelatedPledge() {
            select = "msnfp_transactions?$select=msnfp_transactionid,msnfp_title,msnfp_amount,msnfp_amountpaid,msnfp_depositdate,msnfp_chequewiredate,msnfp_chequenumber";
            //filter = "&$filter=(statuscode eq 1 or statuscode eq 84406004) and (msnfp_transactionid eq " + relatedPledgeId + ")";
            filter = "&$filter=msnfp_transactionid eq " + relatedPledgeId + "";
            var result = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + select + filter);

            if (result != null && result.length > 0) {
                result = result[0];
                var str = '';
                var name = result.msnfp_title;
                str = 'Pledge: ' + name;
                if (result.msnfp_amount != null) {
                    str += ' Amount: ' + currencySymbol + result.msnfp_amount;
                }
                if (result.msnfp_amountpaid != null) {
                    str += ' Amount Paid: ' + currencySymbol + result.msnfp_amountpaid;
                }

                $('.spanExistingPledge').html(str);
                $('.spanExistingPledge').data('id', result.msnfp_transactionid);
            }
        }

        function getLookupGuid(fieldName) {
            var field = parent.Xrm.Page.data.entity.attributes.get(fieldName);
            if (field != null && field.getValue() != null) {
                return parent.Xrm.Page.data.entity.attributes.get(fieldName).getValue()[0].id.replace('{', '').replace('}', '');
            }
            return null;
        }

        function bindRefundMethods() {
            searchTable = $('#searchResult').DataTable({
                "info": false,
                "bPaginate": true,
                "bFilter": false,
                "bLengthChange": false,
                "sPaginationType": "numbers",
                "iDisplayLength": 5,
                "columnDefs": [{
                    orderable: false, targets: [0]
                }],
                "order": [[1, "asc"]]
            });

            //9.	Refund a Donation
            RefundProcess();
        }

        function RefundProcess() {
            var statusreason = donationPledge.statuscode;
            if (statusreason == 844060000) //Only if Completed
            {
                if (donationPledge.msnfp_bookdaterefunded != null) {
                    $('.refund-donation-sucess').show();
                    $('#txtRefundSucessOn').val(donationPledge.msnfp_bookdaterefunded);
                    $('#txtRefundSuccessAmount').val(currencySymbol + donationPledge.msnfp_totalrefunded);
                }
                else {
                    if (donationPledge.msnfp_type == 84406000)//Donation
                    {
                        var giftType = donationPledge.msnfp_paymenttypecode;

                        if (giftType == PaymentType.Cheque || giftType == PaymentType.WireTransfer) {
                            $('#txtChequeNumberRefund').val(donationPledge.msnfp_chequenumber);
                        }
                        var amount = donationPledge.msnfp_amount;
                        $('#txtConfirmedAmount').val(currencySymbol + amount);

                        $('#selectRefundType').append($('<option>',
                            {
                                text: getGiftType(giftType)
                            }));
                    }
                    else {
                        $('.refund-donation').hide();
                    }
                }
            }
            else if (statusreason == 844060004) {
                if (donationPledge.msnfp_bookdaterefunded != null) {
                    $('.refund-donation').hide();
                    $('.refund-donation-sucess').show();

                    $('#txtRefundSucessOn').val(donationPledge.msnfp_bookdaterefunded.toLocaleString().split("T")[0]);
                    $('#txtRefundSuccessAmount').val(currencySymbol + donationPledge.msnfp_totalrefunded);
                }
            }
            else if (statusreason == 1 && donationPledge.msnfp_type == DonationPledgeType.RecurringDonation) {
                $('.refund-donation').hide();
            }
        }

        function getGiftType(giftType) {
            if (giftType == 844060000) { return 'Cash'; }
            if (giftType == 844060001) { return 'Cheque'; }
            if (giftType == 844060002) { return 'Credit / Debit Card'; }
            if (giftType == 844060003) { return 'Bank (Ach)'; }
            if (giftType == 844060004) { return 'In Kind'; }
            if (giftType == 844060005) { return 'Gift'; }
            if (giftType == 844060006) { return 'Stock'; }
            if (giftType == 844060007) { return 'Property'; }
            if (giftType == 844060009) { return 'WireTransfer'; }
            if (giftType == 844060008) { return 'Other'; }
            return '';
        }

        function successDonationPledgeRefund(recordID) {
            $('#txtRefundFailed').closest('div').hide();

            if (recordID != null && recordID != '') {
                select = "msnfp_transactions?$select=msnfp_transactionid,msnfp_transactionresult,msnfp_bookdaterefunded,msnfp_totalrefunded,msnfp_gifttype,msnfp_amount";
                filter = "&$filter=(msnfp_transactionid eq " + recordID + ")";
                var result = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + select + filter);

                if (result != null) {
                    result = result[0];
                    if (result.msnfp_transactionresult == 'true') {
                        $('#txtRefundSucessOn').val(result.msnfp_bookdaterefunded.toLocaleString().split("T")[0]);
                        $('#txtRefundSuccessAmount').val(currencySymbol + result.msnfp_totalrefunded);
                        completedDonationPledgeRefund();
                    }
                    else {
                        failedDonationPledgeRefund();
                    }
                }
                else {
                    failedDonationPledgeRefund();
                }
            }
            else {
                failedDonationPledgeRefund();
            }
        }

        function completedDonationPledgeRefund() {
            $('.refund-donation-process').hide();
            $('.subsequent-main').show();
            $('.default-subsequent').show();
            $('.refund-donation').hide();
            $('.refund-donation-sucess').show();
            var parameters = {};
            xrm.Utility.openEntityForm("msnfp_donationpledge", currentID, parameters, true);
        }

        function failedDonationPledgeRefund() {
            $('#txtRefundFailed').closest('div').show();
            $('#txtRefundFailed').val('An Error Occurred, please check the response logs for details.');
            $('#btnProcessRefund').val('Complete');
        }


        function getSuffix(n) {
            return n < 11 || n > 13 ? ['st', 'nd', 'rd', 'th'][Math.min((n - 1) % 10, 3)] : 'th'
        }

        function getNameForPaymentProcessor(paymentProcessorId) {
            var retval = "";

            if (isNullOrUndefined(paymentProcessorId)) {
                return retval;
            }

            var selectPP = "msnfp_paymentprocessors?$select=msnfp_paymentprocessorid,msnfp_name,msnfp_paymentgatewaytype";
            filterPP = "&$filter=(msnfp_paymentprocessorid eq " + XrmUtility.CleanGuid(paymentProcessorId) + ")";
            var resultPP = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + selectPP + filterPP);

            if (resultPP != null) {
                if (resultPP[0].msnfp_name != null) {
                    retval = resultPP[0].msnfp_name;
                }
            }

            return retval;
        }

        //11.	Convert a Pledge to a Donation
        function loadParentDonationDetails(parentDonationId) {
            selectQuery = "msnfp_donorcommitments(" + parentDonationId + ")?";
            expandQuery = "$expand=msnfp_CustomerId_contact($select=contactid,fullname),msnfp_CustomerId_account($select=accountid,name)";
            var result = XrmServiceUtility.ExecuteQueryWithExpand(XrmServiceUtility.GetWebAPIUrl() + selectQuery + expandQuery);

            $(result).each(function () {
                $("input[name=donationPledgeType][value='" + DonationPledgeTypeForm.Donation + "']").prop("checked", true);
                $("input[name=donationPledgeType]").each(function () {
                    $(this).attr("disabled", "disabled");
                });

                $("input[name=anonymousDonation][value='" + this.msnfp_anonymous + "']").prop("checked", true);
                $("input[name=giftSource][value='" + this.msnfp_dataentrysource + "']").prop("checked", true);

                if (this.msnfp_bookdate != null && this.msnfp_bookdate != '')
                    var str = this.msnfp_bookdate.split('-');
                var _date = new Date(str[0] + '-' + str[1] + '-' + str[2]);
                var _utcdate = new Date(_date.getUTCFullYear(), _date.getUTCMonth(), _date.getUTCDate(), _date.getUTCHours(), _date.getUTCMinutes(), _date.getUTCSeconds());

                $('#txtDate').val(getFormattedDate(_utcdate));
                $('#txtFirstName').val(this.msnfp_firstname);
                $('#txtLastName').val(this.msnfp_lastname);
                $('#txtOrganization').val(this.msnfp_organizationname);
                $('#txtEmail').val(this.msnfp_emailaddress1);
                $('#txtPhone').val(this.msnfp_telephone1);
                $('#txtAltPhone').val(this.msnfp_telephone2);
                $('#txtMobilePhone').val(this.msnfp_mobilephone);
                $('#txtAddressLine1').val(this.msnfp_billing_line1);
                $('#txtAddressLine2').val(this.msnfp_billing_line2);
                $('#txtAddressLine3').val(this.msnfp_billing_line3);
                $('#txtAddressCity').val(this.msnfp_billing_city);
                $('#txtAddressProvince').val(this.msnfp_billing_stateorprovince);
                $('#txtAddressPostalCode').val(this.msnfp_billing_postalcode);
                $('#txtDonorName').val();
                $('#txtAmount').val(currencySymbol + addCommasonLoad(parseFloat(this.msnfp_recurringamount).toFixed(2)));
                //$('#txtTotalAmount').val(this.msnfp_recurringamount);
                $('#txtTotalAmount').val(currencySymbol + addCommasonLoad(parseFloat(this.msnfp_recurringamount).toFixed(2)));

                var selectRelated = "";
                var filterRelated = "";
                if (this.msnfp_CustomerId_account != null) {
                    selectRelated = "accounts?";
                    filterRelated = "$filter=accountid eq " + this._msnfp_customerid_value;
                }
                else if (this.msnfp_CustomerId_contact != null) {
                    selectRelated = "contacts?";
                    filterRelated = "$filter=contactid eq " + this._msnfp_customerid_value;
                }

                if (this.msnfp_CustomerId_account != null || this.msnfp_CustomerId_contact != null) {
                    var resultRelatedDonor = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + selectRelated + filterRelated);

                    if (resultRelatedDonor != null && this.msnfp_CustomerId_account != null) {
                        var donorID = resultRelatedDonor[0].accountid;
                        var donorName = resultRelatedDonor[0].name;
                        var donorType = "account";
                    }
                    else if (resultRelatedDonor != null && this.msnfp_CustomerId_contact != null) {
                        var donorID = resultRelatedDonor[0].contactid;
                        var donorName = resultRelatedDonor[0].fullname;
                        var donorType = "contact";
                    }
                    parent.Xrm.Page.getAttribute("msnfp_customerid").setValue([{ id: donorID, name: donorName, entityType: donorType }]);
                    customerChange();
                }
            });
        }

        //14.	Recurring Donations
        function addRemoveRecurringDonationFields() {
            $('.donatoinRecurring, .divRecurringNext').hide();
            var paymentType = $('input[name=paymentType]:checked').val();

            if ((formType === FormType.Update || formType === FormType.Disabled || formType === FormType.ReadOnly) && paymentType == PaymentType.Bank) {
                $('#btnProcess').hide();
            }
            else {
                $('#btnProcess').show();
            }

            $('#txtRecurringStartDate, #txtRecurringInstance, #ddlRecurringEveryDayType, #ddlRecurrenceStart').closest('div').removeClass('mandatory');

            var selectedVal = $('input[name=donationPledgeType]:checked').val();

            if (selectedVal == DonationPledgeTypeForm.RecurringDonation) {
                $('#btnProcess').hide();
                $('.divRecurringNext').css("display", "flex");
                $('.donatoinRecurring').css("display", "block");

                $('#txtRecurringStartDate, #txtRecurringInstance, #ddlRecurringEveryDayType, #ddlRecurrenceStart').closest('div').addClass('mandatory');

                var dt = parent.Xrm.Page.getAttribute('msnfp_bookdate').getValue();
                try {
                    $('#txtRecurringStartDate').val(getFormattedDate(dt));
                }
                catch (error) {
                    console.log("addRemoveRecurringDonationFields Error: " + error);
                }
            }
        }

        function bindRecurringDonation() {
            var selectedDonation = $('input[name=donationPledgeType]:checked').val();
            if (selectedDonation == DonationPledgeTypeForm.RecurringDonation) {
                $('.divLinkExistingPledgeNull').hide();
                $('.divUpdateChequeDepositDate').hide();
                $('.divUpdateWireDepositDate').hide();
                $('.recurringDonation-success').css("display", "block");
                $('.recurringDonation-last').css("display", "block");
                $('#btnProcess').hide();

                if (parent.Xrm.Page.getAttribute('msnfp_nextpaymentdate').getValue() != null) {

                    var utcYear = new Date(parent.Xrm.Page.getAttribute('msnfp_nextpaymentdate').getValue()).getFullYear();
                    var utcMonth = new Date(parent.Xrm.Page.getAttribute('msnfp_nextpaymentdate').getValue()).getMonth();
                    var utcDate = new Date(parent.Xrm.Page.getAttribute('msnfp_nextpaymentdate').getValue()).getDate();

                    var nextDt = new Date(utcYear, utcMonth, utcDate);
                    $('#btnRecurringNextDonation').val(DSTOffsetMMDDYYYYSlashes((getFormattedDate(nextDt))));
                }

                //$('#btnRecurringNextDonationAmount').val(parseFloat(donationPledge.msnfp_recurringamount).toFixed(2));
                $('#btnRecurringNextDonationAmount').val(currencySymbol + addCommasonLoad(parseFloat(donationPledge.msnfp_recurringamount).toFixed(2)));

                bindRelatedDonation();
            }
        }

        function bindRelatedDonation() {
            select = "msnfp_transactions?$select=msnfp_transactionid,msnfp_name,createdon,msnfp_bookdate&$orderby=createdon desc";
            filter = "&$filter=(statuscode eq 844060000) and (_msnfp_transaction_paymentscheduleid_value eq " + currentID + ")";

            var result = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + select + filter);
            $('.recurringDonationLastList').empty();

            var $txt = $('<b style="line-height: 35px;">Last donation processed is&nbsp;&nbsp;</b>');
            $(".recurringDonationLastList").append($txt);

            if (!isNullOrUndefined(result)) {
                var date = result[0].msnfp_bookdate.split('-');
                var str = 'Donation ' + result[0].msnfp_name + ' on the ' + (date[1] + "/" + date[2].substring(0, 2) + "/" + date[0]);

                var $input = $('<span type="button" class="form-control main-button" style="margin-left: 0px;float:right;width:auto;"><i class="fas fa-link"></i> ' + str + '</span>');
                $($input).data('id', result[0].msnfp_transactionid);
                $(".recurringDonationLastList").append($input);
            }

            if (result == undefined || result.length == 0) {
                $('.recurringDonationLastList').hide();
            }
            else {
                bindInputEvents();
                $('.recurringDonationLastList').show();
            }
        }

        function bindInputEvents() {
            $('.recurringDonationLastList span').click(function () {
                var donationId = $(this).data('id');
                if (donationId != '') {
                    var parameters = {};
                    xrm.Utility.openEntityForm("msnfp_transaction", donationId, parameters, true);
                }
            });
        }

        function mapRelatedDonationFields() {
            relatedDonationEntity = {};

            if (donationPledge.msnfp_anonymity != null)
                relatedDonationEntity["msnfp_anonymous"] = donationPledge.msnfp_anonymity;

            if (donationPledge.msnfp_CustomerId_account != null)
                relatedDonationEntity["msnfp_CustomerId_account@odata.bind"] = "/accounts(" + donationPledge._msnfp_customerid_value + ")";
            else if (donationPledge.msnfp_CustomerId_contact != null)
                relatedDonationEntity["msnfp_CustomerId_contact@odata.bind"] = "/contacts(" + donationPledge._msnfp_customerid_value + ")";
            else if (parent.Xrm.Page.data.entity.attributes.get("msnfp_customerid").getValue() != null) {
                var donor = parent.Xrm.Page.data.entity.attributes.get("msnfp_customerid").getValue();
                if (donor != null) {
                    if (donor[0].entityType == "account") {
                        relatedDonationEntity["msnfp_CustomerId_account@odata.bind"] = "/accounts(" + donationPledge._msnfp_customerid_value + ")";
                    }
                    else if (donor[0].entityType == "contact") {
                        relatedDonationEntity["msnfp_CustomerId_contact@odata.bind"] = "/contacts(" + donationPledge._msnfp_customerid_value + ")";
                    }
                }
            }

            let cons = getConstituent();
            if (cons) relatedDonationEntity["msnfp_RelatedConstituentId@odata.bind"] = cons;

            if (donationPledge._msnfp_donationpageid_value != null)
                relatedDonationEntity["msnfp_DonationPageId@odata.bind"] = "/msnfp_donationpages(" + donationPledge._msnfp_donationpageid_value + ")";

            if (donationPledge._msnfp_campaignpageid_value != null)
                relatedDonationEntity["msnfp_CampaignPageId@odata.bind"] = "/msnfp_campaignpages(" + donationPledge._msnfp_campaignpageid_value + ")";

            if (donationPledge._msnfp_originatingcampaignid_value != null)
                relatedDonationEntity["msnfp_OriginatingCampaignId@odata.bind"] = "/campaigns(" + donationPledge._msnfp_originatingcampaignid_value + ")";

            var date = new Date();
            relatedDonationEntity["msnfp_bookdate"] = new Date(date.getFullYear() + '-' + (date.getMonth() + 1) + '-' + date.getDate()).toUTCString();

            if (donationPledge.msnfp_paymenttypecode != null)
                relatedDonationEntity["msnfp_paymenttypecode"] = donationPledge.msnfp_paymenttypecode;

            if (donationPledge.msnfp_dataentrysource != null)
                relatedDonationEntity["msnfp_dataentrysource"] = donationPledge.msnfp_dataentrysource;

            relatedDonationEntity["msnfp_firstname"] = donationPledge.msnfp_firstname;
            relatedDonationEntity["msnfp_lastname"] = donationPledge.msnfp_lastname;

            if (donationPledge.msnfp_organizationname != null)
                relatedDonationEntity["msnfp_organizationname"] = donationPledge.msnfp_organizationname;

            relatedDonationEntity["msnfp_emailaddress1"] = donationPledge.msnfp_emailaddress1;
            relatedDonationEntity["msnfp_telephone1"] = donationPledge.msnfp_telephone1;
            relatedDonationEntity["msnfp_billing_line1"] = donationPledge.msnfp_billing_line1;
            relatedDonationEntity["msnfp_billing_line2"] = donationPledge.msnfp_billing_line2;
            relatedDonationEntity["msnfp_billing_line3"] = donationPledge.msnfp_billing_line3;
            relatedDonationEntity["msnfp_billing_city"] = donationPledge.msnfp_billing_city;
            relatedDonationEntity["msnfp_billing_stateorprovince"] = donationPledge.msnfp_billing_stateorprovince;
            relatedDonationEntity["msnfp_billing_postalcode"] = donationPledge.msnfp_billing_postalcode;
            relatedDonationEntity["msnfp_invoiceidentifier"] = "MIS" + RandomGuid().substring(0, 6).toUpperCase();

            relatedDonationEntity["msnfp_appraiser"] = donationPledge.msnfp_appraiser;
            relatedDonationEntity["msnfp_chequenumber"] = donationPledge.msnfp_chequenumber;

            if (donationPledge.msnfp_chequewiredate != null)
                relatedDonationEntity["msnfp_chequewiredate"] = donationPledge.msnfp_chequewiredate;

            relatedDonationEntity["msnfp_amount_receipted"] = donationPledge.msnfp_amount_receipted;
            relatedDonationEntity["msnfp_amount_membership"] = donationPledge.msnfp_amount_membership;

            if (donationPledge.msnfp_alert != null)
                relatedDonationEntity["msnfp_alert"] = donationPledge.msnfp_alert;

            relatedDonationEntity["msnfp_transactionresult"] = donationPledge.msnfp_transactionresult;
            relatedDonationEntity["msnfp_dataentryreference"] = donationPledge.msnfp_sourceidentifier;

            if (!isNullOrUndefined(donationPledge._msnfp_configurationid_value))
                relatedDonationEntity["msnfp_ConfigurationId@odata.bind"] = "/msnfp_configurations(" + donationPledge._msnfp_configurationid_value + ")";

            if (donationPledge.msnfp_cctype != null)
                relatedDonationEntity["msnfp_CcBrandCode"] = donationPledge.msnfp_cctype;

            relatedDonationEntity["msnfp_invoiceidentifier"] = donationPledge.msnfp_invoiceidentifier;

            if (donationPledge.msnfp_paymenttypecode != null)
                relatedDonationEntity["msnfp_paymenttypecode"] = donationPledge.msnfp_paymenttypecode;

            if (donationPledge.msnfp_dataentrysource != null)
                relatedDonationEntity["msnfp_dataentrysource"] = donationPledge.msnfp_dataentrysource;

            relatedDonationEntity["msnfp_chargeoncreate"] = true;

            if (donationPledge.msnfp_cancelledon != null)
                relatedDonationEntity["msnfp_cancelledon"] = donationPledge.msnfp_cancelledon;

            if (donationPledge.msnfp_cancelationcode != null)
                relatedDonationEntity["msnfp_cancelationcode"] = donationPledge.msnfp_cancelationcode;
        }

        // This function gets the fields and creates the recurring donation.
        function createRelatedDonation() {
            var relatedDonation = { ...relatedDonationEntity, ...MissionFunctions.GetEntityLookups(msnfp_entity_lookups) };

            relatedDonation["msnfp_receiveddate"] = new Date();

            if (parent.Xrm.Page.getAttribute("msnfp_name").getValue() != null) {
                relatedDonation["msnfp_name"] = parent.Xrm.Page.getAttribute("msnfp_name").getValue() + " - Donation Instance";
            }
            else {
                relatedDonation["msnfp_name"] = "Donation Instance";
            }

            // Due to field naming, we need to swap out the field values and remove the other entities fields for the following:
            relatedDonation["msnfp_Transaction_PaymentScheduleId@odata.bind"] = "/msnfp_paymentschedules(" + currentID + ")";

            // Total Header:
            if (parent.Xrm.Page.getAttribute('msnfp_recurringamount').getValue() != null) {
                relatedDonation["msnfp_amount"] = parent.Xrm.Page.getAttribute('msnfp_recurringamount').getValue();
            }
            else if (relatedDonation["msnfp_recurringamount"] != null) {
                relatedDonation["msnfp_amount"] = relatedDonation["msnfp_recurringamount"];
            }

            // Get the payment processor from the config file:
            if (configRecord._msnfp_paymentprocessorid_value != null) {
                relatedDonation["msnfp_PaymentProcessorId@odata.bind"] = "/msnfp_paymentprocessors(" + XrmUtility.CleanGuid(configRecord._msnfp_paymentprocessorid_value) + ")";
            }

            // Set the date on the new donation to the next date or today for new payment schedules:
            if (parent.Xrm.Page.getAttribute('msnfp_nextpaymentdate').getValue() != null) {
                relatedDonation["msnfp_bookdate"] = DSTOffset(parent.Xrm.Page.getAttribute('msnfp_nextpaymentdate').getValue());
            }
            else {
                console.log("Set book date");
                relatedDonation["msnfp_bookdate"] = DSTOffset(new Date());
            }


            relatedDonation["msnfp_anonymous"] = relatedDonation["msnfp_anonymity"];

            relatedDonation["statuscode"] = parseInt(844060000);

            if (relatedDonation["msnfp_OriginatingCampaignId@odata.bind"] != null) {
                relatedDonation["msnfp_OriginatingCampaignId@odata.bind"] = relatedDonation["msnfp_OriginatingCampaignId@odata.bind"];
            }

            if (relatedDonation["msnfp_CustomerId_contact@odata.bind"] != null) {
                relatedDonation["msnfp_CustomerId_contact@odata.bind"] = relatedDonation["msnfp_CustomerId_contact@odata.bind"];
            }

            if (relatedDonation["msnfp_CustomerId_account@odata.bind"] != null) {
                relatedDonation["msnfp_CustomerId_account@odata.bind"] = relatedDonation["msnfp_CustomerId_account@odata.bind"];
            }

            if ($('input[name=giftSource]:checked').val() != undefined) {
                relatedDonation["msnfp_dataentrysource"] = $('input[name=giftSource]:checked').val();
            }

            // Assign this payment schedule as parent:
            relatedDonation["msnfp_Transaction_PaymentScheduleId@odata.bind"] = "/msnfp_paymentschedules(" + currentID + ")";

            // Assign the payment method to the children:
            var selectedType = parseInt($('input[name=donationPledgeType]:checked').val());
            // We don't save this on pledges:
            if (selectedType != DonationPledgeTypeForm.PledgeSchedule) {
                // Set the type to donation:
                relatedDonation["msnfp_typecode"] = parseInt(844060000);

                if (relatedDonation["msnfp_PaymentMethodId@odata.bind"] != null) {
                    relatedDonation["msnfp_Transaction_PaymentMethodId@odata.bind"] = relatedDonation["msnfp_PaymentMethodId@odata.bind"];
                }
                // Get payment method if they click 'Charge this Donation Now':
                else if (parent.Xrm.Page.getAttribute('msnfp_paymentmethodid').getValue() != null) {
                    relatedDonation["msnfp_Transaction_PaymentMethodId@odata.bind"] = "/msnfp_paymentmethods(" + XrmUtility.CleanGuid(parent.Xrm.Page.data.entity.attributes.get("msnfp_paymentmethodid").getValue()[0].id) + ")";
                }

                // Set the membership instance (if appicable)
                if (membershipInstanceID != null) {
                    relatedDonation["msnfp_MembershipInstanceId@odata.bind"] = "/msnfp_memberships(" + membershipInstanceID + ")";
                }
                // Get the Membership Instance if they click 'Charge this Donation Now':
                else if (parent.Xrm.Page.getAttribute('msnfp_membershipinstanceid').getValue() != null) {
                    relatedDonation["msnfp_MembershipInstanceId@odata.bind"] = "/msnfp_memberships(" + XrmUtility.CleanGuid(parent.Xrm.Page.data.entity.attributes.get("msnfp_membershipinstanceid").getValue()[0].id) + ")";
                }

                // Get the Membership Category if they click 'Charge this Donation Now'. This is done at the parent level save/btnprocess otherwise:
                if (parent.Xrm.Page.getAttribute('msnfp_membershipcategoryid').getValue() != null) {
                    relatedDonation["msnfp_MembershipCategoryId@odata.bind"] = "/msnfp_membershipcategories(" + XrmUtility.CleanGuid(parent.Xrm.Page.data.entity.attributes.get("msnfp_membershipcategoryid").getValue()[0].id) + ")";
                }
            }

            // Set the first and last names:
            relatedDonation["msnfp_firstname"] = $('#txtFirstName').val();
            relatedDonation["msnfp_lastname"] = $('#txtLastName').val();

            // Remove some of the parent payment schedule fields from the child transaction entity, as these don't exist on the child transaction entity:
            delete relatedDonation["msnfp_OriginatingCampaignId"];
            //delete relatedDonation["msnfp_CustomerId_contact@odata.bind"];
            //delete relatedDonation["msnfp_CustomerId_account@odata.bind"];
            delete relatedDonation["msnfp_endondate"];
            delete relatedDonation["msnfp_frequencystartcode"];
            delete relatedDonation["msnfp_scheduletypecode"];
            delete relatedDonation["msnfp_firstpaymentdate"];
            delete relatedDonation["msnfp_frequency"];
            delete relatedDonation["msnfp_frequencyinterval"];
            delete relatedDonation["msnfp_lastpaymentdate"];
            delete relatedDonation["msnfp_nextpaymentdate"];
            delete relatedDonation["msnfp_recurringamount"];
            delete relatedDonation["msnfp_anonymity"];
            //delete relatedDonation["msnfp_dataentrysource"];
            delete relatedDonation["msnfp_PaymentMethodId@odata.bind"];
            delete relatedDonation["msnfp_PaymentMethodId"];

            if (relatedDonationId == undefined || relatedDonationId == '') {
                var qry = XrmServiceUtility.GetWebAPIUrl() + "msnfp_transactions";
                XrmServiceUtility.CreateRecordAsync(qry, relatedDonation, saveSuccessRelatedDonation, errorFailure);
            }
            else {
                var qry = XrmServiceUtility.GetWebAPIUrl() + "msnfp_transactions(" + currentID + ")";
                XrmServiceUtility.UpdateRecordAsync(qry, relatedDonation, saveSuccessRelatedDonation, errorFailure);
            }
        }

        function saveSuccessRelatedDonation(recordID) {
            $('.payment-failed-msg').hide();
            $('#payment-failed-block').text('');

            xrm.Utility.closeProgressIndicator();
            console.log("Saved Donation, now update/reload payment schedule: " + currentID);

            if (recordID != null && recordID != '') {
                relatedDonationId = recordID;

                var paymentType = $('input[name=paymentType]:checked').val();
                if (paymentType == PaymentType.Bank || paymentType == PaymentType.CreditDebit) {
                    // First get the child:
                    select = "msnfp_transactions?$select=msnfp_transactionid,msnfp_bookdate,msnfp_transactionresult,statuscode";
                    filter = "&$filter=(msnfp_transactionid eq " + recordID + ")";

                    var result = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + select + filter);
                    if (result != null) {
                        result = result[0];

                        if (result.statuscode == 844060000 || (result.statuscode == 1 && paymentType == PaymentType.Bank)) {
                            // Parent in this context is: msnfp_paymentschedule
                            var selectParent = "msnfp_paymentschedules?$select=msnfp_paymentscheduleid,msnfp_firstpaymentdate,msnfp_nextpaymentdate,msnfp_lastpaymentdate,msnfp_transactionresult,statuscode,msnfp_frequencyinterval,msnfp_frequencystartcode";
                            var filterParent = "&$filter=(msnfp_paymentscheduleid eq " + currentID + ")";
                            var resultParent = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + selectParent + filterParent);

                            if (resultParent != null && formType != FormType.Create) {
                                resultParent = resultParent[0];
                                updateLastDonationDate(resultParent, true);

                                console.log("resultParent.msnfp_nextpaymentdate - " + resultParent.msnfp_nextpaymentdate);
                                console.log("resultParent.msnfp_lastpaymentdate - " + resultParent.msnfp_lastpaymentdate);

                                var qry = XrmServiceUtility.GetWebAPIUrl() + "msnfp_paymentschedules(" + currentID + ")";
                                XrmServiceUtility.UpdateRecord(qry, resultParent);
                            }

                            var donationId = $(this).data('id');
                            if (donationId != '') {
                                var parameters = {};
                                xrm.Utility.openEntityForm("msnfp_paymentschedule", currentID, parameters, true);
                            }
                        }
                        else {
                            console.log("Payment failed result found in function saveSuccessRelatedDonation(), result.statuscode: " + result.statuscode);
                            relatedDonationId = null;
                            $('.payment-failed-msg').show();
                            $('#payment-failed-block').text(result.msnfp_transactionresult);
                            $('.donationBankAccount, .donationCreditCard, .divAmount, .divProcess').hide();
                            xrm.Utility.closeProgressIndicator();
                        }
                    }
                }
                else {
                    relatedDonationId = null;
                    $('.payment-failed-msg').show();
                    $('#payment-failed-block').text('An Error Occurred, please check the response logs for details.');
                    $('.donationBankAccount, .donationCreditCard, .divAmount, .divProcess').hide();
                    xrm.Utility.closeProgressIndicator();
                }
            }
        }

        function updateLastDonationDateFromIframe(entity, checkGracePeriod) {

            var firstDonationDate = entity.msnfp_bookdate;
            var nextDonationDate = null;

            if (formType == FormType.Create) {
                nextDonationDate = new Date(firstDonationDate);
            }
            else {
                if (parent.Xrm.Page.getAttribute('msnfp_nextpaymentdate').getValue() != null) {
                    var nYear = new Date(parent.Xrm.Page.getAttribute('msnfp_nextpaymentdate').getValue()).getFullYear();
                    var nMonth = new Date(parent.Xrm.Page.getAttribute('msnfp_nextpaymentdate').getValue()).getMonth();
                    var nDate = new Date(parent.Xrm.Page.getAttribute('msnfp_nextpaymentdate').getValue()).getDate();

                    var nextDt = new Date(nYear, nMonth, nDate);
                    nextDonationDate = nextDt;
                }
                else {
                    nextDonationDate = new Date();
                }
            }

            // Get the recurrance frequency (Monthly, Daily, etc):
            var dayType;
            if (parent.Xrm.Page.getAttribute('msnfp_frequency').getValue() != null) {
                dayType = parent.Xrm.Page.getAttribute('msnfp_frequency').getValue();
            }
            else if ($('#ddlRecurringEveryDayType').val() != null) {
                dayType = $('#ddlRecurringEveryDayType').val();
            }

            // Get the interval (every X dayType):
            var instance;
            if (parent.Xrm.Page.getAttribute('msnfp_frequencyinterval').getValue() != null) {
                instance = parent.Xrm.Page.getAttribute('msnfp_frequencyinterval').getValue();
            }
            else if ($('#txtRecurringInstance').val() != null) {
                instance = $('#txtRecurringInstance').val();
            }

            // Get the start date:
            var recurrenceStart;
            if (parent.Xrm.Page.getAttribute('msnfp_frequencystartcode').getValue() != null) {
                recurrenceStart = parent.Xrm.Page.getAttribute('msnfp_frequencystartcode').getValue();
            }
            else if ($('#ddlRecurrenceStart').val() != null) {
                recurrenceStart = $('#ddlRecurrenceStart').val();
            }

            if (dayType == 844060000 && instance != null) { // Daily
                nextDonationDate.setDate(nextDonationDate.getDate() + parseInt(instance));
            }
            else if (dayType == 844060001 && instance != null) { // Weekly
                nextDonationDate.setDate(nextDonationDate.getDate() + (parseInt(instance) * 7));
            }
            else if (dayType == 844060003 && instance != null) { //Annually
                nextDonationDate.setFullYear(nextDonationDate.getFullYear() + parseInt(instance));
            }
            else if (dayType == 844060002) // Monthly
            {
                var gracePeriod = 0;

                if (recurrenceStart == RecurrenceStart.CurrentDay) {
                    var lastDateOfCurrentMonth = getLastDateOfMonth(nextDonationDate.getFullYear(), nextDonationDate.getMonth());
                    var lastDateofNextmonth = getLastDateOfMonth(nextDonationDate.getFullYear(), nextDonationDate.getMonth() + 1);

                    //Set Next Donation Date as last date of month
                    if (nextDonationDate.getDate() > lastDateofNextmonth.getDate() && lastDateOfCurrentMonth.getDate() > lastDateofNextmonth.getDate()) {
                        nextDonationDate = getLastDateOfMonth(nextDonationDate.getFullYear(), nextDonationDate.getMonth() + 1);
                    }
                    else {
                        nextDonationDate.setMonth(nextDonationDate.getMonth() + 1);
                    }
                }
                else if (recurrenceStart == RecurrenceStart.FirstOftheMonth) {
                    nextDonationDate = getFirstDateOfNextMonth(nextDonationDate.getFullYear(), nextDonationDate.getMonth());

                    if (!isNullOrUndefined(configRecord.msnfp_sche_graceperiod)) { // apply Grace Period for this criteria
                        gracePeriod = parseInt(configRecord.msnfp_sche_graceperiod);
                        if (!checkGracePeriod && nextDonationDate.getDate() >= gracePeriod && recurrenceStart != RecurrenceStart.CurrentDay)
                            nextDonationDate.setMonth(nextDonationDate.getMonth() + 1);
                    }
                }
                else if (recurrenceStart == RecurrenceStart.FifteenoOftheMonth) {
                    nextDonationDate = getFifteenthDateOfNextMonth(nextDonationDate.getFullYear(), nextDonationDate.getMonth());

                    if (!isNullOrUndefined(configRecord.msnfp_sche_graceperiod)) { // apply Grace Period for this criteria
                        gracePeriod = parseInt(configRecord.msnfp_sche_graceperiod);
                        if (!checkGracePeriod && nextDonationDate.getDate() >= gracePeriod && recurrenceStart != RecurrenceStart.CurrentDay)
                            nextDonationDate.setMonth(nextDonationDate.getMonth() + 1);
                    }
                }

                if (instance != null) { // After calculate the correct datetime for the next donation, increase the month according to the instance inputted
                    nextDonationDate.setMonth(nextDonationDate.getMonth() - 1 + parseInt(instance));
                }
            }

            nextDonationDate = nextDonationDate.setHours(12);

            entity["msnfp_nextpaymentdate"] = nextDonationDate;
            entity["msnfp_lastpaymentdate"] = new Date();

            return entity;
        }


        function updateLastDonationDate(entity, isUpdate) {
            var nextDonationDate = entity.msnfp_firstpaymentdate;

            if (formType == FormType.Update) {
                if (parent.Xrm.Page.getAttribute('msnfp_nextpaymentdate').getValue() != null) {
                    var utcYear = new Date(parent.Xrm.Page.getAttribute('msnfp_nextpaymentdate').getValue()).getUTCFullYear();
                    var utcMonth = new Date(parent.Xrm.Page.getAttribute('msnfp_nextpaymentdate').getValue()).getUTCMonth();
                    var utcDate = new Date(parent.Xrm.Page.getAttribute('msnfp_nextpaymentdate').getValue()).getUTCDate();

                    var nextDt = new Date(utcYear, utcMonth, utcDate);
                    nextDonationDate = nextDt;//dt;
                }
                else {
                    nextDonationDate = new Date(new Date(nextDonationDate).getUTCFullYear(), new Date(nextDonationDate).getUTCMonth(), new Date(nextDonationDate).getUTCDate());
                }
            }
            else {
                nextDonationDate = new Date(new Date(nextDonationDate).getUTCFullYear(), new Date(nextDonationDate).getUTCMonth(), new Date(nextDonationDate).getUTCDate());
            }

            if (nextDonationDate == null) {
                nextDonationDate = new Date();
            }

            // Get the recurrance frequency (Monthly, Daily, etc):
            var dayType;
            if (parent.Xrm.Page.getAttribute('msnfp_frequency').getValue() != null) {
                dayType = parent.Xrm.Page.getAttribute('msnfp_frequency').getValue();
            }
            else if ($('#ddlRecurringEveryDayType').val() != null) {
                dayType = $('#ddlRecurringEveryDayType').val();
            }

            // Get the interval (every X dayType):
            var instance;
            if (parent.Xrm.Page.getAttribute('msnfp_frequencyinterval').getValue() != null) {
                instance = parent.Xrm.Page.getAttribute('msnfp_frequencyinterval').getValue();
            }
            else if ($('#txtRecurringInstance').val() != null) {
                instance = $('#txtRecurringInstance').val();
            }

            // Get the start date:
            var recurrenceStart;
            if (parent.Xrm.Page.getAttribute('msnfp_frequencystartcode').getValue() != null) {
                recurrenceStart = parent.Xrm.Page.getAttribute('msnfp_frequencystartcode').getValue();
            }
            else if ($('#ddlRecurrenceStart').val() != null) {
                recurrenceStart = $('#ddlRecurrenceStart').val();
            }

            var gracePeriod = 0;

            if (!isNullOrUndefined(configRecord.msnfp_sche_graceperiod)) {
                gracePeriod = parseInt(configRecord.msnfp_sche_graceperiod);

                if (!isUpdate && nextDonationDate.getDate() >= gracePeriod && recurrenceStart != RecurrenceStart.CurrentDay) {
                    nextDonationDate.setMonth(nextDonationDate.getMonth() + 1);
                }
            }


            if (dayType == 844060000 && instance != null) { //Daily
                nextDonationDate.setDate(nextDonationDate.getDate() + parseInt(instance));
            }
            else if (dayType == 844060001 && instance != null) { //Weekly
                nextDonationDate.setDate(nextDonationDate.getDate() + (parseInt(instance) * 7));
            }
            else if (dayType == 844060002)//Monthly
            {
                if (recurrenceStart == RecurrenceStart.CurrentDay) {
                    var lastDateOfCurrentMonth = getLastDateOfMonth(nextDonationDate.getFullYear(), nextDonationDate.getMonth());
                    var lastDateofNextmonth = getLastDateOfMonth(nextDonationDate.getFullYear(), nextDonationDate.getMonth() + 1);

                    if (nextDonationDate.getDate() > lastDateofNextmonth.getDate()) {
                        if (lastDateOfCurrentMonth.getDate() > lastDateofNextmonth.getDate()) {
                            nextDonationDate = getLastDateOfMonth(nextDonationDate.getFullYear(), nextDonationDate.getMonth() + 1);
                        }
                        else {
                            nextDonationDate.setMonth(nextDonationDate.getMonth() + 1);
                        }
                    }
                    else {
                        nextDonationDate.setMonth(nextDonationDate.getMonth() + 1);
                    }
                }
                else if (recurrenceStart == RecurrenceStart.FirstOftheMonth) {
                    nextDonationDate = getFirstDateOfNextMonth(nextDonationDate.getFullYear(), nextDonationDate.getMonth());
                }
                else if (recurrenceStart == RecurrenceStart.FifteenoOftheMonth) {
                    nextDonationDate = getFifteenthDateOfNextMonth(nextDonationDate.getFullYear(), nextDonationDate.getMonth());
                }
            }
            else if (dayType == 844060003 && instance != null) { //Annually
                nextDonationDate.setFullYear(nextDonationDate.getFullYear() + parseInt(instance));
            }

            nextDonationDate = (nextDonationDate.getMonth() + 1) + '/' + nextDonationDate.getDate() + '/' + nextDonationDate.getFullYear();
            nextDonationDate = new Date(nextDonationDate);

            // Now add the number of months:
            if (instance != null && dayType == 844060002) {
                nextDonationDate.setMonth(nextDonationDate.getMonth() - 1 + parseInt(instance));
            }

            nextDonationDate = nextDonationDate.setHours(12);

            entity["msnfp_nextpaymentdate"] = DSTOffsetYYYYMMDD(new Date(nextDonationDate));
            entity["msnfp_lastpaymentdate"] = new Date();

            console.log("nextDonationDate = " + nextDonationDate);

            return entity;
        }

        var getLastDateOfMonth = function (y, m) {
            return new Date(y, m + 1, 0);
        }

        var getFirstDateOfNextMonth = function (y, m) {
            return new Date(y, m + 1);
        }

        var getFifteenthDateOfNextMonth = function (y, m) {
            return new Date(y, m + 1, 15);
        }

        //Pledge Schedule
        function addRemoveScheduleFields() {
            $('.donationPledgeSchedule').hide();
            $('#btnProcess').val('Process >');
            $('#txtScheduleStartDate, #txtScheduleInstance, #ddlScheduleEveryDayType').closest('div').removeClass('mandatory');

            var selectedVal = $('input[name=donationPledgeType]:checked').val();

            var dt = parent.Xrm.Page.getAttribute('msnfp_bookdate').getValue();
            if (selectedVal == DonationPledgeTypeForm.PledgeSchedule) {
                $('#btnProcess').show();
                $('.donationPledgeSchedule').show();
                $('#btnProcess').val('Generate Pledge Allocations >');

                $('#txtScheduleStartDate, #txtScheduleInstance, #ddlScheduleEveryDayType').closest('div').addClass('mandatory');
                $('#txtScheduleStartDate').val(getFormattedDate(dt));

                if (parent.Xrm.Page.getAttribute('msnfp_frequencyinterval').getValue() != null) {
                    $('#txtScheduleInstance').val(parent.Xrm.Page.getAttribute('msnfp_frequencyinterval').getValue());
                }
                if (parent.Xrm.Page.getAttribute('msnfp_frequency').getValue() != null) {
                    $('#ddlScheduleEveryDayType').val(parent.Xrm.Page.getAttribute('msnfp_frequency').getValue());
                }
            }
        }

        function bindDonation_PledgeSchedule() {
            var selectedDonation = $('input[name=donationPledgeType]:checked').val();

            if (selectedDonation == DonationPledgeTypeForm.PledgeSchedule && document.getElementById("PledgeScheduleModal").style.display != "block") {
                if (isActive) {
                    $('.divLinkExistingPledgeNull, .divUpdateWireDepositDate,.divUpdateChequeDepositDate, .divProcess, .subsequent-main').hide();
                }
                else {
                    $('.divLinkExistingPledgeNull, .divUpdateWireDepositDate ,.divUpdateChequeDepositDate, .divAmount, .divProcess, .subsequent-main').hide();
                }

                $('#donationInfo, .donationPledgeSchedule').show();

                $('#txtDonorName').closest('div').hide();
                $('#txtInHonorMemoryOf').closest('div').hide();

                $('#radioBankACH').next('label').hide();

                if (donationPledge.msnfp_firstpaymentdate != null && donationPledge.msnfp_firstpaymentdate != '') {
                    var str = donationPledge.msnfp_firstpaymentdate.split('-');
                    var _date = new Date(str[0] + '-' + str[1] + '-' + str[2]);
                    var _utcdate = new Date(_date.getUTCFullYear(), _date.getUTCMonth(), _date.getUTCDate(), _date.getUTCHours(), _date.getUTCMinutes(), _date.getUTCSeconds());
                    $('#txtScheduleStartDate').val(getFormattedDate(_utcdate));
                }

                $('#txtScheduleInstance').val(donationPledge.msnfp_frequencyinterval);
                $('#ddlScheduleEveryDayType').val(donationPledge.msnfp_frequency);

                searchTable = $('#pledgeScheduleTable').DataTable({
                    "info": false,
                    "bPaginate": true,
                    "bFilter": false,
                    "bLengthChange": false,
                    "sPaginationType": "numbers",
                    "iDisplayLength": 5,
                    "columnDefs": [
                        { "orderable": false, "width": "20%", "targets": 0, "className": "dt-center" },
                        { "width": "9%", "targets": 1, "className": "dt-center" },
                        { "width": "9%", "targets": 2, "className": "dt-center" },
                        { "width": "9%", "targets": 3, "className": "dt-center", "visible": false },
                        { "width": "9%", "targets": 4, "className": "dt-center", "visible": false },
                        { "width": "9%", "targets": 5, "className": "dt-center" },
                        { "width": "12%", "targets": 6, "className": "dt-center" }
                    ],
                    "initComplete": function () {
                        $(document).on("click", "th[role='columnheader']", function () {
                            if (document.getElementById('PledgeScheduleModal').style.display != "block") {
                                PledgeScheduleModal.style.display = "block";
                                document.getElementById('divPledgeScheduleModalDiv').style.display = "block";
                                bindDonation_PledgeSchedule();
                            }
                        });
                    }
                });

                bindPledgeScheduleList();
            }
            if (document.getElementById("PledgeScheduleModal").style.display == "block") {

                searchTable = $('#pledgeScheduleTableModal').DataTable({
                    "info": false,
                    "bPaginate": true,
                    "bFilter": false,
                    "bLengthChange": false,
                    "sPaginationType": "numbers",
                    "iDisplayLength": 5,
                    "columnDefs": [
                        { "orderable": false, "width": "20%", "targets": 0, "className": "dt-center" },
                        { "width": "9%", "targets": 1, "className": "dt-center" },
                        { "width": "9%", "targets": 2, "className": "dt-center" },
                        { "width": "9%", "targets": 3, "className": "dt-center" },
                        { "width": "9%", "targets": 4, "className": "dt-center" },
                        { "width": "9%", "targets": 5, "className": "dt-center" },
                        { "width": "12%", "targets": 6, "className": "dt-center" }
                    ]
                });

                bindPledgeScheduleList();
            }
        }

        var pledgeAllocationList = [];
        function bindPledgeScheduleList() {
            var select = "msnfp_donorcommitments?$select=msnfp_donorcommitmentid,msnfp_totalamount,statuscode,_msnfp_parentscheduleid_value,msnfp_bookdate,msnfp_totalamount_balance,msnfp_totalamount_paid&$orderby=msnfp_bookdate";
            var filter = "&$filter=(_msnfp_parentscheduleid_value eq " + currentID + ")";
            XrmServiceUtility.ExecuteQueryAsync(XrmServiceUtility.GetWebAPIUrl() + select + filter, successPledgeScheduleList);
        }

        function successPledgeScheduleList(result) {
            pledgeAllocationList = result;
            var total = result.length;

            $(result).each(function (index) {
                var pledgeAllocationId = this.msnfp_donorcommitmentid;

                var button = null;
                var buttonDonation = null;

                var utcYear = new Date(this.msnfp_bookdate).getUTCFullYear();
                var utcMonth = new Date(this.msnfp_bookdate).getUTCMonth();
                var utcDate = new Date(this.msnfp_bookdate).getUTCDate();

                var date = new Date(utcYear, utcMonth, utcDate);

                if (this.statuscode == 1) {
                    if (index === total - 1) {
                        button = "<input class='btnRemovePledgeAllocation main-button' style='margin: 1px;' type='button' disabled value='Remove' data-id='" +
                            pledgeAllocationId +
                            "' data-amount='" +
                            this.msnfp_totalamount +
                            "' data-amountowing='" +
                            this.msnfp_totalamount_balance +
                            "' data-date='" +
                            date +
                            "' />";
                    }
                    else {

                        if (this.msnfp_totalamount_paid > 0) {
                            button = "<input class='btnRemovePledgeAllocation main-button' style='margin: 1px;' type='button' value='Remove' role='button' data-id='" +
                                pledgeAllocationId +
                                "' data-amount='" +
                                this.msnfp_totalamount +
                                "' data-amountowing='" +
                                this.msnfp_totalamount_balance +
                                "' data-date='" +
                                date +
                                "' />";
                        } else {
                            button = "<input class='btnRemovePledgeAllocation main-button' style='margin: 1px;' type='button' role='button' value='Remove' data-id='" +
                                pledgeAllocationId +
                                "' data-amount='" +
                                this.msnfp_totalamount +
                                "' data-amountowing='" +
                                this.msnfp_totalamount_balance +
                                "' data-date='" +
                                date +
                                "' />";
                        }

                    }
                    if (this.msnfp_totalamount_balance > 0) {
                        buttonDonation = "<input class='btnAddDonation main-button' title='Create new donation' style='margin: 1px;' type='button' role='button' value='Donation' data-id='" +
                            pledgeAllocationId +
                            "' data-amount='" +
                            this.msnfp_totalamount +
                            "' data-amountowing='" +
                            this.msnfp_totalamount_balance +
                            "' data-date='" +
                            date +
                            "' />";
                    }
                    else {
                        buttonDonation = "<input class='btnAddDonation main-button' style='margin: 1px; display: none;' type='button' role='button' value='Donation' data-id='" +
                            pledgeAllocationId +
                            "' data-amount='" +
                            this.msnfp_totalamount +
                            "' data-amountowing='" +
                            this.msnfp_totalamount_balance +
                            "' data-date='" +
                            date +
                            "' />";
                    }
                }
                else {

                    if (this.msnfp_totalamount_paid > 0) {
                        button = "<input class='btnRemovePledgeAllocation main-button' style='margin: 1px;' type='button' role='button' disabled value='Remove' data-id='" +
                            pledgeAllocationId +
                            "' data-amount='" +
                            this.msnfp_totalamount +
                            "' data-amountowing='" +
                            this.msnfp_totalamount_balance +
                            "' data-date='" +
                            date +
                            "' />";
                    } else {
                        button = "<input class='btnRemovePledgeAllocation main-button' style='margin: 1px;' type='button' role='button' value='Remove' data-id='" +
                            pledgeAllocationId +
                            "' data-amount='" +
                            this.msnfp_totalamount +
                            "' data-amountowing='" +
                            this.msnfp_totalamount_balance +
                            "' data-date='" +
                            date +
                            "' />";
                    }

                    if (this.msnfp_totalamount_balance > 0) {
                        var buttonDonation = "<input class='btnAddDonation main-button' title='Create new donation' role='button' style='margin: 1px;' type='button' value='Donation' data-id='" +
                            pledgeAllocationId +
                            "' data-amount='" +
                            this.msnfp_totalamount +
                            "' data-amountowing='" +
                            this.msnfp_totalamount_balance +
                            "' data-date='" +
                            date +
                            "' />";
                    }
                    else {
                        var buttonDonation = "<input class='btnAddDonation main-button' style='margin: 1px; display: none;' role='button' type='button' disabled value='Donation' data-id='" +
                            pledgeAllocationId +
                            "' data-amount='" +
                            this.msnfp_totalamount +
                            "' data-amountowing='" +
                            this.msnfp_totalamount_balance +
                            "' data-date='" +
                            date +
                            "' />";
                    }
                }

                var dropdown = null;
                var amountInput = null;
                var dateInput = null;
                var amountOwingInput = null;
                var amountPaidInput = null;

                if (this.statuscode == 1 || (this.statuscode == 844060000 && this.msnfp_totalamount_balance != 0)) {
                    dropdown = $('<select class="ddlPledgeAllocationStatus" aria-label="Select - Status" style="height: 30px;margin-top: 5px;" role="listbox" />');
                }
                else if (this.statuscode == 844060000 && this.msnfp_totalamount_balance == 0) {
                    dropdown = $('<select class="ddlPledgeAllocationStatus" aria-label="Select - Status" role="listbox" style="height: 30px;margin-top: 5px;" disabled/>');
                }

                if (this.statuscode == 1 || (this.statuscode == 844060000 && this.msnfp_totalamount_balance != 0)) {
                    $('<option />', { value: 1, text: 'In Progress', selected: 'selected' }).appendTo(dropdown);
                }
                else {
                    $('<option />', { value: 1, text: 'In Progress' }).appendTo(dropdown);
                }

                if (this.statuscode == 844060000 && this.msnfp_totalamount_balance == 0) {
                    $('<option />', { value: 844060000, text: 'Paid', selected: 'selected' }).appendTo(dropdown);
                }
                else {
                    $('<option />', { value: 844060000, text: 'Paid' }).appendTo(dropdown);
                }

                var amount = currencySymbol + (!isNullOrUndefined(this.msnfp_totalamount) ? addCommasonLoad(parseFloat(this.msnfp_totalamount).toFixed(2)) : 0);
                var amountOwing = currencySymbol + (!isNullOrUndefined(this.msnfp_totalamount_balance) ? addCommasonLoad(parseFloat(this.msnfp_totalamount_balance).toFixed(2)) : 0);
                var amountPaid = currencySymbol + (!isNullOrUndefined(this.msnfp_totalamount_paid) ? addCommasonLoad(parseFloat(this.msnfp_totalamount_paid).toFixed(2)) : 0); //=0;

                if (this.statuscode == 844060000 && this.msnfp_totalamount_balance == 0) {
                    amountInput = "<input type='text' aria-label='Amount' style='width: 90px;margin: 0.5px !important;padding-left: 2px; padding-right: 0.5px;' value='" + amount + "' disabled>";
                    dateInput = "<input type='text' aria-label='Date' class='dtCalendar' style='width: 67px;margin: 0.5px !important;padding-left: 1px; padding-right: 0.5px;' value='" + getFormattedDate(date) + "' disabled>";
                    amountOwingInput = "<input type='text' aria-label='Balance' style='width: 90px; margin: 0.5px !important;padding-left: 2px; padding-right: 0.5px;' value='" + amountOwing + "' readonly disabled>";
                    amountPaidInput = "<input type='text' aria-label='Amount Paid' style='width: 90px; margin: 0.5px !important;padding-left: 2px; padding-right: 0.5px;' value='" + amountPaid + "' readonly disabled>";
                }
                else {
                    amountInput = "<input type='text' aria-label='Amount' style='width: 90px;margin: 0.5px !important;padding-left: 2px; padding-right: 0.5px;' value='" + amount + "'>";
                    dateInput = "<input type='text' aria-label='Date' class='dtCalendar' style='width: 67px;margin: 0.5px !important;padding-left: 1px; padding-right: 0.5px;' value='" + getFormattedDate(date) + "'>";
                    amountOwingInput = "<input type='text' aria-label='Balance' style='width: 90px; margin: 0.5px !important;padding-left: 2px; padding-right: 0.5px;' value='" + amountOwing + "' readonly>";
                    amountPaidInput = "<input type='text' aria-label='Amount Paid' style='width: 90px; margin: 0.5px !important;padding-left: 2px; padding-right: 0.5px;' value='" + amountPaid + "' readonly>";
                }

                searchTable.row.add([
                    button,
                    dateInput,
                    amountInput,
                    amountOwingInput,
                    amountPaidInput,
                    $(dropdown)[0].outerHTML,
                    buttonDonation
                ]).draw(false);
            });

            $(".dtCalendar").datepicker({
                dateFormat: 'mm/dd/yy',
                minDate: 0
            });

            bindRemovePledgeAllocation();
            bindChangePledgeAllocationStatus();
            $('.pledgeScheduleList').show();
        }

        // This function has been changed drastically, as we only need to create pledge records not allocations anymore.
        function generatePledgeRecords() {
            var scheduleStartDate;
            var instance;
            var amount;

            if (formType == FormType.Update) {
                scheduleStartDate = new Date(donationPledge.msnfp_startondate);
                instance = donationPledge.msnfp_recurrenceinstance;
                amount = parseFloat($('#txtAmount').val().replace(currencySymbol, '').replace(/[^\d\.\-]/g, ""));
            }
            else {
                var dt = new Date($('#txtScheduleStartDate').val()).getDate();
                scheduleStartDate = new Date($('#txtScheduleStartDate').val());
                instance = parseInt($('#txtScheduleInstance').val());
                amount = parseFloat($('#txtAmount').val().replace(currencySymbol, '').replace(/[^\d\.\-]/g, ""));

                scheduleStartDate.setDate(dt);
            }

            // If it is still undefined, try and get it from the dynamics field:
            if (parent.Xrm.Page.getAttribute('msnfp_frequencyinterval').getValue() != null && isNullOrUndefined(instance)) {
                instance = parent.Xrm.Page.getAttribute('msnfp_frequencyinterval').getValue();
            }

            if (isNullOrUndefined(scheduleStartDate) || scheduleStartDate == "Invalid Date") {
                scheduleStartDate = new Date($('#txtScheduleStartDate').val());
            }

            var dayType = $('#ddlScheduleEveryDayType').val();
            var calculateAmount = amount / instance;
            calculateAmount = calculateAmount.toFixed(2);
            var lastAmount = 0;
            if ((calculateAmount * instance) < amount) {
                lastAmount = amount - (calculateAmount * instance);
            }

            // For the number of instances selected, create a pledge for each:
            for (var i = 0; i < instance; i++) {
                var entity = {};

                if (parent.Xrm.Page.getAttribute("msnfp_name").getValue() != null) {
                    entity["msnfp_name"] = parent.Xrm.Page.getAttribute("msnfp_name").getValue() + " Pledge Allocation " + (i + 1);
                }
                else {
                    entity["msnfp_name"] = "Unnamed Pledge Allocation " + (i + 1);
                }

                if (i == instance - 1) {
                    entity["msnfp_totalamount"] = parseFloat(parseFloat(calculateAmount) + parseFloat(lastAmount.toFixed(2)));
                    entity["msnfp_totalamount_balance"] = parseFloat(parseFloat(calculateAmount) + parseFloat(lastAmount.toFixed(2)));
                }
                else {
                    entity["msnfp_totalamount"] = parseFloat(calculateAmount);
                    entity["msnfp_totalamount_balance"] = parseFloat(calculateAmount);
                }

                entity["msnfp_totalamount_paid"] = 0;

                entity["msnfp_ParentScheduleId@odata.bind"] = "/msnfp_paymentschedules(" + currentID + ")";
                entity["statuscode"] = 1; //In Progress

                // Set the Donor:
                if (selectedDonor.isAccount) {
                    entity["msnfp_CustomerId_account@odata.bind"] = "/accounts(" + selectedDonor.accountid + ")";
                }
                else {
                    entity["msnfp_CustomerId_contact@odata.bind"] = "/contacts(" + selectedDonor.contactid + ")";
                }

                // Set the Campaign:
                campaignEventID = XrmUtility.CleanGuid(parent.Xrm.Page.data.entity.attributes.get("msnfp_originatingcampaignid").getValue()[0].id);
                if (!isNullOrUndefined(campaignEventID)) {
                    entity["msnfp_Commitment_CampaignId@odata.bind"] = "/campaigns(" + campaignEventID + ")";
                }
                else {
                    entity["msnfp_Commitment_CampaignId"] = null;
                }

                // Set Appeal:
                if (parent.Xrm.Page.data.entity.attributes.get("msnfp_appealid").getValue() != null) {
                    psAppealID = XrmUtility.CleanGuid(parent.Xrm.Page.data.entity.attributes.get("msnfp_appealid").getValue()[0].id);
                    if (!isNullOrUndefined(psAppealID)) {
                        entity["msnfp_AppealId@odata.bind"] = "/msnfp_appeals(" + psAppealID + ")";
                    }
                    else {
                        entity["msnfp_AppealId"] = null;
                    }
                }

                // Set Package:
                if (parent.Xrm.Page.data.entity.attributes.get("msnfp_packageid").getValue() != null) {
                    psPackageID = XrmUtility.CleanGuid(parent.Xrm.Page.data.entity.attributes.get("msnfp_packageid").getValue()[0].id);
                    if (!isNullOrUndefined(psPackageID)) {
                        entity["msnfp_PackageId@odata.bind"] = "/msnfp_packages(" + psPackageID + ")";
                    }
                    else {
                        entity["msnfp_PackageId"] = null;
                    }
                }

                // Set the Primary Designation:
                if (parent.Xrm.Page.data.entity.attributes.get("msnfp_designationid").getValue() != null) {
                    primaryDesignationID = XrmUtility.CleanGuid(parent.Xrm.Page.data.entity.attributes.get("msnfp_designationid").getValue()[0].id);
                    if (!isNullOrUndefined(primaryDesignationID)) {
                        entity["msnfp_Commitment_DefaultDesignationId@odata.bind"] = "/msnfp_designations(" + primaryDesignationID + ")";
                    }
                    else {
                        entity["msnfp_Commitment_DefaultDesignationId"] = null;
                    }
                }
                else {
                    entity["msnfp_Commitment_DefaultDesignationId"] = null;
                }

                // Set the Gift Source:
                if ($('input[name=giftSource]:checked').val() != undefined) {
                    entity["msnfp_dataentrysource"] = $('input[name=giftSource]:checked').val();
                }

                // Set the Related Constituent:
                let cons = getConstituent();
                if (cons) entity["msnfp_ConstituentId@odata.bind"] = cons;

                entity["msnfp_firstname"] = $('#txtFirstName').val();
                entity["msnfp_lastname"] = $('#txtLastName').val();
                entity["msnfp_emailaddress1"] = $('#txtEmail').val();
                entity["msnfp_telephone1"] = $('#txtPhone').val();
                entity["msnfp_telephone2"] = $('#txtAltPhone').val();
                entity["msnfp_mobilephone"] = $('#txtMobilePhone').val();
                entity["msnfp_billing_line1"] = $('#txtAddressLine1').val();
                entity["msnfp_billing_line2"] = $('#txtAddressLine2').val();
                entity["msnfp_billing_line3"] = $('#txtAddressLine3').val();
                entity["msnfp_billing_city"] = $('#txtAddressCity').val();
                entity["msnfp_billing_stateorprovince"] = $('#txtAddressProvince').val();
                entity["msnfp_billing_postalcode"] = $('#txtAddressPostalCode').val();
                entity["msnfp_billing_country"] = $('#txtAddressCountry').val();

                var date = new Date(scheduleStartDate);
                if (dayType == 844060000) {
                    date.setDate(date.getDate() + i);
                }
                else if (dayType == 844060001) {
                    date.setDate(date.getDate() + (i * 7));
                }
                else if (dayType == 844060002) {
                    date.setMonth(date.getMonth() + i);
                }
                else if (dayType == 844060003) {
                    date.setFullYear(date.getFullYear() + i);
                }

                date = date.getMonth() + 1 + '/' + date.getDate() + '/' + date.getFullYear();
                entity["msnfp_bookdate"] = new Date(date);

                entity["msnfp_anonymous"] = $('input[name=anonymousDonation]:checked').val();
                var qry = XrmServiceUtility.GetWebAPIUrl() + "msnfp_donorcommitments";
                XrmServiceUtility.CreateRecord(qry, entity);
            }

            xrm.Utility.closeProgressIndicator();
        }

        function bindChangePledgeAllocationStatus() {
            $('.ddlPledgeAllocationStatus').change(function () {
                var button = $($(this).closest('tr').find('input')[0]);
                var pledgeId = button.data('id');

                var entity = {};
                entity['statuscode'] = parseInt($(this).val());

                var qry = XrmServiceUtility.GetWebAPIUrl() + "msnfp_donorcommitments(" + pledgeId + ")";
                XrmServiceUtility.UpdateRecord(qry, entity);

                $('#pledgeScheduleTable').DataTable().clear();
                bindPledgeScheduleList();
            });
        }

        function bindRemovePledgeAllocation() {
            var dt = $("#pledgeScheduleTable").DataTable();
            if (document.getElementById('PledgeScheduleModal').style.display == "block") {
                dt = $('#pledgeScheduleTableModal').DataTable();
            }
            var isUpdated = false;
            var currentTR = null;

            $('.btnRemovePledgeAllocation').click(function () {
                currentTR = $(this).closest('tr');

                var currentAllocationID = $(dt.row(currentTR).data()[0]).data('id');
                var currentRowAmount = $(dt.row(currentTR).data()[0]).data('amount');
                var currentRowAmountOwing = $(dt.row(currentTR).data()[0]).data('amountowing');
                if (confirm('Are you sure to remove this Pledge record?')) {
                    XrmServiceUtility.DeleteRecord(currentAllocationID, 'msnfp_donorcommitments');
                    // Now we update the next remaining amount accordingly:
                    for (var i = (currentTR.index() + 1); i < dt.rows().count(); i++) {
                        if (!isUpdated && dt.row().index() != undefined) {
                            var paidAmount = $(dt.row(dt.row(i)).data()[4]).val().replace(currencySymbol, '');
                            var isInProgress = $(dt.row(dt.row(i)).data()[5]).val();

                            if (parseInt(isInProgress) == 1 && parseFloat(paidAmount) <= 0)//Pledge allocation status = In Progress
                            {
                                var nextRowAmount = $(dt.row(dt.row(i)).data()[0]).data('amount');
                                var nextAllocationID = $(dt.row(dt.row(i)).data()[0]).data('id');
                                var nextRowAmountOwing = $(dt.row(dt.row(i)).data()[0]).data('amountowing');

                                pledgeAllocationEntity = {};
                                var totalAmount = currentRowAmount + nextRowAmount;
                                pledgeAllocationEntity["msnfp_totalamount"] = totalAmount;

                                var totalAmountOwing = currentRowAmountOwing + nextRowAmountOwing;
                                pledgeAllocationEntity["msnfp_totalamount_balance"] = totalAmountOwing;

                                isUpdated = true;
                                currentTR.remove();
                                var qryPA = XrmServiceUtility.GetWebAPIUrl() + "msnfp_donorcommitments(" + nextAllocationID + ")";
                                XrmServiceUtility.UpdateRecord(qryPA, pledgeAllocationEntity, updatePledgeAllocation, errorFailure);
                                // Visually remove the row. Alternatively, could use searchtable.clear() and rebind the schedule list:
                                currentTR.remove();
                                reloadOnUpdateSuccess();
                            }
                        }
                    }
                }
            });

            $('.btnAddDonation').click(function () {
                var pledgeAllocationId = $(this).data('id');
                var amount = parseFloat($(this).data('amountowing'));

                var parameters = {};
                parameters["param_msnfp_pledgeallocationid"] = pledgeAllocationId;
                parameters["param_msnfp_type"] = DonationPledgeType.Donation; //Donation
                parameters["param_msnfp_amount"] = amount;
                parameters["param_pledge_donationid"] = currentID;
                parameters["param_msnfp_constituentid"] = parent.Xrm.Page.data.entity.attributes.get("msnfp_constituentid").getValue();
                parameters["msnfp_anonymous"] = parent.Xrm.Page.data.entity.attributes.get("msnfp_anonymity").getValue();

                if (selectedDonor.isAccount) {
                    parameters["param_msnfp_customerid"] = selectedDonor.accountid;
                    parameters["param_msnfp_customeridname"] = selectedDonor.name;
                    parameters["param_msnfp_customeridtype"] = "account";
                }
                else {
                    parameters["param_msnfp_customerid"] = selectedDonor.contactid;
                    parameters["param_msnfp_customeridname"] = selectedDonor.fullname;
                    parameters["param_msnfp_customeridtype"] = "contact";
                }

                // Here, we are adding a donation to the pledge. So we open the transaction record and associate this pledge to that new donation:
                xrm.Utility.openEntityForm("msnfp_transaction", null, parameters, true);
            });
        }

        function updatePledgeAllocation(recordID) {
            $('#pledgeScheduleTable').DataTable().clear();
            $('#pledgeScheduleTableModal').DataTable().clear();
            bindPledgeScheduleList();
        }

        function regeneratePledgeRecords() {
            var entity = {};
            entity["msnfp_amount_receipted"] = parseFloat($('#txtAmount').val().replace(currencySymbol, '').replace(/[^\d\.\-]/g, ""));
            entity["msnfp_recurringamount"] = parseFloat($('#txtAmount').val().replace(currencySymbol, '').replace(/[^\d\.\-]/g, ""));

            var qry = XrmServiceUtility.GetWebAPIUrl() + "msnfp_paymentschedules(" + currentID + ")";
            XrmServiceUtility.UpdateRecord(qry, entity);

            $(pledgeAllocationList).each(function (index) {
                var id = pledgeAllocationList[index].msnfp_donorcommitmentid;
                XrmServiceUtility.DeleteRecord(id, 'msnfp_donorcommitments');
            });

            generatePledgeRecords();
            savedDonationSuccessfully();
        }


        //add Membership to Donation
        var membershipGroupList = [];
        var membershipList = [];
        var isLoaded = false;

        function loadGroupOrderList() {
            if (!isLoaded) {
                membershipList = [];

                var goQuery = "msnfp_membershiporders?";
                goQuery += "$select=_msnfp_frommembershipid_value,_msnfp_tomembershipgroupid_value,msnfp_order&$orderby=msnfp_order asc";
                var goResult = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + goQuery);

                $(goResult).each(function () {
                    if (!isNullOrUndefined(this._msnfp_tomembershipgroupid_value)) {
                        var mgQuery = "msnfp_membershipgroups?";
                        mgQuery += "$select=msnfp_membershipgroupid,msnfp_identifier,msnfp_groupname";
                        mgQuery += "&$filter=msnfp_membershipgroupid eq " + this._msnfp_tomembershipgroupid_value;
                        var mgResult = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + mgQuery);

                        if (!isNullOrUndefined(mgResult)) {
                            membershipGroupList.push(mgResult[0]);
                        }
                    }
                });

                membershipGroupList = membershipGroupList.distinctMembershipGroup();
                membershipGroupList = membershipGroupList.sort(listSorter);

                $(membershipGroupList).each(function (index) {
                    if (!isLoaded) {
                        var link = $("<a>");
                        link.addClass("tab");
                        link.attr('id', 'Tab' + this.msnfp_groupname);
                        link.attr('title', 'divMGroup' + index);
                        link.attr("href", "javascript:void(0);");
                        link.text(this.msnfp_groupname);

                        $('.tabview').append(link);
                    }
                });

                $(membershipGroupList).each(function (index) {
                    if (!isLoaded) {
                        $('.tabview').append($('.membershipGroup-clone').clone());
                        var divAddedMembershipGroup = $('.tabview .membershipGroup-clone');
                        $(divAddedMembershipGroup).removeClass('membershipGroup-clone').addClass('divMembershipGroup');
                        $(divAddedMembershipGroup).attr('id', 'divMGroup' + index);
                        $($(divAddedMembershipGroup).find('table')[0]).attr('id', 'tblMGroup' + index);
                        //$($(divAddedMembershipGroup).find('table')[0]).attr('tabIndex', "0");

                        var tblName = 'tblMGroup' + index;
                        var tblDT;

                        if ($.fn.DataTable.isDataTable('#' + tblName)) {
                            $('#tblMGroup' + index).DataTable().clear();
                            tblDT = $('#tblMGroup' + index).DataTable();
                        }
                        else {
                            tblDT = $('#tblMGroup' + index).DataTable({
                                "pagingType": "numbers",
                                "tabIndex": 0,
                                "paging": true,
                                "searching": false,
                                "lengthChange": false,
                                "info": false,
                                "pageLength": 5,
                                "columnDefs": [
                                    { "className": "dt-center", "width": "10%", "targets": 0 },
                                    { "width": "55%", "targets": 1 },
                                    { "width": "35%", "targets": 2 },
                                ],
                            });
                        }

                        membershipList = getMembershipCategoriesForThisGroup(this.msnfp_membershipgroupid);

                        $(membershipList).each(function () {
                            var rdoBtn = "<input type='checkbox' data-id='" + this.msnfp_membershipcategoryid + "' name='chkMembership' class='chkMembership' aria-label='Select this Membership'/>";
                            var name = !isNullOrUndefined(this.msnfp_name) ? this.msnfp_name : "";
                            //if (!isNullOrUndefined(this.msnfp_name)) var name = "<input type='text' tabindex='0' value='" + this.msnfp_name + "' readonly/>";
                            //else var name = "<input type='text' tabindex='0' value='' readonly/>";
                            //var baseCost = currencySymbol + (!isNullOrUndefined(this.msnfp_amount) ? this.msnfp_amount : 0);
                            var baseCost = currencySymbol + (!isNullOrUndefined(this.msnfp_amount) ? addCommasonLoad(parseFloat(this.msnfp_amount).toFixed(2)) : 0);
                            //if (!isNullOrUndefined(this.msnfp_amount)) var baseCost = "<input type='text' tabindex='0' value='" + addCommasonLoad(parseFloat(this.msnfp_amount).toFixed(2)) + "' readonly/>";
                            //else var baseCost = "<input type='text' tabindex='0' value='0' readonly/>";
                            tblDT.row.add([
                                rdoBtn,
                                name,
                                baseCost
                            ]).draw(false);
                        });
                        $("#tblMGroup" + index + " td").each(function () {
                            $(this).attr("tabindex", "0");
                        });

                    }
                });
            }

            isLoaded = true;

            // Remove all active:
            $('.tabview').children('a').each(function () {
                $(this).removeClass('tab-active');
            });

            // Add active to the first:
            $('.tabview a:first').addClass('tab-active');

            $('.tabview').children('div.divMembershipGroup').each(function () {
                // Show table:
                if ($(this)[0].id == $('.tabview').find('a:first')[0].title) {
                    $(this).show();
                    $($($(this)[0]).find('table')[0]).css('display', 'table');
                    var hiddenTable = $($($(this)[0]).find('table')[0]);
                    hiddenTable.removeAttr("hidden"); //table stripe hover dataTable no-footer
                    hiddenTable.removeAttr("aria-hidden");
                }
                // Hide table:
                else {
                    $($($(this)[0]).find('table')[0]).css('display', 'none')
                    $(this).hide();
                    var hiddenTable = $($($(this)[0]).find('table')[0]);
                    hiddenTable.removeAttr("hidden");
                    hiddenTable.removeAttr("aria-hidden");

                }
            });

            $('.tabview').children('a').each(function () {
                $(this).click(function (e) {
                    manageMembershipTab(this);
                });
            });

            $('.chkMembership').click(function () {

                $('input.chkMembership').not(this).prop('checked', false);
            });
        }

        function manageMembershipTab(current) {
            $('.tabview').children('a').each(function () {
                if (this === current) {
                    $(this).addClass('tab-active');
                    $('#' + this.title).show();
                    $($('#' + this.title).find('table')[0]).css('display', 'table');
                }
                else {
                    $(this).removeClass('tab-active');
                    $($('#' + this.title).find('table')[0]).css('display', 'none');
                    $('#' + this.title).hide();
                }
            });
        }

        function getMembershipCategoriesForThisGroup(mGroupID) {
            var apiQuery = XrmServiceUtility.GetWebAPIUrl() + "msnfp_membershipcategories";
            var fetchXML = '<fetch distinct="true" mapping="logical" output-format="xml-platform" version="1.0">' +
                '<entity name="msnfp_membershipcategory">' +
                '<attribute name="msnfp_membershipcategoryid"/>' +
                '<attribute name="msnfp_name"/>' +
                '<attribute name="msnfp_amount"/>' +
                '<attribute name="msnfp_amount_tax"/>' +
                '<attribute name="msnfp_amount_membership"/>' +
                '<link-entity name="msnfp_membershiporder" alias="ah" to="msnfp_membershipcategoryid" from="msnfp_frommembershipid">' +
                '<attribute name="msnfp_order"/>' +
                '<filter type="and">' +
                '<condition attribute="msnfp_tomembershipgroupid" value="' + mGroupID + '" uitype="msnfp_membershipgroup" operator="eq"/>' +
                '</filter>' +
                '<order attribute="msnfp_order" descending="false" />' +
                '</link-entity>' +
                '</entity>' +
                '</fetch>';
            var encodedFetchXML = encodeURIComponent(fetchXML);

            var results;
            var req = new XMLHttpRequest();
            req.open("GET", apiQuery + "?fetchXml=" + encodedFetchXML, false);
            req.setRequestHeader("OData-MaxVersion", "4.0");
            req.setRequestHeader("OData-Version", "4.0");
            req.setRequestHeader("Accept", "application/json");
            req.setRequestHeader("Prefer", "odata.include-annotations=\"OData.Community.Display.V1.FormattedValue\"");
            req.onreadystatechange = function () {
                if (this.readyState === 4) {
                    req.onreadystatechange = null;
                    if (this.status === 200) {
                        results = JSON.parse(this.responseText);
                        if (!isNullOrUndefined(results) && results.value.length > 0)
                            results = results.value;
                    }
                    else {
                        console.log("Error: status - " + this.status);
                    }
                }
            };
            req.send();

            return results;
        }


        // Here we create the instance of the membership for this gift:
        function createMembershipFromMembershipCategory(membershipCategoryGUID) {
            console.log("Entering: createMembershipFromMembershipCategory");
            if (membershipCategoryGUID != null) {
                var query = "msnfp_membershipcategories?";
                query += "$select=msnfp_membershipcategoryid,msnfp_amount,msnfp_amount_membership,msnfp_amount_tax,msnfp_name,msnfp_membershipduration,msnfp_renewaldate&";
                query += "$filter=msnfp_membershipcategoryid eq " + membershipCategoryGUID;
                var result = XrmServiceUtility.ExecuteQuery(XrmServiceUtility.GetWebAPIUrl() + query);

                if (!isNullOrUndefined(result)) {
                    var entity = {};

                    entity["msnfp_MembershipCategoryId@odata.bind"] = "/msnfp_membershipcategories(" + membershipCategoryGUID + ")";

                    console.log("selectedDonor.accountid - " + selectedDonor.accountid);
                    console.log("selectedDonor.contactid - " + selectedDonor.contactid);

                    // Set the name and the customer binding:
                    if (selectedDonor.isAccount) {
                        entity["msnfp_customer_account@odata.bind"] = "/accounts(" + selectedDonor.accountid + ")";
                        entity["msnfp_name"] = result[0].msnfp_name;
                    }
                    else {
                        entity["msnfp_customer_contact@odata.bind"] = "/contacts(" + selectedDonor.contactid + ")";
                        entity["msnfp_name"] = result[0].msnfp_name;
                    }

                    // Date from today:
                    entity["msnfp_startdate"] = getFormattedDateYYYYMMDD(new Date());

                    // The Date To field is set based on the Renewal date of the category + the duration of the category.
                    entity["msnfp_enddate"] = getFormattedDateYYYYMMDD(calculateMembershipExpiryDate(result[0].msnfp_membershipduration));

                    // Temp set to primary:
                    entity["msnfp_primary"] = true;

                    var qry = XrmServiceUtility.GetWebAPIUrl() + "msnfp_memberships";

                    // Now update the gift to link the donation in the saveMembershipSuccess function:
                    membershipInstanceID = XrmServiceUtility.CreateRecord(qry, entity);
                    if (membershipInstanceID != null) {
                        saveMembershipSuccess(membershipInstanceID);
                    }
                }
            }
            else {
                console.log("Error(in createMembershipFromMembershipCategory): membershipCategoryGUID not set.");
            }
        }

        // Now that the membership is saved, update the gift:
        function saveMembershipSuccess(recordID) {
            if (recordID != null && recordID != '') {
                // First update the gift:
                var entity = {};
                entity["msnfp_MembershipInstanceId@odata.bind"] = "/msnfp_memberships(" + recordID + ")";
                var qry = XrmServiceUtility.GetWebAPIUrl() + "msnfp_paymentschedules(" + currentID + ")";
                XrmServiceUtility.UpdateRecord(qry, entity);

                // Then update the contact or account:
                if (selectedDonor.isAccount) {
                    var customerentity = {};
                    customerentity["msnfp_primarymembershipid@odata.bind"] = "/msnfp_memberships(" + recordID + ")";
                    var customerqry = XrmServiceUtility.GetWebAPIUrl() + "accounts(" + selectedDonor.accountid + ")";
                    XrmServiceUtility.UpdateRecord(customerqry, customerentity);
                }
                else {
                    var customerentity = {};
                    customerentity["msnfp_primarymembershipid@odata.bind"] = "/msnfp_memberships(" + recordID + ")";
                    var customerqry = XrmServiceUtility.GetWebAPIUrl() + "contacts(" + selectedDonor.contactid + ")";
                    XrmServiceUtility.UpdateRecord(customerqry, customerentity);
                }
            }
        }

        function calculateMembershipExpiryDate(duration) {
            var modifiedEndDate = new Date();

            if (MembershipDuration.Month3.value == duration) {
                modifiedEndDate.setMonth(modifiedEndDate.getMonth() + 3);
            }
            else if (MembershipDuration.Month6.value == duration) {
                modifiedEndDate.setMonth(modifiedEndDate.getMonth() + 6);
            }
            else if (MembershipDuration.Month12.value == duration) {
                modifiedEndDate.setMonth(modifiedEndDate.getMonth() + 12);
            }
            else if (MembershipDuration.Month24.value == duration) {
                modifiedEndDate.setMonth(modifiedEndDate.getMonth() + 24);
            }
            else if (MembershipDuration.Year3.value == duration) {
                modifiedEndDate.setMonth(modifiedEndDate.getMonth() + 36);
            }
            else if (MembershipDuration.Year4.value == duration) {
                modifiedEndDate.setMonth(modifiedEndDate.getMonth() + 48);
            }
            else if (MembershipDuration.Year5.value == duration) {
                modifiedEndDate.setMonth(modifiedEndDate.getMonth() + 60);
            }
            else if (MembershipDuration.Year10.value == duration) {
                modifiedEndDate.setMonth(modifiedEndDate.getMonth() + 120);
            }
            else if (MembershipDuration.Lifetime.value == duration) {
                modifiedEndDate.setValue(new Date('2099-12-31'));
            }

            return new Date(modifiedEndDate);
        }

        //Helper Methods
        Array.prototype.distinct = function () {
            var map = {}, out = [];
            var l = this.length;

            for (var i = 0; i < l; i++) {
                if (map[this[i].data]) { continue; }

                out.push(this[i]);
                map[this[i].data] = 1;
            }

            return out;
        }

        Array.prototype.distinctMembershipGroup = function () {
            var map = {}, out = [];
            var l = this.length;

            for (var i = 0; i < l; i++) {
                if (map[this[i].msnfp_identifier]) { continue; }

                out.push(this[i]);
                map[this[i].msnfp_identifier] = 1;
            }

            return out;
        }

        function getLookupGuid(fieldName) {
            var field = parent.Xrm.Page.data.entity.attributes.get(fieldName);
            if (field != null && field.getValue() != null) {
                return parent.Xrm.Page.data.entity.attributes.get(fieldName).getValue()[0].id.replace('{', '').replace('}', '');
            }
            return null;
        }

        function RandomGuid() {
            return s4() + s4() + '' + s4() + '' + s4() + '' +
                s4() + '' + s4() + s4() + s4();
        }

        function s4() {
            return Math.floor((1 + Math.random()) * 0x10000)
                .toString(16)
                .substring(1);
        }

        function getUrlParameter(name) {
            var param = parent.Xrm.Page.context.getQueryStringParameters();
            return param[name];
        }

        function isEmail(email) {
            var regex = /^([a-zA-Z0-9_.+-])+\@(([a-zA-Z0-9-])+\.)+([a-zA-Z0-9]{2,4})+$/;
            return regex.test(email);
        }

        function getFormattedDate(date) {
            return ("0" + (date.getMonth() + 1)).slice(-2)
                + "/"
                + ("0" + date.getDate()).slice(-2)
                + "/"
                + date.getFullYear();
        }

        // Note this is used for Date Only fields:
        function getFormattedDateYYYYMMDD(date) {
            return date.getFullYear() + "-" + ("0" + (date.getMonth() + 1)).slice(-2) + "-" + ("0" + date.getDate()).slice(-2);
        }

        function isNullOrUndefined(value) {
            return (typeof (value) === "undefined" || value === null || value === "");
        }

        function listSorter(a, b) {
            var x = a.msnfp_identifier.toLowerCase();
            var y = b.msnfp_identifier.toLowerCase();
            return ((x < y) ? -1 : ((x > y) ? 1 : 0));
        }

        function validateFloatKeyPress(el, evt) {
            var charCode = (evt.which) ? evt.which : event.keyCode;
            var number = el.value.split('.');
            if (charCode != 46 && charCode > 31 && (charCode < 48 || charCode > 57)) {
                return false;
            }
            //just one dot
            if (number.length > 1 && charCode == 46) {
                return false;
            }
            //get the carat position
            var caratPos = getSelectionStart(el);
            var dotPos = el.value.indexOf(".");
            if (caratPos > dotPos && dotPos > -1 && (number[1].length > 1)) {
                return false;
            }
            return true;
        }

        function getSelectionStart(o) {
            if (o.createTextRange) {
                var r = document.selection.createRange().duplicate();
                r.moveEnd('character', o.value.length);
                if (r.text === '') return o.value.length;
                return o.value.lastIndexOf(r.text);
            } else return o.selectionStart;
        }

        function isNumber(evt) {
            evt = (evt) ? evt : window.event;
            var charCode = (evt.which) ? evt.which : evt.keyCode;
            if (charCode > 31 && (charCode < 48 || charCode > 57)) {
                return false;
            }
            return true;
        }

        function addCommasonLoad(nStr) {
            if (nStr != 0) {
                nStr = nStr.replace(currencySymbol, '').replace(',', '');
                nStr += '';
                x = nStr.split('.');
                x1 = x[0];
                x2 = x.length > 1 ? '.' + x[1] : '';
                var rgx = /(\d+)(\d{3})/;
                while (rgx.test(x1)) {
                    x1 = x1.replace(rgx, '$1' + ',' + '$2');
                }
                return x1 + x2;
            }
            else return '0.00';
        }

        function DSTOffsetYYYYMMDD(str) {
            let dt = new Date(str);
            let start = new Date(dt.getYear(), userSettings.timezonedaylightmonth - 1, userSettings.timezonedaylightday);
            let end = new Date(dt.getYear(), userSettings.timezonestandardmonth - 1, userSettings.timezonestandardday);
            if (dt >= start && dt < end) dt.setMinutes(-userSettings.timezonedaylightbias);
            return dt.getFullYear() + "-" + (dt.getMonth() + 1) + "-" + dt.getDate();
        }

        function DSTOffsetMMDDYYYYSlashes(str) {
            let dt = new Date(str);
            let start = new Date(dt.getYear(), userSettings.timezonedaylightmonth - 1, userSettings.timezonedaylightday);
            let end = new Date(dt.getYear(), userSettings.timezonestandardmonth - 1, userSettings.timezonestandardday);
            if (dt >= start && dt < end) dt.setMinutes(-userSettings.timezonedaylightbias);
            return ("0" + (dt.getMonth() + 1)).slice(-2) + "/" + ("0" + dt.getDate()).slice(-2) + "/" + dt.getFullYear();
        }

        function DSTOffset(str) {
            let dt = new Date(str);
            let start = new Date(dt.getYear(), userSettings.timezonedaylightmonth - 1, userSettings.timezonedaylightday);
            let end = new Date(dt.getYear(), userSettings.timezonestandardmonth - 1, userSettings.timezonestandardday);
            if (dt >= start && dt < end) dt.setMinutes(-userSettings.timezonedaylightbias);
            return dt;
        }

        function getConstituent() {
            var cons = parent.Xrm.Page.data.entity.attributes.get("msnfp_constituentid").getValue();
            if (cons)
                return `/${cons[0].entityType}s(${XrmUtility.CleanGuid(cons[0].id)})`;
            else if (!isNullOrUndefined(selectedConstitute))
                return `/contacts(${selectedConstitute.contactid})`;
            return null;
        }
    </script>

</body>
</html>